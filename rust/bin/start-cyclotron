#!/bin/bash

set -ex

trap "trap - SIGTERM && kill -- -$$" SIGINT SIGTERM EXIT


if [ -z "$CYCLOTRON_DATABASE_URL" ]; then
    echo "CYCLOTRON_DATABASE_URL is not set"
    exit 1
fi

export DATABASE_URL=$CYCLOTRON_DATABASE_URL
export RUST_LOG=info

cd cyclotron-core

# run sqlx migrations
sqlx migrate run

cd ..
cargo build --bin cyclotron-janitor --release && cargo build --bin cyclotron-fetch --release

./target/release/cyclotron-janitor &
./target/release/cyclotron-fetch &

wait