#!/bin/bash
set -eE

MIGRATION_TYPE="$1"

# JSON logging helper function
log_json() {
    local level="$1"
    local message="$2"
    local status="$3"
    local migration_type="${4:-$MIGRATION_TYPE}"
    local extra="${5:-}"

    local timestamp
    timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

    local json="{\"timestamp\":\"$timestamp\",\"level\":\"$level\",\"message\":\"$message\",\"migration_type\":\"$migration_type\",\"status\":\"$status\""

    if [ -n "$extra" ]; then
        json="$json,$extra"
    fi

    json="$json}"
    echo "$json"
}

# Error handler to log failures as JSON
handle_error() {
    local exit_code=$?
    local failed_command="${BASH_COMMAND}"
    log_json "error" "Migration failed" "failed" "$MIGRATION_TYPE" "\"error\":\"Command failed: $failed_command\",\"exit_code\":$exit_code"
    exit $exit_code
}

trap handle_error ERR

if [ -z "$MIGRATION_TYPE" ]; then
    log_json "error" "No migration type specified" "failed" "unknown"
    echo ""
    echo "Usage: $0 <all|persons|cyclotron|behavioral-cohorts>"
    echo "  all                - Run all migrations"
    echo "  persons            - Run only persons migrations"
    echo "  cyclotron          - Run only cyclotron migrations"
    echo "  behavioral-cohorts - Run only behavioral cohorts migrations"
    exit 1
fi

# Determine the base directory for migrations
# In Docker, we use /migrations; locally, we use the parent directory
if [ -d "/migrations" ]; then
    MIGRATIONS_BASE="/migrations"
else
    SCRIPT_DIR=$(dirname "$(readlink -f "$0")")
    MIGRATIONS_BASE="$SCRIPT_DIR/.."
fi

run_persons_migrations() {
    local db_type="persons"
    PERSONS_DATABASE_NAME=${PERSONS_DATABASE_NAME:-posthog_persons}
    PERSONS_DATABASE_URL=${PERSONS_DATABASE_URL:-postgres://posthog:posthog@localhost:5432/$PERSONS_DATABASE_NAME}

    log_json "info" "Starting migrations" "starting" "$db_type" "\"database_name\":\"$PERSONS_DATABASE_NAME\""

    sqlx database create -D "$PERSONS_DATABASE_URL"
    log_json "info" "Database created or already exists" "running" "$db_type"

    sqlx migrate run -D "$PERSONS_DATABASE_URL" --source "$MIGRATIONS_BASE/persons_migrations/"

    log_json "info" "Migrations completed successfully" "completed" "$db_type"
}

run_cyclotron_migrations() {
    local db_type="cyclotron"
    CYCLOTRON_DATABASE_NAME=${CYCLOTRON_DATABASE_NAME:-cyclotron}
    CYCLOTRON_DATABASE_URL=${CYCLOTRON_DATABASE_URL:-postgres://posthog:posthog@localhost:5432/$CYCLOTRON_DATABASE_NAME}

    log_json "info" "Starting migrations" "starting" "$db_type" "\"database_name\":\"$CYCLOTRON_DATABASE_NAME\""

    sqlx database create -D "$CYCLOTRON_DATABASE_URL"
    log_json "info" "Database created or already exists" "running" "$db_type"

    sqlx migrate run -D "$CYCLOTRON_DATABASE_URL" --source "$MIGRATIONS_BASE/cyclotron-core/migrations/"

    log_json "info" "Migrations completed successfully" "completed" "$db_type"
}

run_behavioral_cohorts_migrations() {
    local db_type="behavioral-cohorts"
    BEHAVIORAL_COHORTS_DATABASE_NAME=${BEHAVIORAL_COHORTS_DATABASE_NAME:-behavioral_cohorts}

    # Use environment variables with defaults
    DB_HOST="${POSTGRES_BEHAVIORAL_COHORTS_HOST:-localhost}"
    DB_USER="${POSTGRES_BEHAVIORAL_COHORTS_USER:-posthog}"
    DB_PASS="${POSTGRES_BEHAVIORAL_COHORTS_PASSWORD:-posthog}"

    BEHAVIORAL_COHORTS_DATABASE_URL=${BEHAVIORAL_COHORTS_DATABASE_URL:-postgres://${DB_USER}:${DB_PASS}@${DB_HOST}:5432/$BEHAVIORAL_COHORTS_DATABASE_NAME}

    log_json "info" "Starting migrations" "starting" "$db_type" "\"database_name\":\"$BEHAVIORAL_COHORTS_DATABASE_NAME\""

    sqlx database create -D "$BEHAVIORAL_COHORTS_DATABASE_URL"
    log_json "info" "Database created or already exists" "running" "$db_type"

    sqlx migrate run -D "$BEHAVIORAL_COHORTS_DATABASE_URL" --source "$MIGRATIONS_BASE/behavioral_cohorts_migrations/"

    log_json "info" "Migrations completed successfully" "completed" "$db_type"
}

case "$MIGRATION_TYPE" in
    persons)
        run_persons_migrations
        ;;
    cyclotron)
        run_cyclotron_migrations
        ;;
    behavioral-cohorts)
        run_behavioral_cohorts_migrations
        ;;
    all)
        run_persons_migrations
        run_cyclotron_migrations
        run_behavioral_cohorts_migrations
        ;;
    *)
        log_json "error" "Invalid migration type specified" "failed" "$MIGRATION_TYPE"
        echo "Usage: $0 <all|persons|cyclotron|behavioral-cohorts>"
        echo "  all                - Run all migrations"
        echo "  persons            - Run only persons migrations"
        echo "  cyclotron          - Run only cyclotron migrations"
        echo "  behavioral-cohorts - Run only behavioral cohorts migrations"
        exit 1
        ;;
esac

log_json "info" "All requested migrations completed successfully" "completed"
