#!/bin/bash 
set -e 
LOG_PREFIX="[$(date \"+%Y-%m-%d %H:%M:%S\")]" 
echo "$LOG_PREFIX Cloud-init deployment starting" 
mkdir hobby 
cd hobby 
echo "$LOG_PREFIX Setting up needrestart config" 
sed -i "s/#\$nrconf{restart} = 'i';/\$nrconf{restart} = 'a';/g" /etc/needrestart/needrestart.conf 
echo "$LOG_PREFIX Cloning PostHog repository" 
git clone https://github.com/PostHog/posthog.git 
cd posthog 
echo "$LOG_PREFIX Using branch: fix/do-hobby" 
git checkout fix/do-hobby 
CURRENT_COMMIT=$(git rev-parse HEAD) 
echo "$LOG_PREFIX Current commit: $CURRENT_COMMIT" 
cd .. 
chmod +x posthog/bin/deploy-hobby 
echo "$LOG_PREFIX Starting deployment script" 
echo "$LOG_PREFIX Using commit hash for feature branch deployment" 
./posthog/bin/deploy-hobby $CURRENT_COMMIT do-ci-hobby-19570786461-2.posthog.cc 1 
DEPLOY_EXIT=$? 
echo "$LOG_PREFIX Deployment script exited with code: $DEPLOY_EXIT" 
exit $DEPLOY_EXIT 
