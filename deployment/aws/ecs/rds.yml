AWSTemplateFormatVersion: '2010-09-09'
Metadata: 
  License: Apache-2.0
Parameters:
  VPCId:
    Type: String
    Default: production
    Description: The name of the vpc you want to add postgres to 
  PrivateSubnetOne:
    Type: String
    Description: The name of the subnet you want to add postgres to 
  PrivateSubnetTwo:
    Type: String
    Description: The name of the subnet you want to add postgres to 
Description: 'Postgres template for Posthog on AWS'
Resources:
  PosthogDB:
    Type: AWS::RDS::DBInstance
    Properties:
      DBName: PosthogDB 
      AllocatedStorage: '5'
      DBInstanceClass: db.t2.small
      Engine: PostgreSQL 
      MasterUsername: posthog 
      MasterUserPassword: posthog 
    DeletionPolicy: Snapshot
  SubnetGroup:
    Type: AWS::RDS::SubnetGroup
    Properties:
      Description: RDS Subnet Group
      SubnetIds:
        - !Ref PrivateSubnetOne 
        - !Ref PrivateSubnetTwo
Outputs:
  JDBCConnectionString:
    Description: JDBC connection string for the database
    Value: !Join ['', ['jdbc:mysql://', !GetAtt [PosthogDB, Endpoint.Address], ':', !GetAtt [
          PosthogDB, Endpoint.Port], /posthog]]
  PGConnectionString:
    Description: Connection string for the database
    Value: !Join ['', ['postgres://posthog:posthog@', !GetAtt [PosthogDB, Endpoint.Address], ':', !GetAtt [
          PosthogDB, Endpoint.Port], '/posthog']]
    Export:
      Name: !Join [ ':', [ !Ref 'AWS::StackName', 'PGConnectionString' ] ]