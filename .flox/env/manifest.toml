#
# This is a Flox environment manifest.
# Visit flox.dev/docs/concepts/manifest/
# or see flox-edit(1), manifest.toml(5) for more information.
#
# Flox manifest version managed by Flox CLI
version = 1

# List packages you wish to install in your environment inside
# the `[install]` section.
[install]
# Python - Python itself is installed on activation via `uv sync`
uv = { pkg-path = "uv", pkg-group = "uv", version = "0.9.9" }
xmlsec = { pkg-path = "xmlsec", version = "1.3.7" }
freetds = { pkg-path = "freetds" } # For pymssql
# Node
nodejs = { pkg-path = "nodejs_24", pkg-group = "nodejs", version = "24.12.0" } # Same maj.min ver as in Dockerfile; diverges from patch ver
corepack = { pkg-path = "corepack_24", pkg-group = "nodejs", version = "24.12.0" } # Same maj.min as in Dockerfile; diverges from patch ver
brotli = { pkg-path = "brotli", pkg-group = "nodejs" }
openssl = { pkg-path = "openssl", version = "3.4.1", pkg-group = "openssl" }
nodemon = { pkg-path = "nodemon" }
# Rust toolchain (based on https://flox.dev/docs/cookbook/languages/rust/)
cargo = { pkg-path = "cargo", pkg-group = "rust-toolchain", version = "1.91.1" }
rustc = { pkg-path = "rustc", pkg-group = "rust-toolchain" }
clippy = { pkg-path = "clippy", pkg-group = "rust-toolchain" }
rustfmt = { pkg-path = "rustfmt", pkg-group = "rust-toolchain" }
rust-lib-src = { pkg-path = "rustPlatform.rustLibSrc", pkg-group = "rust-toolchain" }
libiconv = { pkg-path = "libiconv", systems = ["aarch64-darwin"], pkg-group = "rust-toolchain" }
rust-analyzer = { pkg-path = "rust-analyzer", pkg-group = "rust-analyzer" } # rust-analyzer should be isolated in its own group, details in cookbook example
lld = { pkg-path = "lld", systems = ["aarch64-darwin"] } # Faster linker for Rust dev builds on macOS
sccache = { pkg-path = "sccache" } # Compilation cache for Rust (also used in CI)
# Go
go = { pkg-path = "go", version = "1.24", pkg-group = "go" }
golangci-lint = { pkg-path = "golangci-lint", pkg-group = "go" }
air = { pkg-path = "air" }
# CLI tools
mprocs = { pkg-path = "mprocs" }
util-linux = { pkg-path = "util-linux" } # flock
cmake = { pkg-path = "cmake", version = "3.31.5", pkg-group = "cmake" }
sqlx-cli = { pkg-path = "sqlx-cli", version = "0.8.3" } # sqlx
postgresql = { pkg-path = "postgresql_14" } # psql
ffmpeg = { pkg-path = "ffmpeg_5", version = "5.1.4", pkg-group = "ffmpeg" }
gh = { pkg-path = "gh" }
protobuf = { pkg-path = "protobuf" } # protoc compiler for gRPC code generation
ninja.pkg-path = "ninja"
emscripten = { pkg-path = "emscripten", pkg-group = "emscripten", version = "4.0.23" }
libpthread-stubs = { pkg-path = "libpthread-stubs", pkg-group = "emscripten" }
watchman = { pkg-path = "watchman" } # Fast file watching for Django/Celery autoreload (uses pywatchman)

# Set environment variables in the `[vars]` section. These variables may not
# reference one another, and are added to the environment without first
# expanding them. They are available for use in the `[profile]` and `[hook]`
# scripts.
[vars]
DEBUG = "1"
POSTHOG_SKIP_MIGRATION_CHECKS = "1"
FLAGS_REDIS_URL = "redis://localhost:6379/1"
DIRENV_LOG_FORMAT = "" # Disable direnv activation logging (in case direnv is present)
RUST_LOG = "flox=error,flox_rust_sdk=error,flox_watchdog=error" # Suppress Flox logs only (also set in .envrc for early activation)
OPENSSL_ROOT_DIR = "$FLOX_ENV"
OPENSSL_LIB_DIR = "$FLOX_ENV/lib"
DOTENV_FILE = ".env"
OPENSSL_INCLUDE_DIR = "$FLOX_ENV/include"
LDFLAGS="-L$FLOX_ENV/lib"
CPPFLAGS="-I$FLOX_ENV/include"
UV_PROJECT_ENVIRONMENT = "$FLOX_ENV_CACHE/venv"

# The `hook.on-activate` script is run by the *bash* shell immediately upon
# activating an environment, and will not be invoked if Flox detects that the
# environment has previously been activated. Variables set by the script will
# be inherited by `[profile]` scripts defined below. Note that any stdout
# generated by the script will be redirected to stderr.
[hook]
on-activate = '''
source "$FLOX_ENV_PROJECT/.flox/env/on-activate.sh"
'''

# Scripts defined in the `[profile]` section are *sourced* by *your shell* and
# inherit environment variables set in the `[vars]` section and by `[hook]` scripts.
# The `profile.common` script is sourced by all shells and special care should be
# taken to ensure compatibility with all shells, after which exactly one of
# `profile.{bash,fish,tcsh,zsh}` is sourced by the corresponding shell.
[profile]
bash = '''
  if [ -f "$HOME/.bash_profile" ]; then
    source "$HOME/.bash_profile"
    # ensure even with your shell prefs in place we know this is a Flox.dev env
    export PS1="\033[47m(flox)\033[0m $PS1"
  fi
  # Ensure flox binaries (especially Node.js) take precedence over system binaries
  export PATH="$FLOX_ENV/bin:$PATH"
  source $UV_PROJECT_ENVIRONMENT/bin/activate
  # Source hogli bash completions
  [ -f "$FLOX_ENV_CACHE/completions/hogli.bash" ] && source "$FLOX_ENV_CACHE/completions/hogli.bash"
'''
zsh = '''
  if [[ -f "$HOME/.zshrc" ]]; then
    source "$HOME/.zshrc"
    # ensure even with your shell prefs in place we know this is a Flox.dev env
    export PS1="%K{white}%F{black}(flox)%k%f $PS1"
  fi
  # Ensure flox binaries (especially Node.js) take precedence over system binaries
  export PATH="$FLOX_ENV/bin:$PATH"
  source $UV_PROJECT_ENVIRONMENT/bin/activate
  # Add hogli completions to zsh
  [[ -f "$FLOX_ENV_CACHE/completions/_hogli" ]] && fpath=("$FLOX_ENV_CACHE/completions" $fpath)
  autoload -Uz compinit && compinit -i
'''
fish = '''
  # Ensure flox binaries (especially Node.js) take precedence over system binaries
  fish_add_path "$FLOX_ENV/bin"
  source $UV_PROJECT_ENVIRONMENT/bin/activate.fish
'''
tcsh = '''
  # Ensure flox binaries (especially Node.js) take precedence over system binaries
  setenv PATH "$FLOX_ENV/bin:$PATH"
  source $UV_PROJECT_ENVIRONMENT/bin/activate.csh
'''

# The `[services]` section of the manifest allows you to define services.
# Services defined here use the packages provided by the `[install]` section
# and any variables you've defined in the `[vars]` section or `hook.on-activate` script.
[services]
# db.command = "postgres -D $FLOX_ENV_CACHE/postgres"

# Additional options can be set in the `[options]` section. Refer to
# manifest.toml(5) for a list of available options.
[options]
systems = ["aarch64-darwin", "aarch64-linux", "x86_64-darwin", "x86_64-linux"]
