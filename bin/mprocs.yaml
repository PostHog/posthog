procs:
    backend:
        shell: 'uv sync --active && bin/check_postgres_up && bin/check_kafka_clickhouse_up && bin/check_ducklake_up && ./bin/start-backend'

    celery-worker:
        shell: 'uv sync --active && bin/check_postgres_up && bin/check_kafka_clickhouse_up && bin/check_ducklake_up && ./bin/start-celery worker'

    celery-beat:
        shell: 'uv sync --active && bin/check_postgres_up && bin/check_kafka_clickhouse_up && bin/check_ducklake_up && ./bin/start-celery beat'

    nodejs:
        shell: 'bin/check_postgres_up && bin/check_kafka_clickhouse_up && bin/check_ducklake_up && ./bin/posthog-node'

    frontend:
        shell: './bin/start-frontend'
        autorestart: true

    typegen:
        shell: 'if [ -n "$SKIP_TYPEGEN" ]; then exit 0; fi && cd frontend && pnpm run typegen:watch'

    temporal-worker:
        shell: |-
            bin/check_kafka_clickhouse_up && \
            bin/check_temporal_up && \
            bin/check_video_deps && \
            bin/check_ducklake_up && \
            if [ -n "$TEMPORAL_WATCH" ]; then \
                nodemon -w common -w dags -w ee -w posthog -w products -w pyproject.toml -e py --signal SIGTERM --exec "python manage.py start_temporal_worker --task-queue development-task-queue"; \
            else \
                python manage.py start_temporal_worker --task-queue development-task-queue; \
            fi

    dagster:
        shell: |-
            bin/check_postgres_up && \
            bin/check_kafka_clickhouse_up && \
            bin/check_ducklake_up && \
            dagster dev --workspace $DAGSTER_HOME/workspace.yaml -p $DAGSTER_UI_PORT

    docker-compose:
        # docker-compose makes sure the stack is up, and then follows its logs - but doesn't tear down on exit for speed
        shell: 'docker compose -f docker-compose.dev.yml up --pull always -d && docker compose -f docker-compose.dev.yml logs --tail=0 -f'

    cyclotron-janitor:
        shell: |-
            bin/check_postgres_up cyclotron && \
            bin/check_kafka_clickhouse_up && \
            bin/start-rust-service cyclotron-janitor

    cymbal:
        shell: |-
            bin/check_postgres_up && \
            bin/check_kafka_clickhouse_up && \
            bin/start-rust-service cymbal

    embedding-worker:
        shell: |-
            bin/check_kafka_clickhouse_up && \
            bin/start-rust-service embedding-worker

    feature-flags:
        shell: |-
            bin/check_postgres_up posthog && \
            bin/start-rust-service feature-flags

    property-defs-rs:
        shell: |-
            bin/check_postgres_up && \
            bin/check_kafka_clickhouse_up && \
            bin/start-rust-service property-defs-rs

    capture:
        shell: |-
            bin/check_postgres_up && \
            bin/check_kafka_clickhouse_up && \
            bin/start-rust-service capture

    capture-replay:
        shell: |-
            bin/check_postgres_up && \
            bin/check_kafka_clickhouse_up && \
            bin/start-rust-service capture-replay

    capture-ai:
        shell: |-
            bin/check_postgres_up && \
            bin/check_kafka_clickhouse_up && \
            bin/start-rust-service capture-ai

    batch-import-worker:
        shell: |-
            bin/check_postgres_up && \
            bin/check_kafka_clickhouse_up && \
            bin/start-rust-service batch-import-worker

    llm-gateway:
        shell: 'bin/check_postgres_up && bin/start-llm-gateway'
        autostart: true

    # This takes ~10 s
    migrate-postgres:
        shell: 'bin/check_postgres_up && bin/check_ducklake_up && bin/migrate --scope=postgres'

    # This takes ~10 s too
    migrate-clickhouse:
        shell: 'bin/check_kafka_clickhouse_up && bin/check_ducklake_up && bin/migrate --scope=clickhouse'

    migrate-persons-db:
        shell: 'bin/check_postgres_up posthog_persons && bin/migrate --scope=persons'

    migrate-behavioral-cohorts:
        shell: 'bin/check_postgres_up behavioral_cohorts && bin/migrate --scope=behavioral-cohorts'

    generate-demo-data:
        shell: |-
            bin/check_postgres_up && \
            bin/check_kafka_clickhouse_up && \
            bin/check_dagster_graphql_up && \
            bin/check_ducklake_up && \
            ./manage.py generate_demo_data
        autostart: false

    sync-feature-flags:
        shell: |-
            bin/check_postgres_up && \
            bin/check_ducklake_up && \
            ./manage.py sync_feature_flags
        autostart: false

    storybook:
        shell: 'pnpm --filter=@posthog/storybook install && pnpm run storybook'
        autostart: false

    hedgebox-dummy:
        shell: 'bin/check_postgres_up && cd hedgebox-dummy && pnpm install && pnpm run dev'
        autostart: false

mouse_scroll_speed: 1
scrollback: 10000
