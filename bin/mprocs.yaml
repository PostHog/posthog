# Process registry for the intent-based dev environment.
#
# This file defines all available processes and their capabilities.
# Normally, `hogli dev:generate` creates a tailored config at
# .posthog/.generated/mprocs.yaml based on your selected intents.
# This file is used as fallback when hogli isn't available.
#
# To customize which processes run, use `hogli dev:setup`.
# See devenv/intent-map.yaml for intent-to-capability mappings.

procs:
    info:
        shell: |
            echo ''
            printf '\033[38;2;245;78;0m\033[1m  PostHog Dev Environment\033[0m\n'
            printf '\033[38;5;245m  ─────────────────────────────────────\033[0m\n'
            echo ''
            if [ -f devenv/news.txt ]; then
                printf '  \033[38;2;245;78;0m\033[1mNews:\033[0m\n'
                while IFS= read -r line || [ -n "$line" ]; do
                    [ -z "$line" ] && continue
                    printf '    \033[38;5;245m·\033[0m %s\n' "$line"
                done < devenv/news.txt
                echo ''
            fi
            printf '  \033[1mCommands:\033[0m\n'
            printf '    \033[38;2;29;74;255mhogli dev:setup\033[0m    Configure which services run\n'
            printf '    \033[38;2;29;74;255mhogli dev:explain\033[0m  Show why each service is running\n'
            echo ''
            printf '\033[38;5;245m  ─────────────────────────────────────\033[0m\n'
            printf '  \033[38;5;245mRun \033[0m\033[38;2;29;74;255mhogli dev:setup\033[0m\033[38;5;245m to tailor this to your workflow.\033[0m\n'

    backend:
        shell: 'uv sync --active && bin/wait-for-docker && bin/check_ducklake_up && ./bin/start-backend'
        # no capability - always_required via intent-map.yaml

    celery-worker:
        shell: 'uv sync --active && bin/wait-for-docker && bin/check_ducklake_up && ./bin/start-celery worker'
        capability: celery_workers

    celery-beat:
        shell: 'uv sync --active && bin/wait-for-docker && bin/check_ducklake_up && ./bin/start-celery beat'
        capability: celery_scheduler

    nodejs:
        shell: 'bin/wait-for-docker && bin/check_ducklake_up && ./bin/posthog-node'
        capability: event_ingestion
        # Node.js capabilities are controlled via NODEJS_CAPABILITY_GROUPS env var
        # Set by hogli dev:generate based on selected nodejs_* capabilities
        # Valid groups: cdp_workflows, realtime_cohorts, session_replay, logs, feature_flags
        # Example: NODEJS_CAPABILITY_GROUPS=cdp_workflows,session_replay

    frontend:
        shell: './bin/start-frontend'
        autorestart: true
        # no capability - always_required via intent-map.yaml

    typegen:
        shell: 'cd frontend && pnpm run typegen:watch'
        autostart: false
        ask_skip: true # wizard asks if user wants to skip this

    temporal-worker:
        shell: |-
            bin/wait-for-docker temporal && \
            bin/check_ducklake_up && \
            if [ -n "$TEMPORAL_DISABLE_HOT_RELOAD" ] || ! command -v nodemon >/dev/null 2>&1; then \
                python manage.py start_temporal_worker --task-queue development-task-queue; \
            else \
                nodemon -w common -w dags -w ee -w posthog -w products -w pyproject.toml -e py --signal SIGTERM --exec "python manage.py start_temporal_worker --task-queue development-task-queue"; \
            fi
        capability: temporal_workflows

    dagster:
        shell: |-
            bin/wait-for-docker && \
            bin/check_ducklake_up && \
            dagster dev --workspace $DAGSTER_HOME/workspace.yaml -p $DAGSTER_UI_PORT
        capability: dagster_pipelines

    docker-compose:
        shell: 'docker compose -f docker-compose.dev.yml up --pull always -d && docker compose -f docker-compose.dev.yml logs --tail=0 -f'
        capability: core_infra
        # also always_required via intent-map.yaml

    cyclotron-janitor:
        shell: |-
            bin/wait-for-docker && \
            bin/start-rust-service cyclotron-janitor
        capability: cyclotron

    cyclotron-janitor-shadow:
        shell: |-
            bin/wait-for-docker && \
            DATABASE_URL=postgres://posthog:posthog@localhost:5432/cyclotron_shadow \
            BIND_PORT=3304 \
            JANITOR_ID=shadow-janitor \
            SHARD_ID=shadow \
            bin/start-rust-service cyclotron-janitor
        capability: cyclotron

    cymbal:
        shell: |-
            bin/wait-for-docker && \
            bin/start-rust-service cymbal
        capability: error_symbolication

    embedding-worker:
        shell: |-
            bin/wait-for-docker && \
            bin/start-rust-service embedding-worker
        capability: embedding_service

    feature-flags:
        shell: |-
            bin/wait-for-docker && \
            bin/start-rust-service feature-flags
        capability: flag_evaluation

    livestream:
        shell: |-
            bin/wait-for-docker && \
            bin/start-go-service livestream
        capability: livestream

    property-defs-rs:
        shell: |-
            bin/wait-for-docker && \
            bin/start-rust-service property-defs-rs
        capability: property_definitions

    capture:
        shell: |-
            bin/wait-for-docker && \
            bin/start-rust-service capture
        capability: event_ingestion

    capture-replay:
        shell: |-
            bin/wait-for-docker && \
            bin/start-rust-service capture-replay
        capability: replay_storage

    capture-ai:
        shell: |-
            bin/wait-for-docker && \
            bin/start-rust-service capture-ai
        capability: ai_capture

    batch-import-worker:
        shell: |-
            bin/wait-for-docker && \
            bin/start-rust-service batch-import-worker
        capability: batch_imports

    llm-gateway:
        shell: 'bin/wait-for-docker && bin/start-llm-gateway'
        autostart: true
        capability: llm_gateway
        env:
            LLM_GATEWAY_DEBUG: 'true'
            LLM_GATEWAY_TEAM_RATE_LIMIT_MULTIPLIERS: '{"1": 10}'
            LLM_GATEWAY_POSTHOG_PROJECT_TOKEN: 'phc_localposthogprojecttoken'
            LLM_GATEWAY_POSTHOG_HOST: 'http://localhost:8010'

    mcp:
        shell: 'bin/start-mcp-server'
        capability: mcp_server

    mcp-ui-apps:
        shell: 'cd services/mcp && pnpm run build:ui-apps -- --watch'
        capability: mcp_server

    migrate-postgres:
        shell: 'bin/wait-for-docker && bin/check_ducklake_up && bin/migrate --scope=postgres'
        capability: core_infra

    migrate-clickhouse:
        shell: 'bin/wait-for-docker && bin/check_ducklake_up && bin/migrate --scope=clickhouse'
        capability: core_infra

    migrate-cyclotron:
        shell: 'bin/wait-for-docker && bin/migrate --scope=cyclotron'
        capability: cyclotron

    migrate-cyclotron-shadow:
        shell: 'bin/wait-for-docker && bin/migrate --scope=cyclotron-shadow'
        capability: cyclotron

    migrate-persons-db:
        shell: 'bin/wait-for-docker && bin/migrate --scope=persons'
        # no capability - optional migration

    migrate-behavioral-cohorts:
        shell: 'bin/wait-for-docker && bin/migrate --scope=behavioral-cohorts'
        # no capability - optional migration

    generate-demo-data:
        shell: |-
            bin/wait-for-docker && \
            bin/check_ducklake_up && \
            ./manage.py generate_demo_data
        autostart: false
        # no capability - manual start

    sync-feature-flags:
        shell: |-
            bin/wait-for-docker && \
            bin/check_ducklake_up && \
            ./manage.py sync_feature_flags
        autostart: false
        # no capability - manual start

    storybook:
        shell: 'pnpm --filter=@posthog/storybook install && pnpm run storybook'
        autostart: false
        # no capability - manual start

    hedgebox-dummy:
        shell: 'bin/wait-for-docker && cd hedgebox-dummy && pnpm install && pnpm run dev'
        autostart: false
        # no capability - manual start

mouse_scroll_speed: 1
scrollback: 10000
