#!/bin/bash -ex

# Builds the Cyclotron node module and installs it into plugin-server/node-modules/cyclotron

if ! command -v rustc &> /dev/null || ! command -v cargo &> /dev/null; then
    echo "Rust and Cargo need to be installed, please 'brew install rust' or equivalent"
fi

cd rust/cyclotron-node

export DATABASE_URL=${DATABASE_URL:-postgres://posthog:posthog@localhost:5432/posthog}
cargo sqlx migrate run

npm install
npm run build

cd ../../plugin-server

mkdir -p node_modules/cyclotron

cp ../rust/cyclotron-node/index.node node_modules/cyclotron/
