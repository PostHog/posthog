#!/bin/bash
set -e

./bin/migrate-check

# To ensure we are able to expose metrics from multiple processes, we need to
# provide a directory for `prometheus_client` to store a shared registry.
export PROMETHEUS_MULTIPROC_DIR=$(mktemp -d)
chmod -R 777 $PROMETHEUS_MULTIPROC_DIR
trap 'rm -rf "$PROMETHEUS_MULTIPROC_DIR"' EXIT

export PROMETHEUS_METRICS_EXPORT_PORT=8001
export STATSD_PORT=${STATSD_PORT:-8125}

# Granian configuration
export GRANIAN_WORKERS=${GRANIAN_WORKERS:-4}
export GRANIAN_THREADS=2

# Start metrics HTTP server in background on port 8001
python ./bin/granian_metrics.py &
METRICS_PID=$!
trap 'kill $METRICS_PID 2>/dev/null; rm -rf "$PROMETHEUS_MULTIPROC_DIR"' EXIT

exec granian \
    --interface asgi \
    posthog.asgi:application \
    --workers $GRANIAN_WORKERS \
    --runtime-threads $GRANIAN_THREADS \
    --runtime-mode mt \
    --loop uvloop \
    --host 0.0.0.0 \
    --port 8000 \
    --log-level warning \
    --access-log \
    --respawn-failed-workers
