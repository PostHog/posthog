#!/bin/bash
set -e

./bin/migrate-check

# To ensure we are able to expose metrics from multiple processes, we need to
# provide a directory for `prometheus_client` to store shared metrics.
export PROMETHEUS_MULTIPROC_DIR=$(mktemp -d)
trap 'rm -rf "$PROMETHEUS_MULTIPROC_DIR"' EXIT

gunicorn posthog.wsgi \
    --config gunicorn.config.py \
    --bind 0.0.0.0:8000 \
    --log-file - \
    --log-level info \
    --access-logfile - \
    --worker-tmp-dir /dev/shm \
    --workers=2 \
    --threads=4 \
    --worker-class=gthread \
    --limit-request-line=8190
