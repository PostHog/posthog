#!/usr/bin/env bash
set -e

# Wrapper script for syncing object storage between MinIO and SeaweedFS
# This makes it easier to sync different services with sensible defaults

# All available services
ALL_SERVICES=(
    "query-cache"
    "session-recordings"
    "session-recordings-lts"
    "media-uploads"
    "exports"
    "source-maps"
)

MODE="sync"

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PLUGIN_SERVER_DIR="$SCRIPT_DIR/../plugin-server"

# Ensure DEBUG is set for local dev
export DEBUG=1

cd "$PLUGIN_SERVER_DIR"

# Parse arguments - handle both orders
SERVICE=""
DRY_RUN_FLAG=""

for arg in "$@"; do
    if [ "$arg" = "--dry-run" ] || [ "$arg" = "-n" ]; then
        DRY_RUN_FLAG="--dry-run"
    else
        SERVICE="$arg"
    fi
done

# Function to sync a single service
sync_service() {
    local service="$1"
    local dry_run_flag="$2"
    
    echo "ğŸ”„ Syncing $service between MinIO and SeaweedFS..."
    echo ""
    
    # Build the command
    local cmd="node bin/migrate-minio-to-seaweedfs.js --service $service --mode $MODE"
    
    if [ -n "$dry_run_flag" ]; then
        cmd="$cmd --dry-run"
    fi
    
    # Execute
    $cmd
    echo ""
}

# Show dry-run notice if applicable
if [ -n "$DRY_RUN_FLAG" ]; then
    echo "ğŸ“‹ DRY RUN MODE - No changes will be made"
    echo ""
fi

# If no service specified, sync all
if [ -z "$SERVICE" ]; then
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "ğŸ”„ Syncing ALL services between MinIO and SeaweedFS"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    
    for service in "${ALL_SERVICES[@]}"; do
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        sync_service "$service" "$DRY_RUN_FLAG"
    done
    
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo "âœ¨ All services synced!"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
else
    # Sync single service
    sync_service "$SERVICE" "$DRY_RUN_FLAG"
    echo "âœ¨ Done!"
fi

echo ""
echo "Available services:"
echo "  - query-cache            (ephemeral, safe to test)"
echo "  - session-recordings     (current V2 recordings)"  
echo "  - session-recordings-lts (long-term storage)"
echo "  - media-uploads          (user uploaded media)"
echo "  - exports                (CSV, PNG, PDF, videos)"
echo "  - source-maps            (error tracking source maps)"
echo ""
echo "Usage:"
echo "  $0                       # Sync ALL services"
echo "  $0 [--dry-run]           # Preview syncing ALL services"
echo "  $0 <service>             # Sync specific service"
echo "  $0 <service> [--dry-run] # Preview syncing specific service"
echo ""
echo "Examples:"
echo "  $0                       # Sync all services"
echo "  $0 --dry-run             # Dry run for all services"
echo "  $0 query-cache           # Sync query cache only"
echo "  $0 media-uploads -n      # Dry run for media uploads only"

