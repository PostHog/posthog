#!/usr/bin/env bash
set -euo pipefail

# PostHog Stack CLI
VERSION="1.0.0"
INSTALL_DIR="/usr/local/posthog-stack"
COMPOSE_FILE="$INSTALL_DIR/docker-compose.stack.yml"
TARBALL="$INSTALL_DIR/stack-images.tar.gz"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

error() {
  echo -e "${RED}‚úó${NC} $1"
  exit 1
}

success() {
  echo -e "${GREEN}‚úì${NC} $1"
}

warn() {
  echo -e "${YELLOW}‚ö†${NC} $1"
}

check_docker() {
  if ! command -v docker &> /dev/null; then
    error "Docker is not installed. Please install Docker Desktop: https://www.docker.com/products/docker-desktop"
  fi

  if ! docker info &> /dev/null; then
    error "Docker is not running. Please start Docker Desktop and try again."
  fi
}

check_installed() {
  if [ ! -d "$INSTALL_DIR" ]; then
    error "PostHog Stack is not installed. Please run the installer first."
  fi

  if [ ! -f "$COMPOSE_FILE" ]; then
    error "docker-compose.stack.yml not found in $INSTALL_DIR"
  fi
}

load_images_if_needed() {
  # Check if images are already loaded
  if docker image inspect postgres:15.12-alpine &>/dev/null; then
    return 0
  fi

  if [ ! -f "$TARBALL" ]; then
    error "Image tarball not found: $TARBALL"
  fi

  echo "Loading Docker images (this may take 5-10 minutes on first run)..."
  gunzip -c "$TARBALL" | docker load
  success "Images loaded successfully"
  echo ""
}

restore_volumes_if_needed() {
  # Check if volumes already exist
  if docker volume inspect posthog_postgres-15-data &>/dev/null && \
     docker volume inspect posthog_clickhouse-data &>/dev/null; then
    return 0
  fi

  echo "Restoring pre-migrated database volumes (first run only)..."

  # Restore Postgres data
  if [ ! -f "$INSTALL_DIR/postgres-data.tar.gz" ]; then
    error "Postgres data not found: $INSTALL_DIR/postgres-data.tar.gz"
  fi

  echo "  - Restoring Postgres data..."
  docker volume create posthog_postgres-15-data > /dev/null
  docker run --rm \
    -v posthog_postgres-15-data:/data \
    -v "$INSTALL_DIR":/backup:ro \
    alpine \
    sh -c 'cd /data && tar xzf /backup/postgres-data.tar.gz'

  # Restore ClickHouse data
  if [ ! -f "$INSTALL_DIR/clickhouse-data.tar.gz" ]; then
    error "ClickHouse data not found: $INSTALL_DIR/clickhouse-data.tar.gz"
  fi

  echo "  - Restoring ClickHouse data..."
  docker volume create posthog_clickhouse-data > /dev/null
  docker run --rm \
    -v posthog_clickhouse-data:/data \
    -v "$INSTALL_DIR":/backup:ro \
    alpine \
    sh -c 'cd /data && tar xzf /backup/clickhouse-data.tar.gz'

  success "Database volumes restored"
  echo ""
}

cmd_up() {
  check_docker
  check_installed

  echo "Starting PostHog Stack..."
  echo ""

  load_images_if_needed
  restore_volumes_if_needed

  cd "$INSTALL_DIR"
  docker-compose -f docker-compose.stack.yml up -d

  echo ""
  echo "Waiting for services to be ready..."
  sleep 10

  echo ""
  success "PostHog Stack is running!"
  echo ""
  echo "üåê Web UI:       http://localhost:8000"
  echo "üìä ClickHouse:   http://localhost:8123"
  echo "üíæ MinIO:        http://localhost:19001"
  echo ""
  echo "To view logs:    posthog-stack logs"
  echo "To stop:         posthog-stack down"
}

cmd_down() {
  check_docker
  check_installed

  echo "Stopping PostHog Stack..."
  cd "$INSTALL_DIR"
  docker-compose -f docker-compose.stack.yml down

  success "PostHog Stack stopped"
}

cmd_logs() {
  check_docker
  check_installed

  cd "$INSTALL_DIR"
  if [ $# -eq 0 ]; then
    docker-compose -f docker-compose.stack.yml logs -f
  else
    docker-compose -f docker-compose.stack.yml logs -f "$@"
  fi
}

cmd_status() {
  check_docker
  check_installed

  cd "$INSTALL_DIR"
  echo "PostHog Stack Status:"
  echo ""
  docker-compose -f docker-compose.stack.yml ps
}

cmd_reset() {
  check_docker
  check_installed

  warn "This will DELETE all PostHog data and restart fresh."
  read -p "Are you sure? (yes/no): " confirm

  if [ "$confirm" != "yes" ]; then
    echo "Cancelled"
    exit 0
  fi

  echo "Stopping and removing all containers and volumes..."
  cd "$INSTALL_DIR"
  docker-compose -f docker-compose.stack.yml down -v

  success "Data wiped. Run 'posthog-stack up' to start fresh."
}

cmd_version() {
  echo "PostHog Stack v$VERSION"
}

cmd_help() {
  cat << EOF
PostHog Stack - Self-contained PostHog development environment

Usage: posthog-stack <command>

Commands:
  up          Start the PostHog stack
  down        Stop the PostHog stack
  logs        View logs (optional: specify service name)
  status      Show running services
  reset       Wipe all data and start fresh
  version     Show version
  help        Show this help message

Examples:
  posthog-stack up
  posthog-stack logs
  posthog-stack logs db
  posthog-stack down

Documentation: https://posthog.com/docs
EOF
}

# Main command router
case "${1:-help}" in
  up)
    shift
    cmd_up "$@"
    ;;
  down)
    shift
    cmd_down "$@"
    ;;
  logs)
    shift
    cmd_logs "$@"
    ;;
  status)
    shift
    cmd_status "$@"
    ;;
  reset)
    shift
    cmd_reset "$@"
    ;;
  version)
    cmd_version
    ;;
  help|--help|-h)
    cmd_help
    ;;
  *)
    error "Unknown command: $1. Run 'posthog-stack help' for usage."
    ;;
esac
