#!/bin/bash
set -e

export OBJECT_STORAGE_ENDPOINT=http://localhost:19000
export SESSION_RECORDING_V2_S3_ENDPOINT=http://localhost:19000

export CLICKHOUSE_API_USER="api"
export CLICKHOUSE_API_PASSWORD="apipass"
export CLICKHOUSE_APP_USER="app"
export CLICKHOUSE_APP_PASSWORD="apppass"

# Suppress frozen modules warning since we only debug our code, not stdlib
export PYDEVD_DISABLE_FILE_VALIDATION=1

# Bind to Docker bridge gateway IP for container access while maintaining security
DOCKER_GATEWAY_IP=$(docker network inspect bridge --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' 2>/dev/null || echo "172.17.0.1")
echo "üê≥ Using Docker bridge gateway for host access: $DOCKER_GATEWAY_IP"

python ${DEBUG:+ -m debugpy --listen 127.0.0.1:5678} -m uvicorn --reload posthog.asgi:application --host $DOCKER_GATEWAY_IP --log-level debug --reload-include "posthog/" --reload-include "ee/" --reload-include "products/"
