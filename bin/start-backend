#!/bin/bash
set -e

# Cross-platform Docker host access
# On macOS/Windows: Docker runs in a VM, use 127.0.0.1 for the host bind
# On Linux: Use bridge gateway IP for container access while maintaining security
if [[ "$OSTYPE" == "darwin"* ]] || [[ "$OSTYPE" == "msys" ]]; then
    HOST_BIND="127.0.0.1"
    echo "üçé macOS/Windows detected, using secure localhost binding"
else
    # Linux - containers cannot reach host's 127.0.0.1, use bridge gateway
    DOCKER_GATEWAY_IP=$(docker network inspect bridge --format='{{range .IPAM.Config}}{{.Gateway}}{{end}}' 2>/dev/null || echo "172.17.0.1")
    HOST_BIND="$DOCKER_GATEWAY_IP"
    echo "üêß Linux detected, binding to Docker bridge gateway: $HOST_BIND"
fi

python ${DEBUG:+ -m debugpy --listen 127.0.0.1:5678} -m granian \
    --interface asgi \
    posthog.asgi:application \
    --reload \
    --reload-paths ./posthog \
    --reload-paths ./ee \
    --reload-paths ./products \
    --reload-paths ./frontend/src/products.json \
    --host $HOST_BIND \
    --log-level debug \
    --workers 1
