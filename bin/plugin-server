#!/bin/bash

while test $# -gt 0; do
  case "$1" in
    -h|--help)
      echo "USAGE:"
      echo "    bin/plugin-server [FLAGS]"
      echo " "
      echo "FLAGS:"
      echo "    -h, --help           Print this help information."
      echo "    --no-restart-loop    Run without restart loop. Recommended when deferring resiliency to e.g. docker-compose."
      exit 0
      ;;
    --no-restart-loop)
      NO_RESTART_LOOP='true'
      shift
      ;;
    *)
      break
      ;;
  esac
done

export BASE_DIR=$(dirname $(dirname "$PWD/${0#./}"))
# If KAFKA_URL is set, extract netlocs into KAFKA_HOSTS by removing "kafka://" in a compatibility approach
if [ -n "$KAFKA_URL" ]; then
  export KAFKA_HOSTS=$(echo $KAFKA_URL | sed -e "s/kafka\(\+ssl\)\{0,1\}:\/\///g")
fi

./bin/migrate-check

cd plugin-server

if [[ -n $DEBUG ]]; then
  echo "🧐 Verifying installed packages..."
  yarn --frozen-lockfile
fi

if [ $? -ne 0 ]; then
  echo "💥 Verification failed!"
  exit 1
fi

[[ -n $DEBUG ]] && cmd=start:dev || cmd=start:dist

if [[ -n $NO_RESTART_LOOP ]]; then
  echo "▶️ Starting plugin server..."
  trap 'kill -TERM $child 2>/dev/null; while kill -0 $child 2>/dev/null; do sleep 1; done' SIGTERM
  yarn $cmd &
  child=$!
  wait $child
else
  echo "🔁 Starting plugin server in a resiliency loop..."
  while true; do
    yarn $cmd
    echo "💥 Plugin server crashed!"
    echo "⌛️ Waiting 2 seconds before restarting..."
    sleep 2
  done
fi
