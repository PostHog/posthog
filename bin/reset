#!/bin/bash
set -e

echo "🔄 Resetting PostHog development environment..."

echo "📦 Stopping and removing Docker containers..."
docker compose -f docker-compose.dev.yml down --remove-orphans

echo "🚀 Starting Docker containers..."
docker compose -f docker-compose.dev.yml up -d

echo "⏳ Waiting for services to be ready..."
./bin/check_postgres_up
./bin/check_clickhouse_up

echo "⏳ Running migrations..."
DEBUG=1 ./bin/migrate

echo "📊 Generating demo data..."
DEBUG=1 ./manage.py generate_demo_data

echo "👤 Setting test@posthog.com as staff user..."
DEBUG=1 python manage.py shell -c "from posthog.models import User; user = User.objects.get(email='test@posthog.com'); user.is_staff = True; user.save(); print(f'✓ {user.email} is now staff')"

echo "🎌 Syncing feature flags..."
DEBUG=1 python manage.py sync_feature_flags


echo "✅ Reset complete!"
