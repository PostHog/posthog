#!/bin/bash
set -e

echo "ğŸ”„ Resetting PostHog development environment..."

echo "ğŸ“¦ Stopping and removing Docker containers..."
docker compose -f docker-compose.dev.yml down --remove-orphans

echo "ğŸš€ Starting Docker containers..."
docker compose -f docker-compose.dev.yml up -d

echo "â³ Waiting for services to be ready..."
./bin/check_postgres_up
./bin/check_clickhouse_up

echo "â³ Running migrations..."
DEBUG=1 ./bin/migrate

echo "ğŸ“Š Generating demo data..."
DEBUG=1 ./manage.py generate_demo_data

echo "ğŸ‘¤ Setting test@posthog.com as staff user..."
DEBUG=1 python manage.py shell -c "from posthog.models import User; user = User.objects.get(email='test@posthog.com'); user.is_staff = True; user.save(); print(f'âœ“ {user.email} is now staff')"

echo "ğŸŒ Syncing feature flags..."
DEBUG=1 python manage.py sync_feature_flags


echo "âœ… Reset complete!"
