#!/bin/bash

set -e

# Check if we're in a flox environment
if ! command -v flox &> /dev/null; then
    echo "Error: flox not found. This script is optimized for flox environments."
    exit 1
fi

# Store HOME path for use in flox environment
HOME_PATH="$HOME"

# Run all checks within a single flox activation using heredoc
flox activate -- bash << EOF
set -e
export HOME="$HOME_PATH"

# Check if Playwright is installed
if ! python -c "import playwright" &> /dev/null; then
    echo "Installing Playwright via pip..."
    pip install playwright
    echo "Installing Playwright browsers..."
    playwright install
    echo "Playwright installed"
else
    echo "Playwright is already installed"
    
    # Check if browsers are installed by looking for chromium
    # Determine the correct cache directory based on OS
    if [[ "\$OSTYPE" == "darwin"* ]]; then
        PLAYWRIGHT_CACHE_DIR="\$HOME/Library/Caches/ms-playwright"
    else
        PLAYWRIGHT_CACHE_DIR="\$HOME/.cache/ms-playwright"
    fi
    
    if [ ! -d "\$PLAYWRIGHT_CACHE_DIR" ] || ! find "\$PLAYWRIGHT_CACHE_DIR" -name "chrome-*" -o -name "headless_shell" -o -name "chromium-*" 2>/dev/null | grep -q .; then
        echo "Playwright browsers not found, installing..."
        playwright install
        echo "Playwright browser installation completed"
    else
        echo "Playwright browsers are already installed"
    fi
fi

# Check if FFmpeg is installed
if ! command -v ffmpeg &> /dev/null; then
    echo "FFmpeg not found in flox environment"
    exit 1
else
    echo "FFmpeg is already installed"
fi
EOF

# Handle FFmpeg installation outside flox if needed
if [ $? -eq 1 ]; then
    echo "Installing FFmpeg via flox..."
    flox install ffmpeg
fi

echo "Video dependencies check complete"
