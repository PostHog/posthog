#!/usr/bin/env bash
set -euo pipefail

# Wait until Docker Compose services pass their health checks.
# Read-only: does not start, stop, or recreate any containers.
# Used by mprocs processes to block until infrastructure is ready.
#
# Always checks core services (db, redis7, kafka, clickhouse).
# Pass extra service names as arguments, e.g.: bin/wait-for-docker temporal

COMPOSE_FILE="${COMPOSE_FILE:-docker-compose.dev.yml}"

SERVICES=(db redis7 kafka clickhouse)
SERVICES+=("$@")

for svc in "${SERVICES[@]}"; do
    while true; do
        container_id=$(docker compose -f "$COMPOSE_FILE" ps -q "$svc" 2>/dev/null || true)
        if [ -n "$container_id" ]; then
            status=$(docker inspect --format='{{.State.Health.Status}}' "$container_id" 2>/dev/null || echo "starting")
            if [ "$status" = "healthy" ]; then
                break
            fi
        fi
        echo "Waiting for $svc..."
        sleep 1
    done
done

echo "All services healthy."
