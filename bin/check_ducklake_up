#!/usr/bin/env python3

from __future__ import annotations

import time

import duckdb

from ducklake_common import (
    attach_catalog,
    configure_connection,
    get_config,
    initialize_ducklake,
    run_smoke_check,
)

HEALTHCHECK_ALIAS = "ducklake_dev_health"


def check_once(config: dict[str, str]) -> None:
    conn = duckdb.connect()
    try:
        configure_connection(conn, config, install_extension=False)
        attach_catalog(conn, config, alias=HEALTHCHECK_ALIAS)
        run_smoke_check(conn, alias=HEALTHCHECK_ALIAS)
    finally:
        conn.close()


def main() -> int:
    while True:
        config = get_config()
        try:
            check_once(config)
        except KeyboardInterrupt:
            raise
        except Exception as exc:  # noqa: BLE001 - any failure should trigger a retry
            print(f"Awaiting DuckLake warmup... ({exc})")
            try:
                initialized = initialize_ducklake(config, alias="ducklake_dev")
                if initialized:
                    print("Reinitialized DuckLake catalog, retrying health check...")
            except Exception as setup_exc:  # noqa: BLE001
                print(f"DuckLake initialization attempt failed ({setup_exc})")
            time.sleep(1)
            continue

        print("DuckLake is up!")
        return 0


if __name__ == "__main__":
    raise SystemExit(main())
