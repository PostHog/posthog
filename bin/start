#!/bin/bash

set -e

export REPOSITORY_ROOT=$(realpath "$(dirname "$0")/..")
export LOCK_FILE="$REPOSITORY_ROOT/bin/start.lock"

# Acquire exclusive lock using flock (atomic, no race condition)
exec 9>"$LOCK_FILE"
if ! flock -n 9; then
    echo "‚ö†Ô∏è  Another instance of bin/start is already running (lock file: $LOCK_FILE)"
    echo "   To skip this check, delete the lock file: rm $LOCK_FILE"
    exit 1
fi

# Source development defaults, then user overrides
set -o allexport
source "$REPOSITORY_ROOT/.env.development"
[ -f "$REPOSITORY_ROOT/.env" ] && source "$REPOSITORY_ROOT/.env"
set +o allexport

# Computed vars (need REPOSITORY_ROOT)
export DAGSTER_HOME=$REPOSITORY_ROOT/.dagster_home

# Check for minimal mode - disable OpenTelemetry for minimal mode
if [[ "$*" == *"--minimal"* ]]; then
    export OTEL_SDK_DISABLED="true"
else
    export OTEL_SDK_DISABLED="false"
    echo "üëâ Tracing enabled, see http://localhost:16686 for Jaeger UI"
fi

if [[ "$*" == *"--skip-typegen"* ]]; then
    export SKIP_TYPEGEN="1"
fi

if ! python3 - <<'PY' >/dev/null 2>&1
import duckdb  # noqa: F401
PY
then
    echo "DuckLake requires the duckdb Python package."
    echo "Run 'uv sync --active' (or activate Flox) before executing hogli start."
    exit 1
fi

# Geo files
./bin/download-mmdb

if ! command -v mprocs &>/dev/null; then
    if command -v brew &>/dev/null; then
        echo "üîÅ Installing mprocs via Homebrew..."
        brew install mprocs
    else
        echo "üëâ To run bin/start, install mprocs: https://github.com/pvolok/mprocs#installation"
        exit 1
    fi
fi

# Check for conflicting flags
if [[ "$*" == *"--custom"* ]] && ([[ "$*" == *"--minimal"* ]] || [[ "$*" == *"--vite"* ]]); then
    echo "Error: Cannot use --custom with --minimal or --vite"
    exit 1
fi

# Use custom config, if provided (e.g. bin/start --custom bin/mprocs-custom.yaml)
# Ensure to provide config path after --custom flag
if [[ "$*" == *"--custom"* ]]; then
    # Extract the path after --custom
    config_path=""
    found_custom=false
    for i in "$@"; do
        if [[ $found_custom == true ]]; then
            config_path="$i"
            break
        fi
        if [[ "$i" == "--custom" ]]; then
            found_custom=true
        fi
    done
    if [[ -z "$config_path" ]]; then
        echo "Error: --custom requires a config path"
        exit 1
    fi
    exec mprocs --config "$config_path"
    # Use minimal config
    elif [[ "$*" == *"--minimal"* ]]; then
    exec mprocs --config bin/mprocs-minimal.yaml
else
    exec mprocs --config bin/mprocs.yaml
fi
