#!/bin/bash
set -e

help () {
  echo "$0 - Start PostHog's celery worker"
  echo " "
  echo "$0 [options]"
  echo " "
  echo "Options:"
  echo "  --help, -h            show brief help"
  echo "  --with-scheduler      start RedBeat, the celery scheduler (deprecates: --with-beat)"
  echo "  --concurrency=<N>     start N workers. Can be set via WEB_CONCURRENCY env"
  echo ""
  echo "Advanced celery options (disabled by default):"
  echo "  --with-gossip         start celery gossip (useful for prometheus)"
  echo "  --with-heartbeat      start celery internal heartbeat (normally not useful)"
  echo "  --with-mingle         start celery mingle (normally not useful)"
  exit 0
}

with_scheduler=false
with_gossip=false
with_heartbeat=false
with_mingle=false

while test $# -gt 0; do
  case "$1" in
    -h|--help)
      help
      ;;
    --with-scheduler)
      with_scheduler=true
      shift
      ;;
    --with-beat) # deprecated since the name is similar to "heartbeat", use "--with-scheduler" instead
      echo "!! Using docker-worker-celery with --with-beat. This argument is deprecated. Use --with-scheduler instead!"
      with_scheduler=true
      shift
      ;;
    --with-gossip)
      with_gossip=true
      shift
      ;;
    --with-heartbeat)
      with_heartbeat=true
      shift
      ;;
    --with-mingle)
      with_mingle=true
      shift
      ;;
    --concurrency*)
      export WEB_CONCURRENCY=`echo $1 | sed -e 's/^[^=]*=//g'`
      shift
      ;;
    *)
      break
      ;;
  esac
done

if [ "$with_scheduler" == "true" ]; then
  ./bin/docker-worker-beat &
fi

FLAGS=""
[ "$with_gossip" == "false" ]    && FLAGS="$FLAGS --without-gossip"
[ "$with_mingle" == "false" ]    && FLAGS="$FLAGS --without-mingle"
[ "$with_heartbeat" == "false" ] && FLAGS="$FLAGS --without-heartbeat"

# On heroku $WEB_CONCURRENCY contains suggested nr of forks per dyno type
# https://github.com/heroku/heroku-buildpack-python/blob/main/vendor/WEB_CONCURRENCY.sh
[[ -n "${WEB_CONCURRENCY}" ]]    && FLAGS="$FLAGS --concurrency $WEB_CONCURRENCY"

celery -A posthog worker $FLAGS

# Stop the beat!
trap 'kill $(jobs -p)' EXIT
