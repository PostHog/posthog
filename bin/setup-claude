#!/bin/bash

# Only run in remote environments
if [ "$CLAUDE_CODE_REMOTE" != "true" ]; then
  exit 0
fi

# Install flox
echo "ðŸ”„ Installing flox in remote environment..."

# Detect OS and architecture
if [ -f /etc/os-release ]; then
  . /etc/os-release
  OS=$ID
else
  OS=$(uname -s)
fi

ARCH=$(uname -m)

# Install based on OS
if [ "$OS" = "ubuntu" ] || [ "$OS" = "debian" ]; then
  echo "Detected Debian/Ubuntu, installing via .deb package..."

  # Map architecture
  if [ "$ARCH" = "x86_64" ]; then
    DEB_ARCH="amd64"
  elif [ "$ARCH" = "aarch64" ]; then
    DEB_ARCH="arm64"
  else
    echo "Unsupported architecture: $ARCH"
    exit 1
  fi

  # Get latest version
  FLOX_VERSION=$(curl -s https://downloads.flox.dev/by-env/stable/LATEST_VERSION)
  echo "Latest flox version: ${FLOX_VERSION}"

  # Download and install .deb package
  FLOX_DEB="flox-${FLOX_VERSION}.${DEB_ARCH}.deb"
  wget -O "/tmp/${FLOX_DEB}" "https://downloads.flox.dev/by-env/stable/deb/${FLOX_DEB}"
  sudo dpkg -i "/tmp/${FLOX_DEB}"
  rm "/tmp/${FLOX_DEB}"
else
  # Fall back to generic installer for other systems
  echo "Skipping flox installation for non-Debian/Ubuntu systems"
  exit 0
fi

# Add flox to PATH if needed
if [ -n "$CLAUDE_ENV_FILE" ]; then
  echo 'export PATH="$HOME/.flox/bin:$PATH"' >> "$CLAUDE_ENV_FILE"
fi

echo "âœ… Flox is activated"
