import { Meta, StoryFn } from '@storybook/react'
import { router } from 'kea-router'
import { FunnelLayout } from 'lib/constants'
import { useEffect } from 'react'
import { App } from 'scenes/App'
import { urls } from 'scenes/urls'

import { mswDecorator } from '~/mocks/browser'
import { toPaginatedResponse } from '~/mocks/handlers'
import {
    CachedExperimentFunnelsQueryResponse,
    CachedExperimentTrendsQueryResponse,
    ExperimentSignificanceCode,
    NodeKind,
    ResultCustomizationBy,
} from '~/queries/schema/schema-general'
import {
    BaseMathType,
    ChartDisplayType,
    Experiment,
    FunnelConversionWindowTimeUnit,
    FunnelVizType,
    PropertyFilterType,
    PropertyMathType,
    PropertyOperator,
} from '~/types'

const EXPERIMENT: Experiment = {
    id: 66,
    name: 'storybook-experiment-2',
    description: undefined,
    start_date: '2025-01-01T13:23:00Z',
    end_date: null,
    feature_flag_key: 'storybook-experiment-2',
    feature_flag: {
        id: 162,
        team_id: 1,
        name: 'Feature Flag for Experiment storybook-experiment-2',
        key: 'storybook-experiment-2',
        filters: {
            payloads: {},
            groups: [
                {
                    properties: [],
                    rollout_percentage: 100,
                },
            ],
            multivariate: {
                variants: [
                    {
                        key: 'control',
                        rollout_percentage: 34,
                    },
                    {
                        key: 'test-1',
                        rollout_percentage: 33,
                    },
                    {
                        key: 'test-2',
                        rollout_percentage: 33,
                    },
                ],
            },
            aggregation_group_type_index: null,
        },
        deleted: false,
        active: true,
        ensure_experience_continuity: false,
    },
    holdout_id: null,
    parameters: {
        feature_flag_variants: [
            {
                key: 'control',
                rollout_percentage: 34,
            },
            {
                key: 'test-1',
                rollout_percentage: 33,
            },
            {
                key: 'test-2',
                rollout_percentage: 33,
            },
        ],
        recommended_sample_size: 0,
        recommended_running_time: 0,
        minimum_detectable_effect: 1,
    },
    secondary_metrics: [],
    saved_metrics: [],
    saved_metrics_ids: [],
    filters: {},
    archived: false,
    created_by: {
        id: 1,
        uuid: '0193314c-c2b1-0000-24a1-a38b35180d80',
        distinct_id: 'Lc1U777y6KO8OhdOLGfd4G3J8o0ZVfs88EhoBuF2sYr',
        first_name: 'Juraj',
        last_name: '',
        email: 'juraj@posthog.com',
        is_email_verified: false,
    },
    created_at: '2025-01-27T13:21:34.895340Z',
    updated_at: '2025-01-27T14:16:54.298507Z',
    type: 'product',
    metrics: [
        {
            kind: NodeKind.ExperimentFunnelsQuery,
            funnels_query: {
                kind: NodeKind.FunnelsQuery,
                series: [
                    {
                        kind: NodeKind.EventsNode,
                        name: 'signup started (c)',
                        event: 'signup started (c)',
                    },
                    {
                        kind: NodeKind.EventsNode,
                        name: 'signup completed (c)',
                        event: 'signup completed (c)',
                    },
                ],
                dateRange: {
                    date_to: '2025-01-27T23:59',
                    date_from: '2025-01-13T14:23',
                    explicitDate: true,
                },
                funnelsFilter: {
                    layout: FunnelLayout.horizontal,
                    funnelVizType: FunnelVizType.Steps,
                    funnelWindowInterval: 14,
                    funnelWindowIntervalUnit: FunnelConversionWindowTimeUnit.Day,
                },
                filterTestAccounts: false,
            },
        },
        {
            kind: NodeKind.ExperimentTrendsQuery,
            count_query: {
                kind: NodeKind.TrendsQuery,
                series: [
                    {
                        kind: NodeKind.EventsNode,
                        name: 'storybook-click',
                        event: 'storybook-click',
                    },
                ],
                interval: 'day',
                dateRange: {
                    date_to: '2025-01-27T23:59',
                    date_from: '2025-01-13T14:31',
                    explicitDate: true,
                },
                trendsFilter: {
                    display: ChartDisplayType.ActionsLineGraph,
                },
                filterTestAccounts: false,
            },
        },
        {
            kind: NodeKind.ExperimentTrendsQuery,
            count_query: {
                kind: NodeKind.TrendsQuery,
                series: [
                    {
                        kind: NodeKind.EventsNode,
                        math: PropertyMathType.Sum,
                        name: 'revenue (b)',
                        event: 'revenue (b)',
                        math_property: 'revenue',
                        math_property_type: 'numerical_event_properties',
                    },
                ],
                interval: 'day',
                dateRange: {
                    date_to: '2025-01-27T23:59',
                    date_from: '2025-01-13T14:45',
                    explicitDate: true,
                },
                trendsFilter: {
                    display: ChartDisplayType.ActionsLineGraph,
                },
                filterTestAccounts: false,
            },
        },
    ],
    metrics_secondary: [
        {
            kind: NodeKind.ExperimentTrendsQuery,
            count_query: {
                kind: NodeKind.TrendsQuery,
                series: [
                    {
                        kind: NodeKind.EventsNode,
                        name: 'storybook-click',
                        event: 'storybook-click',
                    },
                ],
                interval: 'day',
                dateRange: {
                    date_to: '2025-01-27T23:59',
                    date_from: '2025-01-13T15:15',
                    explicitDate: true,
                },
                trendsFilter: {
                    display: ChartDisplayType.ActionsLineGraph,
                },
                filterTestAccounts: false,
            },
        },
        {
            kind: NodeKind.ExperimentTrendsQuery,
            count_query: {
                kind: NodeKind.TrendsQuery,
                series: [
                    {
                        kind: NodeKind.EventsNode,
                        math: PropertyMathType.Sum,
                        name: 'revenue (b)',
                        event: 'revenue (b)',
                        math_property: 'revenue',
                        math_property_type: 'numerical_event_properties',
                    },
                ],
                interval: 'day',
                dateRange: {
                    date_to: '2025-01-27T23:59',
                    date_from: '2025-01-13T15:16',
                    explicitDate: true,
                },
                trendsFilter: {
                    display: ChartDisplayType.ActionsLineGraph,
                },
                filterTestAccounts: false,
            },
        },
        {
            kind: NodeKind.ExperimentFunnelsQuery,
            funnels_query: {
                kind: NodeKind.FunnelsQuery,
                series: [
                    {
                        kind: NodeKind.EventsNode,
                        name: 'signup started (c)',
                        event: 'signup started (c)',
                    },
                    {
                        kind: NodeKind.EventsNode,
                        name: 'signup completed (c)',
                        event: 'signup completed (c)',
                    },
                ],
                dateRange: {
                    date_to: '2025-01-27T23:59',
                    date_from: '2025-01-13T15:16',
                    explicitDate: true,
                },
                funnelsFilter: {
                    layout: FunnelLayout.horizontal,
                    funnelVizType: FunnelVizType.Steps,
                    funnelWindowInterval: 14,
                    funnelWindowIntervalUnit: FunnelConversionWindowTimeUnit.Day,
                },
                filterTestAccounts: false,
            },
        },
    ],
    stats_config: {
        version: 2,
    },
}

const METRIC_FUNNEL_RESULT: CachedExperimentFunnelsQueryResponse = {
    cache_key: 'cache_1d8090f35d1903264578dcaa3dae2c54',
    cache_target_age: '2025-01-28T13:48:36.289035Z',
    credible_intervals: {
        control: [0.25166557038539855, 0.30679547743950764],
        'test-1': [0.2142216437089944, 0.26691396191516575],
        'test-2': [0.2698848451234281, 0.3270277148414675],
    },
    expected_loss: 1.0,
    funnels_query: {
        kind: NodeKind.FunnelsQuery,
        aggregation_group_type_index: null,
        breakdownFilter: {
            breakdown: '$feature/storybook-experiment-2',
            breakdown_group_type_index: null,
            breakdown_hide_other_aggregation: null,
            breakdown_type: 'event',
        },
        dataColorTheme: null,
        dateRange: {
            date_from: '2025-01-01T13:23:00+00:00',
            date_to: null,
            explicitDate: true,
        },
        filterTestAccounts: false,
        funnelsFilter: {
            exclusions: [],
            funnelWindowInterval: 14,
        },
        properties: [],
        samplingFactor: null,
        series: [
            {
                event: 'signup started (c)',
                kind: NodeKind.EventsNode,
                name: 'signup started (c)',
            },
            {
                event: 'signup completed (c)',
                kind: NodeKind.EventsNode,
                name: 'signup completed (c)',
            },
        ],
    },
    insight: [
        [
            {
                action_id: 'signup started (c)',
                name: 'signup started (c)',
                custom_name: null,
                order: 0,
                people: [],
                count: 1006,
                type: 'events',
                average_conversion_time: null,
                median_conversion_time: null,
                breakdown: ['test-1'],
                breakdown_value: ['test-1'],
            },
            {
                action_id: 'signup completed (c)',
                name: 'signup completed (c)',
                custom_name: null,
                order: 1,
                people: [],
                count: 241,
                type: 'events',
                average_conversion_time: null,
                median_conversion_time: null,
                breakdown: ['test-1'],
                breakdown_value: ['test-1'],
            },
        ],
        [
            {
                action_id: 'signup started (c)',
                name: 'signup started (c)',
                custom_name: null,
                order: 0,
                people: [],
                count: 981,
                type: 'events',
                average_conversion_time: null,
                median_conversion_time: null,
                breakdown: ['test-2'],
                breakdown_value: ['test-2'],
            },
            {
                action_id: 'signup completed (c)',
                name: 'signup completed (c)',
                custom_name: null,
                order: 1,
                people: [],
                count: 292,
                type: 'events',
                average_conversion_time: null,
                median_conversion_time: null,
                breakdown: ['test-2'],
                breakdown_value: ['test-2'],
            },
        ],
        [
            {
                action_id: 'signup started (c)',
                name: 'signup started (c)',
                custom_name: null,
                order: 0,
                people: [],
                count: 1013,
                type: 'events',
                average_conversion_time: null,
                median_conversion_time: null,
                breakdown: ['control'],
                breakdown_value: ['control'],
            },
            {
                action_id: 'signup completed (c)',
                name: 'signup completed (c)',
                custom_name: null,
                order: 1,
                people: [],
                count: 282,
                type: 'events',
                average_conversion_time: null,
                median_conversion_time: null,
                breakdown: ['control'],
                breakdown_value: ['control'],
            },
        ],
    ],
    is_cached: true,
    kind: NodeKind.ExperimentFunnelsQuery,
    last_refresh: '2025-01-27T13:48:36.289035Z',
    next_allowed_client_refresh: '2025-01-27T13:49:36.289035Z',
    probability: {
        control: 0.1678,
        'test-1': 0.0007,
        'test-2': 0.8315,
    },
    significance_code: ExperimentSignificanceCode.LowWinProbability,
    significant: false,
    stats_version: 2,
    timezone: 'UTC',
    variants: [
        {
            failure_count: 731.0,
            key: 'control',
            success_count: 282.0,
        },
        {
            failure_count: 765.0,
            key: 'test-1',
            success_count: 241.0,
        },
        {
            failure_count: 689.0,
            key: 'test-2',
            success_count: 292.0,
        },
    ],
}

const METRIC_TREND_RESULT: CachedExperimentTrendsQueryResponse = {
    cache_key: 'cache_070ac1966021e76ddc77054a1400be51',
    cache_target_age: '2025-01-28T13:46:38.714809Z',
    count_query: {
        aggregation_group_type_index: null,
        breakdownFilter: {
            breakdown: '$feature/storybook-experiment-2',
            breakdown_group_type_index: null,
            breakdown_hide_other_aggregation: null,
            breakdown_type: 'event',
        },
        conversionGoal: null,
        dataColorTheme: null,
        dateRange: {
            date_from: '2025-01-01T13:23:00+00:00',
            date_to: null,
            explicitDate: true,
        },
        filterTestAccounts: false,
        interval: 'day',
        kind: NodeKind.TrendsQuery,
        properties: [
            {
                key: '$feature/storybook-experiment-2',
                operator: PropertyOperator.Exact,
                type: PropertyFilterType.Event,
                value: ['control', 'test-1', 'test-2'],
            },
        ],
        samplingFactor: null,
        series: [
            {
                event: 'storybook-click',
                kind: NodeKind.EventsNode,
                name: 'storybook-click',
            },
        ],
        trendsFilter: {
            aggregationAxisFormat: 'numeric',
            display: ChartDisplayType.ActionsLineGraphCumulative,
            showAlertThresholdLines: false,
            showLegend: false,
            showPercentStackView: false,
            showValuesOnSeries: false,
            smoothingIntervals: 1,
            yAxisScaleType: 'linear',
        },
    },
    credible_intervals: {
        control: [0.2561766232672143, 0.2865558079632093],
        'test-2': [0.37437057436784366, 0.41095555855761073],
        'test-1': [0.32628499711265635, 0.36057812005091006],
    },
    exposure_query: {
        aggregation_group_type_index: null,
        breakdownFilter: {
            breakdown: '$feature_flag_response',
            breakdown_group_type_index: null,
            breakdown_hide_other_aggregation: null,
            breakdown_type: PropertyFilterType.Event,
        },
        conversionGoal: null,
        dataColorTheme: null,
        dateRange: {
            date_from: '2025-01-01T13:23:00+00:00',
            date_to: null,
            explicitDate: true,
        },
        filterTestAccounts: false,
        interval: 'day',
        kind: NodeKind.TrendsQuery,
        properties: [
            {
                key: '$feature_flag_response',
                operator: PropertyOperator.Exact,
                type: PropertyFilterType.Event,
                value: ['control', 'test-1', 'test-2'],
            },
            {
                key: '$feature_flag',
                operator: PropertyOperator.Exact,
                type: PropertyFilterType.Event,
                value: ['storybook-experiment-2'],
            },
        ],
        samplingFactor: null,
        series: [
            {
                event: '$feature_flag_called',
                kind: NodeKind.EventsNode,
                math: BaseMathType.UniqueUsers,
            },
        ],
        trendsFilter: {
            aggregationAxisFormat: 'numeric',
            display: ChartDisplayType.ActionsLineGraphCumulative,
            formula: undefined,
            goalLines: undefined,
            hiddenLegendIndexes: undefined,
            resultCustomizationBy: ResultCustomizationBy.Value,
            showAlertThresholdLines: false,
            showLegend: false,
            showPercentStackView: false,
            showValuesOnSeries: false,
            smoothingIntervals: 1,
            yAxisScaleType: 'linear',
        },
    },
    insight: [
        {
            data: [
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 98.0,
                378.0, 644.0, 863.0, 1118.0, 1383.0, 1636.0, 1767.0,
            ],
            labels: [
                '1-Jan-2025',
                '2-Jan-2025',
                '3-Jan-2025',
                '4-Jan-2025',
                '5-Jan-2025',
                '6-Jan-2025',
                '7-Jan-2025',
                '8-Jan-2025',
                '9-Jan-2025',
                '10-Jan-2025',
                '11-Jan-2025',
                '12-Jan-2025',
                '13-Jan-2025',
                '14-Jan-2025',
                '15-Jan-2025',
                '16-Jan-2025',
                '17-Jan-2025',
                '18-Jan-2025',
                '19-Jan-2025',
                '20-Jan-2025',
                '21-Jan-2025',
                '22-Jan-2025',
                '23-Jan-2025',
                '24-Jan-2025',
                '25-Jan-2025',
                '26-Jan-2025',
                '27-Jan-2025',
            ],
            days: [
                '2025-01-01',
                '2025-01-02',
                '2025-01-03',
                '2025-01-04',
                '2025-01-05',
                '2025-01-06',
                '2025-01-07',
                '2025-01-08',
                '2025-01-09',
                '2025-01-10',
                '2025-01-11',
                '2025-01-12',
                '2025-01-13',
                '2025-01-14',
                '2025-01-15',
                '2025-01-16',
                '2025-01-17',
                '2025-01-18',
                '2025-01-19',
                '2025-01-20',
                '2025-01-21',
                '2025-01-22',
                '2025-01-23',
                '2025-01-24',
                '2025-01-25',
                '2025-01-26',
                '2025-01-27',
            ],
            count: 1767.0,
            label: 'test-2',
            filter: {
                insight: 'TRENDS',
                properties: [
                    {
                        key: '$feature/storybook-experiment-2',
                        label: null,
                        operator: 'exact',
                        type: 'event',
                        value: ['control', 'test-1', 'test-2'],
                    },
                ],
                filter_test_accounts: false,
                date_to: '2025-01-27T13:46:39.649328Z',
                date_from: '2025-01-01T13:23:00Z',
                entity_type: 'events',
                interval: 'day',
                aggregationAxisFormat: 'numeric',
                display: 'ActionsLineGraphCumulative',
                resultCustomizationBy: 'value',
                showAlertThresholdLines: false,
                showLegend: false,
                showPercentStackView: false,
                showValuesOnSeries: false,
                smoothingIntervals: 1,
                yAxisScaleType: 'linear',
                breakdown: '$feature/storybook-experiment-2',
                breakdown_type: 'event',
            },
            action: {
                days: [
                    '2025-01-01T00:00:00Z',
                    '2025-01-02T00:00:00Z',
                    '2025-01-03T00:00:00Z',
                    '2025-01-04T00:00:00Z',
                    '2025-01-05T00:00:00Z',
                    '2025-01-06T00:00:00Z',
                    '2025-01-07T00:00:00Z',
                    '2025-01-08T00:00:00Z',
                    '2025-01-09T00:00:00Z',
                    '2025-01-10T00:00:00Z',
                    '2025-01-11T00:00:00Z',
                    '2025-01-12T00:00:00Z',
                    '2025-01-13T00:00:00Z',
                    '2025-01-14T00:00:00Z',
                    '2025-01-15T00:00:00Z',
                    '2025-01-16T00:00:00Z',
                    '2025-01-17T00:00:00Z',
                    '2025-01-18T00:00:00Z',
                    '2025-01-19T00:00:00Z',
                    '2025-01-20T00:00:00Z',
                    '2025-01-21T00:00:00Z',
                    '2025-01-22T00:00:00Z',
                    '2025-01-23T00:00:00Z',
                    '2025-01-24T00:00:00Z',
                    '2025-01-25T00:00:00Z',
                    '2025-01-26T00:00:00Z',
                    '2025-01-27T00:00:00Z',
                ],
                id: 'storybook-click',
                type: 'events',
                order: 0,
                name: 'storybook-click',
                custom_name: null,
                math: 'total',
                math_property: null,
                math_hogql: null,
                math_group_type_index: null,
                properties: {},
            },
            breakdown_value: 'test-2',
        },
        {
            data: [
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 80.0,
                295.0, 516.0, 788.0, 1011.0, 1222.0, 1414.0, 1538.0,
            ],
            labels: [
                '1-Jan-2025',
                '2-Jan-2025',
                '3-Jan-2025',
                '4-Jan-2025',
                '5-Jan-2025',
                '6-Jan-2025',
                '7-Jan-2025',
                '8-Jan-2025',
                '9-Jan-2025',
                '10-Jan-2025',
                '11-Jan-2025',
                '12-Jan-2025',
                '13-Jan-2025',
                '14-Jan-2025',
                '15-Jan-2025',
                '16-Jan-2025',
                '17-Jan-2025',
                '18-Jan-2025',
                '19-Jan-2025',
                '20-Jan-2025',
                '21-Jan-2025',
                '22-Jan-2025',
                '23-Jan-2025',
                '24-Jan-2025',
                '25-Jan-2025',
                '26-Jan-2025',
                '27-Jan-2025',
            ],
            days: [
                '2025-01-01',
                '2025-01-02',
                '2025-01-03',
                '2025-01-04',
                '2025-01-05',
                '2025-01-06',
                '2025-01-07',
                '2025-01-08',
                '2025-01-09',
                '2025-01-10',
                '2025-01-11',
                '2025-01-12',
                '2025-01-13',
                '2025-01-14',
                '2025-01-15',
                '2025-01-16',
                '2025-01-17',
                '2025-01-18',
                '2025-01-19',
                '2025-01-20',
                '2025-01-21',
                '2025-01-22',
                '2025-01-23',
                '2025-01-24',
                '2025-01-25',
                '2025-01-26',
                '2025-01-27',
            ],
            count: 1538.0,
            label: 'test-1',
            filter: {
                insight: 'TRENDS',
                properties: [
                    {
                        key: '$feature/storybook-experiment-2',
                        label: null,
                        operator: 'exact',
                        type: 'event',
                        value: ['control', 'test-1', 'test-2'],
                    },
                ],
                filter_test_accounts: false,
                date_to: '2025-01-27T13:46:39.653630Z',
                date_from: '2025-01-01T13:23:00Z',
                entity_type: 'events',
                interval: 'day',
                aggregationAxisFormat: 'numeric',
                display: 'ActionsLineGraphCumulative',
                resultCustomizationBy: 'value',
                showAlertThresholdLines: false,
                showLegend: false,
                showPercentStackView: false,
                showValuesOnSeries: false,
                smoothingIntervals: 1,
                yAxisScaleType: 'linear',
                breakdown: '$feature/storybook-experiment-2',
                breakdown_type: 'event',
            },
            action: {
                days: [
                    '2025-01-01T00:00:00Z',
                    '2025-01-02T00:00:00Z',
                    '2025-01-03T00:00:00Z',
                    '2025-01-04T00:00:00Z',
                    '2025-01-05T00:00:00Z',
                    '2025-01-06T00:00:00Z',
                    '2025-01-07T00:00:00Z',
                    '2025-01-08T00:00:00Z',
                    '2025-01-09T00:00:00Z',
                    '2025-01-10T00:00:00Z',
                    '2025-01-11T00:00:00Z',
                    '2025-01-12T00:00:00Z',
                    '2025-01-13T00:00:00Z',
                    '2025-01-14T00:00:00Z',
                    '2025-01-15T00:00:00Z',
                    '2025-01-16T00:00:00Z',
                    '2025-01-17T00:00:00Z',
                    '2025-01-18T00:00:00Z',
                    '2025-01-19T00:00:00Z',
                    '2025-01-20T00:00:00Z',
                    '2025-01-21T00:00:00Z',
                    '2025-01-22T00:00:00Z',
                    '2025-01-23T00:00:00Z',
                    '2025-01-24T00:00:00Z',
                    '2025-01-25T00:00:00Z',
                    '2025-01-26T00:00:00Z',
                    '2025-01-27T00:00:00Z',
                ],
                id: 'storybook-click',
                type: 'events',
                order: 0,
                name: 'storybook-click',
                custom_name: null,
                math: 'total',
                math_property: null,
                math_hogql: null,
                math_group_type_index: null,
                properties: {},
            },
            breakdown_value: 'test-1',
        },
        {
            data: [
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 73.0,
                231.0, 420.0, 615.0, 781.0, 941.0, 1135.0, 1223.0,
            ],
            labels: [
                '1-Jan-2025',
                '2-Jan-2025',
                '3-Jan-2025',
                '4-Jan-2025',
                '5-Jan-2025',
                '6-Jan-2025',
                '7-Jan-2025',
                '8-Jan-2025',
                '9-Jan-2025',
                '10-Jan-2025',
                '11-Jan-2025',
                '12-Jan-2025',
                '13-Jan-2025',
                '14-Jan-2025',
                '15-Jan-2025',
                '16-Jan-2025',
                '17-Jan-2025',
                '18-Jan-2025',
                '19-Jan-2025',
                '20-Jan-2025',
                '21-Jan-2025',
                '22-Jan-2025',
                '23-Jan-2025',
                '24-Jan-2025',
                '25-Jan-2025',
                '26-Jan-2025',
                '27-Jan-2025',
            ],
            days: [
                '2025-01-01',
                '2025-01-02',
                '2025-01-03',
                '2025-01-04',
                '2025-01-05',
                '2025-01-06',
                '2025-01-07',
                '2025-01-08',
                '2025-01-09',
                '2025-01-10',
                '2025-01-11',
                '2025-01-12',
                '2025-01-13',
                '2025-01-14',
                '2025-01-15',
                '2025-01-16',
                '2025-01-17',
                '2025-01-18',
                '2025-01-19',
                '2025-01-20',
                '2025-01-21',
                '2025-01-22',
                '2025-01-23',
                '2025-01-24',
                '2025-01-25',
                '2025-01-26',
                '2025-01-27',
            ],
            count: 1223.0,
            label: 'control',
            filter: {
                insight: 'TRENDS',
                properties: [
                    {
                        key: '$feature/storybook-experiment-2',
                        label: null,
                        operator: 'exact',
                        type: 'event',
                        value: ['control', 'test-1', 'test-2'],
                    },
                ],
                filter_test_accounts: false,
                date_to: '2025-01-27T13:46:39.656219Z',
                date_from: '2025-01-01T13:23:00Z',
                entity_type: 'events',
                interval: 'day',
                aggregationAxisFormat: 'numeric',
                display: 'ActionsLineGraphCumulative',
                resultCustomizationBy: 'value',
                showAlertThresholdLines: false,
                showLegend: false,
                showPercentStackView: false,
                showValuesOnSeries: false,
                smoothingIntervals: 1,
                yAxisScaleType: 'linear',
                breakdown: '$feature/storybook-experiment-2',
                breakdown_type: 'event',
            },
            action: {
                days: [
                    '2025-01-01T00:00:00Z',
                    '2025-01-02T00:00:00Z',
                    '2025-01-03T00:00:00Z',
                    '2025-01-04T00:00:00Z',
                    '2025-01-05T00:00:00Z',
                    '2025-01-06T00:00:00Z',
                    '2025-01-07T00:00:00Z',
                    '2025-01-08T00:00:00Z',
                    '2025-01-09T00:00:00Z',
                    '2025-01-10T00:00:00Z',
                    '2025-01-11T00:00:00Z',
                    '2025-01-12T00:00:00Z',
                    '2025-01-13T00:00:00Z',
                    '2025-01-14T00:00:00Z',
                    '2025-01-15T00:00:00Z',
                    '2025-01-16T00:00:00Z',
                    '2025-01-17T00:00:00Z',
                    '2025-01-18T00:00:00Z',
                    '2025-01-19T00:00:00Z',
                    '2025-01-20T00:00:00Z',
                    '2025-01-21T00:00:00Z',
                    '2025-01-22T00:00:00Z',
                    '2025-01-23T00:00:00Z',
                    '2025-01-24T00:00:00Z',
                    '2025-01-25T00:00:00Z',
                    '2025-01-26T00:00:00Z',
                    '2025-01-27T00:00:00Z',
                ],
                id: 'storybook-click',
                type: 'events',
                order: 0,
                name: 'storybook-click',
                custom_name: null,
                math: 'total',
                math_property: null,
                math_hogql: null,
                math_group_type_index: null,
                properties: {},
            },
            breakdown_value: 'control',
        },
    ],
    is_cached: true,
    kind: NodeKind.ExperimentTrendsQuery,
    last_refresh: '2025-01-27T13:46:38.714809Z',
    next_allowed_client_refresh: '2025-01-27T13:47:38.714809Z',
    p_value: 0.0,
    probability: {
        control: 0.0,
        'test-2': 0.9997,
        'test-1': 0.0003,
    },
    query_status: undefined,
    significance_code: ExperimentSignificanceCode.Significant,
    significant: true,
    stats_version: 2,
    timezone: 'UTC',
    variants: [
        {
            absolute_exposure: 4513.0,
            count: 1223.0,
            exposure: 1.0,
            key: 'control',
        },
        {
            absolute_exposure: 4504.0,
            count: 1767.0,
            exposure: 0.9980057611345003,
            key: 'test-2',
        },
        {
            absolute_exposure: 4483.0,
            count: 1538.0,
            exposure: 0.9933525371150012,
            key: 'test-1',
        },
    ],
}

const METRIC_TREND_CONTINUOUS_RESULT: any = {
    cache_key: 'cache_a50f0cfd80d3087d222a391676e93250',
    cache_target_age: '2025-01-28T14:06:12.792473Z',
    calculation_trigger: null,
    count_query: {
        aggregation_group_type_index: null,
        breakdownFilter: {
            breakdown: '$feature/storybook-experiment-2',
            breakdown_group_type_index: null,
            breakdown_hide_other_aggregation: null,
            breakdown_histogram_bin_count: null,
            breakdown_limit: null,
            breakdown_normalize_url: null,
            breakdown_type: 'event',
            breakdowns: null,
        },
        compareFilter: null,
        conversionGoal: null,
        dataColorTheme: null,
        dateRange: {
            date_from: '2025-01-01T13:23:00+00:00',
            date_to: null,
            explicitDate: true,
        },
        filterTestAccounts: false,
        interval: 'day',
        kind: 'TrendsQuery',
        modifiers: null,
        properties: [
            {
                key: '$feature/storybook-experiment-2',
                label: null,
                operator: 'exact',
                type: 'event',
                value: ['control', 'test-1', 'test-2'],
            },
        ],
        response: null,
        samplingFactor: null,
        series: [
            {
                custom_name: null,
                event: 'revenue (b)',
                fixedProperties: null,
                kind: 'EventsNode',
                limit: null,
                math: 'sum',
                math_group_type_index: null,
                math_hogql: null,
                math_property: 'revenue',
                math_property_type: 'numerical_event_properties',
                name: 'revenue (b)',
                orderBy: null,
                properties: null,
                response: null,
            },
        ],
        trendsFilter: {
            aggregationAxisFormat: 'numeric',
            aggregationAxisPostfix: null,
            aggregationAxisPrefix: null,
            breakdown_histogram_bin_count: null,
            decimalPlaces: null,
            display: 'ActionsLineGraphCumulative',
            formula: null,
            goalLines: null,
            hiddenLegendIndexes: null,
            resultCustomizationBy: 'value',
            resultCustomizations: null,
            showAlertThresholdLines: false,
            showLabelsOnSeries: null,
            showLegend: false,
            showPercentStackView: false,
            showValuesOnSeries: false,
            smoothingIntervals: 1,
            yAxisScaleType: 'linear',
        },
    },
    credible_intervals: {
        control: [30.118933739310194, 31.53033438412298],
        'test-2': [33.2125296241558, 34.762276389660954],
        'test-1': [29.12915590179745, 30.49890061154787],
    },
    exposure_query: {
        aggregation_group_type_index: null,
        breakdownFilter: {
            breakdown: '$feature_flag_response',
            breakdown_group_type_index: null,
            breakdown_hide_other_aggregation: null,
            breakdown_histogram_bin_count: null,
            breakdown_limit: null,
            breakdown_normalize_url: null,
            breakdown_type: 'event',
            breakdowns: null,
        },
        compareFilter: null,
        conversionGoal: null,
        dataColorTheme: null,
        dateRange: {
            date_from: '2025-01-01T13:23:00+00:00',
            date_to: null,
            explicitDate: true,
        },
        filterTestAccounts: false,
        interval: 'day',
        kind: 'TrendsQuery',
        modifiers: null,
        properties: [
            {
                key: '$feature_flag_response',
                label: null,
                operator: 'exact',
                type: 'event',
                value: ['control', 'test-1', 'test-2'],
            },
            {
                key: '$feature_flag',
                label: null,
                operator: 'exact',
                type: 'event',
                value: ['storybook-experiment-2'],
            },
        ],
        response: null,
        samplingFactor: null,
        series: [
            {
                custom_name: null,
                event: '$feature_flag_called',
                fixedProperties: null,
                kind: 'EventsNode',
                limit: null,
                math: 'dau',
                math_group_type_index: null,
                math_hogql: null,
                math_property: null,
                math_property_type: null,
                name: null,
                orderBy: null,
                properties: null,
                response: null,
            },
        ],
        trendsFilter: {
            aggregationAxisFormat: 'numeric',
            aggregationAxisPostfix: null,
            aggregationAxisPrefix: null,
            breakdown_histogram_bin_count: null,
            decimalPlaces: null,
            display: 'ActionsLineGraphCumulative',
            formula: null,
            goalLines: null,
            hiddenLegendIndexes: null,
            resultCustomizationBy: 'value',
            resultCustomizations: null,
            showAlertThresholdLines: false,
            showLabelsOnSeries: null,
            showLegend: false,
            showPercentStackView: false,
            showValuesOnSeries: false,
            smoothingIntervals: 1,
            yAxisScaleType: 'linear',
        },
    },
    insight: [
        {
            data: [
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                11930.856445244448, 38294.94402760637, 67502.81795286323, 95745.74396796973, 124076.91319507855,
                148325.7136489934, 176350.48733632133, 188463.04395650665,
            ],
            labels: [
                '1-Jan-2025',
                '2-Jan-2025',
                '3-Jan-2025',
                '4-Jan-2025',
                '5-Jan-2025',
                '6-Jan-2025',
                '7-Jan-2025',
                '8-Jan-2025',
                '9-Jan-2025',
                '10-Jan-2025',
                '11-Jan-2025',
                '12-Jan-2025',
                '13-Jan-2025',
                '14-Jan-2025',
                '15-Jan-2025',
                '16-Jan-2025',
                '17-Jan-2025',
                '18-Jan-2025',
                '19-Jan-2025',
                '20-Jan-2025',
                '21-Jan-2025',
                '22-Jan-2025',
                '23-Jan-2025',
                '24-Jan-2025',
                '25-Jan-2025',
                '26-Jan-2025',
                '27-Jan-2025',
            ],
            days: [
                '2025-01-01',
                '2025-01-02',
                '2025-01-03',
                '2025-01-04',
                '2025-01-05',
                '2025-01-06',
                '2025-01-07',
                '2025-01-08',
                '2025-01-09',
                '2025-01-10',
                '2025-01-11',
                '2025-01-12',
                '2025-01-13',
                '2025-01-14',
                '2025-01-15',
                '2025-01-16',
                '2025-01-17',
                '2025-01-18',
                '2025-01-19',
                '2025-01-20',
                '2025-01-21',
                '2025-01-22',
                '2025-01-23',
                '2025-01-24',
                '2025-01-25',
                '2025-01-26',
                '2025-01-27',
            ],
            count: 188463.04395650665,
            label: 'test-2',
            filter: {
                insight: 'TRENDS',
                properties: [
                    {
                        key: '$feature/storybook-experiment-2',
                        label: null,
                        operator: 'exact',
                        type: 'event',
                        value: ['control', 'test-1', 'test-2'],
                    },
                ],
                filter_test_accounts: false,
                date_to: '2025-01-27T14:06:13.147881Z',
                date_from: '2025-01-01T13:23:00Z',
                entity_type: 'events',
                interval: 'day',
                aggregationAxisFormat: 'numeric',
                display: 'ActionsLineGraphCumulative',
                resultCustomizationBy: 'value',
                showAlertThresholdLines: false,
                showLegend: false,
                showPercentStackView: false,
                showValuesOnSeries: false,
                smoothingIntervals: 1,
                yAxisScaleType: 'linear',
                breakdown: '$feature/storybook-experiment-2',
                breakdown_type: 'event',
            },
            action: {
                days: [
                    '2025-01-01T00:00:00Z',
                    '2025-01-02T00:00:00Z',
                    '2025-01-03T00:00:00Z',
                    '2025-01-04T00:00:00Z',
                    '2025-01-05T00:00:00Z',
                    '2025-01-06T00:00:00Z',
                    '2025-01-07T00:00:00Z',
                    '2025-01-08T00:00:00Z',
                    '2025-01-09T00:00:00Z',
                    '2025-01-10T00:00:00Z',
                    '2025-01-11T00:00:00Z',
                    '2025-01-12T00:00:00Z',
                    '2025-01-13T00:00:00Z',
                    '2025-01-14T00:00:00Z',
                    '2025-01-15T00:00:00Z',
                    '2025-01-16T00:00:00Z',
                    '2025-01-17T00:00:00Z',
                    '2025-01-18T00:00:00Z',
                    '2025-01-19T00:00:00Z',
                    '2025-01-20T00:00:00Z',
                    '2025-01-21T00:00:00Z',
                    '2025-01-22T00:00:00Z',
                    '2025-01-23T00:00:00Z',
                    '2025-01-24T00:00:00Z',
                    '2025-01-25T00:00:00Z',
                    '2025-01-26T00:00:00Z',
                    '2025-01-27T00:00:00Z',
                ],
                id: 'revenue (b)',
                type: 'events',
                order: 0,
                name: 'revenue (b)',
                custom_name: null,
                math: 'sum',
                math_property: 'revenue',
                math_hogql: null,
                math_group_type_index: null,
                properties: {},
            },
            breakdown_value: 'test-2',
        },
        {
            data: [
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                11119.991054024245, 35641.56760948009, 60184.64472390164, 83212.39692206128, 106983.34326352701,
                128745.70495919144, 154840.98586436044, 169504.27564590378,
            ],
            labels: [
                '1-Jan-2025',
                '2-Jan-2025',
                '3-Jan-2025',
                '4-Jan-2025',
                '5-Jan-2025',
                '6-Jan-2025',
                '7-Jan-2025',
                '8-Jan-2025',
                '9-Jan-2025',
                '10-Jan-2025',
                '11-Jan-2025',
                '12-Jan-2025',
                '13-Jan-2025',
                '14-Jan-2025',
                '15-Jan-2025',
                '16-Jan-2025',
                '17-Jan-2025',
                '18-Jan-2025',
                '19-Jan-2025',
                '20-Jan-2025',
                '21-Jan-2025',
                '22-Jan-2025',
                '23-Jan-2025',
                '24-Jan-2025',
                '25-Jan-2025',
                '26-Jan-2025',
                '27-Jan-2025',
            ],
            days: [
                '2025-01-01',
                '2025-01-02',
                '2025-01-03',
                '2025-01-04',
                '2025-01-05',
                '2025-01-06',
                '2025-01-07',
                '2025-01-08',
                '2025-01-09',
                '2025-01-10',
                '2025-01-11',
                '2025-01-12',
                '2025-01-13',
                '2025-01-14',
                '2025-01-15',
                '2025-01-16',
                '2025-01-17',
                '2025-01-18',
                '2025-01-19',
                '2025-01-20',
                '2025-01-21',
                '2025-01-22',
                '2025-01-23',
                '2025-01-24',
                '2025-01-25',
                '2025-01-26',
                '2025-01-27',
            ],
            count: 169504.27564590378,
            label: 'control',
            filter: {
                insight: 'TRENDS',
                properties: [
                    {
                        key: '$feature/storybook-experiment-2',
                        label: null,
                        operator: 'exact',
                        type: 'event',
                        value: ['control', 'test-1', 'test-2'],
                    },
                ],
                filter_test_accounts: false,
                date_to: '2025-01-27T14:06:13.147881Z',
                date_from: '2025-01-01T13:23:00Z',
                entity_type: 'events',
                interval: 'day',
                aggregationAxisFormat: 'numeric',
                display: 'ActionsLineGraphCumulative',
                resultCustomizationBy: 'value',
                showAlertThresholdLines: false,
                showLegend: false,
                showPercentStackView: false,
                showValuesOnSeries: false,
                smoothingIntervals: 1,
                yAxisScaleType: 'linear',
                breakdown: '$feature/storybook-experiment-2',
                breakdown_type: 'event',
            },
            action: {
                days: [
                    '2025-01-01T00:00:00Z',
                    '2025-01-02T00:00:00Z',
                    '2025-01-03T00:00:00Z',
                    '2025-01-04T00:00:00Z',
                    '2025-01-05T00:00:00Z',
                    '2025-01-06T00:00:00Z',
                    '2025-01-07T00:00:00Z',
                    '2025-01-08T00:00:00Z',
                    '2025-01-09T00:00:00Z',
                    '2025-01-10T00:00:00Z',
                    '2025-01-11T00:00:00Z',
                    '2025-01-12T00:00:00Z',
                    '2025-01-13T00:00:00Z',
                    '2025-01-14T00:00:00Z',
                    '2025-01-15T00:00:00Z',
                    '2025-01-16T00:00:00Z',
                    '2025-01-17T00:00:00Z',
                    '2025-01-18T00:00:00Z',
                    '2025-01-19T00:00:00Z',
                    '2025-01-20T00:00:00Z',
                    '2025-01-21T00:00:00Z',
                    '2025-01-22T00:00:00Z',
                    '2025-01-23T00:00:00Z',
                    '2025-01-24T00:00:00Z',
                    '2025-01-25T00:00:00Z',
                    '2025-01-26T00:00:00Z',
                    '2025-01-27T00:00:00Z',
                ],
                id: 'revenue (b)',
                type: 'events',
                order: 0,
                name: 'revenue (b)',
                custom_name: null,
                math: 'sum',
                math_property: 'revenue',
                math_hogql: null,
                math_group_type_index: null,
                properties: {},
            },
            breakdown_value: 'control',
        },
        {
            data: [
                0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                9992.312758840642, 36335.12542709788, 61039.1503692517, 84814.0140311638, 110709.24573233203,
                131823.41693462967, 150284.80862299612, 162842.85368923214,
            ],
            labels: [
                '1-Jan-2025',
                '2-Jan-2025',
                '3-Jan-2025',
                '4-Jan-2025',
                '5-Jan-2025',
                '6-Jan-2025',
                '7-Jan-2025',
                '8-Jan-2025',
                '9-Jan-2025',
                '10-Jan-2025',
                '11-Jan-2025',
                '12-Jan-2025',
                '13-Jan-2025',
                '14-Jan-2025',
                '15-Jan-2025',
                '16-Jan-2025',
                '17-Jan-2025',
                '18-Jan-2025',
                '19-Jan-2025',
                '20-Jan-2025',
                '21-Jan-2025',
                '22-Jan-2025',
                '23-Jan-2025',
                '24-Jan-2025',
                '25-Jan-2025',
                '26-Jan-2025',
                '27-Jan-2025',
            ],
            days: [
                '2025-01-01',
                '2025-01-02',
                '2025-01-03',
                '2025-01-04',
                '2025-01-05',
                '2025-01-06',
                '2025-01-07',
                '2025-01-08',
                '2025-01-09',
                '2025-01-10',
                '2025-01-11',
                '2025-01-12',
                '2025-01-13',
                '2025-01-14',
                '2025-01-15',
                '2025-01-16',
                '2025-01-17',
                '2025-01-18',
                '2025-01-19',
                '2025-01-20',
                '2025-01-21',
                '2025-01-22',
                '2025-01-23',
                '2025-01-24',
                '2025-01-25',
                '2025-01-26',
                '2025-01-27',
            ],
            count: 162842.85368923214,
            label: 'test-1',
            filter: {
                insight: 'TRENDS',
                properties: [
                    {
                        key: '$feature/storybook-experiment-2',
                        label: null,
                        operator: 'exact',
                        type: 'event',
                        value: ['control', 'test-1', 'test-2'],
                    },
                ],
                filter_test_accounts: false,
                date_to: '2025-01-27T14:06:13.147881Z',
                date_from: '2025-01-01T13:23:00Z',
                entity_type: 'events',
                interval: 'day',
                aggregationAxisFormat: 'numeric',
                display: 'ActionsLineGraphCumulative',
                resultCustomizationBy: 'value',
                showAlertThresholdLines: false,
                showLegend: false,
                showPercentStackView: false,
                showValuesOnSeries: false,
                smoothingIntervals: 1,
                yAxisScaleType: 'linear',
                breakdown: '$feature/storybook-experiment-2',
                breakdown_type: 'event',
            },
            action: {
                days: [
                    '2025-01-01T00:00:00Z',
                    '2025-01-02T00:00:00Z',
                    '2025-01-03T00:00:00Z',
                    '2025-01-04T00:00:00Z',
                    '2025-01-05T00:00:00Z',
                    '2025-01-06T00:00:00Z',
                    '2025-01-07T00:00:00Z',
                    '2025-01-08T00:00:00Z',
                    '2025-01-09T00:00:00Z',
                    '2025-01-10T00:00:00Z',
                    '2025-01-11T00:00:00Z',
                    '2025-01-12T00:00:00Z',
                    '2025-01-13T00:00:00Z',
                    '2025-01-14T00:00:00Z',
                    '2025-01-15T00:00:00Z',
                    '2025-01-16T00:00:00Z',
                    '2025-01-17T00:00:00Z',
                    '2025-01-18T00:00:00Z',
                    '2025-01-19T00:00:00Z',
                    '2025-01-20T00:00:00Z',
                    '2025-01-21T00:00:00Z',
                    '2025-01-22T00:00:00Z',
                    '2025-01-23T00:00:00Z',
                    '2025-01-24T00:00:00Z',
                    '2025-01-25T00:00:00Z',
                    '2025-01-26T00:00:00Z',
                    '2025-01-27T00:00:00Z',
                ],
                id: 'revenue (b)',
                type: 'events',
                order: 0,
                name: 'revenue (b)',
                custom_name: null,
                math: 'sum',
                math_property: 'revenue',
                math_hogql: null,
                math_group_type_index: null,
                properties: {},
            },
            breakdown_value: 'test-1',
        },
    ],
    is_cached: true,
    kind: 'ExperimentTrendsQuery',
    last_refresh: '2025-01-27T14:06:12.792473Z',
    next_allowed_client_refresh: '2025-01-27T14:07:12.792473Z',
    p_value: 0.0,
    probability: {
        control: 0.0,
        'test-2': 1.0,
        'test-1': 0.0,
    },
    query_status: null,
    significance_code: 'significant',
    significant: true,
    stats_version: 2,
    timezone: 'UTC',
    variants: [
        {
            absolute_exposure: 5497.0,
            count: 169504.27564590378,
            exposure: 1.0,
            key: 'control',
        },
        {
            absolute_exposure: 5543.0,
            count: 188463.04395650665,
            exposure: 1.00836820083682,
            key: 'test-2',
        },
        {
            absolute_exposure: 5460.0,
            count: 162842.85368923214,
            exposure: 0.9932690558486447,
            key: 'test-1',
        },
    ],
}

const meta: Meta = {
    title: 'Scenes-App/Experiments',
    parameters: {
        layout: 'fullscreen',
        viewMode: 'story',
        mockDate: '2025-01-27',
    },
    decorators: [
        mswDecorator({
            get: {
                '/api/projects/:team_id/experiments/': toPaginatedResponse([EXPERIMENT]),
                '/api/projects/:team_id/experiments/66/': EXPERIMENT,
                '/api/projects/:team_id/experiment_holdouts': [],
                '/api/projects/:team_id/experiment_saved_metrics/': [],
                '/api/projects/997/feature_flags/162/': {},
                '/api/projects/997/feature_flags/162/status/': {},
            },
            post: {
                '/api/environments/:team_id/query': (req, res, ctx) => {
                    const body = req.body as Record<string, any>

                    if (body.query.kind === 'ExperimentFunnelsQuery') {
                        return res(ctx.json(METRIC_FUNNEL_RESULT))
                    } else if (
                        body.query.kind === 'ExperimentTrendsQuery' &&
                        body.query.count_query.series[0].math === 'sum'
                    ) {
                        return res(ctx.json(METRIC_TREND_CONTINUOUS_RESULT))
                    } else if (body.query.kind === 'ExperimentTrendsQuery') {
                        return res(ctx.json(METRIC_TREND_RESULT))
                    }
                },
            },
        }),
    ],
}
export default meta
export const ExperimentsList: StoryFn = () => {
    useEffect(() => {
        router.actions.push(urls.experiments())
    }, [])
    return <App />
}

export const ExperimentWithThreeMetrics: StoryFn = () => {
    useEffect(() => {
        router.actions.push(urls.experiment(EXPERIMENT.id))
    }, [])
    return <App />
}
