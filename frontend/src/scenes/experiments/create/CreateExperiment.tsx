import { useActions, useValues } from 'kea'
import { Form } from 'kea-forms'
import { router } from 'kea-router'
import { useEffect, useState } from 'react'

import { useHogfetti } from 'lib/components/Hogfetti/Hogfetti'
import { LemonButton } from 'lib/lemon-ui/LemonButton'
import { LemonCollapse } from 'lib/lemon-ui/LemonCollapse'
import { LemonField } from 'lib/lemon-ui/LemonField'
import { LemonTextArea } from 'lib/lemon-ui/LemonTextArea'
import { urls } from 'scenes/urls'

import { SceneContent } from '~/layout/scenes/components/SceneContent'
import { SceneDivider } from '~/layout/scenes/components/SceneDivider'
import { SceneSection } from '~/layout/scenes/components/SceneSection'
import { SceneTitleSection } from '~/layout/scenes/components/SceneTitleSection'

import { MetricSourceModal } from '../Metrics/MetricSourceModal'
import { MetricsReorderModal } from '../MetricsView/MetricsReorderModal'
import { ExperimentCreationChecklist } from './components/ExperimentCreationChecklist'
import { createExperimentLogic } from './createExperimentLogic'
import { ExperimentTypePanel } from './panels/ExperimentTypePanel'
import { ExposureCriteriaPanel } from './panels/ExposureCriteriaPanel'
import { MetricsPanel } from './panels/MetricsPanel'
import { TargetingPanel } from './panels/TargetingPanel'
import { VariantsPanel } from './panels/VariantsPanel'

export const CreateExperiment = (): JSX.Element => {
    const { trigger: triggerHogfetti, HogfettiComponent } = useHogfetti({ count: 100, duration: 3000 })

    const { experiment, experimentCreated, isFeatureFlagAutoGenerated } = useValues(createExperimentLogic)
    const { setExperiment, setExperimentValue, setFeatureFlagFilters } = useActions(createExperimentLogic)

    const [selectedPanel, setSelectedPanel] = useState<string | null>(null)

    console.log('experiment', experiment)

    // Trigger Hogfetti when experiment is successfully created
    // useEffect(() => {
    //     if (experimentCreated) {
    //         triggerHogfetti()
    //     }
    // }, [experimentCreated, triggerHogfetti])

    // // Debounced auto-generation of feature flag key when experiment name changes
    // useEffect(() => {
    //     if (!experiment.name) {
    //         return
    //     }

    //     const timeoutId = setTimeout(() => {
    //         // Only auto-generate if:
    //         // 1. No existing key, OR
    //         // 2. Current key is auto-generated (so we can update it)
    //         if (!experiment.feature_flag_key || isFeatureFlagAutoGenerated) {
    //             generateFeatureFlagKey()
    //         }
    //     }, 500) // 500ms debounce

    //     return () => clearTimeout(timeoutId)
    // }, [experiment.name, experiment.feature_flag_key, isFeatureFlagAutoGenerated, generateFeatureFlagKey])

    return (
        <div className="flex flex-col xl:grid xl:grid-cols-[1fr_400px] gap-x-4 h-full">
            <Form logic={createExperimentLogic} formKey="experiment" enableFormOnSubmit>
                <HogfettiComponent />
                <SceneContent className="max-w-none flex-1">
                    <SceneTitleSection
                        name={experiment.name}
                        description={null}
                        resourceType={{
                            type: 'experiment',
                        }}
                        canEdit
                        forceEdit
                        onNameChange={(name) => {
                            setExperimentValue('name', name)
                            setExperiment({ ...experiment, name })
                        }}
                        actions={
                            <>
                                <LemonButton
                                    data-attr="cancel-experiment"
                                    type="secondary"
                                    size="small"
                                    onClick={() => {
                                        router.actions.push(urls.experiments())
                                    }}
                                >
                                    Cancel
                                </LemonButton>
                                <LemonButton data-attr="save-experiment" type="primary" size="small" htmlType="submit">
                                    Save as draft
                                </LemonButton>
                            </>
                        }
                    />
                    <SceneDivider />
                    <SceneSection title="Hypothesis" description="Describe your experiment in a few sentences.">
                        <LemonField name="description">
                            <LemonTextArea
                                placeholder="The goal of this experiment is ..."
                                data-attr="experiment-hypothesis"
                                value={experiment.description}
                                onChange={(value) => {
                                    setExperiment({ ...experiment, description: value })
                                }}
                            />
                        </LemonField>
                    </SceneSection>
                    <SceneDivider />
                    <LemonCollapse
                        activeKey={selectedPanel ?? undefined}
                        onChange={(key) => {
                            setSelectedPanel(key as string | null)
                        }}
                        className="bg-surface-primary"
                        panels={[
                            {
                                key: 'experiment-type',
                                header: 'Experiment type',
                                content: (
                                    <ExperimentTypePanel
                                        experiment={experiment}
                                        setExperimentType={(type) => setExperiment({ ...experiment, type })}
                                    />
                                ),
                            },
                            {
                                key: 'experiment-variants',
                                header: 'Feature flag & variants',
                                content: (
                                    <div className="p-4">
                                        <VariantsPanel
                                            experiment={experiment}
                                            onChange={(updates) => {
                                                if (updates.parameters) {
                                                    const mergedParameters = {
                                                        ...experiment.parameters,
                                                        ...updates.parameters,
                                                    }
                                                    // Ensure feature_flag_variants always has a value
                                                    if (!mergedParameters.feature_flag_variants) {
                                                        mergedParameters.feature_flag_variants =
                                                            experiment.parameters?.feature_flag_variants || []
                                                    }
                                                    setExperiment({
                                                        ...experiment,
                                                        ...updates,
                                                        parameters: mergedParameters,
                                                    })
                                                } else {
                                                    setExperiment({ ...experiment, ...updates } as any)
                                                }
                                            }}
                                        />
                                    </div>
                                ),
                            },
                            {
                                key: 'experiment-targeting',
                                header: 'Targeting',
                                content: (
                                    <div className="p-4">
                                        <TargetingPanel
                                            id={String(experiment.id)}
                                            filters={
                                                (experiment as any).feature_flag_filters || {
                                                    groups: [
                                                        {
                                                            properties: [],
                                                            rollout_percentage: 100,
                                                            variant: null,
                                                        },
                                                    ],
                                                    aggregation_group_type_index: null,
                                                }
                                            }
                                            onChange={(filters) => setFeatureFlagFilters(filters)}
                                        />
                                    </div>
                                ),
                            },
                            {
                                key: 'experiment-exposure',
                                header: 'Exposure criteria',
                                content: (
                                    <div className="p-4">
                                        <ExposureCriteriaPanel />
                                    </div>
                                ),
                            },
                            {
                                key: 'experiment-metrics',
                                header: 'Metrics',
                                content: (
                                    <div className="p-4">
                                        <MetricsPanel />
                                    </div>
                                ),
                            },
                        ]}
                    />
                </SceneContent>
            </Form>
            {/* Sidebar Checklist */}
            <div className="h-full">
                <div className="sticky top-16">
                    <ExperimentCreationChecklist
                        onPanelSelect={(panelKey) => {
                            setSelectedPanel(panelKey)
                        }}
                    />
                </div>
            </div>

            {/* Metric Modals */}
            <MetricSourceModal isSecondary={false} />
            <MetricSourceModal isSecondary={true} />
            <MetricsReorderModal isSecondary={false} />
            <MetricsReorderModal isSecondary={true} />
        </div>
    )
}
