# Generated by Django 4.2.18 on 2025-02-25 19:29

import uuid
from django.db import migrations


def add_question_ids_to_surveys(apps, schema_editor):
    """
    Add a unique ID to each question in existing surveys.
    This ensures all questions have an ID for tracking responses.
    """
    Survey = apps.get_model("posthog", "Survey")

    # Get all surveys
    surveys = Survey.objects.all()

    for survey in surveys:
        # Skip surveys with no questions
        if not survey.questions:
            continue

        # Add IDs to questions that don't have them
        modified = False
        for question in survey.questions:
            if not question.get("id"):
                question["id"] = str(uuid.uuid4())
                modified = True

        # Save the survey if any questions were modified
        if modified:
            survey.save(update_fields=["questions"])


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0675_add_playlist_viewed"),
    ]

    operations = [
        migrations.RunPython(
            add_question_ids_to_surveys,
            reverse_code=migrations.RunPython.noop,
            elidable=True,
        ),
    ]
