# Generated by Django 3.2.12 on 2022-04-22 09:10
import json

import structlog
from django.db import connection, migrations


def migrate_dashboard_insight_relations(apps, _) -> None:
    logger = structlog.get_logger(__name__)
    logger.info("starting_0228_fix_tile_layouts")

    DashboardTile = apps.get_model("posthog", "DashboardTile")

    with connection.cursor() as cursor:
        cursor.execute(
            """
            SELECT id, layouts FROM posthog_dashboardtile ORDER BY id ASC;
        """
        )

        converted_count = 0
        while True:
            page = cursor.fetchmany(500)
            if not page:
                break

            updated_tiles = []

            for tile_row in page:
                if isinstance(tile_row[1], str):
                    tile = DashboardTile.objects.get(pk=tile_row[0])

                    # from migration 0227
                    # the layout was a json serialized string that has again been serialized as string
                    # normally we could load it from string to dict once
                    as_json = json.loads(tile_row[1])
                    if isinstance(as_json, str):
                        # but if it is still in the state after 0227
                        # where it was not `json.loads`ed before being saved
                        # it must be loaded from json twice, since saving it will stringify again
                        as_json = json.loads(as_json)

                    tile.layouts = as_json
                    updated_tiles.append(tile)

            DashboardTile.objects.bulk_update(updated_tiles, ["layouts"])
            converted_count += len(page)

        logger.info("finished_0228_fix_tile_layouts", conversion_count=converted_count)


class Migration(migrations.Migration):

    dependencies = [
        ("posthog", "0227_add_dashboard_tiles"),
    ]

    def reverse(apps, _) -> None:
        pass
        # no-op, it's already wrong... it can't get wronger

    operations = [
        migrations.RunPython(migrate_dashboard_insight_relations, reverse),
    ]
