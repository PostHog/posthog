# Generated by Django 4.2.18 on 2025-03-16 17:01
from django.db import migrations, models
from django.contrib.postgres.operations import AddConstraintNotValid, ValidateConstraint
from django.db.models.constraints import ForeignKeyConstraint


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("posthog", "0688_update_default_version"),
    ]

    operations = [
        #
        # STEP 1: Raw SQL to drop existing constraints & convert columns to bigint.
        #         *NO* "ADD CONSTRAINT" statements here!
        #
        migrations.RunSQL(
            sql="""
                -- Drop existing FK constraints if they exist
                ALTER TABLE "posthog_cohortpeople"
                    DROP CONSTRAINT IF EXISTS "posthog_cohortpeople_person_id_33da7d3f_fk";
                ALTER TABLE "posthog_featureflaghashkeyoverride"
                    DROP CONSTRAINT IF EXISTS "posthog_featureflaghashkeyoverride_person_id_7e517f7c_fk";
                ALTER TABLE "posthog_persondistinctid"
                    DROP CONSTRAINT IF EXISTS "posthog_persondistinctid_person_id_5d655bba_fk";

                -- Convert columns to bigint
                ALTER TABLE "posthog_person"
                    ALTER COLUMN "id" TYPE bigint USING "id"::bigint;
                ALTER SEQUENCE IF EXISTS "posthog_person_id_seq" AS bigint;

                ALTER TABLE "posthog_cohortpeople"
                    ALTER COLUMN "person_id" TYPE bigint USING "person_id"::bigint;
                ALTER TABLE "posthog_featureflaghashkeyoverride"
                    ALTER COLUMN "person_id" TYPE bigint USING "person_id"::bigint;
                ALTER TABLE "posthog_persondistinctid"
                    ALTER COLUMN "person_id" TYPE bigint USING "person_id"::bigint;

                ALTER TABLE "posthog_persondistinctid"
                    ALTER COLUMN "id" TYPE bigint USING "id"::bigint;
                ALTER SEQUENCE IF EXISTS "posthog_persondistinctid_id_seq" AS bigint;
            """,
            reverse_sql=migrations.RunSQL.noop,
        ),
        #
        # STEP 2: Update the Django model state for BigAutoField & new FKs
        #
        migrations.AlterField(
            model_name="person",
            name="id",
            field=models.BigAutoField(primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="persondistinctid",
            name="id",
            field=models.BigAutoField(primary_key=True, serialize=False),
        ),
        migrations.AlterField(
            model_name="cohortpeople",
            name="person",
            field=models.ForeignKey(
                to="posthog.person",
                on_delete=models.CASCADE,
            ),
        ),
        migrations.AlterField(
            model_name="featureflaghashkeyoverride",
            name="person",
            field=models.ForeignKey(
                to="posthog.person",
                on_delete=models.CASCADE,
            ),
        ),
        migrations.AlterField(
            model_name="persondistinctid",
            name="person",
            field=models.ForeignKey(
                to="posthog.person",
                on_delete=models.CASCADE,
            ),
        ),
        #
        # STEP 3: Add each foreign key constraint with NOT VALID (non-blocking)
        #
        AddConstraintNotValid(
            model_name="cohortpeople",
            constraint=ForeignKeyConstraint(
                fields=["person_id"],
                to=["posthog_person", "id"],
                on_delete=models.CASCADE,
                name="posthog_cohortpeople_person_id_33da7d3f_fk",
            ),
        ),
        AddConstraintNotValid(
            model_name="featureflaghashkeyoverride",
            constraint=ForeignKeyConstraint(
                fields=["person_id"],
                to=["posthog_person", "id"],
                on_delete=models.CASCADE,
                name="posthog_featureflaghashkeyoverride_person_id_7e517f7c_fk",
            ),
        ),
        AddConstraintNotValid(
            model_name="persondistinctid",
            constraint=ForeignKeyConstraint(
                fields=["person_id"],
                to=["posthog_person", "id"],
                on_delete=models.CASCADE,
                name="posthog_persondistinctid_person_id_5d655bba_fk",
            ),
        ),
        #
        # STEP 4: Validate constraints in separate steps
        #
        ValidateConstraint(
            model_name="cohortpeople",
            name="posthog_cohortpeople_person_id_33da7d3f_fk",
        ),
        ValidateConstraint(
            model_name="featureflaghashkeyoverride",
            name="posthog_featureflaghashkeyoverride_person_id_7e517f7c_fk",
        ),
        ValidateConstraint(
            model_name="persondistinctid",
            name="posthog_persondistinctid_person_id_5d655bba_fk",
        ),
    ]
