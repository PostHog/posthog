# Generated by Django 4.2.22 on 2025-07-18 22:11
import logging

from django.db import migrations, connection, models
from django.db.models import Q

from posthog.models import Insight

logger = logging.getLogger(__name__)


def update_query_metadata(apps, schema_editor):
    insights = Insight.objects.filter(Q(query_metadata__isnull=True) | Q(query_metadata={}))

    for insight in insights.iterator(chunk_size=100):
        try:
            insight.generate_query_metadata()
            insight.save()
        except Exception as e:
            logger.error(f"Error updating query metadata for insight with id {insight.pk}: {e}")  # noqa: TRY400


def rollback_update_query_metadata(apps, schema_editor):
    with connection.cursor() as cursor:
        cursor.execute(
            """
            UPDATE posthog_dashboarditem
            SET query_metadata = NULL
            WHERE query_metadata IS NOT NULL
            """
        )


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("posthog", "0799_migrate_playlist_types_take_2"),
    ]

    operations = [
        migrations.AddField(
            model_name="insight",
            name="query_metadata",
            field=models.JSONField(blank=True, default=dict, null=True),
        ),
        migrations.RunSQL(
            sql=(
                "CREATE INDEX CONCURRENTLY IF NOT EXISTS dashboarditem_query_metadata ON posthog_dashboarditem USING GIN (query_metadata jsonb_ops);"
            ),
            reverse_sql=("DROP INDEX CONCURRENTLY IF EXISTS dashboarditem_query_metadata;"),
        ),
        migrations.RunPython(update_query_metadata, rollback_update_query_metadata),
    ]
