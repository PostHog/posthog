# Generated by Django 4.2.28 on 2026-02-18 08:16

import datetime

import django.utils.timezone
import django.db.models.deletion
import django.contrib.postgres.fields
import django.contrib.postgres.operations
import django.db.migrations.operations.special
from django.conf import settings
from django.db import migrations, models

import posthog.models.utils


class Migration(migrations.Migration):
    atomic = False

    replaces = [
        ("posthog", "0898_hogflow_variables"),
        ("posthog", "0899_add_cohort_type"),
        ("posthog", "0900_team_receive_org_level_activity_logs"),
        ("posthog", "0901_add_object_property_type"),
        ("posthog", "0902_user_pinned_scene_tabs"),
        ("posthog", "0903_organization_default_anonymize_ips"),
        ("posthog", "0904_alter_dashboard_creation_mode"),
        ("posthog", "0905_alter_person_table"),
        ("posthog", "0906_user_allow_sidebar_suggestions"),
        ("posthog", "0907_alter_persistedfolder_type"),
        ("posthog", "0908_userproductlist"),
        ("posthog", "0909_survey_add_linked_insight_id"),
        ("posthog", "0910_userproductlist_reason_text"),
        ("posthog", "0911_surveyresponsearchive_and_more"),
        ("posthog", "0912_alter_survey_linked_insight_type"),
        ("posthog", "0913_alter_survey_linked_insight"),
        ("posthog", "0914_alter_userproductlist_reason"),
        ("posthog", "0915_alter_userproductlist_reason"),
        ("posthog", "0916_alter_userproductlist_reason"),
        ("posthog", "0917_alter_survey_linked_insight"),
        ("posthog", "0918_add_column_configurator"),
        ("posthog", "0919_teammarketinganalyticsconfig__custom_source_mappings"),
        ("posthog", "0920_alter_integration_kind"),
        ("posthog", "0921_teammarketinganalyticsconfig__campaign_field_preferences_and_more"),
        ("posthog", "0922_remove_persons_db_team_fks"),
        ("posthog", "0923_add_quick_filters"),
        ("posthog", "0924_alter_survey_questions"),
        ("posthog", "0925_team_business_model"),
        ("posthog", "0926_featureflag_bucketing_identifier"),
        ("posthog", "0927_changerequest_approvalpolicy_approval_and_more"),
        ("posthog", "0928_add_team_require_evaluation_tags"),
        ("posthog", "0929_remove_legacy_batch_export_notification_setting"),
        ("posthog", "0930_user_shortcut_position"),
        ("posthog", "0931_materialized_column_slots"),
        ("posthog", "0932_add_session_ids_to_restriction_config"),
        ("posthog", "0933_add_event_names_and_uuids_to_restriction_config"),
        ("posthog", "0934_cohortcalculationhistory_cohort_started_idx"),
        ("posthog", "0935_cohortcalculationhistory_error_code"),
        ("posthog", "0936_survey_headline_response_count_and_more"),
        ("posthog", "0937_remove_redundant_cohortcalculationhistory_indexes"),
        ("posthog", "0938_add_redirect_to_dlq_restriction_type"),
        ("posthog", "0939_team_product_tours_opt_in"),
        ("posthog", "0940_user_allow_impersonation"),
        ("posthog", "0941_add_exported_recording_model"),
        ("posthog", "0942_llm_prompt"),
        ("posthog", "0943_llm_prompt_unique_name"),
        ("posthog", "0944_organization_is_active_and_more"),
        ("posthog", "0945_scheduledchange_recurring_fields"),
    ]

    dependencies = [
        ("posthog", "0897_migrate_data_warehouse_models"),
    ]

    operations = [
        migrations.AddField(
            model_name="hogflow",
            name="variables",
            field=models.JSONField(blank=True, default=list, null=True),
        ),
        migrations.AlterField(
            model_name="cohort",
            name="cohort_type",
            field=models.CharField(
                blank=True,
                choices=[
                    ("static", "static"),
                    ("person_property", "person_property"),
                    ("behavioral", "behavioral"),
                    ("realtime", "realtime"),
                    ("analytical", "analytical"),
                ],
                help_text="Type of cohort based on filter complexity",
                max_length=50,
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="team",
            name="receive_org_level_activity_logs",
            field=models.BooleanField(blank=True, default=False, null=True),
        ),
        migrations.RemoveConstraint(
            model_name="schemapropertygroupproperty",
            name="property_type_is_valid_schema",
        ),
        migrations.AlterField(
            model_name="schemapropertygroupproperty",
            name="property_type",
            field=models.CharField(
                choices=[
                    ("DateTime", "DateTime"),
                    ("String", "String"),
                    ("Numeric", "Numeric"),
                    ("Boolean", "Boolean"),
                    ("Object", "Object"),
                ],
                max_length=50,
            ),
        ),
        migrations.CreateModel(
            name="UserHomeSettings",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("tabs", models.JSONField(blank=True, default=list)),
                ("homepage", models.JSONField(blank=True, default=dict, null=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "team",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to="posthog.team"
                    ),
                ),
                (
                    "user",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="home_settings",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
        ),
        migrations.AddConstraint(
            model_name="userhomesettings",
            constraint=models.UniqueConstraint(fields=("team", "user"), name="posthog_unique_user_home_settings"),
        ),
        migrations.AddField(
            model_name="organization",
            name="default_anonymize_ips",
            field=models.BooleanField(
                default=False,
                help_text="Default setting for 'Discard client IP data' for new projects in this organization.",
            ),
        ),
        migrations.AlterField(
            model_name="dashboard",
            name="creation_mode",
            field=models.CharField(
                choices=[
                    ("default", "Default"),
                    ("template", "Template"),
                    ("duplicate", "Duplicate"),
                    ("unlisted", "Unlisted (product-embedded)"),
                ],
                default="default",
                max_length=16,
            ),
        ),
        migrations.AlterModelTable(
            name="person",
            table="posthog_person",
        ),
        migrations.AddField(
            model_name="user",
            name="allow_sidebar_suggestions",
            field=models.BooleanField(blank=True, default=True, null=True),
        ),
        migrations.RunPython(
            code=django.db.migrations.operations.special.RunPython.noop,
            reverse_code=django.db.migrations.operations.special.RunPython.noop,
        ),
        migrations.AlterField(
            model_name="persistedfolder",
            name="type",
            field=models.CharField(
                choices=[("home", "Home"), ("pinned", "Pinned"), ("custom_products", "Custom Products")], max_length=32
            ),
        ),
        migrations.AddField(
            model_name="survey",
            name="linked_insight_id",
            field=models.IntegerField(blank=True, null=True),
        ),
        migrations.CreateModel(
            name="UserProductList",
            fields=[
                ("updated_at", models.DateTimeField(auto_now=True, null=True)),
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("product_path", models.CharField(max_length=200)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "reason",
                    models.CharField(
                        choices=[("usage", "Usage"), ("new_product", "New Product"), ("sales_led", "Sales Led")],
                        max_length=32,
                        null=True,
                    ),
                ),
                ("enabled", models.BooleanField(default=True)),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
                ("user", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
                ("reason_text", models.TextField(null=True)),
            ],
            options={
                "verbose_name": "User Product List",
                "verbose_name_plural": "User Product Lists",
                "indexes": [models.Index(models.F("team_id"), models.F("user_id"), name="posthog_upl_team_user")],
                "unique_together": {("team", "user", "product_path")},
            },
        ),
        migrations.CreateModel(
            name="SurveyResponseArchive",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                (
                    "response_uuid",
                    models.UUIDField(help_text="UUID of the ClickHouse event representing the survey response"),
                ),
                ("archived_at", models.DateTimeField(auto_now_add=True)),
                (
                    "survey",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="response_archives",
                        related_query_name="response_archive",
                        to="posthog.survey",
                    ),
                ),
                (
                    "team",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="survey_response_archives",
                        related_query_name="survey_response_archive",
                        to="posthog.team",
                    ),
                ),
            ],
            options={
                "indexes": [
                    models.Index(fields=["survey", "team"], name="posthog_sur_survey__f78fc7_idx"),
                    models.Index(fields=["team", "response_uuid"], name="posthog_sur_team_id_2c59a2_idx"),
                ],
            },
        ),
        migrations.AddConstraint(
            model_name="surveyresponsearchive",
            constraint=models.UniqueConstraint(
                fields=("team", "response_uuid"), name="unique_archived_response_per_team"
            ),
        ),
        migrations.SeparateDatabaseAndState(
            state_operations=[
                migrations.RemoveField(
                    model_name="survey",
                    name="linked_insight_id",
                ),
                migrations.AddField(
                    model_name="survey",
                    name="linked_insight",
                    field=models.ForeignKey(
                        blank=True,
                        db_constraint=False,
                        db_index=False,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="surveys_linked_insight",
                        related_query_name="survey_linked_insight",
                        to="posthog.insight",
                    ),
                ),
            ],
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql='\n                        ALTER TABLE "posthog_survey" ADD CONSTRAINT "posthog_survey_linked_insight_id_586524f3_fk_posthog_d" FOREIGN KEY ("linked_insight_id") REFERENCES "posthog_dashboarditem" ("id") DEFERRABLE INITIALLY DEFERRED NOT VALID; -- existing-table-constraint-ignore\n                    ',
                    reverse_sql='\n                        ALTER TABLE "posthog_survey" DROP CONSTRAINT IF EXISTS "posthog_survey_linked_insight_id_586524f3_fk_posthog_d";\n                    ',
                ),
            ],
            state_operations=[
                migrations.AlterField(
                    model_name="survey",
                    name="linked_insight",
                    field=models.ForeignKey(
                        blank=True,
                        db_index=False,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="surveys_linked_insight",
                        related_query_name="survey_linked_insight",
                        to="posthog.insight",
                    ),
                ),
            ],
        ),
        migrations.AlterField(
            model_name="userproductlist",
            name="reason",
            field=models.CharField(
                choices=[
                    ("product_intent", "Product Intent"),
                    ("used_by_colleagues", "Used by Colleagues"),
                    ("used_similar_products", "Used Similar Products"),
                    ("new_product", "New Product"),
                    ("sales_led", "Sales Led"),
                ],
                max_length=32,
                null=True,
            ),
        ),
        migrations.AlterField(
            model_name="userproductlist",
            name="reason",
            field=models.CharField(
                choices=[
                    ("onboarding", "Onboarding"),
                    ("product_intent", "Product Intent"),
                    ("used_by_colleagues", "Used by Colleagues"),
                    ("used_similar_products", "Used Similar Products"),
                    ("new_product", "New Product"),
                    ("sales_led", "Sales Led"),
                ],
                max_length=32,
                null=True,
            ),
        ),
        migrations.AlterField(
            model_name="userproductlist",
            name="reason",
            field=models.CharField(
                choices=[
                    ("onboarding", "Onboarding"),
                    ("product_intent", "Product Intent"),
                    ("used_by_colleagues", "Used by Colleagues"),
                    ("used_similar_products", "Used Similar Products"),
                    ("used_on_separate_team", "Used on Separate Team"),
                    ("new_product", "New Product"),
                    ("sales_led", "Sales Led"),
                ],
                max_length=32,
                null=True,
            ),
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql='\n                    CREATE INDEX CONCURRENTLY IF NOT EXISTS "posthog_survey_linked_insight_id_586524f3" ON "posthog_survey" ("linked_insight_id"); -- existing-table-constraint-ignore\n                    ',
                    reverse_sql='\n                        DROP INDEX IF EXISTS "posthog_survey_linked_insight_id_586524f3";\n                    ',
                ),
            ],
            state_operations=[
                migrations.AlterField(
                    model_name="survey",
                    name="linked_insight",
                    field=models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="surveys_linked_insight",
                        related_query_name="survey_linked_insight",
                        to="posthog.insight",
                    ),
                ),
            ],
        ),
        migrations.CreateModel(
            name="ColumnConfiguration",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("context_key", models.CharField(db_index=True, max_length=255)),
                (
                    "columns",
                    django.contrib.postgres.fields.ArrayField(base_field=models.TextField(), default=list, size=None),
                ),
                ("created_at", models.DateTimeField(default=django.utils.timezone.now)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
            ],
            options={
                "indexes": [models.Index(fields=["team", "context_key"], name="posthog_col_team_id_0cba64_idx")],
            },
        ),
        migrations.AddConstraint(
            model_name="columnconfiguration",
            constraint=models.UniqueConstraint(fields=("team", "context_key"), name="unique_team_context_key"),
        ),
        migrations.AlterField(
            model_name="integration",
            name="kind",
            field=models.CharField(
                choices=[
                    ("slack", "Slack"),
                    ("salesforce", "Salesforce"),
                    ("hubspot", "Hubspot"),
                    ("google-pubsub", "Google Pubsub"),
                    ("google-cloud-storage", "Google Cloud Storage"),
                    ("google-ads", "Google Ads"),
                    ("google-sheets", "Google Sheets"),
                    ("snapchat", "Snapchat"),
                    ("linkedin-ads", "Linkedin Ads"),
                    ("reddit-ads", "Reddit Ads"),
                    ("tiktok-ads", "Tiktok Ads"),
                    ("bing-ads", "Bing Ads"),
                    ("intercom", "Intercom"),
                    ("email", "Email"),
                    ("linear", "Linear"),
                    ("github", "Github"),
                    ("gitlab", "Gitlab"),
                    ("meta-ads", "Meta Ads"),
                    ("twilio", "Twilio"),
                    ("clickup", "Clickup"),
                    ("vercel", "Vercel"),
                    ("databricks", "Databricks"),
                ],
                max_length=20,
            ),
        ),
        migrations.AddField(
            model_name="teammarketinganalyticsconfig",
            name="_campaign_field_preferences",
            field=models.JSONField(
                blank=True,
                db_column="campaign_field_preferences",
                default=dict,
                help_text="Campaign field matching preferences: defines which field (campaign_name or campaign_id) to match utm_campaign against per integration. Manual mappings always take precedence.",
            ),
        ),
        migrations.AddField(
            model_name="teammarketinganalyticsconfig",
            name="_custom_source_mappings",
            field=models.JSONField(
                blank=True,
                db_column="custom_source_mappings",
                default=dict,
                help_text="Custom UTM source mappings: maps integration types to lists of custom UTM source values",
            ),
        ),
        migrations.RunSQL(
            sql='\n                ALTER TABLE posthog_persondistinctid\n                DROP CONSTRAINT IF EXISTS "posthog_persondistinctid_team_id_46330ec9_fk_posthog_team_id";\n            ',
            reverse_sql='\n                ALTER TABLE posthog_persondistinctid\n                ADD CONSTRAINT "posthog_persondistinctid_team_id_46330ec9_fk_posthog_team_id"\n                FOREIGN KEY (team_id)\n                REFERENCES posthog_team(id)\n                DEFERRABLE INITIALLY DEFERRED;\n            ',
        ),
        migrations.RunSQL(
            sql='\n                ALTER TABLE posthog_personlessdistinctid\n                DROP CONSTRAINT IF EXISTS "posthog_personlessdi_team_id_99211fb1_fk_posthog_t";\n            ',
            reverse_sql='\n                ALTER TABLE posthog_personlessdistinctid\n                ADD CONSTRAINT "posthog_personlessdi_team_id_99211fb1_fk_posthog_t"\n                FOREIGN KEY (team_id)\n                REFERENCES posthog_team(id)\n                DEFERRABLE INITIALLY DEFERRED;\n            ',
        ),
        migrations.RunSQL(
            sql='\n                ALTER TABLE posthog_personoverride\n                DROP CONSTRAINT IF EXISTS "posthog_personoverride_team_id_92291e67_fk_posthog_team_id";\n            ',
            reverse_sql='\n                ALTER TABLE posthog_personoverride\n                ADD CONSTRAINT "posthog_personoverride_team_id_92291e67_fk_posthog_team_id"\n                FOREIGN KEY (team_id)\n                REFERENCES posthog_team(id)\n                DEFERRABLE INITIALLY DEFERRED;\n            ',
        ),
        migrations.RunSQL(
            sql='\n                ALTER TABLE posthog_featureflaghashkeyoverride\n                DROP CONSTRAINT IF EXISTS "posthog_featureflagh_team_id_b626eed2_fk_posthog_t";\n            ',
            reverse_sql='\n                ALTER TABLE posthog_featureflaghashkeyoverride\n                ADD CONSTRAINT "posthog_featureflagh_team_id_b626eed2_fk_posthog_t"\n                FOREIGN KEY (team_id)\n                REFERENCES posthog_team(id)\n                DEFERRABLE INITIALLY DEFERRED;\n            ',
        ),
        migrations.RunSQL(
            sql='\n                ALTER TABLE posthog_grouptypemapping\n                DROP CONSTRAINT IF EXISTS "posthog_grouptypemapping_team_id_5fb54d04_fk_posthog_team_id";\n            ',
            reverse_sql='\n                ALTER TABLE posthog_grouptypemapping\n                ADD CONSTRAINT "posthog_grouptypemapping_team_id_5fb54d04_fk_posthog_team_id"\n                FOREIGN KEY (team_id)\n                REFERENCES posthog_team(id)\n                DEFERRABLE INITIALLY DEFERRED;\n            ',
        ),
        migrations.CreateModel(
            name="QuickFilter",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("name", models.CharField(max_length=200)),
                ("property_name", models.CharField(max_length=500)),
                (
                    "type",
                    models.CharField(
                        choices=[("manual-options", "manual-options"), ("auto-discovery", "auto-discovery")],
                        default="manual-options",
                        max_length=50,
                    ),
                ),
                ("options", models.JSONField(blank=True, default=list, null=True)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
            ],
            options={
                "db_table": "posthog_quickfilter",
            },
        ),
        migrations.CreateModel(
            name="QuickFilterContext",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("context", models.CharField(max_length=100)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "quick_filter",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="context_memberships",
                        to="posthog.quickfilter",
                    ),
                ),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
            ],
            options={
                "db_table": "posthog_quickfiltercontext",
                "indexes": [
                    models.Index(fields=["team", "context"], name="posthog_qui_team_id_3d3d27_idx"),
                    models.Index(fields=["quick_filter", "context"], name="posthog_qui_quick_f_ff6325_idx"),
                ],
            },
        ),
        migrations.AddConstraint(
            model_name="quickfiltercontext",
            constraint=models.UniqueConstraint(
                fields=("team", "quick_filter", "context"), name="unique_filter_context"
            ),
        ),
        migrations.AddIndex(
            model_name="quickfilter",
            index=models.Index(fields=["team"], name="posthog_qui_team_id_24fea4_idx"),
        ),
        migrations.AlterField(
            model_name="survey",
            name="questions",
            field=models.JSONField(
                blank=True,
                help_text='\n        The `array` of questions included in the survey. Each question must conform to one of the defined question types: Basic, Link, Rating, or Multiple Choice.\n\n        Basic (open-ended question)\n        - `id`: The question ID\n        - `type`: `open`\n        - `question`: The text of the question.\n        - `description`: Optional description of the question.\n        - `descriptionContentType`: Content type of the description (`html` or `text`).\n        - `optional`: Whether the question is optional (`boolean`).\n        - `buttonText`: Text displayed on the submit button.\n        - `branching`: Branching logic for the question. See branching types below for details.\n\n        Link (a question with a link)\n        - `id`: The question ID\n        - `type`: `link`\n        - `question`: The text of the question.\n        - `description`: Optional description of the question.\n        - `descriptionContentType`: Content type of the description (`html` or `text`).\n        - `optional`: Whether the question is optional (`boolean`).\n        - `buttonText`: Text displayed on the submit button.\n        - `link`: The URL associated with the question.\n        - `branching`: Branching logic for the question. See branching types below for details.\n\n        Rating (a question with a rating scale)\n        - `id`: The question ID\n        - `type`: `rating`\n        - `question`: The text of the question.\n        - `description`: Optional description of the question.\n        - `descriptionContentType`: Content type of the description (`html` or `text`).\n        - `optional`: Whether the question is optional (`boolean`).\n        - `buttonText`: Text displayed on the submit button.\n        - `display`: Display style of the rating (`number` or `emoji`).\n        - `scale`: The scale of the rating (`number`).\n        - `lowerBoundLabel`: Label for the lower bound of the scale.\n        - `upperBoundLabel`: Label for the upper bound of the scale.\n        - `isNpsQuestion`: Whether the question is an NPS rating.\n        - `branching`: Branching logic for the question. See branching types below for details.\n\n        Multiple choice\n        - `id`: The question ID\n        - `type`: `single_choice` or `multiple_choice`\n        - `question`: The text of the question.\n        - `description`: Optional description of the question.\n        - `descriptionContentType`: Content type of the description (`html` or `text`).\n        - `optional`: Whether the question is optional (`boolean`).\n        - `buttonText`: Text displayed on the submit button.\n        - `choices`: An array of choices for the question.\n        - `shuffleOptions`: Whether to shuffle the order of the choices (`boolean`).\n        - `hasOpenChoice`: Whether the question allows an open-ended response (`boolean`).\n        - `branching`: Branching logic for the question. See branching types below for details.\n\n        Branching logic can be one of the following types:\n\n        Next question: Proceeds to the next question\n        ```json\n        {\n            "type": "next_question"\n        }\n        ```\n\n        End: Ends the survey, optionally displaying a confirmation message.\n        ```json\n        {\n            "type": "end"\n        }\n        ```\n\n        Response-based: Branches based on the response values. Available for the `rating` and `single_choice` question types.\n        ```json\n        {\n            "type": "response_based",\n            "responseValues": {\n                "responseKey": "value"\n            }\n        }\n        ```\n\n        Specific question: Proceeds to a specific question by index.\n        ```json\n        {\n            "type": "specific_question",\n            "index": 2\n        }\n        ```\n        ',
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="team",
            name="business_model",
            field=models.CharField(
                blank=True,
                choices=[("b2b", "B2B"), ("b2c", "B2C"), ("other", "Other")],
                help_text="Whether this project serves B2B or B2C customers, used to optimize the UI layout.",
                max_length=10,
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="featureflag",
            name="bucketing_identifier",
            field=models.CharField(
                blank=True,
                choices=[("distinct_id", "User ID (default)"), ("device_id", "Device ID")],
                default="distinct_id",
                help_text="Identifier used for bucketing users into rollout and variants",
                max_length=50,
                null=True,
            ),
        ),
        migrations.CreateModel(
            name="ChangeRequest",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("action_key", models.CharField(max_length=128)),
                ("action_version", models.IntegerField(default=1)),
                ("resource_type", models.CharField(max_length=64)),
                ("resource_id", models.CharField(blank=True, max_length=128, null=True)),
                ("intent", models.JSONField()),
                ("intent_display", models.JSONField()),
                ("policy_snapshot", models.JSONField()),
                (
                    "validation_status",
                    models.CharField(
                        choices=[
                            ("valid", "Valid"),
                            ("invalid", "Invalid"),
                            ("expired", "Expired"),
                            ("stale", "Stale (resource changed)"),
                        ],
                        default="valid",
                        max_length=16,
                    ),
                ),
                ("validation_errors", models.JSONField(blank=True, null=True)),
                ("validated_at", models.DateTimeField(blank=True, null=True)),
                (
                    "state",
                    models.CharField(
                        choices=[
                            ("pending", "Pending"),
                            ("approved", "Approved (awaiting application)"),
                            ("applied", "Applied"),
                            ("rejected", "Rejected"),
                            ("expired", "Expired"),
                            ("failed", "Failed to apply"),
                        ],
                        default="pending",
                        max_length=16,
                    ),
                ),
                (
                    "created_by",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True, null=True)),
                ("expires_at", models.DateTimeField()),
                ("applied_at", models.DateTimeField(blank=True, null=True)),
                ("apply_error", models.TextField(blank=True)),
                ("result_data", models.JSONField(blank=True, null=True)),
                (
                    "applied_by",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="change_requests_applied",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "organization",
                    models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.organization"),
                ),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
            ],
            options={
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="ApprovalPolicy",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("action_key", models.CharField(max_length=128)),
                ("conditions", models.JSONField(default=dict)),
                ("approver_config", models.JSONField()),
                ("allow_self_approve", models.BooleanField(default=False)),
                ("bypass_roles", models.JSONField(default=list)),
                (
                    "created_by",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True, null=True)),
                (
                    "expires_after",
                    models.DurationField(
                        default=datetime.timedelta(days=14), help_text="Auto-expire change requests after this duration"
                    ),
                ),
                ("enabled", models.BooleanField(default=True)),
                (
                    "organization",
                    models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.organization"),
                ),
                (
                    "team",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to="posthog.team"
                    ),
                ),
            ],
            options={
                "verbose_name_plural": "Approval policies",
            },
        ),
        migrations.CreateModel(
            name="Approval",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                (
                    "decision",
                    models.CharField(choices=[("approved", "Approved"), ("rejected", "Rejected")], max_length=16),
                ),
                ("reason", models.TextField(blank=True)),
                (
                    "created_by",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True, null=True)),
                (
                    "change_request",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="approvals",
                        to="posthog.changerequest",
                    ),
                ),
            ],
        ),
        migrations.AddIndex(
            model_name="changerequest",
            index=models.Index(fields=["team", "state"], name="posthog_cha_team_id_0a5974_idx"),
        ),
        migrations.AddIndex(
            model_name="changerequest",
            index=models.Index(fields=["action_key", "state"], name="posthog_cha_action__2d384d_idx"),
        ),
        migrations.AddIndex(
            model_name="changerequest",
            index=models.Index(fields=["expires_at"], name="posthog_cha_expires_0a6444_idx"),
        ),
        migrations.AddIndex(
            model_name="changerequest",
            index=models.Index(fields=["validation_status", "state"], name="posthog_cha_validat_24672f_idx"),
        ),
        migrations.AddIndex(
            model_name="approvalpolicy",
            index=models.Index(fields=["action_key", "enabled"], name="posthog_app_action__871059_idx"),
        ),
        migrations.AddIndex(
            model_name="approvalpolicy",
            index=models.Index(fields=["organization", "enabled"], name="posthog_app_organiz_36e124_idx"),
        ),
        migrations.AddIndex(
            model_name="approvalpolicy",
            index=models.Index(fields=["team", "enabled"], name="posthog_app_team_id_9f077f_idx"),
        ),
        migrations.AlterUniqueTogether(
            name="approvalpolicy",
            unique_together={("organization", "team", "action_key")},
        ),
        migrations.AddIndex(
            model_name="approval",
            index=models.Index(fields=["change_request", "decision"], name="posthog_app_change__5af5e4_idx"),
        ),
        migrations.AlterUniqueTogether(
            name="approval",
            unique_together={("change_request", "created_by")},
        ),
        migrations.AddField(
            model_name="team",
            name="require_evaluation_environment_tags",
            field=models.BooleanField(
                blank=True,
                default=False,
                help_text="Whether to require at least one evaluation environment tag when creating new feature flags",
                null=True,
            ),
        ),
        migrations.RunPython(
            code=django.db.migrations.operations.special.RunPython.noop,
            reverse_code=django.db.migrations.operations.special.RunPython.noop,
        ),
        migrations.AddField(
            model_name="user",
            name="shortcut_position",
            field=models.CharField(
                blank=True,
                choices=[("above", "Above"), ("below", "Below"), ("hidden", "Hidden")],
                default="above",
                max_length=20,
                null=True,
            ),
        ),
        migrations.CreateModel(
            name="MaterializedColumnSlot",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "created_by",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
                    ),
                ),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "team",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="materialized_column_slots",
                        related_query_name="materialized_column_slot",
                        to="posthog.team",
                    ),
                ),
                (
                    "property_definition",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="materialized_column_slots",
                        related_query_name="materialized_column_slot",
                        to="posthog.propertydefinition",
                    ),
                ),
                (
                    "property_type",
                    models.CharField(
                        choices=[
                            ("DateTime", "DateTime"),
                            ("String", "String"),
                            ("Numeric", "Numeric"),
                            ("Boolean", "Boolean"),
                            ("Duration", "Duration"),
                        ],
                        max_length=50,
                    ),
                ),
                ("slot_index", models.PositiveSmallIntegerField()),
                (
                    "state",
                    models.CharField(
                        choices=[("BACKFILL", "Backfill"), ("READY", "Ready"), ("ERROR", "Error")],
                        default="BACKFILL",
                        max_length=20,
                    ),
                ),
                ("backfill_temporal_workflow_id", models.CharField(blank=True, max_length=400, null=True)),
                ("error_message", models.TextField(blank=True, null=True)),
            ],
            options={
                "abstract": False,
            },
        ),
        migrations.AddConstraint(
            model_name="materializedcolumnslot",
            constraint=models.UniqueConstraint(
                fields=("team", "property_definition"), name="unique_team_property_definition"
            ),
        ),
        migrations.AddConstraint(
            model_name="materializedcolumnslot",
            constraint=models.UniqueConstraint(
                fields=("team", "property_type", "slot_index"), name="unique_team_property_type_slot_index"
            ),
        ),
        migrations.AddConstraint(
            model_name="materializedcolumnslot",
            constraint=models.CheckConstraint(
                check=models.Q(("slot_index__gte", 0), ("slot_index__lte", 9)), name="valid_slot_index"
            ),
        ),
        migrations.AddIndex(
            model_name="materializedcolumnslot",
            index=models.Index(fields=["team", "state"], name="posthog_mat_team_st_idx"),
        ),
        migrations.AddIndex(
            model_name="materializedcolumnslot",
            index=models.Index(fields=["team", "property_definition"], name="posthog_mat_team_pr_idx"),
        ),
        migrations.AddIndex(
            model_name="materializedcolumnslot",
            index=models.Index(fields=["team", "property_type", "slot_index"], name="posthog_mat_team_ty_idx"),
        ),
        migrations.AddIndex(
            model_name="materializedcolumnslot",
            index=models.Index(fields=["backfill_temporal_workflow_id"], name="posthog_mat_backfi_idx"),
        ),
        migrations.AddField(
            model_name="eventingestionrestrictionconfig",
            name="session_ids",
            field=django.contrib.postgres.fields.ArrayField(
                base_field=models.CharField(max_length=450), blank=True, default=list, null=True, size=None
            ),
        ),
        migrations.AddField(
            model_name="eventingestionrestrictionconfig",
            name="event_names",
            field=django.contrib.postgres.fields.ArrayField(
                base_field=models.CharField(max_length=450), blank=True, default=list, null=True, size=None
            ),
        ),
        migrations.AddField(
            model_name="eventingestionrestrictionconfig",
            name="event_uuids",
            field=django.contrib.postgres.fields.ArrayField(
                base_field=models.CharField(max_length=450), blank=True, default=list, null=True, size=None
            ),
        ),
        django.contrib.postgres.operations.AddIndexConcurrently(
            model_name="cohortcalculationhistory",
            index=models.Index(fields=["cohort", "-started_at"], name="posthog_coh_cohort__cbac1b_idx"),
        ),
        migrations.AddField(
            model_name="cohortcalculationhistory",
            name="error_code",
            field=models.CharField(
                blank=True,
                help_text="Error code for categorizing failures (e.g., 'timeout', 'memory_limit'), used for displaying errors to end-users",
                max_length=64,
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="survey",
            name="headline_response_count",
            field=models.PositiveIntegerField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="survey",
            name="headline_summary",
            field=models.TextField(blank=True, null=True),
        ),
        migrations.RunSQL(
            sql="DROP INDEX CONCURRENTLY IF EXISTS posthog_cohortcalculationhistory_cohort_id_e7c02b55",
            reverse_sql="CREATE INDEX CONCURRENTLY IF NOT EXISTS posthog_cohortcalculationhistory_cohort_id_e7c02b55 ON posthog_cohortcalculationhistory (cohort_id)",
        ),
        migrations.RunSQL(
            sql="DROP INDEX CONCURRENTLY IF EXISTS posthog_cohortcalculationhistory_team_id_beba9c96",
            reverse_sql="CREATE INDEX CONCURRENTLY IF NOT EXISTS posthog_cohortcalculationhistory_team_id_beba9c96 ON posthog_cohortcalculationhistory (team_id)",
        ),
        migrations.AlterField(
            model_name="eventingestionrestrictionconfig",
            name="restriction_type",
            field=models.CharField(
                choices=[
                    ("skip_person_processing", "Skip Person Processing"),
                    ("drop_event_from_ingestion", "Drop Event From Ingestion"),
                    ("force_overflow_from_ingestion", "Force Overflow From Ingestion"),
                    ("redirect_to_dlq", "Redirect To Dlq"),
                ],
                max_length=100,
            ),
        ),
        migrations.AddField(
            model_name="team",
            name="product_tours_opt_in",
            field=models.BooleanField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="user",
            name="allow_impersonation",
            field=models.BooleanField(blank=True, default=True, null=True),
        ),
        migrations.CreateModel(
            name="ExportedRecording",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("session_id", models.CharField(max_length=200)),
                ("reason", models.TextField()),
                ("export_location", models.CharField(blank=True, max_length=1000, null=True)),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("pending", "Pending"),
                            ("running", "Running"),
                            ("complete", "Complete"),
                            ("failed", "Failed"),
                        ],
                        default="pending",
                        max_length=20,
                    ),
                ),
                ("error_message", models.TextField(blank=True, null=True)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "created_by",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="exported_recordings",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "team",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="exported_recordings",
                        to="posthog.team",
                    ),
                ),
            ],
            options={
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="LLMPrompt",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("name", models.CharField(max_length=255)),
                ("prompt", models.JSONField()),
                ("version", models.PositiveIntegerField(default=1)),
                ("created_at", models.DateTimeField(default=django.utils.timezone.now)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("deleted", models.BooleanField(default=False)),
                (
                    "created_by",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
                    ),
                ),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
            ],
            options={
                "abstract": False,
            },
        ),
        migrations.AddConstraint(
            model_name="llmprompt",
            constraint=models.UniqueConstraint(
                condition=models.Q(("deleted", False)), fields=("team", "name"), name="unique_llm_prompt_name_per_team"
            ),
        ),
        migrations.AddField(
            model_name="organization",
            name="is_active",
            field=models.BooleanField(
                blank=True,
                default=True,
                help_text="Set this to 'No' to temporarily disable an organization.",
                null=True,
                verbose_name="active",
            ),
        ),
        migrations.AddField(
            model_name="organization",
            name="is_not_active_reason",
            field=models.TextField(
                blank=True,
                help_text="(optional) reason for why the organization has been de-activated. This will be displayed to users on the web app.",
                max_length=200,
                null=True,
                verbose_name="de-activated reason",
            ),
        ),
        migrations.AddField(
            model_name="scheduledchange",
            name="end_date",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="scheduledchange",
            name="is_recurring",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="scheduledchange",
            name="last_executed_at",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="scheduledchange",
            name="recurrence_interval",
            field=models.CharField(
                blank=True,
                choices=[("daily", "daily"), ("weekly", "weekly"), ("monthly", "monthly")],
                max_length=20,
                null=True,
            ),
        ),
    ]
