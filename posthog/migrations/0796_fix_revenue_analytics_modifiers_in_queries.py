# Generated by Django 4.2.22 on 2025-07-16 16:38

from django.db import migrations


def remove_revenue_analytics_modifiers(apps, schema_editor):
    Insight = apps.get_model("posthog", "Insight")

    # Find all dashboard items that have the revenue analytics modifiers
    items_to_update = Insight.objects.raw("""
        SELECT * FROM posthog_dashboarditem
        WHERE query->'source'->'modifiers' ? 'revenueAnalyticsPersonsJoinMode'
           OR query->'source'->'modifiers' ? 'revenueAnalyticsPersonsJoinModeCustom'
    """)

    for item in items_to_update:
        if item.query and "source" in item.query and "modifiers" in item.query["source"]:
            modifiers = item.query["source"]["modifiers"]

            # Remove the specific modifiers if they exist
            if "revenueAnalyticsPersonsJoinMode" in modifiers:
                del modifiers["revenueAnalyticsPersonsJoinMode"]

            if "revenueAnalyticsPersonsJoinModeCustom" in modifiers:
                del modifiers["revenueAnalyticsPersonsJoinModeCustom"]

            # Save the updated item
            item.save()


def reverse_remove_revenue_analytics_modifiers(apps, schema_editor):
    # This migration is not reversible since we're removing data
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0795_add_progress_tracking_to_datamodelingjob"),
    ]

    operations = [
        migrations.RunPython(
            remove_revenue_analytics_modifiers,
            reverse_remove_revenue_analytics_modifiers,
        ),
    ]
