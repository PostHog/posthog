# Generated by Django 3.0.6 on 2020-06-25 10:24

import secrets

from django.db import migrations, models

from posthog.models import Filter


def forwards_func(apps, schema_editor):
    Dashboard = apps.get_model("posthog", "Dashboard")
    DashboardItem = apps.get_model("posthog", "DashboardItem")
    dashboards = Dashboard.objects.all()
    for dashboard in dashboards:
        dashboard.share_token = secrets.token_urlsafe(22)
        dashboard.save()

    items = DashboardItem.objects.filter(filters__isnull=False)
    for item in items:
        if item.filters == {}:
            continue
        if item.filters.get("funnel_id"):
            item.funnel_id = item.filters["funnel_id"]
        item.filters = Filter(data=item.filters).to_dict()
        item.save()


def reverse_func(apps, schema_editor):
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0070_team_event_properties_numerical"),
    ]

    operations = [
        migrations.AddField(
            model_name="dashboard",
            name="is_shared",
            field=models.BooleanField(default=False),
        ),
        migrations.AddField(
            model_name="dashboard",
            name="share_token",
            field=models.CharField(blank=True, max_length=400, null=True),
        ),
        migrations.AddField(
            model_name="dashboard",
            name="last_accessed_at",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="dashboarditem",
            name="funnel",
            field=models.ForeignKey(
                blank=True,
                null=True,
                on_delete=models.deletion.CASCADE,
                to="posthog.Funnel",
            ),
        ),
        migrations.RunPython(forwards_func, reverse_func, elidable=True),
    ]
