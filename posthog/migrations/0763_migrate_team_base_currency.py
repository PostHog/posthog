# Generated by Django 4.2.18 on 2025-06-04 20:34

from django.db import migrations


def migrate_revenue_base_currency(apps, schema_editor):
    """
    Set team base_currency from revenue analytics config if it exists.
    """
    Team = apps.get_model("posthog", "Team")
    TeamRevenueAnalyticsConfig = apps.get_model("posthog", "TeamRevenueAnalyticsConfig")

    teams_updated = 0

    for team in Team.objects.iterator():
        try:
            revenue_config = TeamRevenueAnalyticsConfig.objects.get(team=team)
            if hasattr(revenue_config, "base_currency") and revenue_config.base_currency:
                team.base_currency = revenue_config.base_currency
                team.save()
                teams_updated += 1
        except TeamRevenueAnalyticsConfig.DoesNotExist:
            # No revenue config, keep default USD
            continue
        except Exception:
            # Just ignore, this has finished running in prod already, don't need this
            continue


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0762_team_base_currency"),
    ]

    operations = [
        # Migrate existing base_currency data from revenue configs to team
        migrations.RunPython(
            migrate_revenue_base_currency,
            migrations.RunPython.noop,
        ),
    ]
