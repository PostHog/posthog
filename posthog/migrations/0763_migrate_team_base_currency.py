# Generated by Django 4.2.18 on 2025-06-04 20:34

from django.db import migrations
import structlog

logger = structlog.get_logger(__name__)


def migrate_revenue_base_currency(apps, schema_editor):
    """
    Set team base_currency from revenue analytics config if it exists.
    """
    Team = apps.get_model("posthog", "Team")
    TeamRevenueAnalyticsConfig = apps.get_model("posthog", "TeamRevenueAnalyticsConfig")

    teams_updated = 0

    for team in Team.objects.iterator():
        try:
            revenue_config = TeamRevenueAnalyticsConfig.objects.get(team=team)
            if hasattr(revenue_config, "base_currency") and revenue_config.base_currency:
                team.base_currency = revenue_config.base_currency
                team.save()
                teams_updated += 1
                logger.debug(
                    "Updated team base currency from revenue config",
                    team_id=team.id,
                    base_currency=revenue_config.base_currency,
                )
        except TeamRevenueAnalyticsConfig.DoesNotExist:
            # No revenue config, keep default USD
            continue
        except Exception as e:
            logger.error("Failed to migrate base currency for team", team_id=team.id, error=str(e), exc_info=True)
            continue

    logger.info("Revenue base currency migration completed", teams_updated=teams_updated)


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0762_team_base_currency"),
    ]

    operations = [
        # Migrate existing base_currency data from revenue configs to team
        migrations.RunPython(
            migrate_revenue_base_currency,
            migrations.RunPython.noop,
        ),
    ]
