# Generated by Django 4.2.22 on 2025-09-19 06:00

from django.db import migrations


def update_linkedin_api_version(apps, schema_editor):
    from posthog.cdp.validation import compile_hog
    HogFunction = apps.get_model("posthog", "HogFunction")
    
    linkedin_destinations = HogFunction.objects.filter(
        type="destination",
        deleted=False,
        template_id="template-linkedin-ads"
    )
    
    updated_count = 0
    for destination in linkedin_destinations:
        if destination.hog and "'LinkedIn-Version': '202409'" in destination.hog:
            destination.hog = destination.hog.replace(
                "'LinkedIn-Version': '202409'",
                "'LinkedIn-Version': '202508'"
            )
            destination.bytecode = compile_hog(destination.hog, destination.type)
            destination.save(update_fields=['hog', 'bytecode'])
            updated_count += 1
    
    print(f"Updated {updated_count} LinkedIn destinations with new API version")

class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0859_alter_team_session_recording_retention_period"),
    ]

    operations = [
        migrations.RunPython(
            update_linkedin_api_version,
        ), 
    ]
