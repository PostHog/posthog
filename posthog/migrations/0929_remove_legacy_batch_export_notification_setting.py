# Generated by Django 4.2.26 on 2025-12-02 17:08

from django.db import migrations


def remove_legacy_notification_key(apps, schema_editor):
    """
    Remove the legacy 'batch_export_run_failure' key from user notification settings.

    Context:
    - The key was added in PR #21609 (commit dd4a968e) on Apr 19, 2024
    - It was removed in PR #25219 (commit fa152e88) on Oct 3, 2024 when batch export
      notifications were unified under the 'plugin_disabled' setting
    - However, no backfill was done to remove the key from existing users

    Impact:
    - ~91 users in US, ~33 users in EU who set this preference between Apr-Oct 2024
      still have the key in their partial_notification_settings
    - When they try to update any notification setting, the frontend spreads their
      existing settings and the backend rejects the unknown key with:
      "Key batch_export_run_failure is not valid as a key for notification settings"

    To check affected users before running:
        SELECT id, email, partial_notification_settings, date_joined
        FROM posthog_user
        WHERE partial_notification_settings ? 'batch_export_run_failure';

    To verify no new users are affected (should return 0):
        SELECT COUNT(*) FROM posthog_user
        WHERE partial_notification_settings ? 'batch_export_run_failure'
          AND date_joined > '2024-10-03';

    To fix manually if needed:
        UPDATE posthog_user
        SET partial_notification_settings = partial_notification_settings - 'batch_export_run_failure'
        WHERE partial_notification_settings ? 'batch_export_run_failure';
    """
    User = apps.get_model("posthog", "User")
    users_with_legacy_key = User.objects.filter(partial_notification_settings__has_key="batch_export_run_failure")

    for user in users_with_legacy_key.iterator():
        del user.partial_notification_settings["batch_export_run_failure"]
        user.save(update_fields=["partial_notification_settings"])


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("posthog", "0928_add_team_require_evaluation_tags"),
    ]

    operations = [
        migrations.RunPython(remove_legacy_notification_key, migrations.RunPython.noop),
    ]
