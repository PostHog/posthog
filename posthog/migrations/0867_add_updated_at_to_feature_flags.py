# Generated by Django 4.2.22 on 2025-07-23 18:46

from django.db import migrations, models


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0866_add_integration_to_batch_export_destination"),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            state_operations=[
                migrations.AddField(
                    model_name="featureflag",
                    name="updated_at",
                    field=models.DateTimeField(null=True),
                ),
            ],
            database_operations=[
                # Forces creation of the field in the database to allow for the SQL update to work
                migrations.AddField(
                    model_name="featureflag",
                    name="updated_at",
                    field=models.DateTimeField(null=True),
                ),
                migrations.RunSQL(
                    sql="""
                    UPDATE posthog_featureflag flag
                    SET updated_at = last_flag_activity.latest_created_at
                    FROM (
                        SELECT log.item_id, log.team_id, MAX(log.created_at) AS latest_created_at
                        FROM posthog_activitylog log
                        WHERE log.scope = 'FeatureFlag'
                        AND log.activity = 'updated'
                        GROUP BY log.team_id, log.item_id
                    ) last_flag_activity
                    WHERE CAST(flag.id AS VARCHAR) = last_flag_activity.item_id
                    AND flag.team_id = last_flag_activity.team_id;
                    """,
                    reverse_sql="UPDATE posthog_featureflag SET updated_at = NULL WHERE updated_at IS NOT NULL;",
                ),
                migrations.RunSQL(
                    sql="""
                    UPDATE posthog_featureflag
                    SET updated_at = created_at
                    WHERE updated_at IS NULL;
                    """,
                    reverse_sql="UPDATE posthog_featureflag SET updated_at = NULL WHERE updated_at IS NOT NULL;",
                ),
            ],
        ),
        # Alter the field so that after the migration Django will auto-update it on save
        migrations.AlterField(
            model_name="featureflag",
            name="updated_at",
            field=models.DateTimeField(auto_now=True, null=True),
        ),
    ]
