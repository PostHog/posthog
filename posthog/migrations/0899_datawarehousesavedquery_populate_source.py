# Generated by Django 4.2.22 on 2025-10-29 08:15

from django.db import migrations

CHUNK_SIZE = 1000


def forwards_func(apps, schema_editor):
    SavedQuery = apps.get_model("posthog", "DataWarehouseSavedQuery")

    chunk = []
    for query in (
        SavedQuery.objects.filter(managed_viewset__isnull=False).only("id", "source").iterator(chunk_size=CHUNK_SIZE)
    ):
        query.source = "revenue_analytics"
        chunk.append(query)

        if len(chunk) == CHUNK_SIZE:
            SavedQuery.objects.bulk_update(chunk, ["source"])
            chunk = []

    if chunk:
        SavedQuery.objects.bulk_update(chunk, ["source"])

    chunk = []
    for query in (
        SavedQuery.objects.filter(managed_viewset__isnull=True).only("id", "source").iterator(chunk_size=CHUNK_SIZE)
    ):
        query.source = "root"
        chunk.append(query)

        if len(chunk) == CHUNK_SIZE:
            SavedQuery.objects.bulk_update(chunk, ["source"])
            chunk = []

    if chunk:
        SavedQuery.objects.bulk_update(chunk, ["source"])


def reverse_func(apps, schema_editor):
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0898_datawarehousemanagedviewset_change_unique_constraint"),
    ]

    operations = [
        migrations.RunPython(forwards_func, reverse_func),
    ]
