# Generated by Django 3.1.12 on 2021-10-05 13:06

from django.db import migrations


class Migration(migrations.Migration):

    dependencies = [
        ("posthog", "0172_person_properties_last_operation"),
    ]

    operations = [
        migrations.RunSQL(
            """
        -- not-null-ignore
        CREATE OR REPLACE FUNCTION should_update_person_prop(
            in person_id int, 
            in prop_key text, 
            in _timestamp text, 
            in operation text, 
            out should_update bool
        )
        AS $$ 
            SELECT NOT property_exists OR
            (operation='set' AND is_timestamp_newer) OR
            (last_operation='set_once' AND NOT is_timestamp_newer)
            FROM (
                SELECT 
                    properties->prop_key IS NOT NULL as property_exists, 
                    _timestamp > COALESCE(properties_last_updated_at ->> prop_key, '0') as is_timestamp_newer, 
                    COALESCE(properties_last_operation ->> prop_key, '') as last_operation 
                    FROM posthog_person
                    WHERE id=person_id
            ) as person_props
        $$
        LANGUAGE SQL;
        """
        )
    ]
