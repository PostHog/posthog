# Generated by Django 4.2.28 on 2026-02-18 08:16

import django.contrib.postgres.indexes
from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False

    replaces = [
        ("posthog", "0850_add_activitylog_org_scope_created_at"),
        ("posthog", "0851_add_activitylog_org_detail_exists_index"),
        ("posthog", "0852_alter_integration_kind"),
        ("posthog", "0853_create_index_populate_updated_at_flags"),
        ("posthog", "0854_add_activitylog_detail_gin_path_ops_index"),
        ("posthog", "0855_alter_exportedasset_export_format"),
        ("posthog", "0856_add_web_analytics_tables_version"),
        ("posthog", "0857_dashboardtile_filters_overrides"),
        ("posthog", "0858_datamodelingjob_storage_delta_mib_and_more"),
        ("posthog", "0859_alter_team_session_recording_retention_period"),
    ]

    dependencies = [
        ("posthog", "0849_duplicate_warehouse_tables"),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql=[
                        "CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_alog_org_scope_created_at ON posthog_activitylog (organization_id, scope, created_at DESC) WHERE detail IS NOT NULL AND jsonb_typeof(detail) = 'object';"
                    ],
                    reverse_sql=["DROP INDEX IF EXISTS idx_alog_org_scope_created_at;"],
                ),
            ],
            state_operations=[
                migrations.AddIndex(
                    model_name="activitylog",
                    index=models.Index(
                        condition=models.Q(("detail__isnull", False), ("detail__jsonb_typeof", "object")),
                        fields=["organization_id", "scope", "-created_at"],
                        name="idx_alog_org_scope_created_at",
                    ),
                ),
            ],
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql=[
                        "CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_alog_org_detail_exists ON posthog_activitylog (organization_id) WHERE detail IS NOT NULL AND jsonb_typeof(detail) = 'object';"
                    ],
                    reverse_sql=["DROP INDEX IF EXISTS idx_alog_org_detail_exists;"],
                ),
            ],
            state_operations=[
                migrations.AddIndex(
                    model_name="activitylog",
                    index=models.Index(
                        condition=models.Q(("detail__isnull", False), ("detail__jsonb_typeof", "object")),
                        fields=["organization_id"],
                        name="idx_alog_org_detail_exists",
                    ),
                ),
            ],
        ),
        migrations.AlterField(
            model_name="integration",
            name="kind",
            field=models.CharField(
                choices=[
                    ("slack", "Slack"),
                    ("salesforce", "Salesforce"),
                    ("hubspot", "Hubspot"),
                    ("google-pubsub", "Google Pubsub"),
                    ("google-cloud-storage", "Google Cloud Storage"),
                    ("google-ads", "Google Ads"),
                    ("google-sheets", "Google Sheets"),
                    ("snapchat", "Snapchat"),
                    ("linkedin-ads", "Linkedin Ads"),
                    ("reddit-ads", "Reddit Ads"),
                    ("intercom", "Intercom"),
                    ("email", "Email"),
                    ("linear", "Linear"),
                    ("github", "Github"),
                    ("meta-ads", "Meta Ads"),
                    ("twilio", "Twilio"),
                    ("clickup", "Clickup"),
                    ("vercel", "Vercel"),
                ],
                max_length=20,
            ),
        ),
        migrations.RunSQL(
            sql="\n            CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_activitylog_featureflag_updates\n            ON posthog_activitylog (team_id, item_id, created_at DESC)\n            WHERE scope = 'FeatureFlag' AND activity = 'updated';\n            ",
            reverse_sql="DROP INDEX IF EXISTS idx_activitylog_featureflag_updates;",
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql=[
                        "CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_alog_detail_gin_path_ops ON posthog_activitylog USING GIN (detail jsonb_path_ops);"
                    ],
                    reverse_sql=["DROP INDEX IF EXISTS idx_alog_detail_gin_path_ops;"],
                ),
            ],
            state_operations=[
                migrations.AddIndex(
                    model_name="activitylog",
                    index=django.contrib.postgres.indexes.GinIndex(
                        condition=models.Q(("detail__isnull", False)),
                        fields=["detail"],
                        name="idx_alog_detail_gin_path_ops",
                        opclasses=["jsonb_path_ops"],
                    ),
                ),
            ],
        ),
        migrations.AlterField(
            model_name="exportedasset",
            name="export_format",
            field=models.CharField(
                choices=[
                    ("image/png", "image/png"),
                    ("application/pdf", "application/pdf"),
                    ("text/csv", "text/csv"),
                    (
                        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                        "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                    ),
                    ("video/webm", "video/webm"),
                    ("video/mp4", "video/mp4"),
                    ("image/gif", "image/gif"),
                    ("application/json", "application/json"),
                ],
                max_length=100,
            ),
        ),
        migrations.AddField(
            model_name="team",
            name="web_analytics_pre_aggregated_tables_version",
            field=models.CharField(choices=[("v1", "v1"), ("v2", "v2")], default="v2", max_length=10, null=True),
        ),
        migrations.AddField(
            model_name="dashboardtile",
            name="filters_overrides",
            field=models.JSONField(blank=True, default=dict, null=True),
        ),
        migrations.AddField(
            model_name="datamodelingjob",
            name="storage_delta_mib",
            field=models.FloatField(blank=True, default=0, null=True),
        ),
        migrations.AddField(
            model_name="externaldatajob",
            name="storage_delta_mib",
            field=models.FloatField(blank=True, default=0, null=True),
        ),
        migrations.AlterField(
            model_name="team",
            name="session_recording_retention_period",
            field=models.CharField(
                choices=[
                    ("legacy", "Legacy Retention"),
                    ("30d", "30 Days"),
                    ("90d", "90 Days"),
                    ("1y", "1 Year"),
                    ("5y", "5 Years"),
                ],
                default="30d",
                max_length=6,
            ),
        ),
    ]
