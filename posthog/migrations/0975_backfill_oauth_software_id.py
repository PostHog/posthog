# Generated by Django 4.2 on 2026-01-15

from django.db import migrations

# Known partner patterns for deriving software_id from client_name
# Format: (pattern_substring, software_id)
KNOWN_PARTNER_PATTERNS = [
    ("replit", "replit"),
    ("claude code", "claude-code"),
    ("claude-code", "claude-code"),
    ("claudecode", "claude-code"),
    ("cursor", "cursor"),
    ("windsurf", "windsurf"),
    ("zed", "zed"),
    ("vscode", "vscode"),
    ("visual studio code", "vscode"),
    ("vs code", "vscode"),
    ("cline", "cline"),
    ("continue", "continue"),
    ("cody", "cody"),
    ("roo", "roo"),
    ("roocode", "roo"),
]


def derive_software_id_from_name(client_name: str | None) -> str | None:
    """Derive software_id from client_name by matching known patterns."""
    if not client_name:
        return None
    lower_name = client_name.lower()
    for pattern, software_id in KNOWN_PARTNER_PATTERNS:
        if pattern in lower_name:
            return software_id
    return None


def backfill_software_id(apps, schema_editor):
    """Backfill software_id for existing OAuth applications based on client_name."""
    OAuthApplication = apps.get_model("posthog", "OAuthApplication")

    # Only update clients that don't have software_id set
    apps_to_update = OAuthApplication.objects.filter(software_id__isnull=True)

    updated_count = 0
    for app in apps_to_update:
        software_id = derive_software_id_from_name(app.name)
        if software_id:
            app.software_id = software_id
            app.save(update_fields=["software_id"])
            updated_count += 1

    if updated_count > 0:
        print(f"Backfilled software_id for {updated_count} OAuth applications")


def reverse_backfill(apps, schema_editor):
    """Reverse migration - clear all software_id values."""
    OAuthApplication = apps.get_model("posthog", "OAuthApplication")
    OAuthApplication.objects.filter(software_id__isnull=False).update(software_id=None)


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0974_oauth_software_id"),
    ]

    operations = [
        migrations.RunPython(backfill_software_id, reverse_backfill),
    ]
