# Generated by Django 4.2 on 2026-01-15

import re

from django.db import migrations

# Known partner patterns for deriving software_id from client_name
# Format: (pattern, software_id) - patterns use word boundary matching to avoid false positives
KNOWN_PARTNER_PATTERNS = [
    ("replit", "replit"),
    ("claude code", "claude-code"),
    ("claude-code", "claude-code"),
    ("claudecode", "claude-code"),
    ("cursor", "cursor"),
    ("windsurf", "windsurf"),
    ("zed", "zed"),
    ("vscode", "vscode"),
    ("visual studio code", "vscode"),
    ("vs code", "vscode"),
    ("cline", "cline"),
    ("continue", "continue"),
    ("cody", "cody"),
    ("roocode", "roo"),
    ("roo", "roo"),
]


def _matches_word_boundary(text: str, pattern: str) -> bool:
    """Check if pattern matches at word boundaries in text."""
    return bool(re.search(rf"\b{re.escape(pattern)}\b", text))


def derive_software_id_from_name(client_name: str | None) -> str | None:
    """Derive software_id from client_name by matching known patterns at word boundaries."""
    if not client_name:
        return None
    lower_name = client_name.lower()
    for pattern, software_id in KNOWN_PARTNER_PATTERNS:
        if _matches_word_boundary(lower_name, pattern):
            return software_id
    return None


def backfill_software_id(apps, schema_editor):
    """Backfill software_id for existing OAuth applications based on client_name."""
    OAuthApplication = apps.get_model("posthog", "OAuthApplication")

    # Only update clients that don't have software_id set
    apps_to_update = OAuthApplication.objects.filter(software_id__isnull=True)

    apps_with_software_id = []
    for app in apps_to_update:
        software_id = derive_software_id_from_name(app.name)
        if software_id:
            app.software_id = software_id
            apps_with_software_id.append(app)

    if apps_with_software_id:
        OAuthApplication.objects.bulk_update(apps_with_software_id, ["software_id"], batch_size=500)
        print(f"Backfilled software_id for {len(apps_with_software_id)} OAuth applications")


def reverse_backfill(apps, schema_editor):
    """Reverse migration - clear all software_id values."""
    OAuthApplication = apps.get_model("posthog", "OAuthApplication")
    OAuthApplication.objects.filter(software_id__isnull=False).update(software_id=None)


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0974_oauth_software_id"),
    ]

    operations = [
        migrations.RunPython(backfill_software_id, reverse_backfill),
    ]
