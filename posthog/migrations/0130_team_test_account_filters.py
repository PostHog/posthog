# Generated by Django 3.0.6 on 2021-02-25 17:58

import re

import django.contrib.postgres.fields.jsonb
from django.db import migrations
from django.db.models.query_utils import Q

from posthog.utils import GenericEmails


def forward(apps, schema_editor):
    Team = apps.get_model("posthog", "Team")

    for team in Team.objects.all():
        filters = [
            {
                "key": "$host",
                "operator": "is_not",
                "value": ["localhost:8000", "localhost:5000", "127.0.0.1:8000", "127.0.0.1:3000"],
            },
        ]
        if team.organization:
            example_emails = team.organization.members.only("email")
            generic_emails = GenericEmails()
            example_emails = [email.email for email in example_emails if not generic_emails.is_generic(email.email)]
            if len(example_emails) > 0:
                example_email = re.search("@[\w.]+", example_emails[0])
                if example_email:
                    filters += [
                        {"key": "email", "operator": "not_icontains", "value": example_email.group(), "type": "person"},
                    ]
        team.test_account_filters = filters
        team.save()


def reverse(apps, schema_editor):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ("posthog", "0129_merge_20210223_0757"),
    ]

    operations = [
        migrations.AddField(
            model_name="team",
            name="test_account_filters",
            field=django.contrib.postgres.fields.jsonb.JSONField(default=list),
        ),
        migrations.RunPython(forward, reverse),
    ]
