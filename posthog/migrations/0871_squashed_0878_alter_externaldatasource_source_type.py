# Generated by Django 4.2.28 on 2026-02-18 08:16

from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False

    replaces = [
        ("posthog", "0871_team_experiment_recalculation_time"),
        ("posthog", "0872_alter_externaldatasource_source_type"),
        ("posthog", "0873_alter_cohortpeople_options_and_more"),
        ("posthog", "0874_activitylog_idx_alog_org_created_at_and_more"),
        ("posthog", "0875_activitylog_idx_alog_team_scope_created"),
        ("posthog", "0876_add_marketing_analytics_attribution_settings"),
        ("posthog", "0877_delete_named_query_from_state"),
        ("posthog", "0878_alter_externaldatasource_source_type"),
    ]

    dependencies = [
        ("posthog", "0870_move_recording_coment_to_replay"),
    ]

    operations = [
        migrations.AddField(
            model_name="team",
            name="experiment_recalculation_time",
            field=models.TimeField(
                blank=True,
                help_text="Time of day (UTC) when experiment metrics should be recalculated. If not set, uses the default recalculation time.",
                null=True,
            ),
        ),
        migrations.AlterField(
            model_name="externaldatasource",
            name="source_type",
            field=models.CharField(
                choices=[
                    ("Stripe", "Stripe"),
                    ("Hubspot", "Hubspot"),
                    ("Postgres", "Postgres"),
                    ("Zendesk", "Zendesk"),
                    ("Snowflake", "Snowflake"),
                    ("Salesforce", "Salesforce"),
                    ("MySQL", "MySQL"),
                    ("MongoDB", "MongoDB"),
                    ("MSSQL", "MSSQL"),
                    ("Vitally", "Vitally"),
                    ("BigQuery", "BigQuery"),
                    ("Chargebee", "Chargebee"),
                    ("GoogleAds", "GoogleAds"),
                    ("TemporalIO", "TemporalIO"),
                    ("DoIt", "DoIt"),
                    ("GoogleSheets", "GoogleSheets"),
                    ("MetaAds", "MetaAds"),
                    ("Klaviyo", "Klaviyo"),
                    ("Mailchimp", "Mailchimp"),
                    ("Braze", "Braze"),
                    ("Mailjet", "Mailjet"),
                    ("Redshift", "Redshift"),
                    ("Polar", "Polar"),
                    ("RevenueCat", "RevenueCat"),
                    ("LinkedinAds", "LinkedinAds"),
                    ("RedditAds", "RedditAds"),
                    ("TikTokAds", "TikTokAds"),
                ],
                max_length=128,
            ),
        ),
        migrations.AlterModelOptions(
            name="cohortpeople",
            options={"managed": False},
        ),
        migrations.AlterModelOptions(
            name="featureflaghashkeyoverride",
            options={"managed": False},
        ),
        migrations.AlterModelOptions(
            name="flatpersonoverride",
            options={"managed": False},
        ),
        migrations.AlterModelOptions(
            name="group",
            options={"managed": False},
        ),
        migrations.AlterModelOptions(
            name="grouptypemapping",
            options={"managed": False},
        ),
        migrations.AlterModelOptions(
            name="pendingpersonoverride",
            options={"managed": False},
        ),
        migrations.AlterModelOptions(
            name="person",
            options={"managed": False},
        ),
        migrations.AlterModelOptions(
            name="persondistinctid",
            options={"managed": False},
        ),
        migrations.AlterModelOptions(
            name="personlessdistinctid",
            options={"managed": False},
        ),
        migrations.AlterModelOptions(
            name="personoverride",
            options={"managed": False},
        ),
        migrations.AlterModelOptions(
            name="personoverridemapping",
            options={"managed": False},
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql=[
                        "CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_alog_team_scp_act_crtd ON posthog_activitylog (team_id, scope, activity, created_at DESC) WHERE (NOT was_impersonated) AND (NOT is_system);"
                    ],
                    reverse_sql=["DROP INDEX CONCURRENTLY IF EXISTS idx_alog_team_scp_act_crtd;"],
                ),
            ],
            state_operations=[
                migrations.AddIndex(
                    model_name="activitylog",
                    index=models.Index(
                        condition=models.Q(("was_impersonated", False), ("is_system", False)),
                        fields=["team_id", "scope", "activity", "-created_at"],
                        name="idx_alog_team_scp_act_crtd",
                    ),
                ),
            ],
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql=[
                        "CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_alog_team_scope_created ON posthog_activitylog (team_id, scope, created_at DESC) WHERE (NOT was_impersonated) AND (NOT is_system);"
                    ],
                    reverse_sql=["DROP INDEX CONCURRENTLY IF EXISTS idx_alog_team_scope_created;"],
                ),
            ],
            state_operations=[
                migrations.AddIndex(
                    model_name="activitylog",
                    index=models.Index(
                        condition=models.Q(("was_impersonated", False), ("is_system", False)),
                        fields=["team_id", "scope", "-created_at"],
                        name="idx_alog_team_scope_created",
                    ),
                ),
            ],
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql=[
                        "CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_alog_team_act_scope_usr ON posthog_activitylog (team_id, activity, scope, user_id) WHERE (NOT was_impersonated) AND (NOT is_system);"
                    ],
                    reverse_sql=["DROP INDEX CONCURRENTLY IF EXISTS idx_alog_team_act_scope_usr;"],
                ),
            ],
            state_operations=[
                migrations.AddIndex(
                    model_name="activitylog",
                    index=models.Index(
                        condition=models.Q(("was_impersonated", False), ("is_system", False)),
                        fields=["team_id", "activity", "scope", "user"],
                        name="idx_alog_team_act_scope_usr",
                    ),
                ),
            ],
        ),
        migrations.AddField(
            model_name="teammarketinganalyticsconfig",
            name="attribution_mode",
            field=models.CharField(
                choices=[("first_touch", "First Touch"), ("last_touch", "Last Touch")],
                default="last_touch",
                help_text="Attribution mode: first_touch or last_touch",
                max_length=20,
            ),
        ),
        migrations.AddField(
            model_name="teammarketinganalyticsconfig",
            name="attribution_window_days",
            field=models.IntegerField(default=90, help_text="Attribution window in days (1-90)"),
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql="\n                        ALTER TABLE posthog_namedquery DROP CONSTRAINT IF EXISTS posthog_namedquery_created_by_id_4fe5251a_fk_posthog_user_id;\n                        ALTER TABLE posthog_namedquery DROP CONSTRAINT IF EXISTS posthog_namedquery_team_id_584054f1_fk_posthog_team_id;\n                    ",
                    reverse_sql="",
                ),
            ],
            state_operations=[
                migrations.DeleteModel(
                    name="NamedQuery",
                ),
            ],
        ),
        migrations.AlterField(
            model_name="externaldatasource",
            name="source_type",
            field=models.CharField(
                choices=[
                    ("Stripe", "Stripe"),
                    ("Hubspot", "Hubspot"),
                    ("Postgres", "Postgres"),
                    ("Zendesk", "Zendesk"),
                    ("Snowflake", "Snowflake"),
                    ("Salesforce", "Salesforce"),
                    ("MySQL", "MySQL"),
                    ("MongoDB", "MongoDB"),
                    ("MSSQL", "MSSQL"),
                    ("Vitally", "Vitally"),
                    ("BigQuery", "BigQuery"),
                    ("Chargebee", "Chargebee"),
                    ("GoogleAds", "GoogleAds"),
                    ("TemporalIO", "TemporalIO"),
                    ("DoIt", "DoIt"),
                    ("GoogleSheets", "GoogleSheets"),
                    ("MetaAds", "MetaAds"),
                    ("Klaviyo", "Klaviyo"),
                    ("Mailchimp", "Mailchimp"),
                    ("Braze", "Braze"),
                    ("Mailjet", "Mailjet"),
                    ("Redshift", "Redshift"),
                    ("Polar", "Polar"),
                    ("RevenueCat", "RevenueCat"),
                    ("LinkedinAds", "LinkedinAds"),
                    ("RedditAds", "RedditAds"),
                    ("TikTokAds", "TikTokAds"),
                    ("Shopify", "Shopify"),
                ],
                max_length=128,
            ),
        ),
    ]
