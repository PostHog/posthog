# Generated by Django 4.2.22 on 2025-09-11 14:39

from django.db import migrations


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0848_activitylog_detail_gin_index"),
    ]

    operations = [
        migrations.RunSQL(
            """
        WITH duplicates AS (
            SELECT external_data_source_id, name
            FROM posthog_datawarehousetable
            WHERE deleted = false
            GROUP BY 1, 2
            HAVING COUNT(*) > 1
        ),
        correct AS (
            SELECT dwt.external_data_source_id, dwt.name, dwt.id AS correct_table_id
            FROM posthog_externaldataschema eds
            JOIN posthog_datawarehousetable dwt ON dwt.id = eds.table_id
            WHERE dwt.deleted = false
        ),
        to_delete AS (
            SELECT dwt.id
            FROM posthog_datawarehousetable dwt
            JOIN duplicates dup ON dup.external_data_source_id = dwt.external_data_source_id AND dup.name = dwt.name
            LEFT JOIN correct c ON c.external_data_source_id = dwt.external_data_source_id AND c.name = dwt.name
            WHERE dwt.deleted = false AND (c.correct_table_id IS NULL OR dwt.id != c.correct_table_id)
        )
        UPDATE posthog_datawarehousetable dwt
        SET deleted = true, deleted_at = now()
        FROM to_delete td
        WHERE dwt.id = td.id""",
            reverse_sql=migrations.RunSQL.noop,
        )
    ]
