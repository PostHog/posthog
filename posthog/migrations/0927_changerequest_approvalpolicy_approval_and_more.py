# Generated by Django 4.2.22 on 2025-10-13 09:00

import datetime

import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models

import posthog.models.utils


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0926_featureflag_bucketing_identifier"),
    ]

    operations = [
        migrations.CreateModel(
            name="ChangeRequest",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("action_key", models.CharField(max_length=128)),
                ("action_version", models.IntegerField(default=1)),
                ("resource_type", models.CharField(max_length=64)),
                ("resource_id", models.CharField(blank=True, max_length=128, null=True)),
                ("intent", models.JSONField()),
                ("intent_display", models.JSONField()),
                ("policy_snapshot", models.JSONField()),
                (
                    "validation_status",
                    models.CharField(
                        choices=[
                            ("valid", "Valid"),
                            ("invalid", "Invalid"),
                            ("expired", "Expired"),
                            ("stale", "Stale (resource changed)"),
                        ],
                        default="valid",
                        max_length=16,
                    ),
                ),
                ("validation_errors", models.JSONField(blank=True, null=True)),
                ("validated_at", models.DateTimeField(blank=True, null=True)),
                (
                    "state",
                    models.CharField(
                        choices=[
                            ("pending", "Pending"),
                            ("approved", "Approved (awaiting application)"),
                            ("applied", "Applied"),
                            ("rejected", "Rejected"),
                            ("expired", "Expired"),
                            ("failed", "Failed to apply"),
                        ],
                        default="pending",
                        max_length=16,
                    ),
                ),
                (
                    "created_by",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL, null=True, blank=True
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True, null=True, blank=True)),
                ("expires_at", models.DateTimeField()),
                ("applied_at", models.DateTimeField(blank=True, null=True)),
                ("apply_error", models.TextField(blank=True)),
                ("result_data", models.JSONField(blank=True, null=True)),
                (
                    "applied_by",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="change_requests_applied",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "organization",
                    models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.organization"),
                ),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
            ],
            options={
                "ordering": ["-created_at"],
            },
        ),
        migrations.CreateModel(
            name="ApprovalPolicy",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("action_key", models.CharField(max_length=128)),
                ("conditions", models.JSONField(default=dict)),
                ("approver_config", models.JSONField()),
                ("allow_self_approve", models.BooleanField(default=False)),
                ("bypass_roles", models.JSONField(default=list)),
                (
                    "created_by",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL, null=True, blank=True
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True, null=True, blank=True)),
                (
                    "expires_after",
                    models.DurationField(
                        default=datetime.timedelta(days=14), help_text="Auto-expire change requests after this duration"
                    ),
                ),
                ("enabled", models.BooleanField(default=True)),
                (
                    "organization",
                    models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.organization"),
                ),
                (
                    "team",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to="posthog.team"
                    ),
                ),
            ],
            options={
                "verbose_name_plural": "Approval policies",
            },
        ),
        migrations.CreateModel(
            name="Approval",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                (
                    "decision",
                    models.CharField(choices=[("approved", "Approved"), ("rejected", "Rejected")], max_length=16),
                ),
                ("reason", models.TextField(blank=True)),
                (
                    "created_by",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL, null=True, blank=True
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True, null=True, blank=True)),
                (
                    "change_request",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="approvals",
                        to="posthog.changerequest",
                    ),
                ),
            ],
        ),
        migrations.AddIndex(
            model_name="changerequest",
            index=models.Index(fields=["team", "state"], name="posthog_cha_team_id_0a5974_idx"),
        ),
        migrations.AddIndex(
            model_name="changerequest",
            index=models.Index(fields=["action_key", "state"], name="posthog_cha_action__2d384d_idx"),
        ),
        migrations.AddIndex(
            model_name="changerequest",
            index=models.Index(fields=["expires_at"], name="posthog_cha_expires_0a6444_idx"),
        ),
        migrations.AddIndex(
            model_name="changerequest",
            index=models.Index(fields=["validation_status", "state"], name="posthog_cha_validat_24672f_idx"),
        ),
        migrations.AddIndex(
            model_name="approvalpolicy",
            index=models.Index(fields=["action_key", "enabled"], name="posthog_app_action__871059_idx"),
        ),
        migrations.AddIndex(
            model_name="approvalpolicy",
            index=models.Index(fields=["organization", "enabled"], name="posthog_app_organiz_36e124_idx"),
        ),
        migrations.AddIndex(
            model_name="approvalpolicy",
            index=models.Index(fields=["team", "enabled"], name="posthog_app_team_id_9f077f_idx"),
        ),
        migrations.AlterUniqueTogether(
            name="approvalpolicy",
            unique_together={("organization", "team", "action_key")},
        ),
        migrations.AddIndex(
            model_name="approval",
            index=models.Index(fields=["change_request", "decision"], name="posthog_app_change__5af5e4_idx"),
        ),
        migrations.AlterUniqueTogether(
            name="approval",
            unique_together={("change_request", "created_by")},
        ),
    ]
