# Generated by Django 4.2.27 on 2026-02-10

from django.db import migrations


def fix_person_property_in_operators(apps, schema_editor):
    """
    Fix feature flags that have person properties with 'in' or 'not_in' operators.

    The Rust flag matching service does not support 'in'/'not_in' operators for
    person properties - these operators are only valid for cohort matching.

    The 'exact' and 'is_not' operators already support array values (checking if
    the person's property value is contained in the array), so we simply change
    the operator name:
    - 'in' -> 'exact'
    - 'not_in' -> 'is_not'
    """
    FeatureFlag = apps.get_model("posthog", "FeatureFlag")

    flags_to_update = []

    for flag in FeatureFlag.objects.filter(deleted=False).iterator(chunk_size=1000):
        if not flag.filters:
            continue

        filters = flag.filters
        modified = False

        # Check groups
        for group in filters.get("groups", []):
            for prop in group.get("properties", []):
                if prop.get("type") == "person" and prop.get("operator") in ("in", "not_in"):
                    prop["operator"] = "exact" if prop["operator"] == "in" else "is_not"
                    modified = True

        # Also check super_groups if present
        for group in filters.get("super_groups", []):
            for prop in group.get("properties", []):
                if prop.get("type") == "person" and prop.get("operator") in ("in", "not_in"):
                    prop["operator"] = "exact" if prop["operator"] == "in" else "is_not"
                    modified = True

        if modified:
            flag.filters = filters  # Reassign to mark JSONField as dirty
            flags_to_update.append(flag)

    if flags_to_update:
        FeatureFlag.objects.bulk_update(flags_to_update, ["filters"], batch_size=500)


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "1000_create_healthissue_table"),
    ]

    operations = [
        migrations.RunPython(fix_person_property_in_operators, migrations.RunPython.noop, elidable=True),
    ]
