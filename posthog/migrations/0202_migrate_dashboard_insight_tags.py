# Generated by Django 3.2.5 on 2022-01-28 21:40
from django.db import migrations

from posthog.models.tagged_item import EnterpriseTaggedItem


def forwards(apps, schema_editor):

    # Create new insight tags
    Insight = apps.get_model("posthog", "Insight")
    for instance in Insight.objects.raw("SELECT * FROM posthog_dashboarditem WHERE tags!='{}' AND tags IS NOT NULL"):
        for tag in instance.tags:
            new_tag = EnterpriseTaggedItem(content_object=instance, tag=tag, team_id=instance.team_id)
            new_tag.save()

    # Create new dashboard tags
    Dashboard = apps.get_model("posthog", "Dashboard")
    for instance in Dashboard.objects.raw("SELECT * FROM posthog_dashboard WHERE tags!='{}' AND tags IS NOT NULL"):
        for tag in instance.tags:
            new_tag = EnterpriseTaggedItem(content_object=instance, tag=tag, team_id=instance.team_id)
            new_tag.save()


def reverse(apps, schema_editor):
    Dashboard = apps.get_model("posthog", "Dashboard")
    for instance in Dashboard.objects.raw("SELECT * FROM posthog_dashboard WHERE tags!='{}' AND tags IS NOT NULL"):
        instance.global_tags.clear()

    Insight = apps.get_model("posthog", "Insight")
    for instance in Insight.objects.raw("SELECT * FROM posthog_dashboarditem WHERE tags!='{}' AND tags IS NOT NULL"):
        instance.global_tags.clear()


class Migration(migrations.Migration):

    dependencies = [
        ("posthog", "0201_global_tags_setup"),
    ]

    operations = [migrations.RunPython(forwards, reverse)]
