# Generated by Django 4.2.15 on 2024-11-04 13:50

from django.db import migrations, connection

from posthog.temporal.data_imports.pipelines.salesforce.settings import INCREMENTAL_ENDPOINTS


def salesforce_schemas(apps, schema_editor):
    with connection.cursor() as cursor:
        cursor.execute(
            "SELECT id, team_id FROM posthog_externaldatasource where source_type = 'Salesforce' and deleted is not true"
        )
        salesforce_sources = cursor.fetchall()

    ExternalDataSchema = apps.get_model("posthog", "ExternalDataSchema")
    for source in salesforce_sources:
        schemas = list(ExternalDataSchema.objects.filter(source_id=source[0]))

        for endpoint in INCREMENTAL_ENDPOINTS:
            if not any(n.name == endpoint for n in schemas):
                schema = ExternalDataSchema.objects.create(
                    name=endpoint,
                    source_id=source[0],
                    team_id=source[1],
                    should_sync=False,
                    sync_type=None,
                    sync_type_config={},
                )
                schema.save()


def reverse(apps, _):
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0509_errortrackingsymbolset_failure_reason"),
    ]

    operations = [
        migrations.RunPython(salesforce_schemas, reverse),
    ]
