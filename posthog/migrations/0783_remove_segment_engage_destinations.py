# Generated by Django 4.2.22 on 2025-07-01 09:45

from django.db import migrations


def remove_engage_destinations(apps, schema_editor):
    """
    Remove broken engage destination templates and their uses
    """
    HogFunction = apps.get_model("posthog", "HogFunction")
    HogFunctionTemplate = apps.get_model("posthog", "HogFunctionTemplate")

    # segment engage destinations
    template_ids_to_remove = [
        "segment-actions-amazon-amc",
        "segment-actions-iterable-lists",
        "segment-actions-marketo-static-lists",
        "segment-actions-s3-csv",
        "segment-actions-taboola-actions",
    ]

    # Mark all HogFunction instances that use these templates as deleted
    HogFunction.objects.filter(template_id__in=template_ids_to_remove).update(deleted=True)

    # Delete the templates themselves
    HogFunctionTemplate.objects.filter(template_id__in=template_ids_to_remove).delete()


def reverse_remove_engage_destinations(apps, schema_editor):
    """
    This migration cannot be reversed as we're deleting data
    """
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0782_remove_segment_hidden_destinations"),
    ]

    operations = [
        migrations.RunPython(
            remove_engage_destinations,
            reverse_remove_engage_destinations,
        ),
    ]
