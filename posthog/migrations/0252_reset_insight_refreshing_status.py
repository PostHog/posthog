# Generated by Django 3.2.14 on 2022-07-26 10:20

from django.db import migrations


def reset_insight_refreshing_status(apps, _) -> None:
    # https://github.com/PostHog/posthog/pull/10960
    # was intended to mark _chosen_ cache update candidates as refreshing earlier in processing
    # but marked all candidate items as refreshing *even when they weren't*
    # This issues two SQL statements to reset the refreshing flag on all potential candidates
    # For most installations this will be a very small number of items
    # It is safe to reprocess items
    DashboardTile = apps.get_model("posthog", "DashboardTile")
    Insight = apps.get_model("posthog", "Insight")

    DashboardTile.objects.filter(refreshing=True).update(refreshing=False)
    Insight.objects.filter(refreshing=True).update(refreshing=False)


def reverse(_apps, _schema_editor) -> None:
    pass


class Migration(migrations.Migration):

    dependencies = [
        ("posthog", "0251_event_buffer"),
    ]

    operations = [
        migrations.RunPython(reset_insight_refreshing_status, reverse),
    ]
