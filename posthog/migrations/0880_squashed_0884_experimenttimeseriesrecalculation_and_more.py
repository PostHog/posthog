# Generated by Django 4.2.28 on 2026-02-18 08:16

import django.db.models.deletion
from django.db import migrations, models

import posthog.models.utils


class Migration(migrations.Migration):
    replaces = [
        ("posthog", "0880_datawarehousetable_queryable_folder"),
        ("posthog", "0881_alter_integration_kind"),
        ("posthog", "0882_add_team_default_evaluation_tags"),
        ("posthog", "0883_featureflag_last_called_at"),
        ("posthog", "0884_experimenttimeseriesrecalculation_and_more"),
    ]

    dependencies = [
        ("posthog", "0879_migrate_error_tracking_models"),
    ]

    operations = [
        migrations.AddField(
            model_name="datawarehousetable",
            name="queryable_folder",
            field=models.CharField(blank=True, max_length=500, null=True),
        ),
        migrations.AlterField(
            model_name="integration",
            name="kind",
            field=models.CharField(
                choices=[
                    ("slack", "Slack"),
                    ("salesforce", "Salesforce"),
                    ("hubspot", "Hubspot"),
                    ("google-pubsub", "Google Pubsub"),
                    ("google-cloud-storage", "Google Cloud Storage"),
                    ("google-ads", "Google Ads"),
                    ("google-sheets", "Google Sheets"),
                    ("snapchat", "Snapchat"),
                    ("linkedin-ads", "Linkedin Ads"),
                    ("reddit-ads", "Reddit Ads"),
                    ("tiktok-ads", "Tiktok Ads"),
                    ("intercom", "Intercom"),
                    ("email", "Email"),
                    ("linear", "Linear"),
                    ("github", "Github"),
                    ("meta-ads", "Meta Ads"),
                    ("twilio", "Twilio"),
                    ("clickup", "Clickup"),
                    ("vercel", "Vercel"),
                    ("databricks", "Databricks"),
                ],
                max_length=20,
            ),
        ),
        migrations.AddField(
            model_name="team",
            name="default_evaluation_environments_enabled",
            field=models.BooleanField(
                blank=True,
                default=False,
                help_text="Whether to automatically apply default evaluation environments to new feature flags",
                null=True,
            ),
        ),
        migrations.CreateModel(
            name="TeamDefaultEvaluationTag",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "tag",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE, related_name="team_defaults", to="posthog.tag"
                    ),
                ),
                (
                    "team",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="default_evaluation_tags",
                        to="posthog.team",
                    ),
                ),
            ],
            options={
                "unique_together": {("team", "tag")},
            },
        ),
        migrations.AddField(
            model_name="featureflag",
            name="last_called_at",
            field=models.DateTimeField(
                blank=True,
                help_text="Last time this feature flag was called (from $feature_flag_called events)",
                null=True,
            ),
        ),
        migrations.CreateModel(
            name="ExperimentTimeseriesRecalculation",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("metric", models.JSONField()),
                ("fingerprint", models.CharField(max_length=64)),
                (
                    "status",
                    models.CharField(
                        choices=[
                            ("pending", "Pending"),
                            ("in_progress", "In Progress"),
                            ("completed", "Completed"),
                            ("failed", "Failed"),
                        ],
                        default="pending",
                        max_length=20,
                    ),
                ),
                ("last_successful_date", models.DateField(blank=True, null=True)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("experiment", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.experiment")),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
            ],
            options={
                "indexes": [models.Index(fields=["status"], name="posthog_exp_status_01657f_idx")],
            },
        ),
        migrations.AddConstraint(
            model_name="experimenttimeseriesrecalculation",
            constraint=models.UniqueConstraint(
                condition=models.Q(("status__in", ["pending", "in_progress"])),
                fields=("experiment", "fingerprint"),
                name="unique_active_recalculation_per_experiment_metric",
            ),
        ),
    ]
