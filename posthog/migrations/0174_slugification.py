# Generated by Django 3.1.12 on 2021-10-12 15:54

from django.db import IntegrityError, migrations, models, transaction
from django.utils.text import slugify

import posthog.models.utils

MAX_SLUG_LENGTH = 48


def slugify_model(model):
    for instance in model.objects.all():
        slugified_name = slugify(instance.name)[:MAX_SLUG_LENGTH]
        for i in range(10):
            # This retry loop handles possible duplicates by appending `-\d` to the slug in case of an IntegrityError
            slugified_name_i = slugified_name[: MAX_SLUG_LENGTH - 2] if i == 0 else f"{slugified_name}-{i}"
            instance.slug = slugified_name_i
            try:
                with transaction.atomic():
                    instance.save()
            except IntegrityError:
                continue
            else:
                break


def slugify_all(apps, schema_editor):
    slugify_model(apps.get_model("posthog", "Organization"))
    slugify_model(apps.get_model("posthog", "Team"))


class Migration(migrations.Migration):

    dependencies = [
        ("posthog", "0173_should_update_person_props_function"),
    ]

    operations = [
        migrations.AddField(
            model_name="organization",
            name="slug",
            field=posthog.models.utils.LowercaseSlugField(max_length=MAX_SLUG_LENGTH, null=True, unique=True),
        ),
        migrations.AddField(
            model_name="team",
            name="slug",
            field=posthog.models.utils.LowercaseSlugField(max_length=MAX_SLUG_LENGTH, null=True, unique=True),
        ),
        migrations.RunPython(slugify_all, migrations.RunPython.noop),
        migrations.AlterField(
            model_name="organization",
            name="slug",
            field=posthog.models.utils.LowercaseSlugField(max_length=MAX_SLUG_LENGTH, unique=True),
        ),
        migrations.AlterField(
            model_name="team",
            name="slug",
            field=posthog.models.utils.LowercaseSlugField(max_length=MAX_SLUG_LENGTH, unique=True),
        ),
    ]
