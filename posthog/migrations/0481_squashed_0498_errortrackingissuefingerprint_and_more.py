# Generated by Django 4.2.28 on 2026-02-18 08:16

import django.utils.timezone
import django.db.models.deletion
import django.contrib.postgres.fields
import django.contrib.postgres.operations
from django.conf import settings
from django.db import migrations, models

import posthog.schema

import posthog.models.utils


class Migration(migrations.Migration):
    atomic = False

    replaces = [
        ("posthog", "0481_insightvariable_code_name"),
        ("posthog", "0482_alertconfiguration_calculation_interval_and_more"),
        ("posthog", "0483_datawarehousesavedquery_table"),
        ("posthog", "0484_productintent"),
        ("posthog", "0485_alter_datawarehousesavedquery_status"),
        ("posthog", "0486_cohort_last_error_at"),
        ("posthog", "0487_team_survey_config"),
        ("posthog", "0488_alter_user_is_active"),
        ("posthog", "0489_alter_integration_kind"),
        ("posthog", "0490_dashboard_variables"),
        ("posthog", "0491_alertconfiguration_snoozed_until_and_more"),
        ("posthog", "0492_team_session_recording_url_trigger_config"),
        ("posthog", "0493_insightvariable_values"),
        ("posthog", "0494_team_project_non_null"),
        ("posthog", "0495_alter_batchexportbackfill_start_at_and_more"),
        ("posthog", "0496_team_person_processing_opt_out"),
        ("posthog", "0497_experimentholdout_experiment_holdout"),
        ("posthog", "0498_errortrackingissuefingerprint_and_more"),
    ]

    dependencies = [
        ("posthog", "0480_insightvariable"),
    ]

    operations = [
        migrations.AddField(
            model_name="insightvariable",
            name="code_name",
            field=models.CharField(blank=True, default=None, max_length=400, null=True),
            preserve_default=False,
        ),
        migrations.AddField(
            model_name="alertconfiguration",
            name="calculation_interval",
            field=models.CharField(
                blank=True,
                choices=[
                    (posthog.schema.AlertCalculationInterval["HOURLY"], "hourly"),
                    (posthog.schema.AlertCalculationInterval["DAILY"], "daily"),
                    (posthog.schema.AlertCalculationInterval["WEEKLY"], "weekly"),
                    (posthog.schema.AlertCalculationInterval["MONTHLY"], "monthly"),
                ],
                default=posthog.schema.AlertCalculationInterval["DAILY"],
                max_length=10,
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="alertconfiguration",
            name="config",
            field=models.JSONField(blank=True, default=dict, null=True),
        ),
        migrations.AddField(
            model_name="alertconfiguration",
            name="is_calculating",
            field=models.BooleanField(blank=True, default=False, null=True),
        ),
        migrations.AddField(
            model_name="alertconfiguration",
            name="last_checked_at",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="alertconfiguration",
            name="next_check_at",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="alertcheck",
            name="state",
            field=models.CharField(
                choices=[
                    (posthog.schema.AlertState["FIRING"], posthog.schema.AlertState["FIRING"]),
                    (posthog.schema.AlertState["NOT_FIRING"], posthog.schema.AlertState["NOT_FIRING"]),
                    (posthog.schema.AlertState["ERRORED"], posthog.schema.AlertState["ERRORED"]),
                ],
                default=posthog.schema.AlertState["NOT_FIRING"],
                max_length=10,
            ),
        ),
        migrations.AlterField(
            model_name="alertconfiguration",
            name="state",
            field=models.CharField(
                choices=[
                    (posthog.schema.AlertState["FIRING"], posthog.schema.AlertState["FIRING"]),
                    (posthog.schema.AlertState["NOT_FIRING"], posthog.schema.AlertState["NOT_FIRING"]),
                    (posthog.schema.AlertState["ERRORED"], posthog.schema.AlertState["ERRORED"]),
                ],
                default=posthog.schema.AlertState["NOT_FIRING"],
                max_length=10,
            ),
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql='\n                    ALTER TABLE "posthog_datawarehousesavedquery" ADD COLUMN "table_id" uuid NULL CONSTRAINT "posthog_datawarehous_table_id_96fdb4f5_fk_posthog_d" REFERENCES "posthog_datawarehousetable"("id") DEFERRABLE INITIALLY DEFERRED; -- existing-table-constraint-ignore\n                    SET CONSTRAINTS "posthog_datawarehous_table_id_96fdb4f5_fk_posthog_d" IMMEDIATE; -- existing-table-constraint-ignore\n                    ',
                    reverse_sql='\n                    ALTER TABLE "posthog_datawarehousesavedquery" DROP COLUMN IF EXISTS "table_id";\n                    ',
                ),
                migrations.RunSQL(
                    sql='\n                    CREATE INDEX CONCURRENTLY "posthog_datawarehousesavedquery_table_id_96fdb4f5" ON "posthog_datawarehousesavedquery" ("table_id");\n                    ',
                    reverse_sql='\n                    DROP INDEX IF EXISTS "posthog_datawarehousesavedquery_table_id_96fdb4f5";\n                    ',
                ),
            ],
            state_operations=[
                migrations.AddField(
                    model_name="datawarehousesavedquery",
                    name="table",
                    field=models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        to="posthog.datawarehousetable",
                    ),
                ),
            ],
        ),
        migrations.CreateModel(
            name="ProductIntent",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                ("product_type", models.CharField(max_length=255)),
                ("onboarding_completed_at", models.DateTimeField(blank=True, null=True)),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
            ],
            options={
                "unique_together": {("team", "product_type")},
            },
        ),
        migrations.AlterField(
            model_name="datawarehousesavedquery",
            name="status",
            field=models.CharField(
                choices=[
                    ("Cancelled", "Cancelled"),
                    ("Modified", "Modified"),
                    ("Completed", "Completed"),
                    ("Failed", "Failed"),
                    ("Running", "Running"),
                ],
                help_text="The status of when this SavedQuery last ran.",
                max_length=64,
                null=True,
            ),
        ),
        migrations.AddField(
            model_name="cohort",
            name="last_error_at",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name="team",
            name="survey_config",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="user",
            name="is_active",
            field=models.BooleanField(
                default=True, help_text="Unselect this to temporarily disable an account.", verbose_name="active"
            ),
        ),
        migrations.AlterField(
            model_name="integration",
            name="kind",
            field=models.CharField(
                choices=[
                    ("slack", "Slack"),
                    ("salesforce", "Salesforce"),
                    ("hubspot", "Hubspot"),
                    ("google-pubsub", "Google Pubsub"),
                    ("google-cloud-storage", "Google Cloud Storage"),
                    ("google-ads", "Google Ads"),
                    ("snapchat", "Snapchat"),
                ],
                max_length=20,
            ),
        ),
        migrations.AddField(
            model_name="dashboard",
            name="variables",
            field=models.JSONField(blank=True, default=dict, null=True),
        ),
        migrations.AddField(
            model_name="alertconfiguration",
            name="snoozed_until",
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name="alertcheck",
            name="state",
            field=models.CharField(
                choices=[
                    (posthog.schema.AlertState["FIRING"], posthog.schema.AlertState["FIRING"]),
                    (posthog.schema.AlertState["NOT_FIRING"], posthog.schema.AlertState["NOT_FIRING"]),
                    (posthog.schema.AlertState["ERRORED"], posthog.schema.AlertState["ERRORED"]),
                    (posthog.schema.AlertState["SNOOZED"], posthog.schema.AlertState["SNOOZED"]),
                ],
                default=posthog.schema.AlertState["NOT_FIRING"],
                max_length=10,
            ),
        ),
        migrations.AlterField(
            model_name="alertconfiguration",
            name="state",
            field=models.CharField(
                choices=[
                    (posthog.schema.AlertState["FIRING"], posthog.schema.AlertState["FIRING"]),
                    (posthog.schema.AlertState["NOT_FIRING"], posthog.schema.AlertState["NOT_FIRING"]),
                    (posthog.schema.AlertState["ERRORED"], posthog.schema.AlertState["ERRORED"]),
                    (posthog.schema.AlertState["SNOOZED"], posthog.schema.AlertState["SNOOZED"]),
                ],
                default=posthog.schema.AlertState["NOT_FIRING"],
                max_length=10,
            ),
        ),
        migrations.AddField(
            model_name="team",
            name="session_recording_url_trigger_config",
            field=django.contrib.postgres.fields.ArrayField(
                base_field=models.JSONField(blank=True, null=True), blank=True, default=list, null=True, size=None
            ),
        ),
        migrations.AddField(
            model_name="insightvariable",
            name="values",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                django.contrib.postgres.operations.ValidateConstraint(
                    model_name="team",
                    name="project_id_is_not_null",
                ),
            ],
            state_operations=[
                migrations.AlterField(
                    model_name="team",
                    name="project",
                    field=models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="teams",
                        related_query_name="team",
                        to="posthog.project",
                    ),
                ),
            ],
        ),
        migrations.AlterField(
            model_name="batchexportbackfill",
            name="start_at",
            field=models.DateTimeField(help_text="The start of the data interval.", null=True),
        ),
        migrations.AlterField(
            model_name="batchexportrun",
            name="data_interval_start",
            field=models.DateTimeField(help_text="The start of the data interval.", null=True),
        ),
        migrations.AddField(
            model_name="team",
            name="person_processing_opt_out",
            field=models.BooleanField(default=False, null=True),
        ),
        migrations.CreateModel(
            name="ExperimentHoldout",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("name", models.CharField(max_length=400)),
                ("description", models.CharField(blank=True, max_length=400, null=True)),
                ("filters", models.JSONField(default=list)),
                ("created_at", models.DateTimeField(default=django.utils.timezone.now)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "created_by",
                    models.ForeignKey(
                        null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
                    ),
                ),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
            ],
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql='\n                    ALTER TABLE "posthog_experiment" ADD COLUMN "holdout_id" integer NULL CONSTRAINT "posthog_experiment_holdout_id_ffd173dd_fk_posthog_e" REFERENCES "posthog_experimentholdout"("id") DEFERRABLE INITIALLY DEFERRED; -- existing-table-constraint-ignore\n                    SET CONSTRAINTS "posthog_experiment_holdout_id_ffd173dd_fk_posthog_e" IMMEDIATE; -- existing-table-constraint-ignore\n                    ',
                    reverse_sql='\n                        ALTER TABLE "posthog_experiment" DROP COLUMN IF EXISTS "holdout_id";\n                    ',
                ),
                migrations.RunSQL(
                    sql='\n                    CREATE INDEX CONCURRENTLY "posthog_experiment_holdout_id_ffd173dd_fk_posthog_e" ON "posthog_experiment" ("holdout_id");\n                    ',
                    reverse_sql='\n                        DROP INDEX IF EXISTS "posthog_experiment_holdout_id_ffd173dd_fk_posthog_e";\n                    ',
                ),
            ],
            state_operations=[
                migrations.AddField(
                    model_name="experiment",
                    name="holdout",
                    field=models.ForeignKey(
                        null=True, on_delete=django.db.models.deletion.SET_NULL, to="posthog.experimentholdout"
                    ),
                ),
            ],
        ),
        migrations.CreateModel(
            name="ErrorTrackingIssueFingerprint",
            fields=[
                ("id", models.AutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
                ("fingerprint", models.TextField()),
                ("version", models.BigIntegerField(blank=True, default=0)),
                (
                    "issue",
                    models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.errortrackinggroup"),
                ),
                (
                    "team",
                    models.ForeignKey(db_index=False, on_delete=django.db.models.deletion.CASCADE, to="posthog.team"),
                ),
            ],
        ),
        migrations.AddConstraint(
            model_name="errortrackingissuefingerprint",
            constraint=models.UniqueConstraint(fields=("team", "fingerprint"), name="unique fingerprint for team"),
        ),
    ]
