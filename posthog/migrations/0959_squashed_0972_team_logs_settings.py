# Generated by Django 4.2.28 on 2026-02-18 08:16

import django.utils.timezone
import django.db.models.deletion
from django.conf import settings
from django.db import migrations, models

import posthog.utils
import posthog.models.utils


class Migration(migrations.Migration):
    replaces = [
        ("posthog", "0959_survey_question_summaries"),
        ("posthog", "0960_remove_dashboardtemplate_unique_template_name_per_team_and_more"),
        ("posthog", "0961_session_recording_external_reference"),
        ("posthog", "0962_webanalyticsfilterpreset"),
        ("posthog", "0963_add_azure_blob_destination"),
        ("posthog", "0964_webauthncredential"),
        ("posthog", "0967_oauth_dcr_fields"),
        ("posthog", "0969_add_oauth_is_verified"),
        ("posthog", "0970_add_session_recording_encryption"),
        ("posthog", "0971_exportedasset_failure_type"),
        ("posthog", "0972_team_logs_settings"),
    ]

    dependencies = [
        ("posthog", "0958_drop_teamcoreeventsconfig_table"),
    ]

    operations = [
        migrations.AddField(
            model_name="survey",
            name="question_summaries",
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.RemoveConstraint(
            model_name="dashboardtemplate",
            name="unique_template_name_per_team",
        ),
        migrations.AddConstraint(
            model_name="dashboardtemplate",
            constraint=models.UniqueConstraint(
                condition=models.Q(("deleted__isnull", True), ("deleted", False), _connector="OR"),
                fields=("template_name", "team"),
                name="unique_template_name_per_team",
            ),
        ),
        migrations.CreateModel(
            name="SessionRecordingExternalReference",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("external_context", models.JSONField(blank=True, null=True)),
                (
                    "integration",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="external_references",
                        to="posthog.integration",
                    ),
                ),
                (
                    "session_recording",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="external_references",
                        related_query_name="external_reference",
                        to="posthog.sessionrecording",
                    ),
                ),
            ],
            options={
                "db_table": "posthog_sessionrecordingexternalreference",
            },
        ),
        migrations.CreateModel(
            name="WebAnalyticsFilterPreset",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                ("short_id", models.CharField(blank=True, default=posthog.utils.generate_short_id, max_length=12)),
                ("name", models.CharField(max_length=400)),
                ("description", models.TextField(blank=True)),
                ("pinned", models.BooleanField(default=False)),
                ("deleted", models.BooleanField(default=False)),
                ("filters", models.JSONField(default=dict)),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                ("last_modified_at", models.DateTimeField(default=django.utils.timezone.now)),
                (
                    "created_by",
                    models.ForeignKey(
                        blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL
                    ),
                ),
                (
                    "last_modified_by",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="modified_web_analytics_filter_presets",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                ("team", models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team")),
            ],
            options={
                "indexes": [models.Index(fields=["deleted", "-last_modified_at"], name="wa_preset_del_mod_idx")],
                "unique_together": {("team", "short_id")},
            },
        ),
        migrations.AlterField(
            model_name="batchexportdestination",
            name="type",
            field=models.CharField(
                choices=[
                    ("S3", "S3"),
                    ("Snowflake", "Snowflake"),
                    ("Postgres", "Postgres"),
                    ("Redshift", "Redshift"),
                    ("BigQuery", "Bigquery"),
                    ("Databricks", "Databricks"),
                    ("AzureBlob", "Azure Blob"),
                    ("Workflows", "Workflows"),
                    ("HTTP", "Http"),
                    ("NoOp", "Noop"),
                ],
                help_text="A choice of supported BatchExportDestination types.",
                max_length=64,
            ),
        ),
        migrations.AlterField(
            model_name="integration",
            name="kind",
            field=models.CharField(
                choices=[
                    ("slack", "Slack"),
                    ("salesforce", "Salesforce"),
                    ("hubspot", "Hubspot"),
                    ("google-pubsub", "Google Pubsub"),
                    ("google-cloud-storage", "Google Cloud Storage"),
                    ("google-ads", "Google Ads"),
                    ("google-sheets", "Google Sheets"),
                    ("snapchat", "Snapchat"),
                    ("linkedin-ads", "Linkedin Ads"),
                    ("reddit-ads", "Reddit Ads"),
                    ("tiktok-ads", "Tiktok Ads"),
                    ("bing-ads", "Bing Ads"),
                    ("intercom", "Intercom"),
                    ("email", "Email"),
                    ("linear", "Linear"),
                    ("github", "Github"),
                    ("gitlab", "Gitlab"),
                    ("meta-ads", "Meta Ads"),
                    ("twilio", "Twilio"),
                    ("clickup", "Clickup"),
                    ("vercel", "Vercel"),
                    ("databricks", "Databricks"),
                    ("azure-blob", "Azure Blob"),
                ],
                max_length=20,
            ),
        ),
        migrations.CreateModel(
            name="WebauthnCredential",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False
                    ),
                ),
                (
                    "credential_id",
                    models.BinaryField(
                        help_text="ID generated by the user's authenticator during credential creation. Stored as bytes."
                    ),
                ),
                (
                    "label",
                    models.CharField(help_text="The user-facing label assigned to this credential.", max_length=200),
                ),
                (
                    "public_key",
                    models.BinaryField(
                        help_text="The public key used to verify attestations from the user's authenticator. Stored as bytes."
                    ),
                ),
                (
                    "algorithm",
                    models.IntegerField(
                        help_text="The COSE algorithm identifier used for public-key verification (e.g., -7 for ES256, -257 for RS256)."
                    ),
                ),
                (
                    "counter",
                    models.IntegerField(
                        default=0,
                        help_text="Tracks the counter of the credential. Traditionally used to detect cloned authenticators, however for our use case we expect to see some inconsistencies here because of the behavior of different passkey managers.",
                    ),
                ),
                (
                    "transports",
                    models.JSONField(
                        default=list,
                        help_text="The transport methods that the authenticator uses to communicate with the browser (e.g., ['internal', 'hybrid']).",
                    ),
                ),
                (
                    "verified",
                    models.BooleanField(
                        default=False,
                        help_text="Whether the credential has been verified by the user after registration. Only verified credentials can be used for login.",
                    ),
                ),
                ("created_at", models.DateTimeField(auto_now_add=True)),
                (
                    "user",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="webauthn_credentials",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
            ],
            options={
                "unique_together": {("user", "credential_id")},
            },
        ),
        migrations.AddField(
            model_name="oauthapplication",
            name="dcr_client_id_issued_at",
            field=models.DateTimeField(
                blank=True, help_text="When the client_id was issued (for DCR clients)", null=True
            ),
        ),
        migrations.AddField(
            model_name="oauthapplication",
            name="is_dcr_client",
            field=models.BooleanField(
                default=False, help_text="True if this client was registered via Dynamic Client Registration"
            ),
        ),
        migrations.AddField(
            model_name="oauthapplication",
            name="is_verified",
            field=models.BooleanField(default=False, help_text="True if this application has been verified by PostHog"),
        ),
        migrations.AddField(
            model_name="team",
            name="session_recording_encryption",
            field=models.BooleanField(blank=True, default=False, null=True),
        ),
        migrations.AddField(
            model_name="exportedasset",
            name="failure_type",
            field=models.CharField(blank=True, max_length=255, null=True),
        ),
        migrations.AddField(
            model_name="team",
            name="logs_settings",
            field=models.JSONField(blank=True, null=True),
        ),
    ]
