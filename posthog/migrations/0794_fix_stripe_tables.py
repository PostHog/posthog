# Generated by Django 4.2.22 on 2025-07-11 16:51

from django.db import connection, migrations

from posthog.warehouse.models import ExternalDataSchema as ExternalDataSchemaModel


def forwards(apps, schema_editor):
    with connection.cursor() as cursor:
        cursor.execute("""
            select sch.id from posthog_externaldataschema sch
            left join posthog_externaldatasource s on s.id = sch.source_id
            where s.source_type = 'Stripe' and sch.should_sync is true and sch.deleted is false and sch.sync_type = 'append' and not (sync_type_config ? 'incremental_field')
        """)
        stripe_schemas = cursor.fetchall()

    ExternalDataSchema: ExternalDataSchemaModel = apps.get_model("posthog", "ExternalDataSchema")

    for (id,) in stripe_schemas:
        schema = ExternalDataSchema.objects.get(id=id)
        schema.sync_type_config["incremental_field"] = "created"
        schema.sync_type_config["incremental_field_type"] = "integer"
        schema.save()


def reverse(apps, schema_editor):
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0793_team_feature_flag_confirmation"),
    ]

    operations = [migrations.RunPython(forwards, reverse)]
