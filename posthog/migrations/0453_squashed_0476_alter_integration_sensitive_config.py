# Generated by Django 4.2.28 on 2026-02-20 11:25

from django.conf import settings
import django.contrib.postgres.fields
import django.contrib.postgres.indexes
from django.db import migrations, models
import django.db.migrations.operations.special
import django.db.models.constraints
import django.db.models.deletion
import django.db.models.expressions
import posthog.helpers.encrypted_fields
import posthog.models.utils
import products.data_warehouse.backend.models.modeling


class Migration(migrations.Migration):

    replaces = [('posthog', '0453_alter_errortrackinggroup_fingerprint_and_more'), ('posthog', '0454_alter_datawarehousetable_format'), ('posthog', '0455_alter_externaldatasource_source_type'), ('posthog', '0456_hogfunction_masking'), ('posthog', '0457_datawarehousejoin_deleted_at_and_more'), ('posthog', '0458_alter_insightviewed_team_alter_insightviewed_user'), ('posthog', '0459_convert_personsnode_insights_to_actorsquery'), ('posthog', '0460_alertconfiguration_threshold_alertsubscription_and_more'), ('posthog', '0461_alter_externaldatasource_source_type'), ('posthog', '0462_change_replay_team_setting_defaults'), ('posthog', '0463_datawarehousemodelpath_and_more'), ('posthog', '0464_action_pinned_at'), ('posthog', '0465_datawarehouse_stripe_account'), ('posthog', '0466_alter_externaldatasource_source_type'), ('posthog', '0467_add_web_vitals_allowed_metrics'), ('posthog', '0468_integration_google_pubsub'), ('posthog', '0469_datawarehousesavedquery_at_and_more'), ('posthog', '0470_integration_google_cloud_storage'), ('posthog', '0471_webexperiment_experiment_type_experiment_variants'), ('posthog', '0472_experiment_metrics'), ('posthog', '0473_dashboardtemplate_availability_contexts'), ('posthog', '0474_hogfunction_encrypted_inputs'), ('posthog', '0475_alter_externaldatasource_source_type'), ('posthog', '0476_alter_integration_sensitive_config')]

    dependencies = [
        ('posthog', '0452_organization_logo'),
    ]

    operations = [
        migrations.AlterField(
            model_name='errortrackinggroup',
            name='fingerprint',
            field=django.contrib.postgres.fields.ArrayField(base_field=models.TextField(), size=None),
        ),
        migrations.AlterField(
            model_name='errortrackinggroup',
            name='merged_fingerprints',
            field=django.contrib.postgres.fields.ArrayField(base_field=django.contrib.postgres.fields.ArrayField(base_field=models.TextField(), size=None), default=list, size=None),
        ),
        migrations.AlterField(
            model_name='datawarehousetable',
            name='format',
            field=models.CharField(choices=[('CSV', 'CSV'), ('CSVWithNames', 'CSVWithNames'), ('Parquet', 'Parquet'), ('JSONEachRow', 'JSON'), ('Delta', 'Delta'), ('DeltaS3Wrapper', 'DeltaS3Wrapper')], max_length=128),
        ),
        migrations.AlterField(
            model_name='externaldatasource',
            name='source_type',
            field=models.CharField(choices=[('Stripe', 'Stripe'), ('Hubspot', 'Hubspot'), ('Postgres', 'Postgres'), ('Zendesk', 'Zendesk'), ('Snowflake', 'Snowflake'), ('Salesforce', 'Salesforce'), ('MySQL', 'MySQL')], max_length=128),
        ),
        migrations.AddField(
            model_name='hogfunction',
            name='masking',
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='datawarehousejoin',
            name='deleted_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='datawarehousesavedquery',
            name='deleted_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='datawarehousetable',
            name='deleted_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='datawarehouseviewlink',
            name='deleted_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='externaldataschema',
            name='deleted',
            field=models.BooleanField(blank=True, default=False, null=True),
        ),
        migrations.AddField(
            model_name='externaldataschema',
            name='deleted_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='externaldatasource',
            name='deleted',
            field=models.BooleanField(blank=True, default=False, null=True),
        ),
        migrations.AddField(
            model_name='externaldatasource',
            name='deleted_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='datawarehousejoin',
            name='deleted',
            field=models.BooleanField(blank=True, default=False, null=True),
        ),
        migrations.AlterField(
            model_name='datawarehousesavedquery',
            name='deleted',
            field=models.BooleanField(blank=True, default=False, null=True),
        ),
        migrations.AlterField(
            model_name='datawarehousetable',
            name='deleted',
            field=models.BooleanField(blank=True, default=False, null=True),
        ),
        migrations.AlterField(
            model_name='datawarehouseviewlink',
            name='deleted',
            field=models.BooleanField(blank=True, default=False, null=True),
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql='\n                    ALTER TABLE "posthog_insightviewed" ALTER COLUMN "team_id" DROP NOT NULL;\n                    ',
                    reverse_sql='\n                    ALTER TABLE "posthog_insightviewed" ALTER COLUMN "team_id" SET NOT NULL;\n                    ',
                ),
                migrations.RunSQL(
                    sql='\n                    ALTER TABLE "posthog_insightviewed" ALTER COLUMN "user_id" DROP NOT NULL;\n                    ',
                    reverse_sql='\n                    ALTER TABLE "posthog_insightviewed" ALTER COLUMN "user_id" SET NOT NULL;\n                    ',
                ),
            ],
            state_operations=[
                migrations.AlterField(
                    model_name='insightviewed',
                    name='team',
                    field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='posthog.team'),
                ),
                migrations.AlterField(
                    model_name='insightviewed',
                    name='user',
                    field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL),
                ),
            ],
        ),
        migrations.CreateModel(
            name='AlertConfiguration',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('id', models.UUIDField(default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(blank=True, max_length=255)),
                ('condition', models.JSONField(default=dict)),
                ('state', models.CharField(choices=[('firing', 'Firing'), ('inactive', 'Inactive')], default='inactive', max_length=10)),
                ('enabled', models.BooleanField(default=True)),
                ('last_notified_at', models.DateTimeField(blank=True, null=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('insight', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='posthog.insight')),
            ],
            options={
                'abstract': False,
            },
        ),
        migrations.CreateModel(
            name='Threshold',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('id', models.UUIDField(default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False)),
                ('name', models.CharField(blank=True, max_length=255)),
                ('configuration', models.JSONField(default=dict)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('insight', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='posthog.insight')),
                ('team', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='posthog.team')),
            ],
            options={
                'abstract': False,
            },
        ),
        migrations.CreateModel(
            name='AlertSubscription',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('id', models.UUIDField(default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False)),
                ('subscribed', models.BooleanField(default=True)),
                ('alert_configuration', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='posthog.alertconfiguration')),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('user', models.ForeignKey(limit_choices_to={'is_active': True, 'organization_id': django.db.models.expressions.OuterRef('alert_configuration__team__organization_id')}, on_delete=django.db.models.deletion.CASCADE, related_name='alert_subscriptions', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'unique_together': {('user', 'alert_configuration')},
            },
        ),
        migrations.AddField(
            model_name='alertconfiguration',
            name='subscribed_users',
            field=models.ManyToManyField(related_name='alert_configurations', through='posthog.AlertSubscription', to=settings.AUTH_USER_MODEL),
        ),
        migrations.AddField(
            model_name='alertconfiguration',
            name='team',
            field=models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='posthog.team'),
        ),
        migrations.AddField(
            model_name='alertconfiguration',
            name='threshold',
            field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, to='posthog.threshold'),
        ),
        migrations.CreateModel(
            name='AlertCheck',
            fields=[
                ('id', models.UUIDField(default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('calculated_value', models.FloatField(blank=True, null=True)),
                ('condition', models.JSONField(default=dict)),
                ('targets_notified', models.JSONField(default=dict)),
                ('error', models.JSONField(blank=True, null=True)),
                ('state', models.CharField(choices=[('firing', 'Firing'), ('not_met', 'Not Met')], default='not_met', max_length=10)),
                ('alert_configuration', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='posthog.alertconfiguration')),
            ],
            options={
                'abstract': False,
            },
        ),
        migrations.AlterField(
            model_name='externaldatasource',
            name='source_type',
            field=models.CharField(choices=[('Stripe', 'Stripe'), ('Hubspot', 'Hubspot'), ('Postgres', 'Postgres'), ('Zendesk', 'Zendesk'), ('Snowflake', 'Snowflake'), ('Salesforce', 'Salesforce'), ('MySQL', 'MySQL'), ('MSSQL', 'MSSQL')], max_length=128),
        ),
        migrations.AlterField(
            model_name='team',
            name='capture_console_log_opt_in',
            field=models.BooleanField(blank=True, default=True, null=True),
        ),
        migrations.AlterField(
            model_name='team',
            name='capture_performance_opt_in',
            field=models.BooleanField(blank=True, default=True, null=True),
        ),
        migrations.RunSQL(
            sql='CREATE EXTENSION ltree;',
            reverse_sql='DROP EXTENSION ltree;',
        ),
        migrations.CreateModel(
            name='DataWarehouseModelPath',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True, null=True)),
                ('id', models.UUIDField(default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False)),
                ('path', products.data_warehouse.backend.models.modeling.LabelTreeField()),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('saved_query', models.ForeignKey(default=None, null=True, on_delete=django.db.models.deletion.SET_NULL, to='posthog.datawarehousesavedquery')),
                ('table', models.ForeignKey(default=None, null=True, on_delete=django.db.models.deletion.SET_NULL, to='posthog.datawarehousetable')),
                ('team', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='posthog.team')),
            ],
            options={
                'indexes': [models.Index(fields=['team_id', 'path'], name='team_id_path'), models.Index(fields=['team_id', 'saved_query_id'], name='team_id_saved_query_id'), django.contrib.postgres.indexes.GistIndex(models.F('path'), name='model_path_path')],
            },
        ),
        migrations.AddConstraint(
            model_name='datawarehousemodelpath',
            constraint=models.UniqueConstraint(deferrable=django.db.models.constraints.Deferrable['IMMEDIATE'], fields=('team_id', 'path'), name='unique_team_id_path'),
        ),
        migrations.AddField(
            model_name='action',
            name='pinned_at',
            field=models.DateTimeField(blank=True, default=None, null=True),
        ),
        migrations.RunPython(
            code=django.db.migrations.operations.special.RunPython.noop,
            reverse_code=django.db.migrations.operations.special.RunPython.noop,
        ),
        migrations.AlterField(
            model_name='externaldatasource',
            name='source_type',
            field=models.CharField(choices=[('Stripe', 'Stripe'), ('Hubspot', 'Hubspot'), ('Postgres', 'Postgres'), ('Zendesk', 'Zendesk'), ('Snowflake', 'Snowflake'), ('Salesforce', 'Salesforce'), ('MySQL', 'MySQL'), ('MSSQL', 'MSSQL'), ('Vitally', 'Vitally')], max_length=128),
        ),
        migrations.AddField(
            model_name='team',
            name='autocapture_web_vitals_allowed_metrics',
            field=models.JSONField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='integration',
            name='kind',
            field=models.CharField(choices=[('slack', 'Slack'), ('salesforce', 'Salesforce'), ('hubspot', 'Hubspot'), ('google-pubsub', 'Google Pubsub')], max_length=20),
        ),
        migrations.AddField(
            model_name='datawarehousesavedquery',
            name='last_run_at',
            field=models.DateTimeField(help_text="The timestamp of this SavedQuery's last run (if any).", null=True),
        ),
        migrations.AddField(
            model_name='datawarehousesavedquery',
            name='status',
            field=models.CharField(choices=[('Cancelled', 'Cancelled'), ('Completed', 'Completed'), ('Failed', 'Failed'), ('Running', 'Running')], help_text='The status of when this SavedQuery last ran.', max_length=64, null=True),
        ),
        migrations.AlterField(
            model_name='integration',
            name='kind',
            field=models.CharField(choices=[('slack', 'Slack'), ('salesforce', 'Salesforce'), ('hubspot', 'Hubspot'), ('google-pubsub', 'Google Pubsub'), ('google-cloud-storage', 'Google Cloud Storage')], max_length=20),
        ),
        migrations.CreateModel(
            name='WebExperiment',
            fields=[
            ],
            options={
                'proxy': True,
                'indexes': [],
                'constraints': [],
            },
            bases=('posthog.experiment',),
        ),
        migrations.AddField(
            model_name='experiment',
            name='type',
            field=models.CharField(blank=True, choices=[('web', 'web'), ('product', 'product')], default='product', max_length=40, null=True),
        ),
        migrations.AddField(
            model_name='experiment',
            name='variants',
            field=models.JSONField(blank=True, default=dict, null=True),
        ),
        migrations.AddField(
            model_name='experiment',
            name='metrics',
            field=models.JSONField(blank=True, default=list, null=True),
        ),
        migrations.AddField(
            model_name='dashboardtemplate',
            name='availability_contexts',
            field=django.contrib.postgres.fields.ArrayField(base_field=models.CharField(max_length=255), blank=True, null=True, size=None),
        ),
        migrations.AddField(
            model_name='hogfunction',
            name='encrypted_inputs',
            field=posthog.helpers.encrypted_fields.EncryptedJSONStringField(blank=True, null=True),
        ),
        migrations.AlterField(
            model_name='externaldatasource',
            name='source_type',
            field=models.CharField(choices=[('Stripe', 'Stripe'), ('Hubspot', 'Hubspot'), ('Postgres', 'Postgres'), ('Zendesk', 'Zendesk'), ('Snowflake', 'Snowflake'), ('Salesforce', 'Salesforce'), ('MySQL', 'MySQL'), ('MSSQL', 'MSSQL'), ('Vitally', 'Vitally'), ('BigQuery', 'BigQuery')], max_length=128),
        ),
        migrations.AlterField(
            model_name='integration',
            name='sensitive_config',
            field=posthog.helpers.encrypted_fields.EncryptedJSONField(default=dict),
        ),
    ]
