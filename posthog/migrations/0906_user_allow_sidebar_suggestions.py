# Generated by Django 4.2.22 on 2025-11-12 00:18

from django.db import migrations, models


def backfill_allow_sidebar_suggestions(apps, schema_editor):
    User = apps.get_model("posthog", "User")
    batch_size = 1000

    # Using batch approach to avoid updating `updated_at` field on every user
    # but trying to avoid locking the whole table for updates for too long
    #
    # We want this to be true for every single user by default, they need to opt-out
    while True:
        user_ids = list(
            User.objects.filter(allow_sidebar_suggestions__isnull=True).values_list("id", flat=True)[:batch_size]
        )
        if not user_ids:
            break

        User.objects.filter(id__in=user_ids).update(allow_sidebar_suggestions=True)


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("posthog", "0905_alter_person_table"),
    ]

    operations = [
        migrations.AddField(
            model_name="user",
            name="allow_sidebar_suggestions",
            field=models.BooleanField(blank=True, default=True, null=True),
        ),
        migrations.RunPython(backfill_allow_sidebar_suggestions, reverse_code=migrations.RunPython.noop),
    ]
