# Generated by Django 4.2.15 on 2025-01-15 10:15

from django.conf import settings
from django.db import migrations, models
import django.db.models.deletion


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0541_usergroup_usergroupmembership_usergroup_members_and_more"),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            state_operations=[
                migrations.RemoveConstraint(
                    model_name="errortrackingissueassignment",
                    name="unique_on_user_and_issue",
                ),
                migrations.AddField(
                    model_name="errortrackingissueassignment",
                    name="user_group",
                    field=models.ForeignKey(
                        null=True, on_delete=django.db.models.deletion.CASCADE, to="posthog.usergroup"
                    ),
                ),
                migrations.AlterField(
                    model_name="errortrackingissueassignment",
                    name="issue",
                    field=models.OneToOneField(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="assignment",
                        to="posthog.errortrackingissue",
                    ),
                ),
                migrations.AlterField(
                    model_name="errortrackingissueassignment",
                    name="user",
                    field=models.ForeignKey(
                        null=True, on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
                    ),
                ),
            ],
            database_operations=[
                # Remove constraint unique_on_user_and_issue from model errortrackingissueassignment
                migrations.RunSQL(
                    """
                    ALTER TABLE "posthog_errortrackingissueassignment" DROP CONSTRAINT "unique_on_user_and_issue";
                    """,
                    reverse_sql="""
                        ALTER TABLE "posthog_errortrackingissueassignment" ADD CONSTRAINT "unique_on_user_and_issue" UNIQUE ("issue_id", "user_id");
                    """,
                ),
                # Add field user_group to errortrackingissueassignment
                migrations.RunSQL(
                    """
                    ALTER TABLE "posthog_errortrackingissueassignment" ADD COLUMN "user_group_id" uuid NULL CONSTRAINT "posthog_errortrackin_user_group_id_459a0006_fk_posthog_u" REFERENCES "posthog_usergroup"("id") DEFERRABLE INITIALLY DEFERRED;
                    SET CONSTRAINTS "posthog_errortrackin_user_group_id_459a0006_fk_posthog_u" IMMEDIATE;
                    """,
                    reverse_sql="""
                        ALTER TABLE "posthog_errortrackingissueassignment" DROP COLUMN "user_group_id" CASCADE;
                    """,
                ),
                # Alter field issue on errortrackingissueassignment
                migrations.RunSQL(
                    """
                    SET CONSTRAINTS "posthog_errortrackin_issue_id_d9cce9cb_fk_posthog_e" IMMEDIATE;
                    ALTER TABLE "posthog_errortrackingissueassignment" DROP CONSTRAINT "posthog_errortrackin_issue_id_d9cce9cb_fk_posthog_e";
                    DROP INDEX IF EXISTS "posthog_errortrackingissueassignment_issue_id_d9cce9cb";
                    ALTER TABLE "posthog_errortrackingissueassignment" ADD CONSTRAINT "posthog_errortrackingissueassignment_issue_id_d9cce9cb_uniq" UNIQUE ("issue_id"); -- existing-table-constraint-ignore
                    ALTER TABLE "posthog_errortrackingissueassignment" ADD CONSTRAINT "posthog_errortrackin_issue_id_d9cce9cb_fk_posthog_e" FOREIGN KEY ("issue_id") REFERENCES "posthog_errortrackingissue" ("id") DEFERRABLE INITIALLY DEFERRED; -- existing-table-constraint-ignore
                    """,
                    reverse_sql="""
                        SET CONSTRAINTS "posthog_errortrackin_issue_id_d9cce9cb_fk_posthog_e" IMMEDIATE;
                        ALTER TABLE "posthog_errortrackingissueassignment" DROP CONSTRAINT "posthog_errortrackin_issue_id_d9cce9cb_fk_posthog_e";
                        CREATE INDEX "posthog_errortrackingissueassignment_issue_id_d9cce9cb" ON "posthog_errortrackingissueassignment" ("issue_id");
                        ALTER TABLE "posthog_errortrackingissueassignment" ADD CONSTRAINT "posthog_errortrackin_issue_id_d9cce9cb_fk_posthog_e" FOREIGN KEY ("issue_id") REFERENCES "posthog_errortrackingissue" ("id") DEFERRABLE INITIALLY DEFERRED;
                    """,
                ),
                # Alter field user on errortrackingissueassignment
                migrations.RunSQL(
                    """
                    SET CONSTRAINTS "posthog_errortrackin_user_id_83f2e696_fk_posthog_u" IMMEDIATE;
                    ALTER TABLE "posthog_errortrackingissueassignment" DROP CONSTRAINT "posthog_errortrackin_user_id_83f2e696_fk_posthog_u";
                    ALTER TABLE "posthog_errortrackingissueassignment" ALTER COLUMN "user_id" DROP NOT NULL;
                    ALTER TABLE "posthog_errortrackingissueassignment" ADD CONSTRAINT "posthog_errortrackin_user_id_83f2e696_fk_posthog_u" FOREIGN KEY ("user_id") REFERENCES "posthog_user" ("id") DEFERRABLE INITIALLY DEFERRED; -- existing-table-constraint-ignore
                    """,
                    reverse_sql="""
                        SET CONSTRAINTS "posthog_errortrackin_user_id_83f2e696_fk_posthog_u" IMMEDIATE;
                        ALTER TABLE "posthog_errortrackingissueassignment" DROP CONSTRAINT "posthog_errortrackin_user_id_83f2e696_fk_posthog_u";
                        ALTER TABLE "posthog_errortrackingissueassignment" ALTER COLUMN "user_id" SET NOT NULL;
                        ALTER TABLE "posthog_errortrackingissueassignment" ADD CONSTRAINT "posthog_errortrackin_user_id_83f2e696_fk_posthog_u" FOREIGN KEY ("user_id") REFERENCES "posthog_user" ("id") DEFERRABLE INITIALLY DEFERRED;
                    """,
                ),
            ],
        )
    ]


# ORIGINAL MIGRATION
# class Migration(migrations.Migration):
#     dependencies = [
#         ("posthog", "0541_usergroup_usergroupmembership_usergroup_members_and_more"),
#     ]

#     operations = [
#         migrations.RemoveConstraint(
#             model_name="errortrackingissueassignment",
#             name="unique_on_user_and_issue",
#         ),
#         migrations.AddField(
#             model_name="errortrackingissueassignment",
#             name="user_group",
#             field=models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, to="posthog.usergroup"),
#         ),
#         migrations.AlterField(
#             model_name="errortrackingissueassignment",
#             name="issue",
#             field=models.OneToOneField(
#                 on_delete=django.db.models.deletion.CASCADE, related_name="assignment", to="posthog.errortrackingissue"
#             ),
#         ),
#         migrations.AlterField(
#             model_name="errortrackingissueassignment",
#             name="user",
#             field=models.ForeignKey(
#                 null=True, on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL
#             ),
#         ),
#     ]
