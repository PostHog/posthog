# Generated by Django 4.2.14 on 2024-08-22 14:00
from typing import cast

from django.db import migrations

from posthog.schema import ActorsQuery, CohortPropertyFilter, DataTableNode, NodeKind, PersonsNode


def convert_insights(apps, schema_editor):
    Insight = apps.get_model("posthog", "Insight")

    insights = Insight.objects.filter(query__kind=NodeKind.DATA_TABLE_NODE, query__source__kind=NodeKind.PERSONS_NODE)

    for insight in insights.iterator(chunk_size=100):
        try:
            query_dict = insight.query.copy()
            query = DataTableNode(**query_dict)
            node = cast(PersonsNode, query.source)

            properties = node.properties or []
            if node.cohort is not None:
                properties.append(CohortPropertyFilter(key="id", value=node.cohort))

            del query_dict["source"]

            updated_query = DataTableNode(
                **query_dict,
                source=ActorsQuery(
                    search=node.search,
                    properties=properties,
                    fixedProperties=node.fixedProperties,
                    limit=node.limit,
                    offset=node.offset,
                ),
            )
            insight.query = updated_query.model_dump(exclude_none=True)
            insight.save()
        except:
            pass


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0458_alter_insightviewed_team_alter_insightviewed_user"),
    ]

    operations = [
        migrations.RunPython(convert_insights, migrations.RunPython.noop, elidable=True),
    ]
