# Generated by Django 4.2.22 on 2025-10-07 08:19

from django.db import migrations

import structlog

logger = structlog.get_logger(__name__)


def migrate_recording_comments_to_replay_scope(apps, schema_editor):
    Comment = apps.get_model("posthog", "Comment")

    comments_to_migrate = []
    batch_size = 500

    for comment in Comment.objects.filter(scope="recording").only("id", "scope").iterator(chunk_size=batch_size // 5):
        try:
            comment.scope = "Replay"
            comments_to_migrate.append(comment)

            if len(comments_to_migrate) >= batch_size:
                Comment.objects.bulk_update(
                    comments_to_migrate,
                    ["scope"],
                )
                print(f"Migrated {len(comments_to_migrate)} comments")  # noqa: T201
                comments_to_migrate = []
        except Exception as e:
            # If anything fails for a comment, skip it and continue with others
            logger.error(
                "recording_to_replay_comment_scope_migration_failed", comment_id=comment.id, error=str(e), exc_info=True
            )
            continue

    # Migrate any remaining comments
    Comment.objects.bulk_update(
        comments_to_migrate,
        ["scope"],
    )


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0869_create_cohort_calculation_history"),
    ]

    operations = [
        migrations.RunPython(migrate_recording_comments_to_replay_scope, reverse_code=migrations.RunPython.noop),
    ]
