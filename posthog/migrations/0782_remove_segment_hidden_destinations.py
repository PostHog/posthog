# Generated by Django 4.2.22 on 2025-07-01 06:53

from django.db import migrations


def remove_segment_hidden_destinations(apps, schema_editor):
    """
    Mark old destinations as deleted which have the status hidden and where the template id starts with segment-
    """
    HogFunction = apps.get_model("posthog", "HogFunction")
    HogFunctionTemplate = apps.get_model("posthog", "HogFunctionTemplate")

    hidden_segment_templates = HogFunctionTemplate.objects.filter(
        template_id__startswith="segment-", status="hidden"
    ).values_list("template_id", flat=True)

    # Mark all HogFunction instances that use these templates as deleted
    HogFunction.objects.filter(template_id__in=hidden_segment_templates).update(deleted=True)

    # Delete the templates themselves
    HogFunctionTemplate.objects.filter(template_id__startswith="segment-", status="hidden").delete()


def reverse_remove_segment_hidden_destinations(apps, schema_editor):
    """
    This migration cannot be reversed as we're deleting data
    """
    pass


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0781_alter_externaldatasource_source_type"),
    ]

    operations = [
        migrations.RunPython(
            remove_segment_hidden_destinations,
            reverse_remove_segment_hidden_destinations,
        ),
    ]
