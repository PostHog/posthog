# Generated by Django 4.2.28 on 2026-02-20 11:25

from django.conf import settings
import django.contrib.postgres.operations
from django.db import migrations, models
import django.db.models.deletion
import django.utils.timezone
import posthog.models.utils


class Migration(migrations.Migration):

    atomic = False

    replaces = [('posthog', '0720_add_hog_function_template_model'), ('posthog', '0721_eventingestionrestrictionconfig_note'), ('posthog', '0722_alter_datamodelingjob_status'), ('posthog', '0723_add_help_text_to_cohorts'), ('posthog', '0724_errortrackinggroupingrule'), ('posthog', '0725_file_system_cleanup'), ('posthog', '0726_team_secret_api_token_and_backup'), ('posthog', '0727_team_secret_api_token_unique'), ('posthog', '0728_experiment_conclusion_experiment_conclusion_comment'), ('posthog', '0729_sessionrecordingplaylist_type'), ('posthog', '0730_add_hog_function_template_as_fk_to_hog_function'), ('posthog', '0731_backfill_hog_function_template_fk'), ('posthog', '0732_teamrevenueanalyticsconfig_notified_first_sync'), ('posthog', '0733_file_system_shortcut'), ('posthog', '0734_add_links_model'), ('posthog', '0735_rename_posthog_lin_short_l_33b439_idx_domain_short_code_idx_and_more'), ('posthog', '0736_externaldatajob_finished_at'), ('posthog', '0737_experiment_deleted'), ('posthog', '0738_persisted_folder'), ('posthog', '0739_teamrevenueanalyticsconfig__goals'), ('posthog', '0740_insight_dashboarditem_query_gin'), ('posthog', '0741_experimentsavedmetric_metadata'), ('posthog', '0742_exportedasset_exception')]

    dependencies = [
        ('posthog', '0719_replace_person_with_person_display_name_in_live_events_columns'),
    ]

    operations = [
        migrations.CreateModel(
            name='HogFunctionTemplate',
            fields=[
                ('id', models.UUIDField(default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False)),
                ('template_id', models.CharField(db_index=True, max_length=255)),
                ('sha', models.CharField(db_index=True, max_length=100)),
                ('name', models.CharField(max_length=400)),
                ('description', models.TextField(blank=True, null=True)),
                ('code', models.TextField()),
                ('code_language', models.CharField(default='hog', max_length=20)),
                ('inputs_schema', models.JSONField()),
                ('bytecode', models.JSONField(blank=True, null=True)),
                ('type', models.CharField(max_length=50)),
                ('status', models.CharField(default='alpha', max_length=20)),
                ('category', models.JSONField(default=list)),
                ('kind', models.CharField(blank=True, max_length=50, null=True)),
                ('free', models.BooleanField(default=False)),
                ('icon_url', models.URLField(blank=True, null=True)),
                ('filters', models.JSONField(blank=True, null=True)),
                ('masking', models.JSONField(blank=True, null=True)),
                ('mappings', models.JSONField(blank=True, null=True)),
                ('mapping_templates', models.JSONField(blank=True, null=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
            ],
            options={
                'indexes': [models.Index(fields=['template_id', 'sha'], name='posthog_hog_templat_55950b_idx'), models.Index(fields=['type', 'status'], name='posthog_hog_type_8cac9a_idx'), models.Index(fields=['created_at'], name='posthog_hog_created_6a9df3_idx'), models.Index(fields=['template_id', 'created_at'], name='posthog_hog_templat_d1778e_idx')],
                'unique_together': {('template_id', 'sha')},
            },
        ),
        migrations.AddField(
            model_name='eventingestionrestrictionconfig',
            name='note',
            field=models.TextField(blank=True, help_text='Optional note explaining why this restriction was put in place', null=True),
        ),
        migrations.AlterField(
            model_name='datamodelingjob',
            name='status',
            field=models.CharField(choices=[('Running', 'Running'), ('Completed', 'Completed'), ('Failed', 'Failed'), ('Cancelled', 'Cancelled')], default='Running', max_length=400),
        ),
        migrations.AlterField(
            model_name='cohort',
            name='filters',
            field=models.JSONField(blank=True, help_text='Filters for the cohort. Examples:\n\n        # Behavioral filter (performed event)\n        {\n            "properties": {\n                "type": "OR",\n                "values": [{\n                    "type": "OR",\n                    "values": [{\n                        "key": "address page viewed",\n                        "type": "behavioral",\n                        "value": "performed_event",\n                        "negation": false,\n                        "event_type": "events",\n                        "time_value": "30",\n                        "time_interval": "day"\n                    }]\n                }]\n            }\n        }\n\n        # Person property filter\n        {\n            "properties": {\n                "type": "OR",\n                "values": [{\n                    "type": "AND",\n                    "values": [{\n                        "key": "promoCodes",\n                        "type": "person",\n                        "value": ["1234567890"],\n                        "negation": false,\n                        "operator": "exact"\n                    }]\n                }]\n            }\n        }\n\n        # Cohort filter\n        {\n            "properties": {\n                "type": "OR",\n                "values": [{\n                    "type": "AND",\n                    "values": [{\n                        "key": "id",\n                        "type": "cohort",\n                        "value": 8814,\n                        "negation": false\n                    }]\n                }]\n            }\n        }', null=True),
        ),
        migrations.CreateModel(
            name='ErrorTrackingGroupingRule',
            fields=[
                ('id', models.UUIDField(default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False)),
                ('bytecode', models.JSONField()),
                ('filters', models.JSONField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('disabled_data', models.JSONField(blank=True, null=True)),
                ('order_key', models.IntegerField()),
                ('description', models.TextField(null=True)),
                ('role', models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, to='ee.role')),
                ('team', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='posthog.team')),
                ('user', models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
                ('user_group', models.ForeignKey(null=True, on_delete=django.db.models.deletion.CASCADE, to='posthog.usergroup')),
            ],
            options={
                'indexes': [models.Index(fields=['team_id'], name='posthog_err_team_id_bf614f_idx')],
            },
        ),
        django.contrib.postgres.operations.RemoveIndexConcurrently(
            model_name='filesystem',
            name='posthog_fil_project_840481_idx',
        ),
        django.contrib.postgres.operations.RemoveIndexConcurrently(
            model_name='filesystem',
            name='posthog_fs_project_path',
        ),
        django.contrib.postgres.operations.RemoveIndexConcurrently(
            model_name='filesystem',
            name='posthog_fs_project_depth',
        ),
        django.contrib.postgres.operations.RemoveIndexConcurrently(
            model_name='filesystem',
            name='posthog_fs_project_typeref',
        ),
        migrations.AlterField(
            model_name='filesystem',
            name='created_at',
            field=models.DateTimeField(default=django.utils.timezone.now, editable=False),
        ),
        django.contrib.postgres.operations.AddIndexConcurrently(
            model_name='filesystem',
            index=models.Index(models.F('team_id'), models.F('path'), name='posthog_fs_team_path'),
        ),
        django.contrib.postgres.operations.AddIndexConcurrently(
            model_name='filesystem',
            index=models.Index(models.F('team_id'), models.F('depth'), name='posthog_fs_team_depth'),
        ),
        django.contrib.postgres.operations.AddIndexConcurrently(
            model_name='filesystem',
            index=models.Index(models.F('team_id'), models.F('type'), models.F('ref'), name='posthog_fs_team_typeref'),
        ),
        migrations.AddField(
            model_name='team',
            name='secret_api_token',
            field=models.CharField(blank=True, max_length=200, null=True),
        ),
        migrations.AddField(
            model_name='team',
            name='secret_api_token_backup',
            field=models.CharField(blank=True, max_length=200, null=True),
        ),
        migrations.RunSQL(
            sql='CREATE UNIQUE INDEX CONCURRENTLY team_secret_api_token_unique_idx ON posthog_team (secret_api_token);',
            reverse_sql='DROP INDEX CONCURRENTLY team_secret_api_token_unique_idx;',
        ),
        migrations.RunSQL(
            sql='CREATE UNIQUE INDEX CONCURRENTLY team_secret_api_token_backup_unique_idx ON posthog_team (secret_api_token_backup);',
            reverse_sql='DROP INDEX CONCURRENTLY team_secret_api_token_backup_unique_idx;',
        ),
        migrations.AddField(
            model_name='experiment',
            name='conclusion',
            field=models.CharField(blank=True, choices=[('won', 'Won'), ('lost', 'Lost'), ('inconclusive', 'Inconclusive'), ('stopped_early', 'Stopped Early'), ('invalid', 'Invalid')], max_length=30, null=True),
        ),
        migrations.AddField(
            model_name='experiment',
            name='conclusion_comment',
            field=models.TextField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='sessionrecordingplaylist',
            name='type',
            field=models.CharField(blank=True, choices=[('collection', 'Collection'), ('filters', 'Filters')], max_length=50, null=True),
        ),
        migrations.SeparateDatabaseAndState(
            database_operations=[
                migrations.RunSQL(
                    sql='\n                    ALTER TABLE "posthog_hogfunction" ADD COLUMN "hog_function_template_id" uuid NULL CONSTRAINT "posthog_hogfunction_hog_function_templat_3dc757e7_fk_posthog_h" REFERENCES "posthog_hogfunctiontemplate"("id") DEFERRABLE INITIALLY DEFERRED; -- existing-table-constraint-ignore\n                    SET CONSTRAINTS "posthog_hogfunction_hog_function_templat_3dc757e7_fk_posthog_h" IMMEDIATE; -- existing-table-constraint-ignore\n                    ',
                    reverse_sql='\n                        ALTER TABLE "posthog_hogfunction" DROP COLUMN IF EXISTS "hog_function_template_id";\n                    ',
                ),
                migrations.RunSQL(
                    sql='\n                    CREATE INDEX CONCURRENTLY "posthog_hogfunction_hog_function_template_id_3dc757e7" ON "posthog_hogfunction" ("hog_function_template_id");\n                    ',
                    reverse_sql='\n                        DROP INDEX IF EXISTS "posthog_hogfunction_hog_function_template_id_3dc757e7";\n                    ',
                ),
            ],
            state_operations=[
                migrations.AddField(
                    model_name='hogfunction',
                    name='hog_function_template',
                    field=models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='hog_functions', to='posthog.hogfunctiontemplate'),
                ),
            ],
        ),
        migrations.RunSQL(
            sql="DO $$\nDECLARE\n    _table text;\n    _resolved regclass;\n    _has_rows boolean;\nBEGIN\n    FOREACH _table IN ARRAY ARRAY['posthog_hogfunction'] LOOP\n        _resolved := to_regclass(_table);\n        IF _resolved IS NULL THEN\n            RAISE EXCEPTION 'Bootstrap policy noop_if_empty table % does not exist for %', _table, 'posthog.0731_backfill_hog_function_template_fk op#1';\n        END IF;\n        EXECUTE format('SELECT EXISTS (SELECT 1 FROM %s LIMIT 1)', _resolved) INTO _has_rows;\n        IF _has_rows THEN\n            RAISE EXCEPTION 'Bootstrap policy noop_if_empty blocked: table % is not empty for %', _table, 'posthog.0731_backfill_hog_function_template_fk op#1';\n        END IF;\n    END LOOP;\nEND\n$$;",
            reverse_sql='',
        ),
        migrations.AddField(
            model_name='teamrevenueanalyticsconfig',
            name='notified_first_sync',
            field=models.BooleanField(default=False, null=True),
        ),
        migrations.RunSQL(
            sql="DO $$\nDECLARE\n    _table text;\n    _resolved regclass;\n    _has_rows boolean;\nBEGIN\n    FOREACH _table IN ARRAY ARRAY['posthog_teamrevenueanalyticsconfig'] LOOP\n        _resolved := to_regclass(_table);\n        IF _resolved IS NULL THEN\n            RAISE EXCEPTION 'Bootstrap policy noop_if_empty table % does not exist for %', _table, 'posthog.0732_teamrevenueanalyticsconfig_notified_first_sync op#2';\n        END IF;\n        EXECUTE format('SELECT EXISTS (SELECT 1 FROM %s LIMIT 1)', _resolved) INTO _has_rows;\n        IF _has_rows THEN\n            RAISE EXCEPTION 'Bootstrap policy noop_if_empty blocked: table % is not empty for %', _table, 'posthog.0732_teamrevenueanalyticsconfig_notified_first_sync op#2';\n        END IF;\n    END LOOP;\nEND\n$$;",
            reverse_sql='',
        ),
        migrations.CreateModel(
            name='FileSystemShortcut',
            fields=[
                ('id', models.UUIDField(default=posthog.models.utils.uuid7, primary_key=True, serialize=False)),
                ('path', models.TextField()),
                ('type', models.CharField(blank=True, max_length=100)),
                ('ref', models.CharField(blank=True, max_length=100, null=True)),
                ('href', models.TextField(blank=True, null=True)),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now, editable=False)),
                ('team', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='posthog.team')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'indexes': [models.Index(fields=['team', 'user'], name='posthog_fil_team_id_e8b1fe_idx'), models.Index(models.F('team_id'), models.F('path'), name='posthog_fs_s_team_path'), models.Index(models.F('team_id'), models.F('type'), models.F('ref'), name='posthog_fs_s_team_typeref')],
            },
        ),
        migrations.CreateModel(
            name='Link',
            fields=[
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True, null=True)),
                ('id', models.UUIDField(default=posthog.models.utils.UUIDT, editable=False, primary_key=True, serialize=False)),
                ('redirect_url', models.URLField(max_length=2048)),
                ('short_link_domain', models.CharField(help_text='Domain where the short link is hosted, e.g. hog.gg', max_length=255)),
                ('short_code', models.CharField(help_text="The unique code/path that identifies the short link, e.g. 'abc123'", max_length=255)),
                ('description', models.TextField(blank=True, null=True)),
                ('created_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, to=settings.AUTH_USER_MODEL)),
                ('team', models.ForeignKey(help_text='Team that owns this link', on_delete=django.db.models.deletion.CASCADE, to='posthog.team')),
            ],
            options={
                'indexes': [models.Index(fields=['short_link_domain', 'short_code'], name='domain_short_code_idx'), models.Index(fields=['team_id'], name='team_id_idx')],
            },
        ),
        migrations.AddConstraint(
            model_name='link',
            constraint=models.UniqueConstraint(fields=('short_link_domain', 'short_code'), name='unique_short_link_domain_short_code'),
        ),
        migrations.AddField(
            model_name='externaldatajob',
            name='finished_at',
            field=models.DateTimeField(blank=True, null=True),
        ),
        migrations.AddField(
            model_name='experiment',
            name='deleted',
            field=models.BooleanField(default=False, null=True),
        ),
        migrations.CreateModel(
            name='PersistedFolder',
            fields=[
                ('id', models.UUIDField(default=posthog.models.utils.uuid7, editable=False, primary_key=True, serialize=False)),
                ('type', models.CharField(choices=[('home', 'Home'), ('pinned', 'Pinned')], max_length=32)),
                ('protocol', models.CharField(default='products://', max_length=64)),
                ('path', models.TextField(blank=True, default='')),
                ('created_at', models.DateTimeField(default=django.utils.timezone.now, editable=False)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('team', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to='posthog.team')),
                ('user', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Persisted Folder',
                'verbose_name_plural': 'Persisted Folders',
                'indexes': [models.Index(models.F('team_id'), models.F('user_id'), name='posthog_pf_team_user'), models.Index(models.F('team_id'), models.F('user_id'), models.F('type'), name='posthog_pf_team_user_type')],
                'unique_together': {('team', 'user', 'type')},
            },
        ),
        migrations.AddField(
            model_name='teamrevenueanalyticsconfig',
            name='_goals',
            field=models.JSONField(blank=True, db_column='goals', default=list, null=True),
        ),
        migrations.RunSQL(
            sql='CREATE INDEX CONCURRENTLY IF NOT EXISTS posthog_dashboarditem_query_gin ON posthog_dashboarditem USING GIN (query jsonb_ops);',
            reverse_sql='DROP INDEX CONCURRENTLY IF EXISTS posthog_dashboarditem_query_gin;',
        ),
        migrations.AddField(
            model_name='experimentsavedmetric',
            name='metadata',
            field=models.JSONField(blank=True, default=dict, null=True),
        ),
        migrations.AddField(
            model_name='exportedasset',
            name='exception',
            field=models.TextField(blank=True, null=True),
        ),
    ]
