{% extends "email/base.html" %}
{% load posthog_assets %}
{% load posthog_filters %}

{% block preheader %}Materialized view failures in {{ team.name }}{% endblock %}

{% block heading %}Materialized view failures{% endblock %}

{% block section %}
<p>
    Here is your daily summary of materialized view issues in project <strong>{{ team.name }}</strong>.
</p>

{% if failed_views %}
<h3 style="margin: 16px 0 8px 0;">Failed syncs (last 24 hours)</h3>
<p class="muted" style="margin: 0 0 12px 0;">These views failed during their most recent sync.</p>

{% for view in failed_views %}
<div class="mb" style="border: 1px solid #e1e5e9; padding: 16px; border-radius: 8px; border-left: 4px solid #dc3545;">
    <h4 style="margin: 0 0 4px 0;">
        <a href="{{ view.url }}" target="_blank" style="text-decoration: none; color: #5375ff;">{{ view.name }}</a>
    </h4>
    <p class="muted" style="margin: 4px 0; font-size: 0.9em;">Error: {{ view.error }}</p>
    <p class="muted" style="margin: 4px 0; font-size: 0.9em;">Last run: {{ view.last_run_at }}</p>
</div>
{% endfor %}
{% endif %}

{% if paused_views %}
<h3 style="margin: 16px 0 8px 0;">Paused schedules</h3>
<p class="muted" style="margin: 0 0 12px 0;">These views have been paused due to repeated failures (e.g. query timeouts) and require manual intervention to resume.</p>

{% for view in paused_views %}
<div class="mb" style="border: 1px solid #e1e5e9; padding: 16px; border-radius: 8px; border-left: 4px solid #fd7e14;">
    <h4 style="margin: 0 0 4px 0;">
        <a href="{{ view.url }}" target="_blank" style="text-decoration: none; color: #5375ff;">{{ view.name }}</a>
    </h4>
    <p class="muted" style="margin: 4px 0; font-size: 0.9em;">Reason: {{ view.error }}</p>
</div>
{% endfor %}
{% endif %}

<div class="mb mt text-center">
    <a class="button" href="{{ site_url }}/project/{{ team.id }}/sql">
        Open SQL editor
    </a>
</div>
{% endblock %}

{% block footer %}
Need help?
<a href="https://posthog.com/questions?{{ utm_tags }}"
    target="_blank"><b>Visit support</b></a>
or
<a href="https://posthog.com/docs/data-warehouse/views?{{ utm_tags }}"
    target="_blank"><b>read our documentation</b></a>.<br /><br />

<a href="{% absolute_uri '/settings/user-notifications' %}">Manage these notifications in PostHog</a>
{% endblock %}
