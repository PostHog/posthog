{% extends "email/base.html" %}
{% load posthog_assets %}
{% load posthog_filters %}

{% block preheader %}Data Pipeline Failures Alert{% endblock %}

{% block heading %}Data Pipeline Failures Alert for {{ date }}{% endblock %}

{% block section %}
<p>
    Your data pipelines had failures on <strong>{{ date }}</strong> in project <strong>{{ team.name }}</strong>. Here's what needs attention:
</p>

<div class="mb mt">
    <h2>Summary</h2>
    <p>
        <strong>{{ total_functions }}</strong> function{{ total_functions|pluralize }} ran 
        <strong>{{ total_runs }}</strong> time{{ total_runs|pluralize }}
    </p>
    
    {% if total_succeeded > 0 %}
        <p>‚úÖ <strong>{{ total_succeeded }}</strong> successful run{{ total_succeeded|pluralize }}</p>
    {% endif %}
    
    {% if total_failed > 0 %}
        <p class="danger">‚ùå <strong>{{ total_failed }}</strong> failed run{{ total_failed|pluralize }}</p>
    {% endif %}
    
    {% if total_filtered > 0 %}
        <p>üîç <strong>{{ total_filtered }}</strong> filtered run{{ total_filtered|pluralize }}</p>
    {% endif %}
</div>

<div class="mb mt">
    <h2>Function Details</h2>
    {% for function in functions %}
        <div class="mb">
            <h3>
                <a href="{{ function.url }}" target="_blank">{{ function.name }}</a>
            </h3>
            <p class="muted">Type: {{ function.type|capfirst }}</p>
            
            <p>
                ‚úÖ {{ function.succeeded }} succeeded
                {% if function.failed > 0 %}
                    | <span class="danger">‚ùå {{ function.failed }} failed</span>
                {% endif %}
                {% if function.filtered > 0 %}
                    | üîç {{ function.filtered }} filtered
                {% endif %}
            </p>
            
            {% if function.failed > 0 and function.total_runs > 0 %}
                {% with error_rate=function.failed|floatformat:0|add:0 %}
                    {% with total_rate=function.total_runs|floatformat:0|add:0 %}
                        {% if error_rate > 0 and total_rate > 0 %}
                            {% widthratio error_rate total_rate 100 as error_percentage %}
                            {% if error_percentage > 10 %}
                                <p class="danger">
                                    ‚ö†Ô∏è High error rate ({{ error_percentage }}%)
                                </p>
                            {% endif %}
                        {% endif %}
                    {% endwith %}
                {% endwith %}
            {% endif %}
        </div>
    {% endfor %}
</div>

<div class="mb mt text-center">
    <a class="button" href="{{ site_url }}/project/{{ team.id }}/pipeline">
        View Data Pipelines
    </a>
</div>
{% endblock %}

{% block footer %}
Need help?
<a href="https://posthog.com/questions?{{ utm_tags }}"
    target="_blank"><b>Visit support</b></a>
or
<a href="https://posthog.com/docs?{{ utm_tags }}"
    target="_blank"><b>read our documentation</b></a>.<br /><br />

<a href="{% absolute_uri '/settings/user-notifications' %}">Manage these notifications in PostHog</a>
{% endblock %}