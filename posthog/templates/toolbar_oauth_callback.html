<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Toolbar authorization</title>
</head>
<body>
    <p id="toolbar-oauth-callback-status">Finishing authorization...</p>
    {{ payload|json_script:"toolbar-oauth-payload" }}
    <script>
        (function () {
            const payloadElement = document.getElementById("toolbar-oauth-payload")
            const statusElement = document.getElementById("toolbar-oauth-callback-status")
            if (!payloadElement || !statusElement) {
                return
            }

            const payload = JSON.parse(payloadElement.textContent || "{}")
            const openerWindow = window.opener
            const targetOrigin = "{{ target_origin|escapejs }}"

            if (openerWindow && !openerWindow.closed) {
                // Restrict postMessage to targetOrigin (the PostHog origin that opened
                // this popup) so the payload is not sent to other origins. The opener
                // must validate event.origin and event.data.type before using the payload.
                openerWindow.postMessage(payload, targetOrigin)
                window.close()
                return
            }

            // Fallback path when popup has no opener (manual navigation, blockers).
            statusElement.textContent = "Authorization complete. You can close this window."
        })()
    </script>
</body>
</html>
