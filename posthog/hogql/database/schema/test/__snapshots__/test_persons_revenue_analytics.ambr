# serializer version: 1
# name: TestRevenueAnalytics.test_get_revenue_for_events
  '''
  SELECT persons__revenue_analytics.revenue AS revenue,
         persons__revenue_analytics.revenue AS `$virt_revenue`
  FROM
    (SELECT argMax(person.id, person.version) AS persons___id,
            person.id AS id
     FROM person
     WHERE and(equals(person.team_id, 99999), in(id,
                                                   (SELECT where_optimization.id AS id
                                                    FROM person AS where_optimization
                                                    WHERE and(equals(where_optimization.team_id, 99999), equals(where_optimization.id, '00000000-0000-0000-0000-000000000000')))))
     GROUP BY person.id
     HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0))) AS persons
  LEFT JOIN
    (SELECT 99999 AS team_id,
            accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
            sum(revenue_analytics_revenue_item.amount) AS revenue,
            sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
     FROM
       (SELECT toString(events.uuid) AS id,
               toString(events.uuid) AS invoice_item_id,
               'revenue_analytics.events.purchase' AS source_label,
               toTimeZone(events.timestamp, 'UTC') AS timestamp,
               timestamp AS created_at,
               0 AS is_recurring,
               NULL AS product_id,
               toString(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id)) AS customer_id,
               events.`$group_0` AS group_0_key,
               events.`$group_1` AS group_1_key,
               events.`$group_2` AS group_2_key,
               events.`$group_3` AS group_3_key,
               events.`$group_4` AS group_4_key,
               NULL AS invoice_id,
               NULL AS subscription_id,
               toString(events.`$session_id`) AS session_id,
               events.event AS event_name,
               NULL AS coupon,
               coupon AS coupon_id,
               'USD' AS original_currency,
               accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
               in(original_currency,
                  ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                 if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                 divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                 'USD' AS currency,
                 if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
        FROM events
        LEFT OUTER JOIN
          (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                  person_distinct_id_overrides.distinct_id AS distinct_id
           FROM person_distinct_id_overrides
           WHERE equals(person_distinct_id_overrides.team_id, 99999)
           GROUP BY person_distinct_id_overrides.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__override ON equals(events.distinct_id, events__override.distinct_id)
        WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
        ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
     GROUP BY person_id) AS persons__revenue_analytics ON equals(persons.persons___id, persons__revenue_analytics.person_id)
  WHERE ifNull(equals(persons.id, '00000000-0000-0000-0000-000000000000'), 0)
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1,
                     format_csv_allow_double_quotes=0,
                     max_ast_elements=4000000,
                     max_expanded_ast_elements=4000000,
                     max_bytes_before_external_group_by=0,
                     transform_null_in=1,
                     optimize_min_equality_disjunction_chain_length=4294967295,
                     allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_get_revenue_for_schema_source_for_customer_with_multiple_distinct_ids
  '''
  SELECT persons.id AS id,
         persons__revenue_analytics.revenue AS `$virt_revenue`
  FROM
    (SELECT argMax(person.id, person.version) AS persons___id,
            person.id AS id
     FROM person
     WHERE equals(person.team_id, 99999)
     GROUP BY person.id
     HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
  LEFT JOIN
    (SELECT 99999 AS team_id,
            accurateCastOrNull(revenue_analytics_customer__persons.id, 'UUID') AS person_id,
            sum(revenue_analytics_revenue_item.amount) AS revenue,
            sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
     FROM
       (SELECT if(ifNull(greater(invoice.period_months, 1), 0), concat(ifNull(toString(invoice.invoice_item_id), ''), '_', ifNull(toString(invoice.month_index), '')), invoice.invoice_item_id) AS id,
               invoice.invoice_item_id AS invoice_item_id,
               'stripe.posthog_test' AS source_label,
               addMonths(invoice.timestamp, invoice.month_index) AS timestamp,
               invoice.created_at AS created_at,
               ifNull(notEmpty(invoice.subscription_id), 0) AS is_recurring,
               invoice.product_id AS product_id,
               invoice.customer_id AS customer_id,
               NULL AS group_0_key,
               NULL AS group_1_key,
               NULL AS group_2_key,
               NULL AS group_3_key,
               NULL AS group_4_key,
               invoice.id AS invoice_id,
               invoice.subscription_id AS subscription_id,
               NULL AS session_id,
               NULL AS event_name,
               JSONExtractString(invoice.discount, 'coupon', 'name') AS coupon,
               JSONExtractString(invoice.discount, 'coupon', 'id') AS coupon_id,
               upper(invoice.currency) AS original_currency,
               accurateCastOrNull(invoice.amount_captured, 'Decimal64(10)') AS original_amount,
               in(original_currency,
                  ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                 if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                 divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                 'GBP' AS currency,
                 divideDecimal(if(equals(original_currency, currency), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))))), accurateCastOrNull(invoice.period_months, 'Decimal64(10)')) AS amount
        FROM
          (SELECT posthog_test_stripe_invoice.id AS id,
                  parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC') AS created_at,
                  posthog_test_stripe_invoice.customer AS customer_id,
                  posthog_test_stripe_invoice.subscription AS subscription_id,
                  posthog_test_stripe_invoice.discount AS discount,
                  arrayJoin(JSONExtractArrayRaw(assumeNotNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(posthog_test_stripe_invoice.lines, 'data'), ''), 'null'), '^"|"$', '')))) AS data,
                  JSONExtractString(data, 'id') AS invoice_item_id,
                  JSONExtractUInt(data, 'amount') AS amount_before_discount,
                  coalesce(arraySum(arrayMap(x -> JSONExtractInt(x, 'amount'), JSONExtractArrayRaw(data, 'discount_amounts'))), 0) AS discount_amount,
                  greatest(minus(amount_before_discount, discount_amount), 0) AS amount_captured,
                  JSONExtractString(data, 'currency') AS currency,
                  JSONExtractString(data, 'price', 'product') AS product_id,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'start')) AS period_start,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'end')) AS period_end,
                  greatest(toInt16(round(divide(dateDiff('day', ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')), ifNull(period_end, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC'))), 30.44))), 1) AS period_months,
                  arrayJoin(range(0, period_months)) AS month_index,
                  ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')) AS timestamp
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS posthog_test_stripe_invoice
           WHERE posthog_test_stripe_invoice.paid) AS invoice) AS revenue_analytics_revenue_item
     INNER JOIN
       (SELECT outer.id AS id,
               'stripe.posthog_test' AS source_label,
               parseDateTime64BestEffortOrNull(toString(outer.created), 6, 'UTC') AS timestamp,
               outer.name AS name,
               outer.email AS email,
               outer.phone AS phone,
               outer.address AS address,
               outer.metadata AS metadata,
               JSONExtractString(address, 'country') AS country,
               cohort_inner.cohort AS cohort,
               cohort_inner.initial_coupon AS initial_coupon,
               cohort_inner.initial_coupon_id AS initial_coupon_id
        FROM
          (SELECT *
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_customers/posthog_test_stripe_customer/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `name` String, `email` String, `phone` String, `address` String, `created` DateTime, `metadata` String')) AS outer
        LEFT JOIN
          (SELECT invoice.customer AS customer_id,
                  formatDateTime(toStartOfMonth(min(parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC'))), '%Y-%m') AS cohort,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'name'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'id'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon_id
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS invoice
           GROUP BY invoice.customer) AS cohort_inner ON equals(cohort_inner.customer_id, outer.id)) AS revenue_analytics_customer ON equals(revenue_analytics_revenue_item.customer_id, revenue_analytics_customer.id)
     LEFT JOIN
       (SELECT persons.id AS id,
               persons__pdi.distinct_id AS revenue_analytics_customer__persons___pdi___distinct_id
        FROM
          (SELECT argMax(person.id, person.version) AS persons___id,
                  person.id AS id
           FROM person
           WHERE equals(person.team_id, 99999)
           GROUP BY person.id
           HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
        LEFT JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 99999)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS persons__pdi ON equals(persons.persons___id, persons__pdi.person_id)) AS revenue_analytics_customer__persons ON equals(revenue_analytics_customer.email, revenue_analytics_customer__persons.revenue_analytics_customer__persons___pdi___distinct_id)
     GROUP BY person_id) AS persons__revenue_analytics ON equals(persons.persons___id, persons__revenue_analytics.person_id)
  ORDER BY persons__revenue_analytics.revenue ASC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1,
                     format_csv_allow_double_quotes=1,
                     max_ast_elements=4000000,
                     max_expanded_ast_elements=4000000,
                     max_bytes_before_external_group_by=0,
                     transform_null_in=1,
                     optimize_min_equality_disjunction_chain_length=4294967295,
                     allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_get_revenue_for_schema_source_for_customer_with_multiple_distinct_ids.1
  '''
  SELECT persons__revenue_analytics.revenue AS `$virt_revenue`
  FROM
    (SELECT argMax(person.id, person.version) AS persons___id,
            person.id AS id
     FROM person
     WHERE equals(person.team_id, 99999)
     GROUP BY person.id
     HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
  LEFT JOIN
    (SELECT 99999 AS team_id,
            accurateCastOrNull(revenue_analytics_customer__persons.id, 'UUID') AS person_id,
            sum(revenue_analytics_revenue_item.amount) AS revenue,
            sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
     FROM
       (SELECT if(ifNull(greater(invoice.period_months, 1), 0), concat(ifNull(toString(invoice.invoice_item_id), ''), '_', ifNull(toString(invoice.month_index), '')), invoice.invoice_item_id) AS id,
               invoice.invoice_item_id AS invoice_item_id,
               'stripe.posthog_test' AS source_label,
               addMonths(invoice.timestamp, invoice.month_index) AS timestamp,
               invoice.created_at AS created_at,
               ifNull(notEmpty(invoice.subscription_id), 0) AS is_recurring,
               invoice.product_id AS product_id,
               invoice.customer_id AS customer_id,
               NULL AS group_0_key,
               NULL AS group_1_key,
               NULL AS group_2_key,
               NULL AS group_3_key,
               NULL AS group_4_key,
               invoice.id AS invoice_id,
               invoice.subscription_id AS subscription_id,
               NULL AS session_id,
               NULL AS event_name,
               JSONExtractString(invoice.discount, 'coupon', 'name') AS coupon,
               JSONExtractString(invoice.discount, 'coupon', 'id') AS coupon_id,
               upper(invoice.currency) AS original_currency,
               accurateCastOrNull(invoice.amount_captured, 'Decimal64(10)') AS original_amount,
               in(original_currency,
                  ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                 if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                 divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                 'GBP' AS currency,
                 divideDecimal(if(equals(original_currency, currency), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))))), accurateCastOrNull(invoice.period_months, 'Decimal64(10)')) AS amount
        FROM
          (SELECT posthog_test_stripe_invoice.id AS id,
                  parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC') AS created_at,
                  posthog_test_stripe_invoice.customer AS customer_id,
                  posthog_test_stripe_invoice.subscription AS subscription_id,
                  posthog_test_stripe_invoice.discount AS discount,
                  arrayJoin(JSONExtractArrayRaw(assumeNotNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(posthog_test_stripe_invoice.lines, 'data'), ''), 'null'), '^"|"$', '')))) AS data,
                  JSONExtractString(data, 'id') AS invoice_item_id,
                  JSONExtractUInt(data, 'amount') AS amount_before_discount,
                  coalesce(arraySum(arrayMap(x -> JSONExtractInt(x, 'amount'), JSONExtractArrayRaw(data, 'discount_amounts'))), 0) AS discount_amount,
                  greatest(minus(amount_before_discount, discount_amount), 0) AS amount_captured,
                  JSONExtractString(data, 'currency') AS currency,
                  JSONExtractString(data, 'price', 'product') AS product_id,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'start')) AS period_start,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'end')) AS period_end,
                  greatest(toInt16(round(divide(dateDiff('day', ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')), ifNull(period_end, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC'))), 30.44))), 1) AS period_months,
                  arrayJoin(range(0, period_months)) AS month_index,
                  ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')) AS timestamp
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS posthog_test_stripe_invoice
           WHERE posthog_test_stripe_invoice.paid) AS invoice) AS revenue_analytics_revenue_item
     INNER JOIN
       (SELECT outer.id AS id,
               'stripe.posthog_test' AS source_label,
               parseDateTime64BestEffortOrNull(toString(outer.created), 6, 'UTC') AS timestamp,
               outer.name AS name,
               outer.email AS email,
               outer.phone AS phone,
               outer.address AS address,
               outer.metadata AS metadata,
               JSONExtractString(address, 'country') AS country,
               cohort_inner.cohort AS cohort,
               cohort_inner.initial_coupon AS initial_coupon,
               cohort_inner.initial_coupon_id AS initial_coupon_id
        FROM
          (SELECT *
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_customers/posthog_test_stripe_customer/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `name` String, `email` String, `phone` String, `address` String, `created` DateTime, `metadata` String')) AS outer
        LEFT JOIN
          (SELECT invoice.customer AS customer_id,
                  formatDateTime(toStartOfMonth(min(parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC'))), '%Y-%m') AS cohort,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'name'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'id'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon_id
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS invoice
           GROUP BY invoice.customer) AS cohort_inner ON equals(cohort_inner.customer_id, outer.id)) AS revenue_analytics_customer ON equals(revenue_analytics_revenue_item.customer_id, revenue_analytics_customer.id)
     LEFT JOIN
       (SELECT persons.id AS id,
               persons__pdi.distinct_id AS revenue_analytics_customer__persons___pdi___distinct_id
        FROM
          (SELECT argMax(person.id, person.version) AS persons___id,
                  person.id AS id
           FROM person
           WHERE equals(person.team_id, 99999)
           GROUP BY person.id
           HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
        LEFT JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 99999)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS persons__pdi ON equals(persons.persons___id, persons__pdi.person_id)) AS revenue_analytics_customer__persons ON equals(revenue_analytics_customer.email, revenue_analytics_customer__persons.revenue_analytics_customer__persons___pdi___distinct_id)
     GROUP BY person_id) AS persons__revenue_analytics ON equals(persons.persons___id, persons__revenue_analytics.person_id)
  ORDER BY persons__revenue_analytics.revenue ASC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1,
                     format_csv_allow_double_quotes=1,
                     max_ast_elements=4000000,
                     max_expanded_ast_elements=4000000,
                     max_bytes_before_external_group_by=0,
                     transform_null_in=1,
                     optimize_min_equality_disjunction_chain_length=4294967295,
                     allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_get_revenue_for_schema_source_for_email_join
  '''
  SELECT persons.id AS id,
         persons__revenue_analytics.revenue AS revenue,
         persons__revenue_analytics.revenue AS `$virt_revenue`
  FROM
    (SELECT argMax(person.id, person.version) AS persons___id,
            person.id AS id
     FROM person
     WHERE equals(person.team_id, 99999)
     GROUP BY person.id
     HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
  LEFT JOIN
    (SELECT 99999 AS team_id,
            accurateCastOrNull(revenue_analytics_customer__persons.id, 'UUID') AS person_id,
            sum(revenue_analytics_revenue_item.amount) AS revenue,
            sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
     FROM
       (SELECT if(ifNull(greater(invoice.period_months, 1), 0), concat(ifNull(toString(invoice.invoice_item_id), ''), '_', ifNull(toString(invoice.month_index), '')), invoice.invoice_item_id) AS id,
               invoice.invoice_item_id AS invoice_item_id,
               'stripe.posthog_test' AS source_label,
               addMonths(invoice.timestamp, invoice.month_index) AS timestamp,
               invoice.created_at AS created_at,
               ifNull(notEmpty(invoice.subscription_id), 0) AS is_recurring,
               invoice.product_id AS product_id,
               invoice.customer_id AS customer_id,
               NULL AS group_0_key,
               NULL AS group_1_key,
               NULL AS group_2_key,
               NULL AS group_3_key,
               NULL AS group_4_key,
               invoice.id AS invoice_id,
               invoice.subscription_id AS subscription_id,
               NULL AS session_id,
               NULL AS event_name,
               JSONExtractString(invoice.discount, 'coupon', 'name') AS coupon,
               JSONExtractString(invoice.discount, 'coupon', 'id') AS coupon_id,
               upper(invoice.currency) AS original_currency,
               accurateCastOrNull(invoice.amount_captured, 'Decimal64(10)') AS original_amount,
               in(original_currency,
                  ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                 if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                 divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                 'GBP' AS currency,
                 divideDecimal(if(equals(original_currency, currency), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))))), accurateCastOrNull(invoice.period_months, 'Decimal64(10)')) AS amount
        FROM
          (SELECT posthog_test_stripe_invoice.id AS id,
                  parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC') AS created_at,
                  posthog_test_stripe_invoice.customer AS customer_id,
                  posthog_test_stripe_invoice.subscription AS subscription_id,
                  posthog_test_stripe_invoice.discount AS discount,
                  arrayJoin(JSONExtractArrayRaw(assumeNotNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(posthog_test_stripe_invoice.lines, 'data'), ''), 'null'), '^"|"$', '')))) AS data,
                  JSONExtractString(data, 'id') AS invoice_item_id,
                  JSONExtractUInt(data, 'amount') AS amount_before_discount,
                  coalesce(arraySum(arrayMap(x -> JSONExtractInt(x, 'amount'), JSONExtractArrayRaw(data, 'discount_amounts'))), 0) AS discount_amount,
                  greatest(minus(amount_before_discount, discount_amount), 0) AS amount_captured,
                  JSONExtractString(data, 'currency') AS currency,
                  JSONExtractString(data, 'price', 'product') AS product_id,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'start')) AS period_start,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'end')) AS period_end,
                  greatest(toInt16(round(divide(dateDiff('day', ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')), ifNull(period_end, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC'))), 30.44))), 1) AS period_months,
                  arrayJoin(range(0, period_months)) AS month_index,
                  ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')) AS timestamp
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS posthog_test_stripe_invoice
           WHERE posthog_test_stripe_invoice.paid) AS invoice) AS revenue_analytics_revenue_item
     INNER JOIN
       (SELECT outer.id AS id,
               'stripe.posthog_test' AS source_label,
               parseDateTime64BestEffortOrNull(toString(outer.created), 6, 'UTC') AS timestamp,
               outer.name AS name,
               outer.email AS email,
               outer.phone AS phone,
               outer.address AS address,
               outer.metadata AS metadata,
               JSONExtractString(address, 'country') AS country,
               cohort_inner.cohort AS cohort,
               cohort_inner.initial_coupon AS initial_coupon,
               cohort_inner.initial_coupon_id AS initial_coupon_id
        FROM
          (SELECT *
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_customers/posthog_test_stripe_customer/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `name` String, `email` String, `phone` String, `address` String, `created` DateTime, `metadata` String')) AS outer
        LEFT JOIN
          (SELECT invoice.customer AS customer_id,
                  formatDateTime(toStartOfMonth(min(parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC'))), '%Y-%m') AS cohort,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'name'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'id'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon_id
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS invoice
           GROUP BY invoice.customer) AS cohort_inner ON equals(cohort_inner.customer_id, outer.id)) AS revenue_analytics_customer ON equals(revenue_analytics_revenue_item.customer_id, revenue_analytics_customer.id)
     LEFT JOIN
       (SELECT persons.id AS id,
               persons__pdi.distinct_id AS revenue_analytics_customer__persons___pdi___distinct_id
        FROM
          (SELECT argMax(person.id, person.version) AS persons___id,
                  person.id AS id
           FROM person
           WHERE equals(person.team_id, 99999)
           GROUP BY person.id
           HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
        LEFT JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 99999)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS persons__pdi ON equals(persons.persons___id, persons__pdi.person_id)) AS revenue_analytics_customer__persons ON equals(revenue_analytics_customer.email, revenue_analytics_customer__persons.revenue_analytics_customer__persons___pdi___distinct_id)
     GROUP BY person_id) AS persons__revenue_analytics ON equals(persons.persons___id, persons__revenue_analytics.person_id)
  ORDER BY persons.id ASC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1,
                     format_csv_allow_double_quotes=1,
                     max_ast_elements=4000000,
                     max_expanded_ast_elements=4000000,
                     max_bytes_before_external_group_by=0,
                     transform_null_in=1,
                     optimize_min_equality_disjunction_chain_length=4294967295,
                     allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_get_revenue_for_schema_source_for_id_join
  '''
  SELECT persons.id AS id,
         persons__revenue_analytics.revenue AS revenue
  FROM
    (SELECT argMax(person.id, person.version) AS persons___id,
            person.id AS id
     FROM person
     WHERE equals(person.team_id, 99999)
     GROUP BY person.id
     HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
  LEFT JOIN
    (SELECT 99999 AS team_id,
            accurateCastOrNull(revenue_analytics_customer__persons.id, 'UUID') AS person_id,
            sum(revenue_analytics_revenue_item.amount) AS revenue,
            sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
     FROM
       (SELECT if(ifNull(greater(invoice.period_months, 1), 0), concat(ifNull(toString(invoice.invoice_item_id), ''), '_', ifNull(toString(invoice.month_index), '')), invoice.invoice_item_id) AS id,
               invoice.invoice_item_id AS invoice_item_id,
               'stripe.posthog_test' AS source_label,
               addMonths(invoice.timestamp, invoice.month_index) AS timestamp,
               invoice.created_at AS created_at,
               ifNull(notEmpty(invoice.subscription_id), 0) AS is_recurring,
               invoice.product_id AS product_id,
               invoice.customer_id AS customer_id,
               NULL AS group_0_key,
               NULL AS group_1_key,
               NULL AS group_2_key,
               NULL AS group_3_key,
               NULL AS group_4_key,
               invoice.id AS invoice_id,
               invoice.subscription_id AS subscription_id,
               NULL AS session_id,
               NULL AS event_name,
               JSONExtractString(invoice.discount, 'coupon', 'name') AS coupon,
               JSONExtractString(invoice.discount, 'coupon', 'id') AS coupon_id,
               upper(invoice.currency) AS original_currency,
               accurateCastOrNull(invoice.amount_captured, 'Decimal64(10)') AS original_amount,
               in(original_currency,
                  ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                 if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                 divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                 'GBP' AS currency,
                 divideDecimal(if(equals(original_currency, currency), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))))), accurateCastOrNull(invoice.period_months, 'Decimal64(10)')) AS amount
        FROM
          (SELECT posthog_test_stripe_invoice.id AS id,
                  parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC') AS created_at,
                  posthog_test_stripe_invoice.customer AS customer_id,
                  posthog_test_stripe_invoice.subscription AS subscription_id,
                  posthog_test_stripe_invoice.discount AS discount,
                  arrayJoin(JSONExtractArrayRaw(assumeNotNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(posthog_test_stripe_invoice.lines, 'data'), ''), 'null'), '^"|"$', '')))) AS data,
                  JSONExtractString(data, 'id') AS invoice_item_id,
                  JSONExtractUInt(data, 'amount') AS amount_before_discount,
                  coalesce(arraySum(arrayMap(x -> JSONExtractInt(x, 'amount'), JSONExtractArrayRaw(data, 'discount_amounts'))), 0) AS discount_amount,
                  greatest(minus(amount_before_discount, discount_amount), 0) AS amount_captured,
                  JSONExtractString(data, 'currency') AS currency,
                  JSONExtractString(data, 'price', 'product') AS product_id,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'start')) AS period_start,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'end')) AS period_end,
                  greatest(toInt16(round(divide(dateDiff('day', ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')), ifNull(period_end, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC'))), 30.44))), 1) AS period_months,
                  arrayJoin(range(0, period_months)) AS month_index,
                  ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')) AS timestamp
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS posthog_test_stripe_invoice
           WHERE posthog_test_stripe_invoice.paid) AS invoice) AS revenue_analytics_revenue_item
     INNER JOIN
       (SELECT outer.id AS id,
               'stripe.posthog_test' AS source_label,
               parseDateTime64BestEffortOrNull(toString(outer.created), 6, 'UTC') AS timestamp,
               outer.name AS name,
               outer.email AS email,
               outer.phone AS phone,
               outer.address AS address,
               outer.metadata AS metadata,
               JSONExtractString(address, 'country') AS country,
               cohort_inner.cohort AS cohort,
               cohort_inner.initial_coupon AS initial_coupon,
               cohort_inner.initial_coupon_id AS initial_coupon_id
        FROM
          (SELECT *
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_customers/posthog_test_stripe_customer/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `name` String, `email` String, `phone` String, `address` String, `created` DateTime, `metadata` String')) AS outer
        LEFT JOIN
          (SELECT invoice.customer AS customer_id,
                  formatDateTime(toStartOfMonth(min(parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC'))), '%Y-%m') AS cohort,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'name'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'id'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon_id
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS invoice
           GROUP BY invoice.customer) AS cohort_inner ON equals(cohort_inner.customer_id, outer.id)) AS revenue_analytics_customer ON equals(revenue_analytics_revenue_item.customer_id, revenue_analytics_customer.id)
     LEFT JOIN
       (SELECT persons.id AS id,
               persons__pdi.distinct_id AS revenue_analytics_customer__persons___pdi___distinct_id
        FROM
          (SELECT argMax(person.id, person.version) AS persons___id,
                  person.id AS id
           FROM person
           WHERE equals(person.team_id, 99999)
           GROUP BY person.id
           HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
        LEFT JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 99999)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS persons__pdi ON equals(persons.persons___id, persons__pdi.person_id)) AS revenue_analytics_customer__persons ON equals(revenue_analytics_customer.id, revenue_analytics_customer__persons.revenue_analytics_customer__persons___pdi___distinct_id)
     GROUP BY person_id) AS persons__revenue_analytics ON equals(persons.persons___id, persons__revenue_analytics.person_id)
  ORDER BY persons.id ASC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1,
                     format_csv_allow_double_quotes=1,
                     max_ast_elements=4000000,
                     max_expanded_ast_elements=4000000,
                     max_bytes_before_external_group_by=0,
                     transform_null_in=1,
                     optimize_min_equality_disjunction_chain_length=4294967295,
                     allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_get_revenue_for_schema_source_for_id_join.1
  '''
  SELECT persons.id AS id,
         persons__revenue_analytics.revenue AS `$virt_revenue`
  FROM
    (SELECT argMax(person.id, person.version) AS persons___id,
            person.id AS id
     FROM person
     WHERE equals(person.team_id, 99999)
     GROUP BY person.id
     HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
  LEFT JOIN
    (SELECT 99999 AS team_id,
            accurateCastOrNull(revenue_analytics_customer__persons.id, 'UUID') AS person_id,
            sum(revenue_analytics_revenue_item.amount) AS revenue,
            sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
     FROM
       (SELECT if(ifNull(greater(invoice.period_months, 1), 0), concat(ifNull(toString(invoice.invoice_item_id), ''), '_', ifNull(toString(invoice.month_index), '')), invoice.invoice_item_id) AS id,
               invoice.invoice_item_id AS invoice_item_id,
               'stripe.posthog_test' AS source_label,
               addMonths(invoice.timestamp, invoice.month_index) AS timestamp,
               invoice.created_at AS created_at,
               ifNull(notEmpty(invoice.subscription_id), 0) AS is_recurring,
               invoice.product_id AS product_id,
               invoice.customer_id AS customer_id,
               NULL AS group_0_key,
               NULL AS group_1_key,
               NULL AS group_2_key,
               NULL AS group_3_key,
               NULL AS group_4_key,
               invoice.id AS invoice_id,
               invoice.subscription_id AS subscription_id,
               NULL AS session_id,
               NULL AS event_name,
               JSONExtractString(invoice.discount, 'coupon', 'name') AS coupon,
               JSONExtractString(invoice.discount, 'coupon', 'id') AS coupon_id,
               upper(invoice.currency) AS original_currency,
               accurateCastOrNull(invoice.amount_captured, 'Decimal64(10)') AS original_amount,
               in(original_currency,
                  ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                 if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                 divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                 'GBP' AS currency,
                 divideDecimal(if(equals(original_currency, currency), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))))), accurateCastOrNull(invoice.period_months, 'Decimal64(10)')) AS amount
        FROM
          (SELECT posthog_test_stripe_invoice.id AS id,
                  parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC') AS created_at,
                  posthog_test_stripe_invoice.customer AS customer_id,
                  posthog_test_stripe_invoice.subscription AS subscription_id,
                  posthog_test_stripe_invoice.discount AS discount,
                  arrayJoin(JSONExtractArrayRaw(assumeNotNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(posthog_test_stripe_invoice.lines, 'data'), ''), 'null'), '^"|"$', '')))) AS data,
                  JSONExtractString(data, 'id') AS invoice_item_id,
                  JSONExtractUInt(data, 'amount') AS amount_before_discount,
                  coalesce(arraySum(arrayMap(x -> JSONExtractInt(x, 'amount'), JSONExtractArrayRaw(data, 'discount_amounts'))), 0) AS discount_amount,
                  greatest(minus(amount_before_discount, discount_amount), 0) AS amount_captured,
                  JSONExtractString(data, 'currency') AS currency,
                  JSONExtractString(data, 'price', 'product') AS product_id,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'start')) AS period_start,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'end')) AS period_end,
                  greatest(toInt16(round(divide(dateDiff('day', ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')), ifNull(period_end, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC'))), 30.44))), 1) AS period_months,
                  arrayJoin(range(0, period_months)) AS month_index,
                  ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')) AS timestamp
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS posthog_test_stripe_invoice
           WHERE posthog_test_stripe_invoice.paid) AS invoice) AS revenue_analytics_revenue_item
     INNER JOIN
       (SELECT outer.id AS id,
               'stripe.posthog_test' AS source_label,
               parseDateTime64BestEffortOrNull(toString(outer.created), 6, 'UTC') AS timestamp,
               outer.name AS name,
               outer.email AS email,
               outer.phone AS phone,
               outer.address AS address,
               outer.metadata AS metadata,
               JSONExtractString(address, 'country') AS country,
               cohort_inner.cohort AS cohort,
               cohort_inner.initial_coupon AS initial_coupon,
               cohort_inner.initial_coupon_id AS initial_coupon_id
        FROM
          (SELECT *
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_customers/posthog_test_stripe_customer/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `name` String, `email` String, `phone` String, `address` String, `created` DateTime, `metadata` String')) AS outer
        LEFT JOIN
          (SELECT invoice.customer AS customer_id,
                  formatDateTime(toStartOfMonth(min(parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC'))), '%Y-%m') AS cohort,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'name'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'id'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon_id
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS invoice
           GROUP BY invoice.customer) AS cohort_inner ON equals(cohort_inner.customer_id, outer.id)) AS revenue_analytics_customer ON equals(revenue_analytics_revenue_item.customer_id, revenue_analytics_customer.id)
     LEFT JOIN
       (SELECT persons.id AS id,
               persons__pdi.distinct_id AS revenue_analytics_customer__persons___pdi___distinct_id
        FROM
          (SELECT argMax(person.id, person.version) AS persons___id,
                  person.id AS id
           FROM person
           WHERE equals(person.team_id, 99999)
           GROUP BY person.id
           HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
        LEFT JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 99999)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS persons__pdi ON equals(persons.persons___id, persons__pdi.person_id)) AS revenue_analytics_customer__persons ON equals(revenue_analytics_customer.id, revenue_analytics_customer__persons.revenue_analytics_customer__persons___pdi___distinct_id)
     GROUP BY person_id) AS persons__revenue_analytics ON equals(persons.persons___id, persons__revenue_analytics.person_id)
  ORDER BY persons.id ASC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1,
                     format_csv_allow_double_quotes=1,
                     max_ast_elements=4000000,
                     max_expanded_ast_elements=4000000,
                     max_bytes_before_external_group_by=0,
                     transform_null_in=1,
                     optimize_min_equality_disjunction_chain_length=4294967295,
                     allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_get_revenue_for_schema_source_for_metadata_join
  '''
  SELECT persons.id AS id,
         persons__revenue_analytics.revenue AS revenue,
         persons__revenue_analytics.revenue AS `$virt_revenue`
  FROM
    (SELECT argMax(person.id, person.version) AS persons___id,
            person.id AS id
     FROM person
     WHERE equals(person.team_id, 99999)
     GROUP BY person.id
     HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
  LEFT JOIN
    (SELECT 99999 AS team_id,
            accurateCastOrNull(revenue_analytics_customer__persons.id, 'UUID') AS person_id,
            sum(revenue_analytics_revenue_item.amount) AS revenue,
            sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
     FROM
       (SELECT if(ifNull(greater(invoice.period_months, 1), 0), concat(ifNull(toString(invoice.invoice_item_id), ''), '_', ifNull(toString(invoice.month_index), '')), invoice.invoice_item_id) AS id,
               invoice.invoice_item_id AS invoice_item_id,
               'stripe.posthog_test' AS source_label,
               addMonths(invoice.timestamp, invoice.month_index) AS timestamp,
               invoice.created_at AS created_at,
               ifNull(notEmpty(invoice.subscription_id), 0) AS is_recurring,
               invoice.product_id AS product_id,
               invoice.customer_id AS customer_id,
               NULL AS group_0_key,
               NULL AS group_1_key,
               NULL AS group_2_key,
               NULL AS group_3_key,
               NULL AS group_4_key,
               invoice.id AS invoice_id,
               invoice.subscription_id AS subscription_id,
               NULL AS session_id,
               NULL AS event_name,
               JSONExtractString(invoice.discount, 'coupon', 'name') AS coupon,
               JSONExtractString(invoice.discount, 'coupon', 'id') AS coupon_id,
               upper(invoice.currency) AS original_currency,
               accurateCastOrNull(invoice.amount_captured, 'Decimal64(10)') AS original_amount,
               in(original_currency,
                  ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                 if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                 divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                 'GBP' AS currency,
                 divideDecimal(if(equals(original_currency, currency), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))))), accurateCastOrNull(invoice.period_months, 'Decimal64(10)')) AS amount
        FROM
          (SELECT posthog_test_stripe_invoice.id AS id,
                  parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC') AS created_at,
                  posthog_test_stripe_invoice.customer AS customer_id,
                  posthog_test_stripe_invoice.subscription AS subscription_id,
                  posthog_test_stripe_invoice.discount AS discount,
                  arrayJoin(JSONExtractArrayRaw(assumeNotNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(posthog_test_stripe_invoice.lines, 'data'), ''), 'null'), '^"|"$', '')))) AS data,
                  JSONExtractString(data, 'id') AS invoice_item_id,
                  JSONExtractUInt(data, 'amount') AS amount_before_discount,
                  coalesce(arraySum(arrayMap(x -> JSONExtractInt(x, 'amount'), JSONExtractArrayRaw(data, 'discount_amounts'))), 0) AS discount_amount,
                  greatest(minus(amount_before_discount, discount_amount), 0) AS amount_captured,
                  JSONExtractString(data, 'currency') AS currency,
                  JSONExtractString(data, 'price', 'product') AS product_id,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'start')) AS period_start,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'end')) AS period_end,
                  greatest(toInt16(round(divide(dateDiff('day', ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')), ifNull(period_end, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC'))), 30.44))), 1) AS period_months,
                  arrayJoin(range(0, period_months)) AS month_index,
                  ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')) AS timestamp
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS posthog_test_stripe_invoice
           WHERE posthog_test_stripe_invoice.paid) AS invoice) AS revenue_analytics_revenue_item
     INNER JOIN
       (SELECT outer.id AS id,
               'stripe.posthog_test' AS source_label,
               parseDateTime64BestEffortOrNull(toString(outer.created), 6, 'UTC') AS timestamp,
               outer.name AS name,
               outer.email AS email,
               outer.phone AS phone,
               outer.address AS address,
               outer.metadata AS metadata,
               JSONExtractString(address, 'country') AS country,
               cohort_inner.cohort AS cohort,
               cohort_inner.initial_coupon AS initial_coupon,
               cohort_inner.initial_coupon_id AS initial_coupon_id
        FROM
          (SELECT *
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_customers/posthog_test_stripe_customer/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `name` String, `email` String, `phone` String, `address` String, `created` DateTime, `metadata` String')) AS outer
        LEFT JOIN
          (SELECT invoice.customer AS customer_id,
                  formatDateTime(toStartOfMonth(min(parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC'))), '%Y-%m') AS cohort,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'name'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'id'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon_id
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS invoice
           GROUP BY invoice.customer) AS cohort_inner ON equals(cohort_inner.customer_id, outer.id)) AS revenue_analytics_customer ON equals(revenue_analytics_revenue_item.customer_id, revenue_analytics_customer.id)
     LEFT JOIN
       (SELECT persons.id AS id,
               persons__pdi.distinct_id AS revenue_analytics_customer__persons___pdi___distinct_id
        FROM
          (SELECT argMax(person.id, person.version) AS persons___id,
                  person.id AS id
           FROM person
           WHERE equals(person.team_id, 99999)
           GROUP BY person.id
           HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
        LEFT JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 99999)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS persons__pdi ON equals(persons.persons___id, persons__pdi.person_id)) AS revenue_analytics_customer__persons ON equals(JSONExtractString(revenue_analytics_customer.metadata, 'id'), revenue_analytics_customer__persons.revenue_analytics_customer__persons___pdi___distinct_id)
     GROUP BY person_id) AS persons__revenue_analytics ON equals(persons.persons___id, persons__revenue_analytics.person_id)
  ORDER BY persons.id ASC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1,
                     format_csv_allow_double_quotes=1,
                     max_ast_elements=4000000,
                     max_expanded_ast_elements=4000000,
                     max_bytes_before_external_group_by=0,
                     transform_null_in=1,
                     optimize_min_equality_disjunction_chain_length=4294967295,
                     allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_query_revenue_analytics_table
  '''
  SELECT persons_revenue_analytics.person_id AS person_id,
         persons_revenue_analytics.revenue AS revenue,
         persons_revenue_analytics.revenue_last_30_days AS revenue_last_30_days
  FROM
    (SELECT 99999 AS team_id,
            accurateCastOrNull(revenue_analytics_customer__persons.id, 'UUID') AS person_id,
            sum(revenue_analytics_revenue_item.amount) AS revenue,
            sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
     FROM
       (SELECT if(ifNull(greater(invoice.period_months, 1), 0), concat(ifNull(toString(invoice.invoice_item_id), ''), '_', ifNull(toString(invoice.month_index), '')), invoice.invoice_item_id) AS id,
               invoice.invoice_item_id AS invoice_item_id,
               'stripe.posthog_test' AS source_label,
               addMonths(invoice.timestamp, invoice.month_index) AS timestamp,
               invoice.created_at AS created_at,
               ifNull(notEmpty(invoice.subscription_id), 0) AS is_recurring,
               invoice.product_id AS product_id,
               invoice.customer_id AS customer_id,
               NULL AS group_0_key,
               NULL AS group_1_key,
               NULL AS group_2_key,
               NULL AS group_3_key,
               NULL AS group_4_key,
               invoice.id AS invoice_id,
               invoice.subscription_id AS subscription_id,
               NULL AS session_id,
               NULL AS event_name,
               JSONExtractString(invoice.discount, 'coupon', 'name') AS coupon,
               JSONExtractString(invoice.discount, 'coupon', 'id') AS coupon_id,
               upper(invoice.currency) AS original_currency,
               accurateCastOrNull(invoice.amount_captured, 'Decimal64(10)') AS original_amount,
               in(original_currency,
                  ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                 if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                 divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                 'GBP' AS currency,
                 divideDecimal(if(equals(original_currency, currency), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', original_currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', currency, toDate(ifNull(timestamp, toDateTime(0, 'UTC'))), toDecimal64(0, 10))))), accurateCastOrNull(invoice.period_months, 'Decimal64(10)')) AS amount
        FROM
          (SELECT posthog_test_stripe_invoice.id AS id,
                  parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC') AS created_at,
                  posthog_test_stripe_invoice.customer AS customer_id,
                  posthog_test_stripe_invoice.subscription AS subscription_id,
                  posthog_test_stripe_invoice.discount AS discount,
                  arrayJoin(JSONExtractArrayRaw(assumeNotNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(posthog_test_stripe_invoice.lines, 'data'), ''), 'null'), '^"|"$', '')))) AS data,
                  JSONExtractString(data, 'id') AS invoice_item_id,
                  JSONExtractUInt(data, 'amount') AS amount_before_discount,
                  coalesce(arraySum(arrayMap(x -> JSONExtractInt(x, 'amount'), JSONExtractArrayRaw(data, 'discount_amounts'))), 0) AS discount_amount,
                  greatest(minus(amount_before_discount, discount_amount), 0) AS amount_captured,
                  JSONExtractString(data, 'currency') AS currency,
                  JSONExtractString(data, 'price', 'product') AS product_id,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'start')) AS period_start,
                  fromUnixTimestamp(JSONExtractUInt(data, 'period', 'end')) AS period_end,
                  greatest(toInt16(round(divide(dateDiff('day', ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')), ifNull(period_end, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC'))), 30.44))), 1) AS period_months,
                  arrayJoin(range(0, period_months)) AS month_index,
                  ifNull(period_start, parseDateTime64BestEffortOrNull(toString(posthog_test_stripe_invoice.created), 6, 'UTC')) AS timestamp
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS posthog_test_stripe_invoice
           WHERE posthog_test_stripe_invoice.paid) AS invoice) AS revenue_analytics_revenue_item
     INNER JOIN
       (SELECT outer.id AS id,
               'stripe.posthog_test' AS source_label,
               parseDateTime64BestEffortOrNull(toString(outer.created), 6, 'UTC') AS timestamp,
               outer.name AS name,
               outer.email AS email,
               outer.phone AS phone,
               outer.address AS address,
               outer.metadata AS metadata,
               JSONExtractString(address, 'country') AS country,
               cohort_inner.cohort AS cohort,
               cohort_inner.initial_coupon AS initial_coupon,
               cohort_inner.initial_coupon_id AS initial_coupon_id
        FROM
          (SELECT *
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_customers/posthog_test_stripe_customer/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `name` String, `email` String, `phone` String, `address` String, `created` DateTime, `metadata` String')) AS outer
        LEFT JOIN
          (SELECT invoice.customer AS customer_id,
                  formatDateTime(toStartOfMonth(min(parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC'))), '%Y-%m') AS cohort,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'name'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon,
                  argMin(JSONExtractString(invoice.discount, 'coupon', 'id'), parseDateTime64BestEffortOrNull(toString(invoice.created), 6, 'UTC')) AS initial_coupon_id
           FROM s3('http://host.docker.internal:19000/posthog/test_storage_bucket-posthog.revenue_analytics.insights_query_runner.stripe_invoices/posthog_test_stripe_invoice/*.csv', 'object_storage_root_user', 'object_storage_root_password', 'CSVWithNames', '`id` String, `tax` Int64, `paid` UInt8, `lines` String, `total` Int64, `charge` String, `issuer` String, `number` String, `object` String, `status` String, `created` DateTime, `currency` String, `customer` String, `discount` String, `due_date` DateTime, `livemode` UInt8, `metadata` String, `subtotal` Int64, `attempted` UInt8, `discounts` String, `rendering` String, `amount_due` Int64, `amount_paid` Int64, `description` String, `invoice_pdf` String, `account_name` String, `auto_advance` UInt8, `effective_at` DateTime, `subscription` String, `attempt_count` UInt8, `automatic_tax` String, `customer_name` String, `period_end_at` DateTime, `billing_reason` String, `customer_email` String, `ending_balance` Int64, `payment_intent` String, `account_country` String, `amount_shipping` Int64, `period_start_at` DateTime, `amount_remaining` Int64, `customer_address` String, `customer_tax_ids` String, `paid_out_of_band` UInt8, `payment_settings` String, `starting_balance` Int64, `collection_method` String, `default_tax_rates` String, `total_tax_amounts` String, `hosted_invoice_url` String, `status_transitions` String, `customer_tax_exempt` String, `total_excluding_tax` Int64, `subscription_details` String, `webhooks_delivered_at` DateTime, `subtotal_excluding_tax` Int64, `total_discount_amounts` String, `pre_payment_credit_notes_amount` Int64, `post_payment_credit_notes_amount` Int64') AS invoice
           GROUP BY invoice.customer) AS cohort_inner ON equals(cohort_inner.customer_id, outer.id)) AS revenue_analytics_customer ON equals(revenue_analytics_revenue_item.customer_id, revenue_analytics_customer.id)
     LEFT JOIN
       (SELECT persons.id AS id,
               persons__pdi.distinct_id AS revenue_analytics_customer__persons___pdi___distinct_id
        FROM
          (SELECT argMax(person.id, person.version) AS persons___id,
                  person.id AS id
           FROM person
           WHERE equals(person.team_id, 99999)
           GROUP BY person.id
           HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS persons
        LEFT JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 99999)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS persons__pdi ON equals(persons.persons___id, persons__pdi.person_id)) AS revenue_analytics_customer__persons ON equals(revenue_analytics_customer.email, revenue_analytics_customer__persons.revenue_analytics_customer__persons___pdi___distinct_id)
     GROUP BY person_id) AS persons_revenue_analytics
  ORDER BY persons_revenue_analytics.person_id ASC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1,
                     format_csv_allow_double_quotes=1,
                     max_ast_elements=4000000,
                     max_expanded_ast_elements=4000000,
                     max_bytes_before_external_group_by=0,
                     transform_null_in=1,
                     optimize_min_equality_disjunction_chain_length=4294967295,
                     allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_virtual_property_in_trend_0_disabled
  '''
  SELECT toTimeZone(events.timestamp, 'UTC') AS timestamp
  FROM events
  WHERE and(equals(events.team_id, 99999), greater(toTimeZone(events.timestamp, 'UTC'), toDateTime64('1980-01-01 00:00:00.000000', 6, 'UTC')), equals(events.event, '$pageview'))
  ORDER BY toTimeZone(events.timestamp, 'UTC') ASC
  LIMIT 1 SETTINGS readonly=2,
                   max_execution_time=60,
                   allow_experimental_object_type=1,
                   format_csv_allow_double_quotes=0,
                   max_ast_elements=4000000,
                   max_expanded_ast_elements=4000000,
                   max_bytes_before_external_group_by=0,
                   transform_null_in=1,
                   optimize_min_equality_disjunction_chain_length=4294967295,
                   allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_virtual_property_in_trend_0_disabled.1
  '''
  SELECT arrayMap(number -> plus(toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1)), toIntervalDay(number)), range(0, plus(coalesce(dateDiff('day', toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1)), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC')), toIntervalDay(1)))), 1))) AS date,
         arrayMap(d -> arraySum(arrayMap((v, dd) -> if(ifNull(equals(dd, d), isNull(dd)
                                                              and isNull(d)), v, 0), vals, days)), date) AS total,
         breakdown_value AS breakdown_value
  FROM
    (SELECT groupArray(top_n_and_other_breakdown_values.day_start) AS days,
            groupArray(top_n_and_other_breakdown_values.value) AS vals,
            top_n_and_other_breakdown_values.breakdown_value AS breakdown_value
     FROM
       (SELECT day_start AS day_start,
               value AS value,
               breakdown_value AS breakdown_value
        FROM
          (SELECT top_n_breakdown_values.day_start AS day_start,
                  top_n_breakdown_values.value AS value,
                  top_n_breakdown_values.breakdown_value AS breakdown_value
           FROM
             (SELECT ranked_breakdown_values.day_start AS day_start,
                     ranked_breakdown_values.count AS value,
                     ranked_breakdown_values.breakdown_value AS breakdown_value
              FROM
                (SELECT breakdown_series.count AS count,
                        breakdown_series.day_start AS day_start,
                        breakdown_series.breakdown_value AS breakdown_value,
                        ranked_breakdown_totals.ordering AS ordering,
                        ranked_breakdown_totals.breakdown_rank AS breakdown_rank
                 FROM
                   (SELECT count AS count,
                                    day_start AS day_start,
                                    breakdown_value AS breakdown_value
                    FROM
                      (SELECT sum(total) AS count,
                              day_start AS day_start,
                              [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                       FROM
                         (SELECT count() AS total,
                                 toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                 ifNull(nullIf(toString(e__pdi__person__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                          FROM events AS e SAMPLE 1
                          INNER JOIN
                            (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS e__pdi___person_id,
                                    argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                                    person_distinct_id2.distinct_id AS distinct_id
                             FROM person_distinct_id2
                             WHERE equals(person_distinct_id2.team_id, 99999)
                             GROUP BY person_distinct_id2.distinct_id
                             HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__pdi ON equals(e.distinct_id, e__pdi.distinct_id)
                          LEFT JOIN
                            (SELECT argMax(person.id, person.version) AS e__pdi__person___id,
                                    person.id AS id
                             FROM person
                             WHERE equals(person.team_id, 99999)
                             GROUP BY person.id
                             HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS e__pdi__person ON equals(e__pdi.e__pdi___person_id, e__pdi__person.e__pdi__person___id)
                          LEFT JOIN
                            (SELECT 99999 AS team_id,
                                    accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                    sum(revenue_analytics_revenue_item.amount) AS revenue,
                                    sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                             FROM
                               (SELECT toString(events.uuid) AS id,
                                       toString(events.uuid) AS invoice_item_id,
                                       'revenue_analytics.events.purchase' AS source_label,
                                       toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                       timestamp AS created_at,
                                       0 AS is_recurring,
                                       NULL AS product_id,
                                       toString(events__pdi.person_id) AS customer_id,
                                       events.`$group_0` AS group_0_key,
                                       events.`$group_1` AS group_1_key,
                                       events.`$group_2` AS group_2_key,
                                       events.`$group_3` AS group_3_key,
                                       events.`$group_4` AS group_4_key,
                                       NULL AS invoice_id,
                                       NULL AS subscription_id,
                                       toString(events.`$session_id`) AS session_id,
                                       events.event AS event_name,
                                       NULL AS coupon,
                                       coupon AS coupon_id,
                                       'USD' AS original_currency,
                                       accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                       in(original_currency,
                                          ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                         if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                         divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                         'USD' AS currency,
                                         if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                FROM events
                                INNER JOIN
                                  (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                                          person_distinct_id2.distinct_id AS distinct_id
                                   FROM person_distinct_id2
                                   WHERE equals(person_distinct_id2.team_id, 99999)
                                   GROUP BY person_distinct_id2.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
                                WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                             GROUP BY person_id) AS e__pdi__person__revenue_analytics ON equals(e__pdi__person.e__pdi__person___id, e__pdi__person__revenue_analytics.person_id)
                          WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                          GROUP BY day_start,
                                   breakdown_value_1)
                       GROUP BY day_start,
                                breakdown_value_1
                       ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                 JOIN
                   (SELECT totals_per_breakdown.breakdown_value AS breakdown_value,
                           totals_per_breakdown.ordering AS ordering,
                           totals_per_breakdown.total_count_for_breakdown AS total_count_for_breakdown,
                           row_number() OVER (
                                              ORDER BY totals_per_breakdown.ordering ASC, totals_per_breakdown.total_count_for_breakdown DESC, totals_per_breakdown.breakdown_value ASC) AS breakdown_rank
                    FROM
                      (SELECT breakdown_series.breakdown_value AS breakdown_value,
                              sum(breakdown_series.count) AS total_count_for_breakdown,
                              if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) AS ordering
                       FROM
                         (SELECT count AS count,
                                          day_start AS day_start,
                                          breakdown_value AS breakdown_value
                          FROM
                            (SELECT sum(total) AS count,
                                    day_start AS day_start,
                                    [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                             FROM
                               (SELECT count() AS total,
                                       toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                       ifNull(nullIf(toString(e__pdi__person__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                                FROM events AS e SAMPLE 1
                                INNER JOIN
                                  (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS e__pdi___person_id,
                                          argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                                          person_distinct_id2.distinct_id AS distinct_id
                                   FROM person_distinct_id2
                                   WHERE equals(person_distinct_id2.team_id, 99999)
                                   GROUP BY person_distinct_id2.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__pdi ON equals(e.distinct_id, e__pdi.distinct_id)
                                LEFT JOIN
                                  (SELECT argMax(person.id, person.version) AS e__pdi__person___id,
                                          person.id AS id
                                   FROM person
                                   WHERE equals(person.team_id, 99999)
                                   GROUP BY person.id
                                   HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS e__pdi__person ON equals(e__pdi.e__pdi___person_id, e__pdi__person.e__pdi__person___id)
                                LEFT JOIN
                                  (SELECT 99999 AS team_id,
                                          accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                          sum(revenue_analytics_revenue_item.amount) AS revenue,
                                          sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                                   FROM
                                     (SELECT toString(events.uuid) AS id,
                                             toString(events.uuid) AS invoice_item_id,
                                             'revenue_analytics.events.purchase' AS source_label,
                                             toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                             timestamp AS created_at,
                                             0 AS is_recurring,
                                             NULL AS product_id,
                                             toString(events__pdi.person_id) AS customer_id,
                                             events.`$group_0` AS group_0_key,
                                             events.`$group_1` AS group_1_key,
                                             events.`$group_2` AS group_2_key,
                                             events.`$group_3` AS group_3_key,
                                             events.`$group_4` AS group_4_key,
                                             NULL AS invoice_id,
                                             NULL AS subscription_id,
                                             toString(events.`$session_id`) AS session_id,
                                             events.event AS event_name,
                                             NULL AS coupon,
                                             coupon AS coupon_id,
                                             'USD' AS original_currency,
                                             accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                             in(original_currency,
                                                ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                               if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                               divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                               'USD' AS currency,
                                               if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                      FROM events
                                      INNER JOIN
                                        (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                                                person_distinct_id2.distinct_id AS distinct_id
                                         FROM person_distinct_id2
                                         WHERE equals(person_distinct_id2.team_id, 99999)
                                         GROUP BY person_distinct_id2.distinct_id
                                         HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
                                      WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                      ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                                   GROUP BY person_id) AS e__pdi__person__revenue_analytics ON equals(e__pdi__person.e__pdi__person___id, e__pdi__person__revenue_analytics.person_id)
                                WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                                GROUP BY day_start,
                                         breakdown_value_1)
                             GROUP BY day_start,
                                      breakdown_value_1
                             ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                       GROUP BY breakdown_series.breakdown_value) AS totals_per_breakdown) AS ranked_breakdown_totals ON equals(ranked_breakdown_totals.breakdown_value, breakdown_series.breakdown_value)) AS ranked_breakdown_values
              WHERE ifNull(lessOrEquals(ranked_breakdown_values.breakdown_rank, 25), 0)) AS top_n_breakdown_values
           UNION ALL SELECT other_breakdown_values.day_start AS day_start,
                            other_breakdown_values.value AS value,
                            other_breakdown_values.breakdown_value AS breakdown_value
           FROM
             (SELECT ranked_breakdown_values.day_start AS day_start,
                     sum(ranked_breakdown_values.count) AS value,
                     ['$$_posthog_breakdown_other_$$'] AS breakdown_value
              FROM
                (SELECT breakdown_series.count AS count,
                        breakdown_series.day_start AS day_start,
                        breakdown_series.breakdown_value AS breakdown_value,
                        ranked_breakdown_totals.ordering AS ordering,
                        ranked_breakdown_totals.breakdown_rank AS breakdown_rank
                 FROM
                   (SELECT count AS count,
                                    day_start AS day_start,
                                    breakdown_value AS breakdown_value
                    FROM
                      (SELECT sum(total) AS count,
                              day_start AS day_start,
                              [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                       FROM
                         (SELECT count() AS total,
                                 toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                 ifNull(nullIf(toString(e__pdi__person__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                          FROM events AS e SAMPLE 1
                          INNER JOIN
                            (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS e__pdi___person_id,
                                    argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                                    person_distinct_id2.distinct_id AS distinct_id
                             FROM person_distinct_id2
                             WHERE equals(person_distinct_id2.team_id, 99999)
                             GROUP BY person_distinct_id2.distinct_id
                             HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__pdi ON equals(e.distinct_id, e__pdi.distinct_id)
                          LEFT JOIN
                            (SELECT argMax(person.id, person.version) AS e__pdi__person___id,
                                    person.id AS id
                             FROM person
                             WHERE equals(person.team_id, 99999)
                             GROUP BY person.id
                             HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS e__pdi__person ON equals(e__pdi.e__pdi___person_id, e__pdi__person.e__pdi__person___id)
                          LEFT JOIN
                            (SELECT 99999 AS team_id,
                                    accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                    sum(revenue_analytics_revenue_item.amount) AS revenue,
                                    sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                             FROM
                               (SELECT toString(events.uuid) AS id,
                                       toString(events.uuid) AS invoice_item_id,
                                       'revenue_analytics.events.purchase' AS source_label,
                                       toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                       timestamp AS created_at,
                                       0 AS is_recurring,
                                       NULL AS product_id,
                                       toString(events__pdi.person_id) AS customer_id,
                                       events.`$group_0` AS group_0_key,
                                       events.`$group_1` AS group_1_key,
                                       events.`$group_2` AS group_2_key,
                                       events.`$group_3` AS group_3_key,
                                       events.`$group_4` AS group_4_key,
                                       NULL AS invoice_id,
                                       NULL AS subscription_id,
                                       toString(events.`$session_id`) AS session_id,
                                       events.event AS event_name,
                                       NULL AS coupon,
                                       coupon AS coupon_id,
                                       'USD' AS original_currency,
                                       accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                       in(original_currency,
                                          ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                         if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                         divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                         'USD' AS currency,
                                         if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                FROM events
                                INNER JOIN
                                  (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                                          person_distinct_id2.distinct_id AS distinct_id
                                   FROM person_distinct_id2
                                   WHERE equals(person_distinct_id2.team_id, 99999)
                                   GROUP BY person_distinct_id2.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
                                WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                             GROUP BY person_id) AS e__pdi__person__revenue_analytics ON equals(e__pdi__person.e__pdi__person___id, e__pdi__person__revenue_analytics.person_id)
                          WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                          GROUP BY day_start,
                                   breakdown_value_1)
                       GROUP BY day_start,
                                breakdown_value_1
                       ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                 JOIN
                   (SELECT totals_per_breakdown.breakdown_value AS breakdown_value,
                           totals_per_breakdown.ordering AS ordering,
                           totals_per_breakdown.total_count_for_breakdown AS total_count_for_breakdown,
                           row_number() OVER (
                                              ORDER BY totals_per_breakdown.ordering ASC, totals_per_breakdown.total_count_for_breakdown DESC, totals_per_breakdown.breakdown_value ASC) AS breakdown_rank
                    FROM
                      (SELECT breakdown_series.breakdown_value AS breakdown_value,
                              sum(breakdown_series.count) AS total_count_for_breakdown,
                              if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) AS ordering
                       FROM
                         (SELECT count AS count,
                                          day_start AS day_start,
                                          breakdown_value AS breakdown_value
                          FROM
                            (SELECT sum(total) AS count,
                                    day_start AS day_start,
                                    [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                             FROM
                               (SELECT count() AS total,
                                       toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                       ifNull(nullIf(toString(e__pdi__person__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                                FROM events AS e SAMPLE 1
                                INNER JOIN
                                  (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS e__pdi___person_id,
                                          argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                                          person_distinct_id2.distinct_id AS distinct_id
                                   FROM person_distinct_id2
                                   WHERE equals(person_distinct_id2.team_id, 99999)
                                   GROUP BY person_distinct_id2.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__pdi ON equals(e.distinct_id, e__pdi.distinct_id)
                                LEFT JOIN
                                  (SELECT argMax(person.id, person.version) AS e__pdi__person___id,
                                          person.id AS id
                                   FROM person
                                   WHERE equals(person.team_id, 99999)
                                   GROUP BY person.id
                                   HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS e__pdi__person ON equals(e__pdi.e__pdi___person_id, e__pdi__person.e__pdi__person___id)
                                LEFT JOIN
                                  (SELECT 99999 AS team_id,
                                          accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                          sum(revenue_analytics_revenue_item.amount) AS revenue,
                                          sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                                   FROM
                                     (SELECT toString(events.uuid) AS id,
                                             toString(events.uuid) AS invoice_item_id,
                                             'revenue_analytics.events.purchase' AS source_label,
                                             toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                             timestamp AS created_at,
                                             0 AS is_recurring,
                                             NULL AS product_id,
                                             toString(events__pdi.person_id) AS customer_id,
                                             events.`$group_0` AS group_0_key,
                                             events.`$group_1` AS group_1_key,
                                             events.`$group_2` AS group_2_key,
                                             events.`$group_3` AS group_3_key,
                                             events.`$group_4` AS group_4_key,
                                             NULL AS invoice_id,
                                             NULL AS subscription_id,
                                             toString(events.`$session_id`) AS session_id,
                                             events.event AS event_name,
                                             NULL AS coupon,
                                             coupon AS coupon_id,
                                             'USD' AS original_currency,
                                             accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                             in(original_currency,
                                                ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                               if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                               divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                               'USD' AS currency,
                                               if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                      FROM events
                                      INNER JOIN
                                        (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                                                person_distinct_id2.distinct_id AS distinct_id
                                         FROM person_distinct_id2
                                         WHERE equals(person_distinct_id2.team_id, 99999)
                                         GROUP BY person_distinct_id2.distinct_id
                                         HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
                                      WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                      ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                                   GROUP BY person_id) AS e__pdi__person__revenue_analytics ON equals(e__pdi__person.e__pdi__person___id, e__pdi__person__revenue_analytics.person_id)
                                WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                                GROUP BY day_start,
                                         breakdown_value_1)
                             GROUP BY day_start,
                                      breakdown_value_1
                             ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                       GROUP BY breakdown_series.breakdown_value) AS totals_per_breakdown) AS ranked_breakdown_totals ON equals(ranked_breakdown_totals.breakdown_value, breakdown_series.breakdown_value)) AS ranked_breakdown_values
              WHERE ifNull(greater(ranked_breakdown_values.breakdown_rank, 25), 0)
              GROUP BY breakdown_value,
                       ranked_breakdown_values.day_start) AS other_breakdown_values)
        ORDER BY day_start ASC, value ASC) AS top_n_and_other_breakdown_values
     GROUP BY top_n_and_other_breakdown_values.breakdown_value)
  ORDER BY if(has(breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) ASC, arraySum(total) DESC, breakdown_value ASC
  LIMIT 50000 SETTINGS readonly=2,
                       max_execution_time=60,
                       allow_experimental_object_type=1,
                       format_csv_allow_double_quotes=0,
                       max_ast_elements=4000000,
                       max_expanded_ast_elements=4000000,
                       max_bytes_before_external_group_by=0,
                       transform_null_in=1,
                       optimize_min_equality_disjunction_chain_length=4294967295,
                       allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_virtual_property_in_trend_1_person_id_no_override_properties_on_events
  '''
  SELECT toTimeZone(events.timestamp, 'UTC') AS timestamp
  FROM events
  WHERE and(equals(events.team_id, 99999), greater(toTimeZone(events.timestamp, 'UTC'), toDateTime64('1980-01-01 00:00:00.000000', 6, 'UTC')), equals(events.event, '$pageview'))
  ORDER BY toTimeZone(events.timestamp, 'UTC') ASC
  LIMIT 1 SETTINGS readonly=2,
                   max_execution_time=60,
                   allow_experimental_object_type=1,
                   format_csv_allow_double_quotes=0,
                   max_ast_elements=4000000,
                   max_expanded_ast_elements=4000000,
                   max_bytes_before_external_group_by=0,
                   transform_null_in=1,
                   optimize_min_equality_disjunction_chain_length=4294967295,
                   allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_virtual_property_in_trend_1_person_id_no_override_properties_on_events.1
  '''
  SELECT arrayMap(number -> plus(toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1)), toIntervalDay(number)), range(0, plus(coalesce(dateDiff('day', toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1)), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC')), toIntervalDay(1)))), 1))) AS date,
         arrayMap(d -> arraySum(arrayMap((v, dd) -> if(ifNull(equals(dd, d), isNull(dd)
                                                              and isNull(d)), v, 0), vals, days)), date) AS total,
         breakdown_value AS breakdown_value
  FROM
    (SELECT groupArray(top_n_and_other_breakdown_values.day_start) AS days,
            groupArray(top_n_and_other_breakdown_values.value) AS vals,
            top_n_and_other_breakdown_values.breakdown_value AS breakdown_value
     FROM
       (SELECT day_start AS day_start,
               value AS value,
               breakdown_value AS breakdown_value
        FROM
          (SELECT top_n_breakdown_values.day_start AS day_start,
                  top_n_breakdown_values.value AS value,
                  top_n_breakdown_values.breakdown_value AS breakdown_value
           FROM
             (SELECT ranked_breakdown_values.day_start AS day_start,
                     ranked_breakdown_values.count AS value,
                     ranked_breakdown_values.breakdown_value AS breakdown_value
              FROM
                (SELECT breakdown_series.count AS count,
                        breakdown_series.day_start AS day_start,
                        breakdown_series.breakdown_value AS breakdown_value,
                        ranked_breakdown_totals.ordering AS ordering,
                        ranked_breakdown_totals.breakdown_rank AS breakdown_rank
                 FROM
                   (SELECT count AS count,
                                    day_start AS day_start,
                                    breakdown_value AS breakdown_value
                    FROM
                      (SELECT sum(total) AS count,
                              day_start AS day_start,
                              [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                       FROM
                         (SELECT count() AS total,
                                 toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                 ifNull(nullIf(toString(e__poe__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                          FROM events AS e SAMPLE 1
                          LEFT JOIN
                            (SELECT 99999 AS team_id,
                                    accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                    sum(revenue_analytics_revenue_item.amount) AS revenue,
                                    sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                             FROM
                               (SELECT toString(events.uuid) AS id,
                                       toString(events.uuid) AS invoice_item_id,
                                       'revenue_analytics.events.purchase' AS source_label,
                                       toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                       timestamp AS created_at,
                                       0 AS is_recurring,
                                       NULL AS product_id,
                                       toString(events.person_id) AS customer_id,
                                       events.`$group_0` AS group_0_key,
                                       events.`$group_1` AS group_1_key,
                                       events.`$group_2` AS group_2_key,
                                       events.`$group_3` AS group_3_key,
                                       events.`$group_4` AS group_4_key,
                                       NULL AS invoice_id,
                                       NULL AS subscription_id,
                                       toString(events.`$session_id`) AS session_id,
                                       events.event AS event_name,
                                       NULL AS coupon,
                                       coupon AS coupon_id,
                                       'USD' AS original_currency,
                                       accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                       in(original_currency,
                                          ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                         if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                         divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                         'USD' AS currency,
                                         if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                FROM events
                                WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                             GROUP BY person_id) AS e__poe__revenue_analytics ON equals(e.person_id, e__poe__revenue_analytics.person_id)
                          WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                          GROUP BY day_start,
                                   breakdown_value_1)
                       GROUP BY day_start,
                                breakdown_value_1
                       ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                 JOIN
                   (SELECT totals_per_breakdown.breakdown_value AS breakdown_value,
                           totals_per_breakdown.ordering AS ordering,
                           totals_per_breakdown.total_count_for_breakdown AS total_count_for_breakdown,
                           row_number() OVER (
                                              ORDER BY totals_per_breakdown.ordering ASC, totals_per_breakdown.total_count_for_breakdown DESC, totals_per_breakdown.breakdown_value ASC) AS breakdown_rank
                    FROM
                      (SELECT breakdown_series.breakdown_value AS breakdown_value,
                              sum(breakdown_series.count) AS total_count_for_breakdown,
                              if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) AS ordering
                       FROM
                         (SELECT count AS count,
                                          day_start AS day_start,
                                          breakdown_value AS breakdown_value
                          FROM
                            (SELECT sum(total) AS count,
                                    day_start AS day_start,
                                    [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                             FROM
                               (SELECT count() AS total,
                                       toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                       ifNull(nullIf(toString(e__poe__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                                FROM events AS e SAMPLE 1
                                LEFT JOIN
                                  (SELECT 99999 AS team_id,
                                          accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                          sum(revenue_analytics_revenue_item.amount) AS revenue,
                                          sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                                   FROM
                                     (SELECT toString(events.uuid) AS id,
                                             toString(events.uuid) AS invoice_item_id,
                                             'revenue_analytics.events.purchase' AS source_label,
                                             toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                             timestamp AS created_at,
                                             0 AS is_recurring,
                                             NULL AS product_id,
                                             toString(events.person_id) AS customer_id,
                                             events.`$group_0` AS group_0_key,
                                             events.`$group_1` AS group_1_key,
                                             events.`$group_2` AS group_2_key,
                                             events.`$group_3` AS group_3_key,
                                             events.`$group_4` AS group_4_key,
                                             NULL AS invoice_id,
                                             NULL AS subscription_id,
                                             toString(events.`$session_id`) AS session_id,
                                             events.event AS event_name,
                                             NULL AS coupon,
                                             coupon AS coupon_id,
                                             'USD' AS original_currency,
                                             accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                             in(original_currency,
                                                ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                               if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                               divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                               'USD' AS currency,
                                               if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                      FROM events
                                      WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                      ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                                   GROUP BY person_id) AS e__poe__revenue_analytics ON equals(e.person_id, e__poe__revenue_analytics.person_id)
                                WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                                GROUP BY day_start,
                                         breakdown_value_1)
                             GROUP BY day_start,
                                      breakdown_value_1
                             ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                       GROUP BY breakdown_series.breakdown_value) AS totals_per_breakdown) AS ranked_breakdown_totals ON equals(ranked_breakdown_totals.breakdown_value, breakdown_series.breakdown_value)) AS ranked_breakdown_values
              WHERE ifNull(lessOrEquals(ranked_breakdown_values.breakdown_rank, 25), 0)) AS top_n_breakdown_values
           UNION ALL SELECT other_breakdown_values.day_start AS day_start,
                            other_breakdown_values.value AS value,
                            other_breakdown_values.breakdown_value AS breakdown_value
           FROM
             (SELECT ranked_breakdown_values.day_start AS day_start,
                     sum(ranked_breakdown_values.count) AS value,
                     ['$$_posthog_breakdown_other_$$'] AS breakdown_value
              FROM
                (SELECT breakdown_series.count AS count,
                        breakdown_series.day_start AS day_start,
                        breakdown_series.breakdown_value AS breakdown_value,
                        ranked_breakdown_totals.ordering AS ordering,
                        ranked_breakdown_totals.breakdown_rank AS breakdown_rank
                 FROM
                   (SELECT count AS count,
                                    day_start AS day_start,
                                    breakdown_value AS breakdown_value
                    FROM
                      (SELECT sum(total) AS count,
                              day_start AS day_start,
                              [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                       FROM
                         (SELECT count() AS total,
                                 toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                 ifNull(nullIf(toString(e__poe__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                          FROM events AS e SAMPLE 1
                          LEFT JOIN
                            (SELECT 99999 AS team_id,
                                    accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                    sum(revenue_analytics_revenue_item.amount) AS revenue,
                                    sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                             FROM
                               (SELECT toString(events.uuid) AS id,
                                       toString(events.uuid) AS invoice_item_id,
                                       'revenue_analytics.events.purchase' AS source_label,
                                       toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                       timestamp AS created_at,
                                       0 AS is_recurring,
                                       NULL AS product_id,
                                       toString(events.person_id) AS customer_id,
                                       events.`$group_0` AS group_0_key,
                                       events.`$group_1` AS group_1_key,
                                       events.`$group_2` AS group_2_key,
                                       events.`$group_3` AS group_3_key,
                                       events.`$group_4` AS group_4_key,
                                       NULL AS invoice_id,
                                       NULL AS subscription_id,
                                       toString(events.`$session_id`) AS session_id,
                                       events.event AS event_name,
                                       NULL AS coupon,
                                       coupon AS coupon_id,
                                       'USD' AS original_currency,
                                       accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                       in(original_currency,
                                          ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                         if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                         divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                         'USD' AS currency,
                                         if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                FROM events
                                WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                             GROUP BY person_id) AS e__poe__revenue_analytics ON equals(e.person_id, e__poe__revenue_analytics.person_id)
                          WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                          GROUP BY day_start,
                                   breakdown_value_1)
                       GROUP BY day_start,
                                breakdown_value_1
                       ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                 JOIN
                   (SELECT totals_per_breakdown.breakdown_value AS breakdown_value,
                           totals_per_breakdown.ordering AS ordering,
                           totals_per_breakdown.total_count_for_breakdown AS total_count_for_breakdown,
                           row_number() OVER (
                                              ORDER BY totals_per_breakdown.ordering ASC, totals_per_breakdown.total_count_for_breakdown DESC, totals_per_breakdown.breakdown_value ASC) AS breakdown_rank
                    FROM
                      (SELECT breakdown_series.breakdown_value AS breakdown_value,
                              sum(breakdown_series.count) AS total_count_for_breakdown,
                              if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) AS ordering
                       FROM
                         (SELECT count AS count,
                                          day_start AS day_start,
                                          breakdown_value AS breakdown_value
                          FROM
                            (SELECT sum(total) AS count,
                                    day_start AS day_start,
                                    [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                             FROM
                               (SELECT count() AS total,
                                       toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                       ifNull(nullIf(toString(e__poe__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                                FROM events AS e SAMPLE 1
                                LEFT JOIN
                                  (SELECT 99999 AS team_id,
                                          accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                          sum(revenue_analytics_revenue_item.amount) AS revenue,
                                          sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                                   FROM
                                     (SELECT toString(events.uuid) AS id,
                                             toString(events.uuid) AS invoice_item_id,
                                             'revenue_analytics.events.purchase' AS source_label,
                                             toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                             timestamp AS created_at,
                                             0 AS is_recurring,
                                             NULL AS product_id,
                                             toString(events.person_id) AS customer_id,
                                             events.`$group_0` AS group_0_key,
                                             events.`$group_1` AS group_1_key,
                                             events.`$group_2` AS group_2_key,
                                             events.`$group_3` AS group_3_key,
                                             events.`$group_4` AS group_4_key,
                                             NULL AS invoice_id,
                                             NULL AS subscription_id,
                                             toString(events.`$session_id`) AS session_id,
                                             events.event AS event_name,
                                             NULL AS coupon,
                                             coupon AS coupon_id,
                                             'USD' AS original_currency,
                                             accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                             in(original_currency,
                                                ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                               if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                               divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                               'USD' AS currency,
                                               if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                      FROM events
                                      WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                      ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                                   GROUP BY person_id) AS e__poe__revenue_analytics ON equals(e.person_id, e__poe__revenue_analytics.person_id)
                                WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                                GROUP BY day_start,
                                         breakdown_value_1)
                             GROUP BY day_start,
                                      breakdown_value_1
                             ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                       GROUP BY breakdown_series.breakdown_value) AS totals_per_breakdown) AS ranked_breakdown_totals ON equals(ranked_breakdown_totals.breakdown_value, breakdown_series.breakdown_value)) AS ranked_breakdown_values
              WHERE ifNull(greater(ranked_breakdown_values.breakdown_rank, 25), 0)
              GROUP BY breakdown_value,
                       ranked_breakdown_values.day_start) AS other_breakdown_values)
        ORDER BY day_start ASC, value ASC) AS top_n_and_other_breakdown_values
     GROUP BY top_n_and_other_breakdown_values.breakdown_value)
  ORDER BY if(has(breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) ASC, arraySum(total) DESC, breakdown_value ASC
  LIMIT 50000 SETTINGS readonly=2,
                       max_execution_time=60,
                       allow_experimental_object_type=1,
                       format_csv_allow_double_quotes=0,
                       max_ast_elements=4000000,
                       max_expanded_ast_elements=4000000,
                       max_bytes_before_external_group_by=0,
                       transform_null_in=1,
                       optimize_min_equality_disjunction_chain_length=4294967295,
                       allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_virtual_property_in_trend_2_person_id_override_properties_on_events
  '''
  SELECT toTimeZone(events.timestamp, 'UTC') AS timestamp
  FROM events
  WHERE and(equals(events.team_id, 99999), greater(toTimeZone(events.timestamp, 'UTC'), toDateTime64('1980-01-01 00:00:00.000000', 6, 'UTC')), equals(events.event, '$pageview'))
  ORDER BY toTimeZone(events.timestamp, 'UTC') ASC
  LIMIT 1 SETTINGS readonly=2,
                   max_execution_time=60,
                   allow_experimental_object_type=1,
                   format_csv_allow_double_quotes=0,
                   max_ast_elements=4000000,
                   max_expanded_ast_elements=4000000,
                   max_bytes_before_external_group_by=0,
                   transform_null_in=1,
                   optimize_min_equality_disjunction_chain_length=4294967295,
                   allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_virtual_property_in_trend_2_person_id_override_properties_on_events.1
  '''
  SELECT arrayMap(number -> plus(toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1)), toIntervalDay(number)), range(0, plus(coalesce(dateDiff('day', toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1)), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC')), toIntervalDay(1)))), 1))) AS date,
         arrayMap(d -> arraySum(arrayMap((v, dd) -> if(ifNull(equals(dd, d), isNull(dd)
                                                              and isNull(d)), v, 0), vals, days)), date) AS total,
         breakdown_value AS breakdown_value
  FROM
    (SELECT groupArray(top_n_and_other_breakdown_values.day_start) AS days,
            groupArray(top_n_and_other_breakdown_values.value) AS vals,
            top_n_and_other_breakdown_values.breakdown_value AS breakdown_value
     FROM
       (SELECT day_start AS day_start,
               value AS value,
               breakdown_value AS breakdown_value
        FROM
          (SELECT top_n_breakdown_values.day_start AS day_start,
                  top_n_breakdown_values.value AS value,
                  top_n_breakdown_values.breakdown_value AS breakdown_value
           FROM
             (SELECT ranked_breakdown_values.day_start AS day_start,
                     ranked_breakdown_values.count AS value,
                     ranked_breakdown_values.breakdown_value AS breakdown_value
              FROM
                (SELECT breakdown_series.count AS count,
                        breakdown_series.day_start AS day_start,
                        breakdown_series.breakdown_value AS breakdown_value,
                        ranked_breakdown_totals.ordering AS ordering,
                        ranked_breakdown_totals.breakdown_rank AS breakdown_rank
                 FROM
                   (SELECT count AS count,
                                    day_start AS day_start,
                                    breakdown_value AS breakdown_value
                    FROM
                      (SELECT sum(total) AS count,
                              day_start AS day_start,
                              [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                       FROM
                         (SELECT count() AS total,
                                 toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                 ifNull(nullIf(toString(e__poe__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                          FROM events AS e SAMPLE 1
                          LEFT OUTER JOIN
                            (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                    person_distinct_id_overrides.distinct_id AS distinct_id
                             FROM person_distinct_id_overrides
                             WHERE equals(person_distinct_id_overrides.team_id, 99999)
                             GROUP BY person_distinct_id_overrides.distinct_id
                             HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__override ON equals(e.distinct_id, e__override.distinct_id)
                          LEFT JOIN
                            (SELECT 99999 AS team_id,
                                    accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                    sum(revenue_analytics_revenue_item.amount) AS revenue,
                                    sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                             FROM
                               (SELECT toString(events.uuid) AS id,
                                       toString(events.uuid) AS invoice_item_id,
                                       'revenue_analytics.events.purchase' AS source_label,
                                       toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                       timestamp AS created_at,
                                       0 AS is_recurring,
                                       NULL AS product_id,
                                       toString(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id)) AS customer_id,
                                       events.`$group_0` AS group_0_key,
                                       events.`$group_1` AS group_1_key,
                                       events.`$group_2` AS group_2_key,
                                       events.`$group_3` AS group_3_key,
                                       events.`$group_4` AS group_4_key,
                                       NULL AS invoice_id,
                                       NULL AS subscription_id,
                                       toString(events.`$session_id`) AS session_id,
                                       events.event AS event_name,
                                       NULL AS coupon,
                                       coupon AS coupon_id,
                                       'USD' AS original_currency,
                                       accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                       in(original_currency,
                                          ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                         if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                         divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                         'USD' AS currency,
                                         if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                FROM events
                                LEFT OUTER JOIN
                                  (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                          person_distinct_id_overrides.distinct_id AS distinct_id
                                   FROM person_distinct_id_overrides
                                   WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                   GROUP BY person_distinct_id_overrides.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__override ON equals(events.distinct_id, events__override.distinct_id)
                                WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                             GROUP BY person_id) AS e__poe__revenue_analytics ON equals(if(not(empty(e__override.distinct_id)), e__override.person_id, e.person_id), e__poe__revenue_analytics.person_id)
                          WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                          GROUP BY day_start,
                                   breakdown_value_1)
                       GROUP BY day_start,
                                breakdown_value_1
                       ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                 JOIN
                   (SELECT totals_per_breakdown.breakdown_value AS breakdown_value,
                           totals_per_breakdown.ordering AS ordering,
                           totals_per_breakdown.total_count_for_breakdown AS total_count_for_breakdown,
                           row_number() OVER (
                                              ORDER BY totals_per_breakdown.ordering ASC, totals_per_breakdown.total_count_for_breakdown DESC, totals_per_breakdown.breakdown_value ASC) AS breakdown_rank
                    FROM
                      (SELECT breakdown_series.breakdown_value AS breakdown_value,
                              sum(breakdown_series.count) AS total_count_for_breakdown,
                              if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) AS ordering
                       FROM
                         (SELECT count AS count,
                                          day_start AS day_start,
                                          breakdown_value AS breakdown_value
                          FROM
                            (SELECT sum(total) AS count,
                                    day_start AS day_start,
                                    [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                             FROM
                               (SELECT count() AS total,
                                       toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                       ifNull(nullIf(toString(e__poe__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                                FROM events AS e SAMPLE 1
                                LEFT OUTER JOIN
                                  (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                          person_distinct_id_overrides.distinct_id AS distinct_id
                                   FROM person_distinct_id_overrides
                                   WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                   GROUP BY person_distinct_id_overrides.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__override ON equals(e.distinct_id, e__override.distinct_id)
                                LEFT JOIN
                                  (SELECT 99999 AS team_id,
                                          accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                          sum(revenue_analytics_revenue_item.amount) AS revenue,
                                          sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                                   FROM
                                     (SELECT toString(events.uuid) AS id,
                                             toString(events.uuid) AS invoice_item_id,
                                             'revenue_analytics.events.purchase' AS source_label,
                                             toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                             timestamp AS created_at,
                                             0 AS is_recurring,
                                             NULL AS product_id,
                                             toString(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id)) AS customer_id,
                                             events.`$group_0` AS group_0_key,
                                             events.`$group_1` AS group_1_key,
                                             events.`$group_2` AS group_2_key,
                                             events.`$group_3` AS group_3_key,
                                             events.`$group_4` AS group_4_key,
                                             NULL AS invoice_id,
                                             NULL AS subscription_id,
                                             toString(events.`$session_id`) AS session_id,
                                             events.event AS event_name,
                                             NULL AS coupon,
                                             coupon AS coupon_id,
                                             'USD' AS original_currency,
                                             accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                             in(original_currency,
                                                ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                               if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                               divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                               'USD' AS currency,
                                               if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                      FROM events
                                      LEFT OUTER JOIN
                                        (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                                person_distinct_id_overrides.distinct_id AS distinct_id
                                         FROM person_distinct_id_overrides
                                         WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                         GROUP BY person_distinct_id_overrides.distinct_id
                                         HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__override ON equals(events.distinct_id, events__override.distinct_id)
                                      WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                      ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                                   GROUP BY person_id) AS e__poe__revenue_analytics ON equals(if(not(empty(e__override.distinct_id)), e__override.person_id, e.person_id), e__poe__revenue_analytics.person_id)
                                WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                                GROUP BY day_start,
                                         breakdown_value_1)
                             GROUP BY day_start,
                                      breakdown_value_1
                             ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                       GROUP BY breakdown_series.breakdown_value) AS totals_per_breakdown) AS ranked_breakdown_totals ON equals(ranked_breakdown_totals.breakdown_value, breakdown_series.breakdown_value)) AS ranked_breakdown_values
              WHERE ifNull(lessOrEquals(ranked_breakdown_values.breakdown_rank, 25), 0)) AS top_n_breakdown_values
           UNION ALL SELECT other_breakdown_values.day_start AS day_start,
                            other_breakdown_values.value AS value,
                            other_breakdown_values.breakdown_value AS breakdown_value
           FROM
             (SELECT ranked_breakdown_values.day_start AS day_start,
                     sum(ranked_breakdown_values.count) AS value,
                     ['$$_posthog_breakdown_other_$$'] AS breakdown_value
              FROM
                (SELECT breakdown_series.count AS count,
                        breakdown_series.day_start AS day_start,
                        breakdown_series.breakdown_value AS breakdown_value,
                        ranked_breakdown_totals.ordering AS ordering,
                        ranked_breakdown_totals.breakdown_rank AS breakdown_rank
                 FROM
                   (SELECT count AS count,
                                    day_start AS day_start,
                                    breakdown_value AS breakdown_value
                    FROM
                      (SELECT sum(total) AS count,
                              day_start AS day_start,
                              [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                       FROM
                         (SELECT count() AS total,
                                 toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                 ifNull(nullIf(toString(e__poe__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                          FROM events AS e SAMPLE 1
                          LEFT OUTER JOIN
                            (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                    person_distinct_id_overrides.distinct_id AS distinct_id
                             FROM person_distinct_id_overrides
                             WHERE equals(person_distinct_id_overrides.team_id, 99999)
                             GROUP BY person_distinct_id_overrides.distinct_id
                             HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__override ON equals(e.distinct_id, e__override.distinct_id)
                          LEFT JOIN
                            (SELECT 99999 AS team_id,
                                    accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                    sum(revenue_analytics_revenue_item.amount) AS revenue,
                                    sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                             FROM
                               (SELECT toString(events.uuid) AS id,
                                       toString(events.uuid) AS invoice_item_id,
                                       'revenue_analytics.events.purchase' AS source_label,
                                       toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                       timestamp AS created_at,
                                       0 AS is_recurring,
                                       NULL AS product_id,
                                       toString(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id)) AS customer_id,
                                       events.`$group_0` AS group_0_key,
                                       events.`$group_1` AS group_1_key,
                                       events.`$group_2` AS group_2_key,
                                       events.`$group_3` AS group_3_key,
                                       events.`$group_4` AS group_4_key,
                                       NULL AS invoice_id,
                                       NULL AS subscription_id,
                                       toString(events.`$session_id`) AS session_id,
                                       events.event AS event_name,
                                       NULL AS coupon,
                                       coupon AS coupon_id,
                                       'USD' AS original_currency,
                                       accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                       in(original_currency,
                                          ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                         if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                         divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                         'USD' AS currency,
                                         if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                FROM events
                                LEFT OUTER JOIN
                                  (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                          person_distinct_id_overrides.distinct_id AS distinct_id
                                   FROM person_distinct_id_overrides
                                   WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                   GROUP BY person_distinct_id_overrides.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__override ON equals(events.distinct_id, events__override.distinct_id)
                                WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                             GROUP BY person_id) AS e__poe__revenue_analytics ON equals(if(not(empty(e__override.distinct_id)), e__override.person_id, e.person_id), e__poe__revenue_analytics.person_id)
                          WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                          GROUP BY day_start,
                                   breakdown_value_1)
                       GROUP BY day_start,
                                breakdown_value_1
                       ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                 JOIN
                   (SELECT totals_per_breakdown.breakdown_value AS breakdown_value,
                           totals_per_breakdown.ordering AS ordering,
                           totals_per_breakdown.total_count_for_breakdown AS total_count_for_breakdown,
                           row_number() OVER (
                                              ORDER BY totals_per_breakdown.ordering ASC, totals_per_breakdown.total_count_for_breakdown DESC, totals_per_breakdown.breakdown_value ASC) AS breakdown_rank
                    FROM
                      (SELECT breakdown_series.breakdown_value AS breakdown_value,
                              sum(breakdown_series.count) AS total_count_for_breakdown,
                              if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) AS ordering
                       FROM
                         (SELECT count AS count,
                                          day_start AS day_start,
                                          breakdown_value AS breakdown_value
                          FROM
                            (SELECT sum(total) AS count,
                                    day_start AS day_start,
                                    [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                             FROM
                               (SELECT count() AS total,
                                       toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                       ifNull(nullIf(toString(e__poe__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                                FROM events AS e SAMPLE 1
                                LEFT OUTER JOIN
                                  (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                          person_distinct_id_overrides.distinct_id AS distinct_id
                                   FROM person_distinct_id_overrides
                                   WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                   GROUP BY person_distinct_id_overrides.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__override ON equals(e.distinct_id, e__override.distinct_id)
                                LEFT JOIN
                                  (SELECT 99999 AS team_id,
                                          accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                          sum(revenue_analytics_revenue_item.amount) AS revenue,
                                          sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                                   FROM
                                     (SELECT toString(events.uuid) AS id,
                                             toString(events.uuid) AS invoice_item_id,
                                             'revenue_analytics.events.purchase' AS source_label,
                                             toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                             timestamp AS created_at,
                                             0 AS is_recurring,
                                             NULL AS product_id,
                                             toString(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id)) AS customer_id,
                                             events.`$group_0` AS group_0_key,
                                             events.`$group_1` AS group_1_key,
                                             events.`$group_2` AS group_2_key,
                                             events.`$group_3` AS group_3_key,
                                             events.`$group_4` AS group_4_key,
                                             NULL AS invoice_id,
                                             NULL AS subscription_id,
                                             toString(events.`$session_id`) AS session_id,
                                             events.event AS event_name,
                                             NULL AS coupon,
                                             coupon AS coupon_id,
                                             'USD' AS original_currency,
                                             accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                             in(original_currency,
                                                ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                               if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                               divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                               'USD' AS currency,
                                               if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                      FROM events
                                      LEFT OUTER JOIN
                                        (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                                person_distinct_id_overrides.distinct_id AS distinct_id
                                         FROM person_distinct_id_overrides
                                         WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                         GROUP BY person_distinct_id_overrides.distinct_id
                                         HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__override ON equals(events.distinct_id, events__override.distinct_id)
                                      WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                      ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                                   GROUP BY person_id) AS e__poe__revenue_analytics ON equals(if(not(empty(e__override.distinct_id)), e__override.person_id, e.person_id), e__poe__revenue_analytics.person_id)
                                WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                                GROUP BY day_start,
                                         breakdown_value_1)
                             GROUP BY day_start,
                                      breakdown_value_1
                             ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                       GROUP BY breakdown_series.breakdown_value) AS totals_per_breakdown) AS ranked_breakdown_totals ON equals(ranked_breakdown_totals.breakdown_value, breakdown_series.breakdown_value)) AS ranked_breakdown_values
              WHERE ifNull(greater(ranked_breakdown_values.breakdown_rank, 25), 0)
              GROUP BY breakdown_value,
                       ranked_breakdown_values.day_start) AS other_breakdown_values)
        ORDER BY day_start ASC, value ASC) AS top_n_and_other_breakdown_values
     GROUP BY top_n_and_other_breakdown_values.breakdown_value)
  ORDER BY if(has(breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) ASC, arraySum(total) DESC, breakdown_value ASC
  LIMIT 50000 SETTINGS readonly=2,
                       max_execution_time=60,
                       allow_experimental_object_type=1,
                       format_csv_allow_double_quotes=0,
                       max_ast_elements=4000000,
                       max_expanded_ast_elements=4000000,
                       max_bytes_before_external_group_by=0,
                       transform_null_in=1,
                       optimize_min_equality_disjunction_chain_length=4294967295,
                       allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_virtual_property_in_trend_3_person_id_override_properties_joined
  '''
  SELECT toTimeZone(events.timestamp, 'UTC') AS timestamp
  FROM events
  WHERE and(equals(events.team_id, 99999), greater(toTimeZone(events.timestamp, 'UTC'), toDateTime64('1980-01-01 00:00:00.000000', 6, 'UTC')), equals(events.event, '$pageview'))
  ORDER BY toTimeZone(events.timestamp, 'UTC') ASC
  LIMIT 1 SETTINGS readonly=2,
                   max_execution_time=60,
                   allow_experimental_object_type=1,
                   format_csv_allow_double_quotes=0,
                   max_ast_elements=4000000,
                   max_expanded_ast_elements=4000000,
                   max_bytes_before_external_group_by=0,
                   transform_null_in=1,
                   optimize_min_equality_disjunction_chain_length=4294967295,
                   allow_experimental_join_condition=1
  '''
# ---
# name: TestRevenueAnalytics.test_virtual_property_in_trend_3_person_id_override_properties_joined.1
  '''
  SELECT arrayMap(number -> plus(toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1)), toIntervalDay(number)), range(0, plus(coalesce(dateDiff('day', toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1)), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC')), toIntervalDay(1)))), 1))) AS date,
         arrayMap(d -> arraySum(arrayMap((v, dd) -> if(ifNull(equals(dd, d), isNull(dd)
                                                              and isNull(d)), v, 0), vals, days)), date) AS total,
         breakdown_value AS breakdown_value
  FROM
    (SELECT groupArray(top_n_and_other_breakdown_values.day_start) AS days,
            groupArray(top_n_and_other_breakdown_values.value) AS vals,
            top_n_and_other_breakdown_values.breakdown_value AS breakdown_value
     FROM
       (SELECT day_start AS day_start,
               value AS value,
               breakdown_value AS breakdown_value
        FROM
          (SELECT top_n_breakdown_values.day_start AS day_start,
                  top_n_breakdown_values.value AS value,
                  top_n_breakdown_values.breakdown_value AS breakdown_value
           FROM
             (SELECT ranked_breakdown_values.day_start AS day_start,
                     ranked_breakdown_values.count AS value,
                     ranked_breakdown_values.breakdown_value AS breakdown_value
              FROM
                (SELECT breakdown_series.count AS count,
                        breakdown_series.day_start AS day_start,
                        breakdown_series.breakdown_value AS breakdown_value,
                        ranked_breakdown_totals.ordering AS ordering,
                        ranked_breakdown_totals.breakdown_rank AS breakdown_rank
                 FROM
                   (SELECT count AS count,
                                    day_start AS day_start,
                                    breakdown_value AS breakdown_value
                    FROM
                      (SELECT sum(total) AS count,
                              day_start AS day_start,
                              [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                       FROM
                         (SELECT count() AS total,
                                 toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                 ifNull(nullIf(toString(e__person__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                          FROM events AS e SAMPLE 1
                          LEFT OUTER JOIN
                            (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                    person_distinct_id_overrides.distinct_id AS distinct_id
                             FROM person_distinct_id_overrides
                             WHERE equals(person_distinct_id_overrides.team_id, 99999)
                             GROUP BY person_distinct_id_overrides.distinct_id
                             HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__override ON equals(e.distinct_id, e__override.distinct_id)
                          LEFT JOIN
                            (SELECT argMax(person.id, person.version) AS e__person___id,
                                    person.id AS id
                             FROM person
                             WHERE equals(person.team_id, 99999)
                             GROUP BY person.id
                             HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS e__person ON equals(if(not(empty(e__override.distinct_id)), e__override.person_id, e.person_id), e__person.e__person___id)
                          LEFT JOIN
                            (SELECT 99999 AS team_id,
                                    accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                    sum(revenue_analytics_revenue_item.amount) AS revenue,
                                    sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                             FROM
                               (SELECT toString(events.uuid) AS id,
                                       toString(events.uuid) AS invoice_item_id,
                                       'revenue_analytics.events.purchase' AS source_label,
                                       toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                       timestamp AS created_at,
                                       0 AS is_recurring,
                                       NULL AS product_id,
                                       toString(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id)) AS customer_id,
                                       events.`$group_0` AS group_0_key,
                                       events.`$group_1` AS group_1_key,
                                       events.`$group_2` AS group_2_key,
                                       events.`$group_3` AS group_3_key,
                                       events.`$group_4` AS group_4_key,
                                       NULL AS invoice_id,
                                       NULL AS subscription_id,
                                       toString(events.`$session_id`) AS session_id,
                                       events.event AS event_name,
                                       NULL AS coupon,
                                       coupon AS coupon_id,
                                       'USD' AS original_currency,
                                       accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                       in(original_currency,
                                          ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                         if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                         divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                         'USD' AS currency,
                                         if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                FROM events
                                LEFT OUTER JOIN
                                  (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                          person_distinct_id_overrides.distinct_id AS distinct_id
                                   FROM person_distinct_id_overrides
                                   WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                   GROUP BY person_distinct_id_overrides.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__override ON equals(events.distinct_id, events__override.distinct_id)
                                WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                             GROUP BY person_id) AS e__person__revenue_analytics ON equals(e__person.e__person___id, e__person__revenue_analytics.person_id)
                          WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                          GROUP BY day_start,
                                   breakdown_value_1)
                       GROUP BY day_start,
                                breakdown_value_1
                       ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                 JOIN
                   (SELECT totals_per_breakdown.breakdown_value AS breakdown_value,
                           totals_per_breakdown.ordering AS ordering,
                           totals_per_breakdown.total_count_for_breakdown AS total_count_for_breakdown,
                           row_number() OVER (
                                              ORDER BY totals_per_breakdown.ordering ASC, totals_per_breakdown.total_count_for_breakdown DESC, totals_per_breakdown.breakdown_value ASC) AS breakdown_rank
                    FROM
                      (SELECT breakdown_series.breakdown_value AS breakdown_value,
                              sum(breakdown_series.count) AS total_count_for_breakdown,
                              if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) AS ordering
                       FROM
                         (SELECT count AS count,
                                          day_start AS day_start,
                                          breakdown_value AS breakdown_value
                          FROM
                            (SELECT sum(total) AS count,
                                    day_start AS day_start,
                                    [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                             FROM
                               (SELECT count() AS total,
                                       toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                       ifNull(nullIf(toString(e__person__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                                FROM events AS e SAMPLE 1
                                LEFT OUTER JOIN
                                  (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                          person_distinct_id_overrides.distinct_id AS distinct_id
                                   FROM person_distinct_id_overrides
                                   WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                   GROUP BY person_distinct_id_overrides.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__override ON equals(e.distinct_id, e__override.distinct_id)
                                LEFT JOIN
                                  (SELECT argMax(person.id, person.version) AS e__person___id,
                                          person.id AS id
                                   FROM person
                                   WHERE equals(person.team_id, 99999)
                                   GROUP BY person.id
                                   HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS e__person ON equals(if(not(empty(e__override.distinct_id)), e__override.person_id, e.person_id), e__person.e__person___id)
                                LEFT JOIN
                                  (SELECT 99999 AS team_id,
                                          accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                          sum(revenue_analytics_revenue_item.amount) AS revenue,
                                          sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                                   FROM
                                     (SELECT toString(events.uuid) AS id,
                                             toString(events.uuid) AS invoice_item_id,
                                             'revenue_analytics.events.purchase' AS source_label,
                                             toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                             timestamp AS created_at,
                                             0 AS is_recurring,
                                             NULL AS product_id,
                                             toString(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id)) AS customer_id,
                                             events.`$group_0` AS group_0_key,
                                             events.`$group_1` AS group_1_key,
                                             events.`$group_2` AS group_2_key,
                                             events.`$group_3` AS group_3_key,
                                             events.`$group_4` AS group_4_key,
                                             NULL AS invoice_id,
                                             NULL AS subscription_id,
                                             toString(events.`$session_id`) AS session_id,
                                             events.event AS event_name,
                                             NULL AS coupon,
                                             coupon AS coupon_id,
                                             'USD' AS original_currency,
                                             accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                             in(original_currency,
                                                ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                               if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                               divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                               'USD' AS currency,
                                               if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                      FROM events
                                      LEFT OUTER JOIN
                                        (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                                person_distinct_id_overrides.distinct_id AS distinct_id
                                         FROM person_distinct_id_overrides
                                         WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                         GROUP BY person_distinct_id_overrides.distinct_id
                                         HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__override ON equals(events.distinct_id, events__override.distinct_id)
                                      WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                      ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                                   GROUP BY person_id) AS e__person__revenue_analytics ON equals(e__person.e__person___id, e__person__revenue_analytics.person_id)
                                WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                                GROUP BY day_start,
                                         breakdown_value_1)
                             GROUP BY day_start,
                                      breakdown_value_1
                             ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                       GROUP BY breakdown_series.breakdown_value) AS totals_per_breakdown) AS ranked_breakdown_totals ON equals(ranked_breakdown_totals.breakdown_value, breakdown_series.breakdown_value)) AS ranked_breakdown_values
              WHERE ifNull(lessOrEquals(ranked_breakdown_values.breakdown_rank, 25), 0)) AS top_n_breakdown_values
           UNION ALL SELECT other_breakdown_values.day_start AS day_start,
                            other_breakdown_values.value AS value,
                            other_breakdown_values.breakdown_value AS breakdown_value
           FROM
             (SELECT ranked_breakdown_values.day_start AS day_start,
                     sum(ranked_breakdown_values.count) AS value,
                     ['$$_posthog_breakdown_other_$$'] AS breakdown_value
              FROM
                (SELECT breakdown_series.count AS count,
                        breakdown_series.day_start AS day_start,
                        breakdown_series.breakdown_value AS breakdown_value,
                        ranked_breakdown_totals.ordering AS ordering,
                        ranked_breakdown_totals.breakdown_rank AS breakdown_rank
                 FROM
                   (SELECT count AS count,
                                    day_start AS day_start,
                                    breakdown_value AS breakdown_value
                    FROM
                      (SELECT sum(total) AS count,
                              day_start AS day_start,
                              [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                       FROM
                         (SELECT count() AS total,
                                 toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                 ifNull(nullIf(toString(e__person__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                          FROM events AS e SAMPLE 1
                          LEFT OUTER JOIN
                            (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                    person_distinct_id_overrides.distinct_id AS distinct_id
                             FROM person_distinct_id_overrides
                             WHERE equals(person_distinct_id_overrides.team_id, 99999)
                             GROUP BY person_distinct_id_overrides.distinct_id
                             HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__override ON equals(e.distinct_id, e__override.distinct_id)
                          LEFT JOIN
                            (SELECT argMax(person.id, person.version) AS e__person___id,
                                    person.id AS id
                             FROM person
                             WHERE equals(person.team_id, 99999)
                             GROUP BY person.id
                             HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS e__person ON equals(if(not(empty(e__override.distinct_id)), e__override.person_id, e.person_id), e__person.e__person___id)
                          LEFT JOIN
                            (SELECT 99999 AS team_id,
                                    accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                    sum(revenue_analytics_revenue_item.amount) AS revenue,
                                    sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                             FROM
                               (SELECT toString(events.uuid) AS id,
                                       toString(events.uuid) AS invoice_item_id,
                                       'revenue_analytics.events.purchase' AS source_label,
                                       toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                       timestamp AS created_at,
                                       0 AS is_recurring,
                                       NULL AS product_id,
                                       toString(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id)) AS customer_id,
                                       events.`$group_0` AS group_0_key,
                                       events.`$group_1` AS group_1_key,
                                       events.`$group_2` AS group_2_key,
                                       events.`$group_3` AS group_3_key,
                                       events.`$group_4` AS group_4_key,
                                       NULL AS invoice_id,
                                       NULL AS subscription_id,
                                       toString(events.`$session_id`) AS session_id,
                                       events.event AS event_name,
                                       NULL AS coupon,
                                       coupon AS coupon_id,
                                       'USD' AS original_currency,
                                       accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                       in(original_currency,
                                          ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                         if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                         divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                         'USD' AS currency,
                                         if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                FROM events
                                LEFT OUTER JOIN
                                  (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                          person_distinct_id_overrides.distinct_id AS distinct_id
                                   FROM person_distinct_id_overrides
                                   WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                   GROUP BY person_distinct_id_overrides.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__override ON equals(events.distinct_id, events__override.distinct_id)
                                WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                             GROUP BY person_id) AS e__person__revenue_analytics ON equals(e__person.e__person___id, e__person__revenue_analytics.person_id)
                          WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                          GROUP BY day_start,
                                   breakdown_value_1)
                       GROUP BY day_start,
                                breakdown_value_1
                       ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                 JOIN
                   (SELECT totals_per_breakdown.breakdown_value AS breakdown_value,
                           totals_per_breakdown.ordering AS ordering,
                           totals_per_breakdown.total_count_for_breakdown AS total_count_for_breakdown,
                           row_number() OVER (
                                              ORDER BY totals_per_breakdown.ordering ASC, totals_per_breakdown.total_count_for_breakdown DESC, totals_per_breakdown.breakdown_value ASC) AS breakdown_rank
                    FROM
                      (SELECT breakdown_series.breakdown_value AS breakdown_value,
                              sum(breakdown_series.count) AS total_count_for_breakdown,
                              if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_series.breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) AS ordering
                       FROM
                         (SELECT count AS count,
                                          day_start AS day_start,
                                          breakdown_value AS breakdown_value
                          FROM
                            (SELECT sum(total) AS count,
                                    day_start AS day_start,
                                    [ifNull(toString(breakdown_value_1), '$$_posthog_breakdown_null_$$')] AS breakdown_value
                             FROM
                               (SELECT count() AS total,
                                       toStartOfDay(toTimeZone(e.timestamp, 'UTC')) AS day_start,
                                       ifNull(nullIf(toString(e__person__revenue_analytics.revenue), ''), '$$_posthog_breakdown_null_$$') AS breakdown_value_1
                                FROM events AS e SAMPLE 1
                                LEFT OUTER JOIN
                                  (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                          person_distinct_id_overrides.distinct_id AS distinct_id
                                   FROM person_distinct_id_overrides
                                   WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                   GROUP BY person_distinct_id_overrides.distinct_id
                                   HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS e__override ON equals(e.distinct_id, e__override.distinct_id)
                                LEFT JOIN
                                  (SELECT argMax(person.id, person.version) AS e__person___id,
                                          person.id AS id
                                   FROM person
                                   WHERE equals(person.team_id, 99999)
                                   GROUP BY person.id
                                   HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0)) SETTINGS optimize_aggregation_in_order=1) AS e__person ON equals(if(not(empty(e__override.distinct_id)), e__override.person_id, e.person_id), e__person.e__person___id)
                                LEFT JOIN
                                  (SELECT 99999 AS team_id,
                                          accurateCastOrNull(revenue_analytics_revenue_item.customer_id, 'UUID') AS person_id,
                                          sum(revenue_analytics_revenue_item.amount) AS revenue,
                                          sumIf(revenue_analytics_revenue_item.amount, greaterOrEquals(toTimeZone(revenue_analytics_revenue_item.timestamp, 'UTC'), minus(today(), toIntervalDay(30)))) AS revenue_last_30_days
                                   FROM
                                     (SELECT toString(events.uuid) AS id,
                                             toString(events.uuid) AS invoice_item_id,
                                             'revenue_analytics.events.purchase' AS source_label,
                                             toTimeZone(events.timestamp, 'UTC') AS timestamp,
                                             timestamp AS created_at,
                                             0 AS is_recurring,
                                             NULL AS product_id,
                                             toString(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id)) AS customer_id,
                                             events.`$group_0` AS group_0_key,
                                             events.`$group_1` AS group_1_key,
                                             events.`$group_2` AS group_2_key,
                                             events.`$group_3` AS group_3_key,
                                             events.`$group_4` AS group_4_key,
                                             NULL AS invoice_id,
                                             NULL AS subscription_id,
                                             toString(events.`$session_id`) AS session_id,
                                             events.event AS event_name,
                                             NULL AS coupon,
                                             coupon AS coupon_id,
                                             'USD' AS original_currency,
                                             accurateCastOrNull(replaceRegexpAll(nullIf(nullIf(JSONExtractRaw(events.properties, 'revenue'), ''), 'null'), '^"|"$', ''), 'Decimal64(10)') AS original_amount,
                                             in(original_currency,
                                                ['BIF', 'CLP', 'DJF', 'GNF', 'JPY', 'KMF', 'KRW', 'MGA', 'PYG', 'RWF', 'UGX', 'VND', 'VUV', 'XAF', 'XOF', 'XPF']) AS enable_currency_aware_divider,
                                               if(enable_currency_aware_divider, accurateCastOrNull(1, 'Decimal64(10)'), accurateCastOrNull(100, 'Decimal64(10)')) AS currency_aware_divider,
                                               divideDecimal(original_amount, currency_aware_divider) AS currency_aware_amount,
                                               'USD' AS currency,
                                               if(isNull('USD'), accurateCastOrNull(currency_aware_amount, 'Decimal64(10)'), if(equals('USD', 'USD'), toDecimal64(currency_aware_amount, 10), if(dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)) = 0, toDecimal64(0, 10), multiplyDecimal(divideDecimal(toDecimal64(currency_aware_amount, 10), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10))), dictGetOrDefault(`posthog_test`.`exchange_rate_dict`, 'rate', 'USD', toDate(toTimeZone(events.timestamp, 'UTC')), toDecimal64(0, 10)))))) AS amount
                                      FROM events
                                      LEFT OUTER JOIN
                                        (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
                                                person_distinct_id_overrides.distinct_id AS distinct_id
                                         FROM person_distinct_id_overrides
                                         WHERE equals(person_distinct_id_overrides.team_id, 99999)
                                         GROUP BY person_distinct_id_overrides.distinct_id
                                         HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__override ON equals(events.distinct_id, events__override.distinct_id)
                                      WHERE and(equals(events.team_id, 99999), and(equals(events.event, 'purchase'), 1, isNotNull(amount)))
                                      ORDER BY timestamp DESC) AS revenue_analytics_revenue_item
                                   GROUP BY person_id) AS e__person__revenue_analytics ON equals(e__person.e__person___id, e__person__revenue_analytics.person_id)
                                WHERE and(equals(e.team_id, 99999), greaterOrEquals(toTimeZone(e.timestamp, 'UTC'), toStartOfInterval(assumeNotNull(toDateTime('2025-05-30 00:00:00', 'UTC')), toIntervalDay(1))), lessOrEquals(toTimeZone(e.timestamp, 'UTC'), assumeNotNull(toDateTime('2025-05-30 23:59:59', 'UTC'))), equals(e.event, '$pageview'))
                                GROUP BY day_start,
                                         breakdown_value_1)
                             GROUP BY day_start,
                                      breakdown_value_1
                             ORDER BY day_start ASC, breakdown_value ASC)) AS breakdown_series
                       GROUP BY breakdown_series.breakdown_value) AS totals_per_breakdown) AS ranked_breakdown_totals ON equals(ranked_breakdown_totals.breakdown_value, breakdown_series.breakdown_value)) AS ranked_breakdown_values
              WHERE ifNull(greater(ranked_breakdown_values.breakdown_rank, 25), 0)
              GROUP BY breakdown_value,
                       ranked_breakdown_values.day_start) AS other_breakdown_values)
        ORDER BY day_start ASC, value ASC) AS top_n_and_other_breakdown_values
     GROUP BY top_n_and_other_breakdown_values.breakdown_value)
  ORDER BY if(has(breakdown_value, '$$_posthog_breakdown_other_$$'), 2, if(has(breakdown_value, '$$_posthog_breakdown_null_$$'), 1, 0)) ASC, arraySum(total) DESC, breakdown_value ASC
  LIMIT 50000 SETTINGS readonly=2,
                       max_execution_time=60,
                       allow_experimental_object_type=1,
                       format_csv_allow_double_quotes=0,
                       max_ast_elements=4000000,
                       max_expanded_ast_elements=4000000,
                       max_bytes_before_external_group_by=0,
                       transform_null_in=1,
                       optimize_min_equality_disjunction_chain_length=4294967295,
                       allow_experimental_join_condition=1
  '''
# ---
