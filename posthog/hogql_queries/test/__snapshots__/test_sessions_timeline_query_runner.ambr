# name: TestSessionsTimelineQueryRunner.test_before_and_after
  '
  SELECT e.uuid,
         e.timestamp,
         e.event,
         e.properties,
         e.distinct_id,
         e.elements_chain,
         e.session_id AS formal_session_id,
         first_value(e.uuid) OVER (PARTITION BY tuple(e.person_id, e.session_id_flip_index)
                                   ORDER BY toInt64(e.timestamp) ASC RANGE BETWEEN 1800 PRECEDING AND CURRENT ROW) AS informal_session_uuid,
                                  dateDiff('s', sre.start_time, sre.end_time) AS recording_duration_s
  FROM
    (SELECT uuid,
            person_id, timestamp, event,
                                  properties,
                                  distinct_id,
                                  elements_chain,
                                  session_id,
                                  prev_session_id,
                                  sum(if(ifNull(equals(session_id, prev_session_id), isNull(session_id)
                                                and isNull(prev_session_id)), 0, 1)) OVER (PARTITION BY person_id
                                                                                           ORDER BY timestamp ASC ROWS UNBOUNDED PRECEDING) AS session_id_flip_index
     FROM
       (SELECT events.uuid,
               events__pdi.person_id AS person_id,
               toTimeZone(events.timestamp, 'UTC') AS timestamp,
               events.event,
               events.properties,
               events.distinct_id,
               events.elements_chain,
               events.`$session_id` AS session_id,
               lagInFrame(events.`$session_id`, 1) OVER (PARTITION BY person_id
                                                         ORDER BY timestamp ASC) AS prev_session_id
        FROM events
        INNER JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 2)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0)) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
        WHERE and(equals(events.team_id, 2), ifNull(greater(timestamp, toDateTime64('2023-10-01 12:00:00.000000', 6, 'UTC')), 0), ifNull(less(timestamp, toDateTime64('2023-10-01 17:00:00.000000', 6, 'UTC')), 0))
        ORDER BY timestamp DESC
        LIMIT 1001)) AS e
  LEFT JOIN
    (SELECT toTimeZone(session_replay_events.start_time, 'UTC') AS start_time,
            toTimeZone(session_replay_events.end_time, 'UTC') AS end_time,
            session_replay_events.session_id
     FROM
       (SELECT min(session_replay_events.min_first_timestamp) AS start_time,
               max(session_replay_events.max_last_timestamp) AS end_time,
               session_replay_events.session_id AS session_id
        FROM session_replay_events
        WHERE equals(session_replay_events.team_id, 2)
        GROUP BY session_replay_events.session_id) AS session_replay_events) AS sre ON equals(e.session_id, sre.session_id)
  ORDER BY e.timestamp DESC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1
  '
---
# name: TestSessionsTimelineQueryRunner.test_before_and_after_defaults
  '
  SELECT e.uuid,
         e.timestamp,
         e.event,
         e.properties,
         e.distinct_id,
         e.elements_chain,
         e.session_id AS formal_session_id,
         first_value(e.uuid) OVER (PARTITION BY tuple(e.person_id, e.session_id_flip_index)
                                   ORDER BY toInt64(e.timestamp) ASC RANGE BETWEEN 1800 PRECEDING AND CURRENT ROW) AS informal_session_uuid,
                                  dateDiff('s', sre.start_time, sre.end_time) AS recording_duration_s
  FROM
    (SELECT uuid,
            person_id, timestamp, event,
                                  properties,
                                  distinct_id,
                                  elements_chain,
                                  session_id,
                                  prev_session_id,
                                  sum(if(ifNull(equals(session_id, prev_session_id), isNull(session_id)
                                                and isNull(prev_session_id)), 0, 1)) OVER (PARTITION BY person_id
                                                                                           ORDER BY timestamp ASC ROWS UNBOUNDED PRECEDING) AS session_id_flip_index
     FROM
       (SELECT events.uuid,
               events__pdi.person_id AS person_id,
               toTimeZone(events.timestamp, 'UTC') AS timestamp,
               events.event,
               events.properties,
               events.distinct_id,
               events.elements_chain,
               events.`$session_id` AS session_id,
               lagInFrame(events.`$session_id`, 1) OVER (PARTITION BY person_id
                                                         ORDER BY timestamp ASC) AS prev_session_id
        FROM events
        INNER JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 2)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0)) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
        WHERE and(equals(events.team_id, 2), ifNull(greater(timestamp, toDateTime64('2023-09-30 16:00:00.000000', 6, 'UTC')), 0), ifNull(less(timestamp, toDateTime64('2023-10-01 16:00:00.000000', 6, 'UTC')), 0))
        ORDER BY timestamp DESC
        LIMIT 1001)) AS e
  LEFT JOIN
    (SELECT toTimeZone(session_replay_events.start_time, 'UTC') AS start_time,
            toTimeZone(session_replay_events.end_time, 'UTC') AS end_time,
            session_replay_events.session_id
     FROM
       (SELECT min(session_replay_events.min_first_timestamp) AS start_time,
               max(session_replay_events.max_last_timestamp) AS end_time,
               session_replay_events.session_id AS session_id
        FROM session_replay_events
        WHERE equals(session_replay_events.team_id, 2)
        GROUP BY session_replay_events.session_id) AS session_replay_events) AS sre ON equals(e.session_id, sre.session_id)
  ORDER BY e.timestamp DESC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1
  '
---
# name: TestSessionsTimelineQueryRunner.test_event_limit_and_has_more
  '
  SELECT e.uuid,
         e.timestamp,
         e.event,
         e.properties,
         e.distinct_id,
         e.elements_chain,
         e.session_id AS formal_session_id,
         first_value(e.uuid) OVER (PARTITION BY tuple(e.person_id, e.session_id_flip_index)
                                   ORDER BY toInt64(e.timestamp) ASC RANGE BETWEEN 1800 PRECEDING AND CURRENT ROW) AS informal_session_uuid,
                                  dateDiff('s', sre.start_time, sre.end_time) AS recording_duration_s
  FROM
    (SELECT uuid,
            person_id, timestamp, event,
                                  properties,
                                  distinct_id,
                                  elements_chain,
                                  session_id,
                                  prev_session_id,
                                  sum(if(ifNull(equals(session_id, prev_session_id), isNull(session_id)
                                                and isNull(prev_session_id)), 0, 1)) OVER (PARTITION BY person_id
                                                                                           ORDER BY timestamp ASC ROWS UNBOUNDED PRECEDING) AS session_id_flip_index
     FROM
       (SELECT events.uuid,
               events__pdi.person_id AS person_id,
               toTimeZone(events.timestamp, 'UTC') AS timestamp,
               events.event,
               events.properties,
               events.distinct_id,
               events.elements_chain,
               events.`$session_id` AS session_id,
               lagInFrame(events.`$session_id`, 1) OVER (PARTITION BY person_id
                                                         ORDER BY timestamp ASC) AS prev_session_id
        FROM events
        INNER JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 2)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0)) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
        WHERE and(equals(events.team_id, 2), ifNull(greater(timestamp, toDateTime64('2023-10-01 06:00:00.000000', 6, 'UTC')), 0), ifNull(less(timestamp, toDateTime64('2023-10-02 06:00:00.000000', 6, 'UTC')), 0))
        ORDER BY timestamp DESC
        LIMIT 3)) AS e
  LEFT JOIN
    (SELECT toTimeZone(session_replay_events.start_time, 'UTC') AS start_time,
            toTimeZone(session_replay_events.end_time, 'UTC') AS end_time,
            session_replay_events.session_id
     FROM
       (SELECT min(session_replay_events.min_first_timestamp) AS start_time,
               max(session_replay_events.max_last_timestamp) AS end_time,
               session_replay_events.session_id AS session_id
        FROM session_replay_events
        WHERE equals(session_replay_events.team_id, 2)
        GROUP BY session_replay_events.session_id) AS session_replay_events) AS sre ON equals(e.session_id, sre.session_id)
  ORDER BY e.timestamp DESC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1
  '
---
# name: TestSessionsTimelineQueryRunner.test_formal_and_informal_sessions_global
  '
  SELECT e.uuid,
         e.timestamp,
         e.event,
         e.properties,
         e.distinct_id,
         e.elements_chain,
         e.session_id AS formal_session_id,
         first_value(e.uuid) OVER (PARTITION BY tuple(e.person_id, e.session_id_flip_index)
                                   ORDER BY toInt64(e.timestamp) ASC RANGE BETWEEN 1800 PRECEDING AND CURRENT ROW) AS informal_session_uuid,
                                  dateDiff('s', sre.start_time, sre.end_time) AS recording_duration_s
  FROM
    (SELECT uuid,
            person_id, timestamp, event,
                                  properties,
                                  distinct_id,
                                  elements_chain,
                                  session_id,
                                  prev_session_id,
                                  sum(if(ifNull(equals(session_id, prev_session_id), isNull(session_id)
                                                and isNull(prev_session_id)), 0, 1)) OVER (PARTITION BY person_id
                                                                                           ORDER BY timestamp ASC ROWS UNBOUNDED PRECEDING) AS session_id_flip_index
     FROM
       (SELECT events.uuid,
               events__pdi.person_id AS person_id,
               toTimeZone(events.timestamp, 'UTC') AS timestamp,
               events.event,
               events.properties,
               events.distinct_id,
               events.elements_chain,
               events.`$session_id` AS session_id,
               lagInFrame(events.`$session_id`, 1) OVER (PARTITION BY person_id
                                                         ORDER BY timestamp ASC) AS prev_session_id
        FROM events
        INNER JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 2)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0)) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
        WHERE and(equals(events.team_id, 2), ifNull(greater(timestamp, toDateTime64('2023-10-01 06:00:00.000000', 6, 'UTC')), 0), ifNull(less(timestamp, toDateTime64('2023-10-02 06:00:00.000000', 6, 'UTC')), 0))
        ORDER BY timestamp DESC
        LIMIT 1001)) AS e
  LEFT JOIN
    (SELECT toTimeZone(session_replay_events.start_time, 'UTC') AS start_time,
            toTimeZone(session_replay_events.end_time, 'UTC') AS end_time,
            session_replay_events.session_id
     FROM
       (SELECT min(session_replay_events.min_first_timestamp) AS start_time,
               max(session_replay_events.max_last_timestamp) AS end_time,
               session_replay_events.session_id AS session_id
        FROM session_replay_events
        WHERE equals(session_replay_events.team_id, 2)
        GROUP BY session_replay_events.session_id) AS session_replay_events) AS sre ON equals(e.session_id, sre.session_id)
  ORDER BY e.timestamp DESC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1
  '
---
# name: TestSessionsTimelineQueryRunner.test_formal_session_with_recording
  '
  SELECT e.uuid,
         e.timestamp,
         e.event,
         e.properties,
         e.distinct_id,
         e.elements_chain,
         e.session_id AS formal_session_id,
         first_value(e.uuid) OVER (PARTITION BY tuple(e.person_id, e.session_id_flip_index)
                                   ORDER BY toInt64(e.timestamp) ASC RANGE BETWEEN 1800 PRECEDING AND CURRENT ROW) AS informal_session_uuid,
                                  dateDiff('s', sre.start_time, sre.end_time) AS recording_duration_s
  FROM
    (SELECT uuid,
            person_id, timestamp, event,
                                  properties,
                                  distinct_id,
                                  elements_chain,
                                  session_id,
                                  prev_session_id,
                                  sum(if(ifNull(equals(session_id, prev_session_id), isNull(session_id)
                                                and isNull(prev_session_id)), 0, 1)) OVER (PARTITION BY person_id
                                                                                           ORDER BY timestamp ASC ROWS UNBOUNDED PRECEDING) AS session_id_flip_index
     FROM
       (SELECT events.uuid,
               events__pdi.person_id AS person_id,
               toTimeZone(events.timestamp, 'UTC') AS timestamp,
               events.event,
               events.properties,
               events.distinct_id,
               events.elements_chain,
               events.`$session_id` AS session_id,
               lagInFrame(events.`$session_id`, 1) OVER (PARTITION BY person_id
                                                         ORDER BY timestamp ASC) AS prev_session_id
        FROM events
        INNER JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 2)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0)) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
        WHERE and(equals(events.team_id, 2), ifNull(greater(timestamp, toDateTime64('2023-10-01 06:00:00.000000', 6, 'UTC')), 0), ifNull(less(timestamp, toDateTime64('2023-10-02 06:00:00.000000', 6, 'UTC')), 0))
        ORDER BY timestamp DESC
        LIMIT 1001)) AS e
  LEFT JOIN
    (SELECT toTimeZone(session_replay_events.start_time, 'UTC') AS start_time,
            toTimeZone(session_replay_events.end_time, 'UTC') AS end_time,
            session_replay_events.session_id
     FROM
       (SELECT min(session_replay_events.min_first_timestamp) AS start_time,
               max(session_replay_events.max_last_timestamp) AS end_time,
               session_replay_events.session_id AS session_id
        FROM session_replay_events
        WHERE equals(session_replay_events.team_id, 2)
        GROUP BY session_replay_events.session_id) AS session_replay_events) AS sre ON equals(e.session_id, sre.session_id)
  ORDER BY e.timestamp DESC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1
  '
---
# name: TestSessionsTimelineQueryRunner.test_formal_sessions_for_person
  '
  SELECT e.uuid,
         e.timestamp,
         e.event,
         e.properties,
         e.distinct_id,
         e.elements_chain,
         e.session_id AS formal_session_id,
         first_value(e.uuid) OVER (PARTITION BY tuple(e.person_id, e.session_id_flip_index)
                                   ORDER BY toInt64(e.timestamp) ASC RANGE BETWEEN 1800 PRECEDING AND CURRENT ROW) AS informal_session_uuid,
                                  dateDiff('s', sre.start_time, sre.end_time) AS recording_duration_s
  FROM
    (SELECT uuid,
            person_id, timestamp, event,
                                  properties,
                                  distinct_id,
                                  elements_chain,
                                  session_id,
                                  prev_session_id,
                                  sum(if(ifNull(equals(session_id, prev_session_id), isNull(session_id)
                                                and isNull(prev_session_id)), 0, 1)) OVER (PARTITION BY person_id
                                                                                           ORDER BY timestamp ASC ROWS UNBOUNDED PRECEDING) AS session_id_flip_index
     FROM
       (SELECT events.uuid,
               events__pdi.person_id AS person_id,
               toTimeZone(events.timestamp, 'UTC') AS timestamp,
               events.event,
               events.properties,
               events.distinct_id,
               events.elements_chain,
               events.`$session_id` AS session_id,
               lagInFrame(events.`$session_id`, 1) OVER (PARTITION BY person_id
                                                         ORDER BY timestamp ASC) AS prev_session_id
        FROM events
        INNER JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 2)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0)) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
        WHERE and(equals(events.team_id, 2), ifNull(greater(timestamp, toDateTime64('2023-10-01 06:00:00.000000', 6, 'UTC')), 0), ifNull(less(timestamp, toDateTime64('2023-10-02 06:00:00.000000', 6, 'UTC')), 0), ifNull(equals(person_id, 'd63e1ecf-f92f-1e50-71f9-501e16e9aebe'), 0))
        ORDER BY timestamp DESC
        LIMIT 1001)) AS e
  LEFT JOIN
    (SELECT toTimeZone(session_replay_events.start_time, 'UTC') AS start_time,
            toTimeZone(session_replay_events.end_time, 'UTC') AS end_time,
            session_replay_events.session_id
     FROM
       (SELECT min(session_replay_events.min_first_timestamp) AS start_time,
               max(session_replay_events.max_last_timestamp) AS end_time,
               session_replay_events.session_id AS session_id
        FROM session_replay_events
        WHERE equals(session_replay_events.team_id, 2)
        GROUP BY session_replay_events.session_id) AS session_replay_events) AS sre ON equals(e.session_id, sre.session_id)
  ORDER BY e.timestamp DESC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1
  '
---
# name: TestSessionsTimelineQueryRunner.test_formal_sessions_global
  '
  SELECT e.uuid,
         e.timestamp,
         e.event,
         e.properties,
         e.distinct_id,
         e.elements_chain,
         e.session_id AS formal_session_id,
         first_value(e.uuid) OVER (PARTITION BY tuple(e.person_id, e.session_id_flip_index)
                                   ORDER BY toInt64(e.timestamp) ASC RANGE BETWEEN 1800 PRECEDING AND CURRENT ROW) AS informal_session_uuid,
                                  dateDiff('s', sre.start_time, sre.end_time) AS recording_duration_s
  FROM
    (SELECT uuid,
            person_id, timestamp, event,
                                  properties,
                                  distinct_id,
                                  elements_chain,
                                  session_id,
                                  prev_session_id,
                                  sum(if(ifNull(equals(session_id, prev_session_id), isNull(session_id)
                                                and isNull(prev_session_id)), 0, 1)) OVER (PARTITION BY person_id
                                                                                           ORDER BY timestamp ASC ROWS UNBOUNDED PRECEDING) AS session_id_flip_index
     FROM
       (SELECT events.uuid,
               events__pdi.person_id AS person_id,
               toTimeZone(events.timestamp, 'UTC') AS timestamp,
               events.event,
               events.properties,
               events.distinct_id,
               events.elements_chain,
               events.`$session_id` AS session_id,
               lagInFrame(events.`$session_id`, 1) OVER (PARTITION BY person_id
                                                         ORDER BY timestamp ASC) AS prev_session_id
        FROM events
        INNER JOIN
          (SELECT argMax(person_distinct_id2.person_id, person_distinct_id2.version) AS person_id,
                  person_distinct_id2.distinct_id AS distinct_id
           FROM person_distinct_id2
           WHERE equals(person_distinct_id2.team_id, 2)
           GROUP BY person_distinct_id2.distinct_id
           HAVING ifNull(equals(argMax(person_distinct_id2.is_deleted, person_distinct_id2.version), 0), 0)) AS events__pdi ON equals(events.distinct_id, events__pdi.distinct_id)
        WHERE and(equals(events.team_id, 2), ifNull(greater(timestamp, toDateTime64('2023-10-01 06:00:00.000000', 6, 'UTC')), 0), ifNull(less(timestamp, toDateTime64('2023-10-02 06:00:00.000000', 6, 'UTC')), 0))
        ORDER BY timestamp DESC
        LIMIT 1001)) AS e
  LEFT JOIN
    (SELECT toTimeZone(session_replay_events.start_time, 'UTC') AS start_time,
            toTimeZone(session_replay_events.end_time, 'UTC') AS end_time,
            session_replay_events.session_id
     FROM
       (SELECT min(session_replay_events.min_first_timestamp) AS start_time,
               max(session_replay_events.max_last_timestamp) AS end_time,
               session_replay_events.session_id AS session_id
        FROM session_replay_events
        WHERE equals(session_replay_events.team_id, 2)
        GROUP BY session_replay_events.session_id) AS session_replay_events) AS sre ON equals(e.session_id, sre.session_id)
  ORDER BY e.timestamp DESC
  LIMIT 100 SETTINGS readonly=2,
                     max_execution_time=60,
                     allow_experimental_object_type=1
  '
---
