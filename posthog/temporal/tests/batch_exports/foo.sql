SELECT sessions.session_id                             AS session_id,
       toString(sessions.session_id_v7)                AS session_id_v7,
       sessions.team_id                                AS team_id,
       sessions.distinct_id                            AS distinct_id,
       sessions.`$start_timestamp`                     AS start_timestamp,
       sessions.`$end_timestamp`                       AS end_timestamp,
       sessions.`$urls`                                AS urls,
       sessions.`$num_uniq_urls`                       AS num_uniq_urls,
       sessions.`$entry_current_url`                   AS entry_current_url,
       sessions.`$entry_pathname`                      AS entry_pathname,
       sessions.`$entry_hostname`                      AS entry_hostname,
       sessions.`$end_current_url`                     AS end_current_url,
       sessions.`$end_pathname`                        AS end_pathname,
       sessions.`$end_hostname`                        AS end_hostname,
       sessions.`$entry_utm_source`                    AS entry_utm_source,
       sessions.`$entry_utm_campaign`                  AS entry_utm_campaign,
       sessions.`$entry_utm_medium`                    AS entry_utm_medium,
       sessions.`$entry_utm_term`                      AS entry_utm_term,
       sessions.`$entry_utm_content`                   AS entry_utm_content,
       sessions.`$entry_referring_domain`              AS entry_referring_domain,
       sessions.`$entry_gclid`                         AS entry_gclid,
       sessions.`$entry_fbclid`                        AS entry_fbclid,
       sessions.`$entry_gad_source`                    AS entry_gad_source,
       sessions.`$pageview_count`                      AS pageview_count,
       sessions.`$autocapture_count`                   AS autocapture_count,
       sessions.`$screen_count`                        AS screen_count,
       sessions.`$channel_type`                        AS channel_type,
       sessions.`$session_duration`                    AS session_duration,
       sessions.duration                               AS duration,
       sessions.`$is_bounce`                           AS is_bounce,
       sessions.`$last_external_click_url`             AS last_external_click_url,
       sessions.`$page_screen_autocapture_count_up_to` AS page_screen_autocapture_count_up_to,
       sessions.`$exit_current_url`                    AS exit_current_url,
       sessions.`$exit_pathname`                       AS exit_pathname,
       sessions.`$vitals_lcp`                          AS vitals_lcp,
       sessions.`$start_timestamp`                     AS _inserted_at
FROM (SELECT toString(reinterpretAsUUID(bitOr(bitShiftLeft(raw_sessions.session_id_v7, 64),
                                              bitShiftRight(raw_sessions.session_id_v7, 64)))) AS session_id,
             raw_sessions.session_id_v7 AS session_id_v7,
             raw_sessions.team_id AS team_id,
             nullIf(argMaxMerge(raw_sessions.distinct_id), %(hogql_val_0)s) AS distinct_id,
             min(toTimeZone(raw_sessions.min_timestamp, %(hogql_val_1)s)) AS `$start_timestamp`,
             max(toTimeZone(raw_sessions.max_timestamp, %(hogql_val_2)s)) AS `$end_timestamp`,
             arrayDistinct(arrayFlatten(groupArray(raw_sessions.urls))) AS `$urls`,
             length(arrayDistinct(arrayFlatten(groupArray(raw_sessions.urls)))) AS `$num_uniq_urls`,
             nullIf(nullIf(argMinMerge(raw_sessions.entry_url), %(hogql_val_3)s), %(hogql_val_4)s) AS `$entry_current_url`,
             path(nullIf(nullIf(argMinMerge(raw_sessions.entry_url), %(hogql_val_5)s), %(hogql_val_6)s)) AS `$entry_pathname`,
             domain(nullIf(nullIf(argMinMerge(raw_sessions.entry_url), %(hogql_val_7)s), %(hogql_val_8)s)) AS `$entry_hostname`,
             nullIf(nullIf(argMaxMerge(raw_sessions.end_url), %(hogql_val_9)s), %(hogql_val_10)s) AS `$end_current_url`,
             path(nullIf(nullIf(argMaxMerge(raw_sessions.end_url), %(hogql_val_11)s), %(hogql_val_12)s)) AS `$end_pathname`,
             domain(nullIf(nullIf(argMaxMerge(raw_sessions.end_url), %(hogql_val_13)s), %(hogql_val_14)s)) AS `$end_hostname`,
             nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_source), %(hogql_val_15)s), %(hogql_val_16)s) AS `$entry_utm_source`,
             nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_campaign), %(hogql_val_17)s), %(hogql_val_18)s) AS `$entry_utm_campaign`,
             nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_medium), %(hogql_val_19)s), %(hogql_val_20)s) AS `$entry_utm_medium`,
             nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_term), %(hogql_val_21)s), %(hogql_val_22)s) AS `$entry_utm_term`,
             nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_content), %(hogql_val_23)s), %(hogql_val_24)s) AS `$entry_utm_content`,
             nullIf(nullIf(argMinMerge(raw_sessions.initial_referring_domain), %(hogql_val_25)s), %(hogql_val_26)s) AS `$entry_referring_domain`,
             nullIf(nullIf(argMinMerge(raw_sessions.initial_gclid), %(hogql_val_27)s), %(hogql_val_28)s) AS `$entry_gclid`,
             nullIf(nullIf(argMinMerge(raw_sessions.initial_fbclid), %(hogql_val_29)s), %(hogql_val_30)s) AS `$entry_fbclid`,
             nullIf(nullIf(argMinMerge(raw_sessions.initial_gad_source), %(hogql_val_31)s), %(hogql_val_32)s) AS `$entry_gad_source`,
             uniqMerge(raw_sessions.pageview_uniq) AS `$pageview_count`,
             uniqMerge(raw_sessions.autocapture_uniq) AS `$autocapture_count`,
             uniqMerge(raw_sessions.screen_uniq) AS `$screen_count`,
             multiIf(match(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_campaign), %(hogql_val_33)s), %(hogql_val_34)s), %(hogql_val_35)s), %(hogql_val_36)s)), %(hogql_val_37)s), %(hogql_val_38)s, or(ifNull(in(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_medium), %(hogql_val_39)s), %(hogql_val_40)s), %(hogql_val_41)s), %(hogql_val_42)s)), tuple(%(hogql_val_43)s, %(hogql_val_44)s, %(hogql_val_45)s, %(hogql_val_46)s, %(hogql_val_47)s, %(hogql_val_48)s)), 0), startsWith(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_medium), %(hogql_val_49)s), %(hogql_val_50)s), %(hogql_val_51)s), %(hogql_val_52)s)), %(hogql_val_53)s), isNotNull(nullIf(nullIf(argMinMerge(raw_sessions.initial_gclid), %(hogql_val_54)s), %(hogql_val_55)s)), isNotNull(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_gad_source), %(hogql_val_56)s), %(hogql_val_57)s), %(hogql_val_58)s), %(hogql_val_59)s))), coalesce(coalesce(dictGetOrNull('channel_definition_dict', 'type_if_paid', (coalesce(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_source), %(hogql_val_60)s), %(hogql_val_61)s), %(hogql_val_62)s), %(hogql_val_63)s)), ''), 'source')) , dictGetOrNull('channel_definition_dict', 'type_if_paid', (cutToFirstSignificantSubdomain(coalesce(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_source), %(hogql_val_60)s), %(hogql_val_61)s), %(hogql_val_62)s), %(hogql_val_63)s)), '')), 'source'))), if(match(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_campaign), %(hogql_val_64)s), %(hogql_val_65)s), %(hogql_val_66)s), %(hogql_val_67)s)), %(hogql_val_68)s), %(hogql_val_69)s, NULL), dictGetOrNull('channel_definition_dict', 'type_if_paid', (coalesce(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_medium), %(hogql_val_70)s), %(hogql_val_71)s), %(hogql_val_72)s), %(hogql_val_73)s)), ''), 'medium')), coalesce(dictGetOrNull('channel_definition_dict', 'type_if_paid', (coalesce(nullIf(nullIf(argMinMerge(raw_sessions.initial_referring_domain), %(hogql_val_74)s), %(hogql_val_75)s), ''), 'source')) , dictGetOrNull('channel_definition_dict', 'type_if_paid', (cutToFirstSignificantSubdomain(coalesce(nullIf(nullIf(argMinMerge(raw_sessions.initial_referring_domain), %(hogql_val_74)s), %(hogql_val_75)s), '')), 'source'))), multiIf(ifNull(equals(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_gad_source), %(hogql_val_76)s), %(hogql_val_77)s), %(hogql_val_78)s), %(hogql_val_79)s), %(hogql_val_80)s), 0), %(hogql_val_81)s, match(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_campaign), %(hogql_val_82)s), %(hogql_val_83)s), %(hogql_val_84)s), %(hogql_val_85)s)), %(hogql_val_86)s), %(hogql_val_87)s, isNotNull(nullIf(nullIf(argMinMerge(raw_sessions.initial_fbclid), %(hogql_val_88)s), %(hogql_val_89)s)), %(hogql_val_90)s, %(hogql_val_91)s)), and(ifNull(equals(nullIf(nullIf(argMinMerge(raw_sessions.initial_referring_domain), %(hogql_val_92)s), %(hogql_val_93)s), %(hogql_val_94)s), 0), isNull(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_medium), %(hogql_val_95)s), %(hogql_val_96)s), %(hogql_val_97)s), %(hogql_val_98)s))), or(isNull(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_source), %(hogql_val_99)s), %(hogql_val_100)s), %(hogql_val_101)s), %(hogql_val_102)s))), ifNull(in(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_source), %(hogql_val_103)s), %(hogql_val_104)s), %(hogql_val_105)s), %(hogql_val_106)s)), tuple(%(hogql_val_107)s, %(hogql_val_108)s, %(hogql_val_109)s)), 0)), not(isNotNull(nullIf(nullIf(argMinMerge(raw_sessions.initial_fbclid), %(hogql_val_110)s), %(hogql_val_111)s)))), %(hogql_val_112)s, coalesce(coalesce(dictGetOrNull('channel_definition_dict', 'type_if_organic', (coalesce(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_source), %(hogql_val_113)s), %(hogql_val_114)s), %(hogql_val_115)s), %(hogql_val_116)s)), ''), 'source')), dictGetOrNull('channel_definition_dict', 'type_if_organic', (cutToFirstSignificantSubdomain(coalesce(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_source), %(hogql_val_113)s), %(hogql_val_114)s), %(hogql_val_115)s), %(hogql_val_116)s)), '')), 'source'))), if(match(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_campaign), %(hogql_val_117)s), %(hogql_val_118)s), %(hogql_val_119)s), %(hogql_val_120)s)), %(hogql_val_121)s), %(hogql_val_122)s, NULL), dictGetOrNull('channel_definition_dict', 'type_if_organic', (coalesce(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_medium), %(hogql_val_123)s), %(hogql_val_124)s), %(hogql_val_125)s), %(hogql_val_126)s)), ''), 'medium')), coalesce(dictGetOrNull('channel_definition_dict', 'type_if_organic', (coalesce(nullIf(nullIf(argMinMerge(raw_sessions.initial_referring_domain), %(hogql_val_127)s), %(hogql_val_128)s), ''), 'source')), dictGetOrNull('channel_definition_dict', 'type_if_organic', (cutToFirstSignificantSubdomain(coalesce(nullIf(nullIf(argMinMerge(raw_sessions.initial_referring_domain), %(hogql_val_127)s), %(hogql_val_128)s), '')), 'source'))), multiIf(match(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_campaign), %(hogql_val_129)s), %(hogql_val_130)s), %(hogql_val_131)s), %(hogql_val_132)s)), %(hogql_val_133)s), %(hogql_val_134)s, match(lower(nullIf(nullIf(nullIf(nullIf(argMinMerge(raw_sessions.initial_utm_medium), %(hogql_val_135)s), %(hogql_val_136)s), %(hogql_val_137)s), %(hogql_val_138)s)), %(hogql_val_139)s), %(hogql_val_140)s, isNotNull(nullIf(nullIf(argMinMerge(raw_sessions.initial_fbclid), %(hogql_val_141)s), %(hogql_val_142)s)), %(hogql_val_143)s, ifNull(equals(nullIf(nullIf(argMinMerge(raw_sessions.initial_referring_domain), %(hogql_val_144)s), %(hogql_val_145)s), %(hogql_val_146)s), 0), %(hogql_val_147)s, isNotNull(nullIf(nullIf(argMinMerge(raw_sessions.initial_referring_domain), %(hogql_val_148)s), %(hogql_val_149)s)), %(hogql_val_150)s, %(hogql_val_151)s))) AS `$channel_type`,
             dateDiff(%(hogql_val_152)s, min(toTimeZone(raw_sessions.min_timestamp, %(hogql_val_153)s)), max(toTimeZone(raw_sessions.max_timestamp, %(hogql_val_154)s))) AS `$session_duration`,
             dateDiff(%(hogql_val_155)s, min(toTimeZone(raw_sessions.min_timestamp, %(hogql_val_156)s)), max(toTimeZone(raw_sessions.max_timestamp, %(hogql_val_157)s))) AS duration,
             if(ifNull(equals(uniqMerge(raw_sessions.pageview_uniq), 0), 0), NULL,
                not (or(ifNull(greater(uniqMerge(raw_sessions.pageview_uniq), 1), 0),
                        ifNull(greater(uniqMerge(raw_sessions.autocapture_uniq), 0), 0),
                        ifNull(greaterOrEquals(dateDiff(%(hogql_val_158)s, min(toTimeZone(raw_sessions.min_timestamp, %(hogql_val_159)s)), max(toTimeZone(raw_sessions.max_timestamp, %(hogql_val_160)s))), 10), 0)))) AS `$is_bounce`,
             nullIf(nullIf(argMaxMerge(raw_sessions.last_external_click_url), %(hogql_val_161)s), %(hogql_val_162)s) AS `$last_external_click_url`,
             uniqUpToMerge(1)(raw_sessions.page_screen_autocapture_uniq_up_to) AS `$page_screen_autocapture_count_up_to`,
             nullIf(nullIf(argMaxMerge(raw_sessions.end_url), %(hogql_val_163)s), %(hogql_val_164)s) AS `$exit_current_url`,
             path(nullIf(nullIf(argMaxMerge(raw_sessions.end_url), %(hogql_val_165)s), %(hogql_val_166)s)) AS `$exit_pathname`,
             argMinMerge(raw_sessions.vitals_lcp) AS `$vitals_lcp`
      FROM raw_sessions
      WHERE and(equals(raw_sessions.team_id, 6), ifNull(lessOrEquals(minus(fromUnixTimestamp(intDiv(
              toUInt64(bitShiftRight(raw_sessions.session_id_v7, 80)), 1000)), toIntervalDay(3)),
                                                                     toDateTime64('2025-03-06 00:00:00.000000', 6, 'UTC')),
                                                        0), ifNull(greaterOrEquals(plus(fromUnixTimestamp(intDiv(
              toUInt64(bitShiftRight(raw_sessions.session_id_v7, 80)), 1000)), toIntervalDay(3)),
                                                                                   toDateTime64('2025-03-05 23:00:00.000000', 6, 'UTC')),
                                                                   0))
      GROUP BY raw_sessions.session_id_v7, raw_sessions.session_id_v7, raw_sessions.team_id) AS sessions
WHERE and(ifNull(equals(sessions.team_id, 6), 0),
          ifNull(less(_inserted_at, toDateTime64('2025-03-06 00:00:00.000000', 6, 'UTC')), 0),
          ifNull(less(sessions.`$start_timestamp`, toDateTime64('2025-03-06 00:00:00.000000', 6, 'UTC')), 0),
          ifNull(greaterOrEquals(_inserted_at, toDateTime64('2025-03-05 23:00:00.000000', 6, 'UTC')), 0),
          ifNull(greaterOrEquals(sessions.`$start_timestamp`, toDateTime64('2025-03-05 23:00:00.000000', 6, 'UTC')), 0))
ORDER BY _inserted_at ASC FORMAT ArrowStream SETTINGS optimize_aggregation_in_order=1, max_bytes_before_external_sort=50000000000, max_bytes_before_external_group_by=50000000000