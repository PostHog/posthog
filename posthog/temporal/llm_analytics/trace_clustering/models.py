"""Data models for trace clustering workflow."""

from dataclasses import dataclass
from typing import TypedDict

from posthog.temporal.llm_analytics.trace_clustering.constants import (
    DEFAULT_LOOKBACK_DAYS,
    DEFAULT_MAX_K,
    DEFAULT_MAX_SAMPLES,
    DEFAULT_MIN_K,
)


@dataclass
class ClusteringWorkflowInputs:
    """Input parameters for the daily trace clustering workflow.

    The workflow calculates window_start/window_end from lookback_days
    and passes them to the activity.
    """

    team_id: int
    lookback_days: int = DEFAULT_LOOKBACK_DAYS
    max_samples: int = DEFAULT_MAX_SAMPLES
    min_k: int = DEFAULT_MIN_K
    max_k: int = DEFAULT_MAX_K


@dataclass
class ClusteringActivityInputs:
    """Input parameters for the clustering activity.

    Window bounds are required and calculated by the workflow.
    """

    team_id: int
    window_start: str  # ISO format, required
    window_end: str  # ISO format, required
    max_samples: int = DEFAULT_MAX_SAMPLES
    min_k: int = DEFAULT_MIN_K
    max_k: int = DEFAULT_MAX_K


@dataclass
class ClusterLabel:
    """Label for a cluster generated by LLM."""

    title: str
    description: str


class TraceClusterMetadata(TypedDict):
    """Metadata for a trace within a cluster."""

    distance_to_centroid: float
    rank: int


@dataclass
class ClusterData:
    """Data structure for a cluster to be emitted in events."""

    cluster_id: int
    size: int
    title: str
    description: str
    traces: dict[str, TraceClusterMetadata]
    centroid: list[float]


@dataclass
class ClusteringMetrics:
    """Metrics from the clustering algorithm."""

    total_traces_analyzed: int = 0
    num_clusters: int = 0
    duration_seconds: float = 0.0


@dataclass
class ClusteringResult:
    """Result of the clustering workflow."""

    clustering_run_id: str
    team_id: int
    timestamp: str  # ISO format
    window_start: str  # ISO format
    window_end: str  # ISO format
    metrics: ClusteringMetrics
    clusters: list[ClusterData]


class TraceSummary(TypedDict):
    """Summary of a trace for labeling."""

    title: str
    flow_diagram: str
    bullets: str
    interesting_notes: str


# Type aliases for data access
TraceId = str
TraceEmbeddings = dict[TraceId, list[float]]
TraceSummaries = dict[TraceId, TraceSummary]
ClusterRepresentatives = dict[int, list[TraceId]]  # cluster_id -> list of representative trace IDs


@dataclass
class KMeansResult:
    """Result of k-means clustering."""

    labels: list[int]  # Cluster assignment for each sample
    centroids: list[list[float]]  # Cluster centroids


@dataclass
class ClusteringComputeResult:
    """Output from the compute activity - passed to labeling and emission."""

    clustering_run_id: str
    trace_ids: list[str]
    labels: list[int]  # cluster assignment per trace
    centroids: list[list[float]]  # k centroids, each 384-dim
    distances: list[list[float]]  # n_traces x k_clusters distance matrix
    representative_trace_ids: ClusterRepresentatives  # cluster_id -> trace_ids


@dataclass
class GenerateLabelsActivityInputs:
    """Input for the LLM labeling activity."""

    team_id: int
    labels: list[int]
    representative_trace_ids: ClusterRepresentatives
    window_start: str
    window_end: str


@dataclass
class GenerateLabelsActivityOutputs:
    """Output from the LLM labeling activity."""

    cluster_labels: dict[int, ClusterLabel]


@dataclass
class EmitEventsActivityInputs:
    """Input for the event emission activity."""

    team_id: int
    clustering_run_id: str
    window_start: str
    window_end: str
    trace_ids: list[str]
    labels: list[int]
    centroids: list[list[float]]
    distances: list[list[float]]
    cluster_labels: dict[int, ClusterLabel]
