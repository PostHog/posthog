"""Data models for trace clustering workflow."""

from dataclasses import dataclass
from typing import Optional, TypedDict

from posthog.temporal.llm_analytics.trace_clustering.constants import (
    DEFAULT_LOOKBACK_DAYS,
    DEFAULT_MAX_K,
    DEFAULT_MAX_SAMPLES,
    DEFAULT_MIN_K,
)


@dataclass
class ClusteringInputs:
    """Input parameters for the daily trace clustering workflow."""

    team_id: int
    current_time: str  # ISO format timestamp from workflow.now()
    lookback_days: int = DEFAULT_LOOKBACK_DAYS
    max_samples: int = DEFAULT_MAX_SAMPLES
    min_k: int = DEFAULT_MIN_K
    max_k: int = DEFAULT_MAX_K
    window_start: Optional[str] = None  # RFC3339 format, overrides lookback_days
    window_end: Optional[str] = None  # RFC3339 format, overrides lookback_days


@dataclass
class ClusterLabel:
    """Label for a cluster generated by LLM."""

    title: str
    description: str


@dataclass
class ClusterData:
    """Data structure for a cluster to be emitted in events."""

    cluster_id: int
    size: int
    title: str
    description: str
    trace_ids: list[str]
    traces: list[dict]
    centroid: list[float]


@dataclass
class ClusteringResult:
    """Result of the clustering workflow."""

    clustering_run_id: str
    team_id: int
    timestamp: str  # ISO format
    window_start: str  # ISO format
    window_end: str  # ISO format
    total_traces_analyzed: int
    sampled_traces_count: int
    optimal_k: int
    silhouette_score: float
    inertia: float
    clusters: list[ClusterData]
    duration_seconds: float


class TraceSummary(TypedDict):
    """Summary of a trace for labeling."""

    title: str
    summary: str


# Type aliases for data access
TraceId = str
Embedding = list[float]
TraceEmbeddings = dict[TraceId, Embedding]
TraceSummaries = dict[TraceId, TraceSummary]
