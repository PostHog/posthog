"""Data models for trace clustering workflow."""

from dataclasses import dataclass
from typing import Optional, TypedDict

from posthog.temporal.llm_analytics.trace_clustering.constants import (
    DEFAULT_LOOKBACK_DAYS,
    DEFAULT_MAX_K,
    DEFAULT_MAX_SAMPLES,
    DEFAULT_MIN_K,
)


@dataclass
class ClusteringInputs:
    """Input parameters for the daily trace clustering workflow."""

    team_id: int
    current_time: str  # ISO format timestamp from workflow.now()
    lookback_days: int = DEFAULT_LOOKBACK_DAYS
    max_samples: int = DEFAULT_MAX_SAMPLES
    min_k: int = DEFAULT_MIN_K
    max_k: int = DEFAULT_MAX_K
    window_start: Optional[str] = None  # RFC3339 format, overrides lookback_days
    window_end: Optional[str] = None  # RFC3339 format, overrides lookback_days


@dataclass
class ClusterLabel:
    """Label for a cluster generated by LLM."""

    title: str
    description: str


@dataclass
class ClusterData:
    """Data structure for a cluster to be emitted in events."""

    cluster_id: int
    size: int
    title: str
    description: str
    traces: dict[str, dict]  # trace_id -> {distance_to_centroid, rank}
    centroid: list[float]


@dataclass
class ClusteringMetrics:
    """Metrics from the clustering algorithm."""

    total_traces_analyzed: int = 0
    num_clusters: int = 0
    duration_seconds: float = 0.0


@dataclass
class ClusteringResult:
    """Result of the clustering workflow."""

    clustering_run_id: str
    team_id: int
    timestamp: str  # ISO format
    window_start: str  # ISO format
    window_end: str  # ISO format
    metrics: ClusteringMetrics
    clusters: list[ClusterData]


class TraceSummary(TypedDict):
    """Summary of a trace for labeling."""

    title: str
    summary: str


# Type aliases for data access
TraceId = str
TraceEmbeddings = dict[TraceId, list[float]]
TraceSummaries = dict[TraceId, TraceSummary]
ClusterRepresentatives = dict[int, list[TraceId]]  # cluster_id -> list of representative trace IDs


@dataclass
class KMeansResult:
    """Result of k-means clustering."""

    labels: list[int]  # Cluster assignment for each sample
    centroids: list[list[float]]  # Cluster centroids
