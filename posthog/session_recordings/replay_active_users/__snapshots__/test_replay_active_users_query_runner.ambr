# serializer version: 1
# name: TestReplayActiveUsersQueryRunner.test_query_performance
  '''
  SELECT sp.person_id AS person_id,
         sp.pp AS pp,
         sum(cs.c) AS total_count
  FROM
    (SELECT session_replay_events.session_id AS session_id,
            any(session_replay_events.distinct_id) AS sess_di,
            count() AS c
     FROM session_replay_events
     WHERE and(equals(session_replay_events.team_id, 99999), greaterOrEquals(toTimeZone(session_replay_events.min_first_timestamp, 'UTC'), minus(toDateTime64('today', 6, 'UTC'), toIntervalDay(7))), lessOrEquals(toTimeZone(session_replay_events.min_first_timestamp, 'UTC'), toDateTime64('today', 6, 'UTC')))
     GROUP BY session_replay_events.session_id
     HAVING greater(dateDiff('second', min(toTimeZone(session_replay_events.min_first_timestamp, 'UTC')), max(toTimeZone(session_replay_events.max_last_timestamp, 'UTC'))), 5)) AS cs
  INNER JOIN
    (SELECT events.`$session_id` AS session_id,
            any(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id)) AS person_id,
            any(events__person.properties) AS pp
     FROM events
     LEFT OUTER JOIN
       (SELECT argMax(person_distinct_id_overrides.person_id, person_distinct_id_overrides.version) AS person_id,
               person_distinct_id_overrides.distinct_id AS distinct_id
        FROM person_distinct_id_overrides
        WHERE equals(person_distinct_id_overrides.team_id, 99999)
        GROUP BY person_distinct_id_overrides.distinct_id
        HAVING ifNull(equals(argMax(person_distinct_id_overrides.is_deleted, person_distinct_id_overrides.version), 0), 0) SETTINGS optimize_aggregation_in_order=1) AS events__override ON equals(events.distinct_id, events__override.distinct_id)
     LEFT JOIN
       (SELECT person.id AS id,
               person.properties AS properties
        FROM person
        WHERE and(equals(person.team_id, 99999), in(tuple(person.id, person.version),
                                                      (SELECT person.id AS id, max(person.version) AS version
                                                       FROM person
                                                       WHERE equals(person.team_id, 99999)
                                                       GROUP BY person.id
                                                       HAVING and(ifNull(equals(argMax(person.is_deleted, person.version), 0), 0), ifNull(less(argMax(toTimeZone(person.created_at, 'UTC'), person.version), plus(now64(6, 'UTC'), toIntervalDay(1))), 0))))) SETTINGS optimize_aggregation_in_order=1) AS events__person ON equals(if(not(empty(events__override.distinct_id)), events__override.person_id, events.person_id), events__person.id)
     WHERE and(equals(events.team_id, 99999), greaterOrEquals(toTimeZone(events.timestamp, 'UTC'), minus(toDateTime64('today', 6, 'UTC'), toIntervalDay(7))), lessOrEquals(toTimeZone(events.timestamp, 'UTC'), toDateTime64('today', 6, 'UTC')), in(events.`$session_id`,
                                                                                                                                                                                                                                                       (SELECT counted_sessions.session_id AS session_id
                                                                                                                                                                                                                                                        FROM
                                                                                                                                                                                                                                                          (SELECT session_replay_events.session_id AS session_id, any(session_replay_events.distinct_id) AS sess_di, count() AS c
                                                                                                                                                                                                                                                           FROM session_replay_events
                                                                                                                                                                                                                                                           WHERE and(equals(session_replay_events.team_id, 99999), greaterOrEquals(toTimeZone(session_replay_events.min_first_timestamp, 'UTC'), minus(toDateTime64('today', 6, 'UTC'), toIntervalDay(7))), lessOrEquals(toTimeZone(session_replay_events.min_first_timestamp, 'UTC'), toDateTime64('today', 6, 'UTC')))
                                                                                                                                                                                                                                                           GROUP BY session_replay_events.session_id
                                                                                                                                                                                                                                                           HAVING greater(dateDiff('second', min(toTimeZone(session_replay_events.min_first_timestamp, 'UTC')), max(toTimeZone(session_replay_events.max_last_timestamp, 'UTC'))), 5)) AS counted_sessions)), in(events.event, tuple('$pageview', '$screen', '$autocapture', '$feature_flag_called', '$pageleave', '$identify', '$web_vitals', '$set', 'Application Opened', 'Application Backgrounded')))
     GROUP BY events.`$session_id`) AS sp ON equals(cs.session_id, sp.session_id)
  WHERE isNotNull(sp.person_id)
  GROUP BY sp.person_id,
           sp.pp
  ORDER BY total_count DESC
  LIMIT 10 SETTINGS readonly=2,
                    max_execution_time=60,
                    allow_experimental_object_type=1,
                    format_csv_allow_double_quotes=0,
                    max_ast_elements=4000000,
                    max_expanded_ast_elements=4000000,
                    max_bytes_before_external_group_by=0,
                    transform_null_in=1,
                    optimize_min_equality_disjunction_chain_length=4294967295,
                    allow_experimental_join_condition=1
  '''
# ---
