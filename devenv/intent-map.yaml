# Intent-based developer environment configuration
#
# This file defines the domain model for developer environments:
# - Intent: What the developer is working on (products like error_tracking, session_replay)
# - Capabilities: Stable abstractions (event_ingestion, replay_storage, etc.)
#
# Process definitions (which processes provide which capability) are in bin/mprocs.yaml.
# Each process declares its capability via the `capability` field.

version: '1.0'

# Capabilities are stable abstractions over processes
# - requires: dependencies resolved transitively
# - docker_profiles: docker compose profiles to activate (see docker-compose.profiles.yml)
# - Processes are NOT listed here - they declare their capability in mprocs.yaml
capabilities:
    core_infra:
        description: 'Essential infrastructure (docker, postgres, clickhouse)'
        docker_profiles: []

    event_ingestion:
        description: 'Kafka-based event pipeline for event capture'
        requires: [core_infra]
        docker_profiles: []

    property_definitions:
        description: 'Track and define event/person properties'
        requires: [event_ingestion]
        docker_profiles: []

    replay_storage:
        description: 'Session replay blob storage and capture'
        requires: [event_ingestion]
        docker_profiles: [replay]

    error_symbolication:
        description: 'Error stack trace symbolication service'
        requires: [event_ingestion]
        docker_profiles: []

    flag_evaluation:
        description: 'Fast feature flag evaluation service'
        requires: [core_infra]
        docker_profiles: []

    celery_workers:
        description: 'Celery background job processing'
        requires: [core_infra]
        docker_profiles: []

    celery_scheduler:
        description: 'Celery beat scheduler for periodic tasks'
        requires: [celery_workers]
        docker_profiles: []

    temporal_workflows:
        description: 'Temporal workflow orchestration'
        requires: [core_infra]
        docker_profiles: [temporal]

    dagster_pipelines:
        description: 'Dagster data pipeline orchestration'
        requires: [core_infra]
        docker_profiles: []

    llm_gateway:
        description: 'LLM gateway for AI features'
        requires: [core_infra]
        docker_profiles: []

    ai_capture:
        description: 'AI event capture service'
        requires: [event_ingestion, llm_gateway]
        docker_profiles: []

    embedding_service:
        description: 'Vector embedding worker for AI features'
        requires: [core_infra]
        docker_profiles: []

    livestream:
        description: 'Real-time event streaming'
        requires: [event_ingestion]
        docker_profiles: []

    cyclotron:
        description: 'Cyclotron job queue infrastructure (includes shadow for testing)'
        requires: [core_infra]
        docker_profiles: []

    # Node.js capability groups - control which consumers run to reduce event loop contention
    nodejs_cdp:
        description: 'Node.js CDP - destinations, webhooks, and realtime alerts'
        requires: [event_ingestion]
        docker_profiles: []

    nodejs_cdp_workflows:
        description: 'Node.js CDP + Workflows - full CDP with HogFlow workflow automation'
        requires: [event_ingestion]
        docker_profiles: []

    nodejs_realtime_cohorts:
        description: 'Node.js Realtime Cohorts - precalculated filters and cohort membership'
        requires: [event_ingestion]
        docker_profiles: []

    nodejs_session_replay:
        description: 'Node.js Session Replay - recording ingestion'
        requires: [event_ingestion]
        docker_profiles: [replay]

    nodejs_logs:
        description: 'Node.js Logs - log ingestion'
        requires: [event_ingestion]
        docker_profiles: []

    nodejs_feature_flags:
        description: 'Node.js Feature Flags - evaluation scheduler'
        requires: [flag_evaluation]
        docker_profiles: []

    batch_imports:
        description: 'Batch data import worker'
        requires: [event_ingestion]
        docker_profiles: []

    observability:
        description: 'OpenTelemetry tracing with Jaeger'
        requires: [core_infra]
        docker_profiles: [observability]

    dev_tools:
        description: 'Development debugging tools (Kafka UI, Flower, etc.)'
        requires: [core_infra]
        docker_profiles: [dev_tools]

    mcp_server:
        description: 'MCP server for AI assistant integration'
        requires: [core_infra]
        docker_profiles: []

# Intents map to products/features developers work on
intents:
    product_analytics:
        description: 'Core product analytics - insights, funnels, trends'
        capabilities: [event_ingestion, property_definitions, celery_workers, nodejs_cdp]

    error_tracking:
        description: 'Track and analyze application errors'
        capabilities: [event_ingestion, error_symbolication, property_definitions, nodejs_cdp]

    session_replay:
        description: 'Record and replay user sessions'
        capabilities: [event_ingestion, replay_storage, property_definitions, celery_workers, nodejs_session_replay]

    feature_flags:
        description: 'Feature flag management and evaluation'
        capabilities: [flag_evaluation, celery_workers, celery_scheduler, nodejs_feature_flags]

    experiments:
        description: 'A/B testing and experimentation'
        capabilities:
            [
                event_ingestion,
                flag_evaluation,
                property_definitions,
                celery_workers,
                nodejs_feature_flags,
                dagster_pipelines,
            ]

    llm_analytics:
        description: 'LLM/AI observability and analytics'
        capabilities: [event_ingestion, ai_capture, llm_gateway, property_definitions, temporal_workflows]

    web_analytics:
        description: 'Web analytics, traffic analysis, and heatmaps'
        capabilities: [event_ingestion, replay_storage, property_definitions]

    surveys:
        description: 'User surveys and feedback collection'
        capabilities: [event_ingestion, property_definitions, celery_workers, celery_scheduler, nodejs_cdp]

    data_warehouse:
        description: 'Data warehouse queries and saved queries'
        capabilities: [event_ingestion, property_definitions, celery_workers, temporal_workflows]

    cohorts:
        description: 'User cohort management'
        capabilities: [event_ingestion, property_definitions, celery_workers, celery_scheduler, nodejs_realtime_cohorts]

    pipelines:
        description: 'Data pipeline transformations and destinations'
        capabilities:
            [event_ingestion, property_definitions, celery_workers, temporal_workflows, nodejs_cdp_workflows, cyclotron]

    ai_features:
        description: 'AI features'
        capabilities: [event_ingestion, llm_gateway, embedding_service, property_definitions, temporal_workflows]

    logs:
        description: 'Log aggregation and viewing'
        capabilities: [event_ingestion, property_definitions, nodejs_logs]

    workflows:
        description: 'Workflow automation and orchestration'
        capabilities: [event_ingestion, property_definitions, temporal_workflows, nodejs_cdp_workflows, cyclotron]

    tracing:
        description: 'OpenTelemetry tracing with Jaeger UI'
        capabilities: [observability]

    debug_tools:
        description: 'Kafka UI, Flower (Celery), maildev, webhook tester'
        capabilities: [dev_tools]

    mcp:
        description: 'MCP server for AI assistant integration'
        capabilities: [mcp_server]

# Always-required processes regardless of intent
# This is the core stack needed for any development
always_required:
    - backend
    - frontend
    - typegen
    - docker-compose
    # Migrations (DBs created by postgres init scripts, run for everyone)
    - migrate-postgres
    - migrate-clickhouse
    - migrate-persons-db
    - migrate-behavioral-cohorts
    # Core services
    - celery-worker
    - celery-beat
    - nodejs
    - capture
    - feature-flags
    - property-defs-rs
