extensions:
    docker_observer:
    health_check: # Default configuration is usually fine
    zpages: # Default configuration is usually fine

receivers:
    receiver_creator:
        watch_observers: [docker_observer]
        receivers:
            filelog:
                rule: type == "container" and not (name matches "otel-collector-local")
                config:
                    include:
                        - '`"/var/lib/docker/containers/" + container_id + "/*.log"`'
                    include_file_path: true
                    operators:
                        - type: regex_replace
                          regex_name: ansi_control_sequences
                          field: body
                        - id: docker-json-parser
                          type: json_parser
                          timestamp:
                              parse_from: attributes.time
                              layout: '%Y-%m-%dT%H:%M:%S.%LZ'
                          on_error: drop
                        - type: move
                          from: attributes["log"]
                          to: body
                        - type: add
                          field: resource["service.name"]
                          value: '`name`'
                        - type: add
                          field: resource["container.name"]
                          value: '`name`'
                        - type: add
                          field: resource["container.id"]
                          value: '`container_id`'
                        - type: add
                          field: resource["container.image.name"]
                          value: '`image`'
                        - type: json_parser
                          parse_from: body
                          on_error: send_quiet
                          if: "hasPrefix(body, '{')"
                        - type: move
                          from: attributes["log.file.name"]
                          to: resource["log.file.name"]
                        - type: move
                          from: attributes["log.file.path"]
                          to: resource["log.file.path"]
    otlp:
        protocols:
            grpc:
                endpoint: 0.0.0.0:4317 # Collector receiving OTLP gRPC
            http:
                endpoint: 0.0.0.0:4318 # Collector receiving OTLP HTTP

exporters:
    otlp: # Using the standard OTLP exporter
        endpoint: 'jaeger-local:4317' # Sending OTLP gRPC to Jaeger
        tls:
            insecure: true # For local communication to Jaeger
    otlphttp/logs:
        endpoint: 'http://capture-logs:4318'
        compression: none
        tls:
            insecure: true
        headers:
            # special "local" token is automatically mapped to team_id 1 in dev environments
            authorization: Bearer phc_local

processors:
    batch:

service:
    pipelines:
        traces:
            receivers: [otlp]
            processors: [batch]
            exporters: [otlp]
        logs:
            exporters:
                - otlphttp/logs
            processors:
                - batch
            receivers:
                - otlp
                - receiver_creator
    extensions: [docker_observer, health_check, zpages] # Enabling the declared extensions
