common --enable_bzlmod

# Allow network access for uv pip compile (git dependencies)
build --sandbox_default_allow_network=true

# Disk cache for faster incremental builds
build --disk_cache=~/.cache/bazel-disk-cache

# Repository cache for external dependencies (pip packages, etc.)
# Saves ~3 min on cold start by caching downloaded external repos
common --repository_cache=~/.cache/bazel-repos

# CI configuration
# Usage: bazel test --config=ci //...
# Note: test_env set via common to avoid analysis cache invalidation
# (otherwise bazel run/query without it, then bazel test with it = cache miss)
common:ci --test_env=DEBUG=1
test:ci --test_output=errors
test:ci --keep_going
test:ci --verbose_failures

# BuildBuddy remote cache + Build Event Service (CI only)
# Requires API key via: --remote_header=x-buildbuddy-api-key=$BUILDBUDDY_API_KEY
build:ci --remote_cache=grpcs://remote.buildbuddy.io
build:ci --bes_backend=grpcs://remote.buildbuddy.io
build:ci --bes_results_url=https://app.buildbuddy.io/invocation/
# Don't block build completion on BES upload finishing
build:ci --bes_upload_mode=nowait_for_upload_complete
build:ci --remote_upload_local_results=true
build:ci --build_metadata=ROLE=CI
# Increase timeouts from default 60s to avoid DEADLINE_EXCEEDED
build:ci --remote_timeout=300
build:ci --bes_timeout=300s
# Compress artifacts for faster uploads/downloads
build:ci --experimental_remote_cache_compression
# Disable disk cache in CI to avoid interference with remote cache
build:ci --disk_cache=

# Local development (default)
test --test_output=summary
