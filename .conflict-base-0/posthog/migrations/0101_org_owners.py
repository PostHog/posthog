# Generated by Django 3.0.6 on 2020-11-19 06:04

from django.db import migrations, models


def make_first_administrators_owners(apps, schema_editor):
    Organization = apps.get_model("posthog", "Organization")
    for organization in Organization.objects.all():
        if organization.memberships.filter(level=15).exists():
            continue
        first_admin = organization.memberships.filter(level=8).first()
        if first_admin is not None:
            first_admin.level = 15
            first_admin.save()


def make_owners_administrators_again(apps, schema_editor):
    OrganizationMembership = apps.get_model("posthog", "OrganizationMembership")
    OrganizationMembership.objects.filter(level=15).update(level=8)


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0100_action_step_max_length"),
    ]

    operations = [
        migrations.AlterField(
            model_name="organizationmembership",
            name="level",
            field=models.PositiveSmallIntegerField(
                choices=[(1, "member"), (8, "administrator"), (15, "owner")], default=1
            ),
        ),
        migrations.AddConstraint(
            model_name="organizationmembership",
            constraint=models.UniqueConstraint(
                condition=models.Q(level=15),
                fields=("organization_id",),
                name="only_one_owner_per_organization",
            ),
        ),
        migrations.RunPython(
            make_first_administrators_owners,
            make_owners_administrators_again,
            elidable=True,
        ),
    ]
