name: Storybook
on:
    pull_request:

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    # This is so that the workflow run isn't canceled when a snapshot update is pushed within it by posthog-bot
    # We do however cancel from container-images-ci.yml if a commit is pushed by someone OTHER than posthog-bot
    cancel-in-progress: false

permissions:
    contents: write
    pull-requests: write

jobs:
    # Job to decide if we should run storybook ci
    # See https://github.com/dorny/paths-filter#conditional-execution for more details
    changes:
        runs-on: ubuntu-latest
        timeout-minutes: 5
        name: Determine need to run storybook checks
        # Set job outputs to values from filter step
        outputs:
            frontend: ${{ steps.filter.outputs.frontend }}
        steps:
            - uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50 # v2
              id: filter
              with:
                  filters: |
                      frontend:
                        - 'frontend/**'
                        - 'products/!(mcp)/**/*.ts'
                        - 'products/!(mcp)/**/*.tsx'
                        - 'products/!(mcp)/**/frontend/**'
                        - 'common/**'
                        - 'ee/frontend/**'
                        - '.storybook/**'
                        - 'package.json'
                        - '.github/workflows/ci-storybook.yml'
                        - 'playwright.config.ts'

    build-storybook:
        name: Build Storybook
        runs-on: depot-ubuntu-24.04-8
        timeout-minutes: 15
        needs: changes
        if: needs.changes.outputs.frontend == 'true'
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  repository: ${{ github.event.pull_request.head.repo.full_name }}
                  # Use PostHog Bot token when not on forks to enable proper snapshot updating
                  token: ${{ secrets.POSTHOG_BOT_PAT || github.token }}

            - name: Install pnpm
              uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  cache: pnpm

            - name: Install dependencies
              run: pnpm --filter=@posthog/storybook... install --frozen-lockfile

            - name: Cache webpack build
              uses: actions/cache@v4
              with:
                  path: common/storybook/node_modules/.cache/
                  key: ${{ runner.os }}-webpack-storybook-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: ${{ runner.os }}-webpack-storybook-

            - name: Build Storybook
              env:
                  NODE_OPTIONS: --max-old-space-size=32768
              run: |
                  bin/turbo --filter=@posthog/storybook prepare
                  pnpm --filter=@posthog/storybook build --test

            - name: Upload Storybook build artifact
              uses: actions/upload-artifact@v4
              with:
                  name: storybook-build
                  path: common/storybook/dist
                  retention-days: 1

    detect-snapshot-mode:
        name: Detect snapshot mode
        runs-on: ubuntu-latest
        needs: [changes]
        if: needs.changes.outputs.frontend == 'true'
        outputs:
            mode: ${{ steps.detect.outputs.mode }}
        steps:
            - name: Detect mode
              id: detect
              run: |
                  if [ "${{ github.event.pull_request.head.repo.full_name }}" != "${{ github.repository }}" ]; then
                    echo "mode=check" >> $GITHUB_OUTPUT
                    echo "Fork detected - running in CHECK mode (no commits allowed)"
                  else
                    AUTHOR="${{ github.actor }}"
                    echo "Workflow triggered by: $AUTHOR"
                    if [[ "$AUTHOR" == *"github-actions"* ]] || [[ "$AUTHOR" == *"[bot]"* ]] || [[ "$AUTHOR" == "posthog-bot" ]]; then
                      echo "mode=check" >> $GITHUB_OUTPUT
                      echo "âš ï¸  Running in CHECK mode - snapshots must match exactly"
                    else
                      echo "mode=update" >> $GITHUB_OUTPUT
                      echo "âœ“ Running in UPDATE mode - snapshots can be updated"
                    fi
                  fi

    storybook-chromatic:
        name: Publish to Chromatic
        runs-on: ubuntu-latest
        timeout-minutes: 15
        needs: changes
        # Don't run on forks
        if: github.event.pull_request.head.repo.full_name == github.repository && needs.changes.outputs.frontend == 'true'
        outputs:
            storybook-url: ${{ steps.publish.outputs.storybookUrl }}
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  repository: ${{ github.event.pull_request.head.repo.full_name }}
                  # Use PostHog Bot token when not on forks to enable proper snapshot updating
                  token: ${{ secrets.POSTHOG_BOT_PAT || github.token }}
                  fetch-depth: 0 # ðŸ‘ˆ Required to retrieve git history (https://www.chromatic.com/docs/github-actions)

            - name: Install pnpm
              uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  cache: pnpm

            - name: Install dependencies and Chromatic
              run: |
                  pnpm --filter=@posthog/storybook... install --frozen-lockfile
                  bin/turbo --filter=@posthog/storybook prepare
                  pnpm install -w -D chromatic

            - name: Publish to Chromatic
              uses: chromaui/action@d7afd50124cf4f337bcd943e7f45cfa85a5e4476 # v12
              id: publish
              env:
                  # ðŸ‘‡ Chromatic project token, refer to the manage page to obtain it
                  CHROMATIC_PROJECT_TOKEN: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  buildScriptName: build
                  workingDir: ./common/storybook/

    visual-regression:
        name: Visual regression tests - ${{ matrix.browser }} (${{ matrix.shard }}/${{ matrix.shard_count }})
        runs-on: ubuntu-latest
        needs: [changes, build-storybook, detect-snapshot-mode]
        if: needs.changes.outputs.frontend == 'true'
        timeout-minutes: 20
        container:
            image: mcr.microsoft.com/playwright:v1.45.0
        strategy:
            fail-fast: false
            matrix:
                include:
                    - browser: chromium
                      shard_count: 16
                      shard: 1
                    - browser: chromium
                      shard_count: 16
                      shard: 2
                    - browser: chromium
                      shard_count: 16
                      shard: 3
                    - browser: chromium
                      shard_count: 16
                      shard: 4
                    - browser: chromium
                      shard_count: 16
                      shard: 5
                    - browser: chromium
                      shard_count: 16
                      shard: 6
                    - browser: chromium
                      shard_count: 16
                      shard: 7
                    - browser: chromium
                      shard_count: 16
                      shard: 8
                    - browser: chromium
                      shard_count: 16
                      shard: 9
                    - browser: chromium
                      shard_count: 16
                      shard: 10
                    - browser: chromium
                      shard_count: 16
                      shard: 11
                    - browser: chromium
                      shard_count: 16
                      shard: 12
                    - browser: chromium
                      shard_count: 16
                      shard: 13
                    - browser: chromium
                      shard_count: 16
                      shard: 14
                    - browser: chromium
                      shard_count: 16
                      shard: 15
                    - browser: chromium
                      shard_count: 16
                      shard: 16
                    # WebKit is much faster, so we run with only 3 shards
                    - browser: webkit
                      shard_count: 3
                      shard: 1
                    - browser: webkit
                      shard_count: 3
                      shard: 2
                    - browser: webkit
                      shard_count: 3
                      shard: 3
        env:
            NODE_OPTIONS: --max-old-space-size=16384
            OPT_OUT_CAPTURE: 1
        outputs:
            # The below have to be manually listed unfortunately, as GitHub Actions doesn't allow matrix-dependent outputs
            chromium-1-added: ${{ steps.diff.outputs.chromium-1-added }}
            chromium-1-modified: ${{ steps.diff.outputs.chromium-1-modified }}
            chromium-1-deleted: ${{ steps.diff.outputs.chromium-1-deleted }}
            chromium-1-total: ${{ steps.diff.outputs.chromium-1-total }}
            chromium-1-commitHash: ${{ steps.commit-hash.outputs.chromium-1-commitHash }}
            chromium-1-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-1-pathsFlapping }}
            chromium-2-added: ${{ steps.diff.outputs.chromium-2-added }}
            chromium-2-modified: ${{ steps.diff.outputs.chromium-2-modified }}
            chromium-2-deleted: ${{ steps.diff.outputs.chromium-2-deleted }}
            chromium-2-total: ${{ steps.diff.outputs.chromium-2-total }}
            chromium-2-commitHash: ${{ steps.commit-hash.outputs.chromium-2-commitHash }}
            chromium-2-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-2-pathsFlapping }}
            chromium-3-added: ${{ steps.diff.outputs.chromium-3-added }}
            chromium-3-modified: ${{ steps.diff.outputs.chromium-3-modified }}
            chromium-3-deleted: ${{ steps.diff.outputs.chromium-3-deleted }}
            chromium-3-total: ${{ steps.diff.outputs.chromium-3-total }}
            chromium-3-commitHash: ${{ steps.commit-hash.outputs.chromium-3-commitHash }}
            chromium-3-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-3-pathsFlapping }}
            chromium-4-added: ${{ steps.diff.outputs.chromium-4-added }}
            chromium-4-modified: ${{ steps.diff.outputs.chromium-4-modified }}
            chromium-4-deleted: ${{ steps.diff.outputs.chromium-4-deleted }}
            chromium-4-total: ${{ steps.diff.outputs.chromium-4-total }}
            chromium-4-commitHash: ${{ steps.commit-hash.outputs.chromium-4-commitHash }}
            chromium-4-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-4-pathsFlapping }}
            chromium-5-added: ${{ steps.diff.outputs.chromium-5-added }}
            chromium-5-modified: ${{ steps.diff.outputs.chromium-5-modified }}
            chromium-5-deleted: ${{ steps.diff.outputs.chromium-5-deleted }}
            chromium-5-total: ${{ steps.diff.outputs.chromium-5-total }}
            chromium-5-commitHash: ${{ steps.commit-hash.outputs.chromium-5-commitHash }}
            chromium-5-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-5-pathsFlapping }}
            chromium-6-added: ${{ steps.diff.outputs.chromium-6-added }}
            chromium-6-modified: ${{ steps.diff.outputs.chromium-6-modified }}
            chromium-6-deleted: ${{ steps.diff.outputs.chromium-6-deleted }}
            chromium-6-total: ${{ steps.diff.outputs.chromium-6-total }}
            chromium-6-commitHash: ${{ steps.commit-hash.outputs.chromium-6-commitHash }}
            chromium-6-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-6-pathsFlapping }}
            chromium-7-added: ${{ steps.diff.outputs.chromium-7-added }}
            chromium-7-modified: ${{ steps.diff.outputs.chromium-7-modified }}
            chromium-7-deleted: ${{ steps.diff.outputs.chromium-7-deleted }}
            chromium-7-total: ${{ steps.diff.outputs.chromium-7-total }}
            chromium-7-commitHash: ${{ steps.commit-hash.outputs.chromium-7-commitHash }}
            chromium-7-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-7-pathsFlapping }}
            chromium-8-added: ${{ steps.diff.outputs.chromium-8-added }}
            chromium-8-modified: ${{ steps.diff.outputs.chromium-8-modified }}
            chromium-8-deleted: ${{ steps.diff.outputs.chromium-8-deleted }}
            chromium-8-total: ${{ steps.diff.outputs.chromium-8-total }}
            chromium-8-commitHash: ${{ steps.commit-hash.outputs.chromium-8-commitHash }}
            chromium-8-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-8-pathsFlapping }}
            chromium-9-added: ${{ steps.diff.outputs.chromium-9-added }}
            chromium-9-modified: ${{ steps.diff.outputs.chromium-9-modified }}
            chromium-9-deleted: ${{ steps.diff.outputs.chromium-9-deleted }}
            chromium-9-total: ${{ steps.diff.outputs.chromium-9-total }}
            chromium-9-commitHash: ${{ steps.commit-hash.outputs.chromium-9-commitHash }}
            chromium-9-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-9-pathsFlapping }}
            chromium-10-added: ${{ steps.diff.outputs.chromium-10-added }}
            chromium-10-modified: ${{ steps.diff.outputs.chromium-10-modified }}
            chromium-10-deleted: ${{ steps.diff.outputs.chromium-10-deleted }}
            chromium-10-total: ${{ steps.diff.outputs.chromium-10-total }}
            chromium-10-commitHash: ${{ steps.commit-hash.outputs.chromium-10-commitHash }}
            chromium-10-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-10-pathsFlapping }}
            chromium-11-added: ${{ steps.diff.outputs.chromium-11-added }}
            chromium-11-modified: ${{ steps.diff.outputs.chromium-11-modified }}
            chromium-11-deleted: ${{ steps.diff.outputs.chromium-11-deleted }}
            chromium-11-total: ${{ steps.diff.outputs.chromium-11-total }}
            chromium-11-commitHash: ${{ steps.commit-hash.outputs.chromium-11-commitHash }}
            chromium-11-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-11-pathsFlapping }}
            chromium-12-added: ${{ steps.diff.outputs.chromium-12-added }}
            chromium-12-modified: ${{ steps.diff.outputs.chromium-12-modified }}
            chromium-12-deleted: ${{ steps.diff.outputs.chromium-12-deleted }}
            chromium-12-total: ${{ steps.diff.outputs.chromium-12-total }}
            chromium-12-commitHash: ${{ steps.commit-hash.outputs.chromium-12-commitHash }}
            chromium-12-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-12-pathsFlapping }}
            chromium-13-added: ${{ steps.diff.outputs.chromium-13-added }}
            chromium-13-modified: ${{ steps.diff.outputs.chromium-13-modified }}
            chromium-13-deleted: ${{ steps.diff.outputs.chromium-13-deleted }}
            chromium-13-total: ${{ steps.diff.outputs.chromium-13-total }}
            chromium-13-commitHash: ${{ steps.commit-hash.outputs.chromium-13-commitHash }}
            chromium-13-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-13-pathsFlapping }}
            chromium-14-added: ${{ steps.diff.outputs.chromium-14-added }}
            chromium-14-modified: ${{ steps.diff.outputs.chromium-14-modified }}
            chromium-14-deleted: ${{ steps.diff.outputs.chromium-14-deleted }}
            chromium-14-total: ${{ steps.diff.outputs.chromium-14-total }}
            chromium-14-commitHash: ${{ steps.commit-hash.outputs.chromium-14-commitHash }}
            chromium-14-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-14-pathsFlapping }}
            chromium-15-added: ${{ steps.diff.outputs.chromium-15-added }}
            chromium-15-modified: ${{ steps.diff.outputs.chromium-15-modified }}
            chromium-15-deleted: ${{ steps.diff.outputs.chromium-15-deleted }}
            chromium-15-total: ${{ steps.diff.outputs.chromium-15-total }}
            chromium-15-commitHash: ${{ steps.commit-hash.outputs.chromium-15-commitHash }}
            chromium-15-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-15-pathsFlapping }}
            chromium-16-added: ${{ steps.diff.outputs.chromium-16-added }}
            chromium-16-modified: ${{ steps.diff.outputs.chromium-16-modified }}
            chromium-16-deleted: ${{ steps.diff.outputs.chromium-16-deleted }}
            chromium-16-total: ${{ steps.diff.outputs.chromium-16-total }}
            chromium-16-commitHash: ${{ steps.commit-hash.outputs.chromium-16-commitHash }}
            chromium-16-pathsFlapping: ${{ steps.flappy-bird.outputs.chromium-16-pathsFlapping }}
            webkit-1-added: ${{ steps.diff.outputs.webkit-1-added }}
            webkit-1-modified: ${{ steps.diff.outputs.webkit-1-modified }}
            webkit-1-deleted: ${{ steps.diff.outputs.webkit-1-deleted }}
            webkit-1-total: ${{ steps.diff.outputs.webkit-1-total }}
            webkit-1-commitHash: ${{ steps.commit-hash.outputs.webkit-1-commitHash }}
            webkit-1-pathsFlapping: ${{ steps.flappy-bird.outputs.webkit-1-pathsFlapping }}
            webkit-2-added: ${{ steps.diff.outputs.webkit-2-added }}
            webkit-2-modified: ${{ steps.diff.outputs.webkit-2-modified }}
            webkit-2-deleted: ${{ steps.diff.outputs.webkit-2-deleted }}
            webkit-2-total: ${{ steps.diff.outputs.webkit-2-total }}
            webkit-2-commitHash: ${{ steps.commit-hash.outputs.webkit-2-commitHash }}
            webkit-2-pathsFlapping: ${{ steps.flappy-bird.outputs.webkit-2-pathsFlapping }}
            webkit-3-added: ${{ steps.diff.outputs.webkit-3-added }}
            webkit-3-modified: ${{ steps.diff.outputs.webkit-3-modified }}
            webkit-3-deleted: ${{ steps.diff.outputs.webkit-3-deleted }}
            webkit-3-total: ${{ steps.diff.outputs.webkit-3-total }}
            webkit-3-commitHash: ${{ steps.commit-hash.outputs.webkit-3-commitHash }}
            webkit-3-pathsFlapping: ${{ steps.flappy-bird.outputs.webkit-3-pathsFlapping }}
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  repository: ${{ github.event.pull_request.head.repo.full_name }}
                  # Use PostHog Bot token when not on forks to enable proper snapshot updating
                  token: ${{ secrets.POSTHOG_BOT_PAT || github.token }}

            - name: Install pnpm
              uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  cache: pnpm

            - name: Get pnpm cache directory path
              id: pnpm-cache-dir
              run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

            - uses: actions/cache@v4
              id: pnpm-cache
              with:
                  path: ${{ steps.pnpm-cache-dir.outputs.PNPM_STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-regression-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: ${{ runner.os }}-pnpm-regression-

            - name: Install package.json dependencies with pnpm
              run: pnpm --filter=@posthog/storybook... install --frozen-lockfile

            - name: Install CI utilities with pnpm
              run: pnpm install http-server wait-on -g

            - name: Download Storybook build artifact
              uses: actions/download-artifact@v4
              with:
                  name: storybook-build
                  path: common/storybook/dist

            - name: Serve Storybook in the background
              run: |
                  retries=5
                  max_timeout=30
                  pnpm exec http-server common/storybook/dist --port 6006 --silent &
                  server_pid=$!
                  echo "Started http-server with PID: $server_pid"

                  # Give the server a moment to start
                  sleep 2

                  while [ $retries -gt 0 ]; do
                      echo "Checking if Storybook is available (retries left: $retries, timeout: ${max_timeout}s)..."
                      if pnpm wait-on http://127.0.0.1:6006 --timeout $max_timeout; then
                          echo "âœ… Storybook is available at http://127.0.0.1:6006"
                          break
                      fi
                      retries=$((retries-1))
                      if [ $retries -gt 0 ]; then
                          echo "âš ï¸ Failed to connect to Storybook, retrying... ($retries retries left)"
                          # Check if server is still running
                          if ! kill -0 $server_pid 2>/dev/null; then
                              echo "âŒ http-server process is no longer running, restarting it..."
                              pnpm exec http-server common/storybook/dist --port 6006 --silent &
                              server_pid=$!
                              echo "Restarted http-server with PID: $server_pid"
                              sleep 2
                          fi
                      fi
                  done

                  if [ $retries -eq 0 ]; then
                      echo "âŒ Failed to serve Storybook after all retries"
                      # Try to get some diagnostic information
                      echo "Checking port 6006 status:"
                      netstat -tuln | grep 6006 || echo "Port 6006 is not in use"
                      echo "Checking http-server process:"
                      ps aux | grep http-server || echo "No http-server process found"
                      echo "Checking Storybook dist directory:"
                      ls -la common/storybook/dist || echo "Storybook dist directory not found"
                      exit 1
                  fi

            - name: Run @storybook/test-runner (up to 3 attempts)
              id: test-runner
              env:
                  HOME: /root
                  STORYBOOK_SKIP_TAGS: 'test-skip,test-skip-${{ matrix.browser }}'
              run: |
                  for i in 1 2 3; do
                    echo "Attempt $i: Running @storybook/test-runner"
                    # In UPDATE mode: run with -u flag to update snapshots on disk
                    # In CHECK mode: run with --ci flag to fail when snapshots differ
                    pnpm --filter=@posthog/storybook test:visual:ci:${{ needs.detect-snapshot-mode.outputs.mode == 'update' && 'update' || 'verify' }} --browsers ${{ matrix.browser }} --shard ${{ matrix.shard }}/${{ matrix.shard_count }} && break
                    if [ $i -eq 3 ]; then
                      echo "Test runner failed after 3 attempts"
                      exit 1
                    fi
                  done

            - name: Archive failure screenshots
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: failure-screenshots-${{ matrix.browser }}-${{ matrix.shard }}
                  path: frontend/__snapshots__/__failures__/

            - name: Configure global git diff log
              run: git config --global --add safe.directory '*'

            # Create git patch for aggregation (handles A/M/D including binary files)
            # Only run in UPDATE mode - CHECK mode doesn't update snapshots
            - name: Create snapshot patch
              id: create-patch
              if: needs.detect-snapshot-mode.outputs.mode == 'update' && (success() || failure()) && github.event.pull_request.head.repo.full_name == github.repository
              run: |
                  # Check if there are any changes in the snapshot directory
                  if git diff --quiet frontend/__snapshots__/; then
                    echo "No snapshot changes"
                    echo "has-changes=false" >> $GITHUB_OUTPUT
                  else
                    # Create binary-safe patch file
                    mkdir -p /tmp/patches
                    git diff --binary --full-index frontend/__snapshots__/ > /tmp/patches/shard-${{ matrix.browser }}-${{ matrix.shard }}.patch
                    echo "Created patch file"
                    echo "has-changes=true" >> $GITHUB_OUTPUT
                  fi

            - name: Upload snapshot patch
              if: steps.create-patch.outputs.has-changes == 'true'
              uses: actions/upload-artifact@v4
              with:
                  name: snapshot-patch-${{ matrix.browser }}-${{ matrix.shard }}
                  path: /tmp/patches/shard-${{ matrix.browser }}-${{ matrix.shard }}.patch
                  retention-days: 1
                  if-no-files-found: ignore

    # Job to collate the status of the matrix jobs for requiring passing status
    visual_regression_tests:
        needs: [visual-regression]
        name: Visual regression tests pass
        runs-on: ubuntu-latest
        if: always()
        steps:
            - name: Check matrix outcome
              run: |
                  # The `needs.visual-regression.result` will be 'success' only if all jobs in the matrix succeeded.
                  # Otherwise, it will be 'failure'.
                  if [[ "${{ needs.visual-regression.result }}" != "success" && "${{ needs.visual-regression.result }}" != "skipped" ]]; then
                    echo "One or more jobs in the visual-regression test matrix failed."
                    exit 1
                  fi
                  echo "All jobs in the visual-regression test matrix passed."

    post-check-comment:
        name: Post check mode comment
        runs-on: ubuntu-latest
        needs: [visual-regression, detect-snapshot-mode]
        if: always() && needs.detect-snapshot-mode.outputs.mode == 'check' && needs.visual-regression.result == 'failure'
        steps:
            - uses: actions/checkout@v4

            - name: Post check-failed comment
              env:
                  GH_TOKEN: ${{ secrets.POSTHOG_BOT_PAT || github.token }}
              run: |
                  .github/scripts/post-snapshot-comment.js \
                    "storybook" \
                    "check-failed" \
                    "" \
                    "${{ github.event.pull_request.number }}" \
                    "${{ github.repository }}" \
                    "${{ github.event.pull_request.head.sha }}"

    handle-snapshots:
        name: Handle snapshot changes
        runs-on: ubuntu-latest
        needs: [visual-regression, detect-snapshot-mode, changes]
        if: always() && needs.detect-snapshot-mode.outputs.mode == 'update' && needs.changes.outputs.frontend == 'true' && github.event.pull_request.head.repo.full_name == github.repository
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  repository: ${{ github.event.pull_request.head.repo.full_name }}
                  token: ${{ secrets.POSTHOG_BOT_PAT || github.token }}
                  fetch-depth: 1

            - name: Download snapshot patches
              id: download-patches
              continue-on-error: true
              uses: actions/download-artifact@v4
              with:
                  pattern: snapshot-patch-*
                  path: /tmp/snapshot-patches/
                  merge-multiple: true

            - name: Check for snapshot changes
              id: check-snapshots
              run: |
                  # Check if patches were downloaded and have content
                  if [ "${{ steps.download-patches.outcome }}" == "failure" ] || [ ! -d /tmp/snapshot-patches/ ]; then
                    echo "has-changes=false" >> $GITHUB_OUTPUT
                    echo "No snapshot patches found"
                    exit 0
                  fi

                  # Check if any patch files have content (>0 bytes)
                  PATCHES=$(find /tmp/snapshot-patches -name "*.patch" -type f -size +0c)
                  if [ -z "$PATCHES" ]; then
                    echo "has-changes=false" >> $GITHUB_OUTPUT
                    echo "Patch files empty - no snapshot changes"
                  else
                    echo "has-changes=true" >> $GITHUB_OUTPUT
                    echo "Snapshot changes detected in patches"
                  fi

            # UPDATE mode: commit the changes
            - name: Commit snapshot changes
              if: steps.check-snapshots.outputs.has-changes == 'true' && needs.detect-snapshot-mode.outputs.mode == 'update'
              uses: ./.github/actions/commit-snapshots
              with:
                  workflow-type: storybook
                  patch-path: /tmp/snapshot-patches/
                  snapshot-path: frontend/__snapshots__/
                  commit-message: Update UI snapshots (all browsers)
                  pr-number: ${{ github.event.pull_request.number }}
                  repository: ${{ github.repository }}
                  commit-sha: ${{ github.event.pull_request.head.sha }}
                  github-token: ${{ secrets.POSTHOG_BOT_PAT || github.token }}

    calculate-running-time:
        name: Calculate running time
        needs: [storybook-chromatic, visual-regression, changes]
        runs-on: ubuntu-latest
        if: # Run on pull requests to PostHog/posthog + on PostHog/posthog outside of PRs - but never on forks
            needs.changes.outputs.frontend == 'true' && (
            (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == 'PostHog/posthog') ||
            (github.event_name != 'pull_request' && github.repository == 'PostHog/posthog'))
        steps:
            - name: Calculate running time
              run: |
                  gh auth login --with-token < <(echo ${{ secrets.GITHUB_TOKEN }})
                  run_id=${GITHUB_RUN_ID}
                  repo=${GITHUB_REPOSITORY}
                  run_info=$(gh api repos/${repo}/actions/runs/${run_id})
                  echo run_info: ${run_info}
                  # name is the name of the workflow file
                  # run_started_at is the start time of the workflow
                  # we want to get the number of seconds between the start time and now
                  name=$(echo ${run_info} | jq -r '.name')
                  run_url=$(echo ${run_info} | jq -r '.url')
                  run_started_at=$(echo ${run_info} | jq -r '.run_started_at')
                  run_attempt=$(echo ${run_info} | jq -r '.run_attempt')
                  start_seconds=$(date -d "${run_started_at}" +%s)
                  now_seconds=$(date +%s)
                  duration=$((now_seconds-start_seconds))
                  echo running_time_duration_seconds=${duration} >> $GITHUB_ENV
                  echo running_time_run_url=${run_url} >> $GITHUB_ENV
                  echo running_time_run_attempt=${run_attempt} >> $GITHUB_ENV
                  echo running_time_run_id=${run_id} >> $GITHUB_ENV
                  echo running_time_run_started_at=${run_started_at} >> $GITHUB_ENV
            - name: Capture running time to PostHog
              uses: PostHog/posthog-github-action@v0.1
              with:
                  posthog-token: ${{secrets.POSTHOG_API_TOKEN}}
                  event: 'posthog-ci-running-time'
                  properties: '{"duration_seconds": ${{ env.running_time_duration_seconds }}, "run_url": "${{ env.running_time_run_url }}", "run_attempt": "${{ env.running_time_run_attempt }}", "run_id": "${{ env.running_time_run_id }}", "run_started_at": "${{ env.running_time_run_started_at }}"}'
