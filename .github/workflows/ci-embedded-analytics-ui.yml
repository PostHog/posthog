name: Embedded-Analytics-UI CI
on:
    pull_request:
    push:
        branches:
            - master

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    # Job to decide if we should run Embedded-Analytics-UI ci
    # See https://github.com/dorny/paths-filter#conditional-execution for more details
    # we skip each step individually, so   they are still reported as success
    # because many of them are required for CI checks to be green
    changes:
        runs-on: depot-ubuntu-24.04-small
        timeout-minutes: 5
        name: Determine need to run Embedded-Analytics-UI checks
        outputs:
            Embedded-Analytics-UI: ${{ steps.filter.outputs.Embedded-Analytics-UI }}
        steps:
            # For pull requests it's not necessary to check out the code, but we
            # also want this to run on master, so we need to check out
            - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

            - uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50 # v2
              id: filter
              with:
                  filters: |
                      Embedded-Analytics-UI:
                        # Avoid running Embedded-Analytics-UI tests for irrelevant changes
                        # NOTE: we are at risk of missing a dependency here.
                        - product/embedded_analytics_ui/**
                        # Make sure we run if someone is explicitly change the workflow
                        - .github/workflows/ci-embedded-analytics-ui.yml
                        # various JS config files
                        - .oxlintrc.json
                        - .prettier*
                        - package.json
                        - pnpm-lock.yaml

    Embedded-Analytics-UI-format:
        name: Embedded-Analytics-UI formatting
        needs: changes
        runs-on: depot-ubuntu-24.04
        steps:
            - name: Skip Embedded-Analytics-UI checks
              if: ${{ needs.changes.outputs.Embedded-Analytics-UI == 'false' }}
              run: |
                  echo "Skipping Embedded-Analytics-UI checks - no Embedded-Analytics-UI changes detected"
                  exit 0

            - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3
              if: needs.changes.outputs.Embedded-Analytics-UI == 'true'

            - name: Install pnpm
              if: needs.changes.outputs.Embedded-Analytics-UI == 'true'
              uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4

            - name: Set up Node.js
              if: needs.changes.outputs.Embedded-Analytics-UI == 'true'
              uses: actions/setup-node@1d0ff469b7ec7b3cb9d8673fde0c81c44821de2a # v4
              with:
                  node-version: 22.17.1
                  cache: 'pnpm'

            - name: Get pnpm cache directory path
              if: needs.changes.outputs.Embedded-Analytics-UI == 'true'
              id: pnpm-cache-dir
              run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

            - uses: actions/cache@d4323d4df104b026a6aa633fdb11d772146be0bf # v4
              if: needs.changes.outputs.Embedded-Analytics-UI == 'true'
              id: pnpm-cache
              with:
                  path: ${{ steps.pnpm-cache-dir.outputs.PNPM_STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-cypress-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: ${{ runner.os }}-pnpm-cypress-

            - name: Check TypeScript types
              if: needs.changes.outputs.Embedded-Analytics-UI == 'true'
              run: pnpm --filter=@posthog/embedded-analytics-ui typescript:check

            - name: Check formatting with prettier
              if: needs.changes.outputs.Embedded-Analytics-UI == 'true'
              run: pnpm --filter=@posthog/embedded-analytics-ui prettier:check

            - name: Lint with Stylelint
              if: needs.changes.outputs.Embedded-Analytics-UI == 'true'
              run: pnpm --filter=@posthog/embedded-analytics-ui lint:css

            - name: Lint with Oxlint
              if: needs.changes.outputs.Embedded-Analytics-UI == 'true'
              run: pnpm --filter=@posthog/embedded-analytics-ui lint:js -f github

            - name: Build the package
              if: needs.changes.outputs.Embedded-Analytics-UI == 'true'
              run: pnpm --filter=@posthog/embedded-analytics-ui build
