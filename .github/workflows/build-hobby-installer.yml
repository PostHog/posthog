# Hobby Installer Build Workflow
#
# This workflow builds the hobby installer binaries and publishes them as GitHub releases.
#
# Download the latest version:
#   curl -L https://github.com/PostHog/posthog/releases/download/hobby-latest/hobby-installer -o hobby-installer && chmod +x hobby-installer
#
# Or browse all versions at: https://github.com/PostHog/posthog/releases?q=hobby-&expanded=true

name: Build Hobby Installer

on:
    push:
        branches:
            - master
        paths:
            - 'bin/hobby-installer/**'
            - '!bin/hobby-installer/README.md'
            - '.github/workflows/build-hobby-installer.yml'

permissions:
    contents: write

jobs:
    build:
        runs-on: ubuntu-24.04

        steps:
            - name: Checkout repository
              uses: actions/checkout@v6

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version: '1.24'

            - name: Build production binary
              run: cd bin/hobby-installer && make build-linux

            - name: Create versioned and latest releases
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  VERSION="hobby-$(date +%Y%m%d-%H%M%S)"

                  # Rename the binary to a more neutral name
                  # This is the same name as the folder so we'll remove it first
                  rm -rf bin/hobby-installer
                  mv bin/hobby-installer-linux bin/hobby-installer

                  # Versioned release for history
                  gh release create "$VERSION" \
                      bin/hobby-installer \
                      --title "Hobby Installer $VERSION" \
                      --notes "Build from commit ${{ github.sha }}" \
                      --latest=false

                  # Update floating latest release
                  gh release delete hobby-latest --yes || true
                  git push origin :refs/tags/hobby-latest || true
                  gh release create hobby-latest \
                      bin/hobby-installer \
                      --title "Hobby Installer (Latest)" \
                      --notes "Latest hobby installer build - same as $VERSION

                  This is currently experimental and may not work as expected. We believe it to be working correctly, but please make sure you backup your data before using it.


                  Download: \`curl -L https://github.com/PostHog/posthog/releases/download/hobby-latest/hobby-installer -o hobby-installer && chmod +x hobby-installer\`" \
                      --latest=false
