name: Turbo Backend CI (POC)

on:
    pull_request:
        paths:
            - 'products/**/backend/**'
            - 'common/**/*.py'
            - 'pyproject.toml'
            - 'uv.lock'

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

env:
    DATABASE_URL: 'postgres://posthog:posthog@localhost:5432/posthog'
    REDIS_URL: 'redis://localhost'
    CLICKHOUSE_HOST: 'localhost'
    TEST: 1

jobs:
    turbo-backend:
        runs-on: depot-ubuntu-latest
        timeout-minutes: 30
        outputs:
            contract_changed: ${{ steps.contract-check.outputs.changed }}

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - uses: pnpm/action-setup@v4

            - uses: actions/setup-node@v4
              with:
                  node-version: '24'
                  cache: 'pnpm'

            - name: Install dependencies
              run: pnpm install

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: 3.12.12

            - name: Install uv
              uses: astral-sh/setup-uv@v7
              with:
                  enable-cache: true

            - name: Install Python dependencies
              run: UV_PROJECT_ENVIRONMENT=$pythonLocation uv sync --frozen --dev

            - name: Start services
              run: |
                  docker compose -f docker-compose.dev.yml up -d
                  bin/check_postgres_up

            # Run contract-check to detect if API surface changed
            - name: Check contract changes
              id: contract-check
              run: |
                  # Run contract-check with dry-run to see cache status
                  OUTPUT=$(pnpm turbo run backend:contract-check --dry-run --output-logs=none 2>&1)

                  # Check if any contract-check task is NOT cached
                  if echo "$OUTPUT" | grep -q "Cached (Local)                 = false"; then
                    echo "Contract files changed - legacy tests needed"
                    echo "changed=true" >> $GITHUB_OUTPUT
                  else
                    echo "No contract changes - only isolated tests needed"
                    echo "changed=false" >> $GITHUB_OUTPUT
                  fi

            # Run isolated product tests via turbo (cached when possible)
            - name: Run product backend tests
              run: |
                  pnpm turbo run backend:test

    # Legacy Django tests - only run if contracts changed
    legacy-tests:
        needs: turbo-backend
        if: needs.turbo-backend.outputs.contract_changed == 'true'
        runs-on: depot-ubuntu-latest
        timeout-minutes: 45

        steps:
            - uses: actions/checkout@v4

            # ... full Django test matrix setup would go here ...
            - name: Run legacy tests
              run: |
                  echo "Running full Django test matrix because contracts changed"
                  # pytest posthog ee --ignore=products/*/backend
