name: Closed PR

on:
    pull_request:
        types:
            - closed

jobs:
    cleanup-hobby-preview:
        name: Cleanup hobby preview deployment
        runs-on: ubuntu-24.04
        if: contains(github.event.pull_request.labels.*.name, 'hobby-preview')
        permissions:
            deployments: write
        steps:
            - name: Cleanup GitHub deployment and environment
              uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
              with:
                  script: |
                      const prNumber = context.issue.number;
                      const environment = `preview-pr-${prNumber}`;

                      console.log(`Cleaning up deployments for ${environment}`);

                      // Get all deployments for this environment
                      const { data: deployments } = await github.rest.repos.listDeployments({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          environment: environment,
                          per_page: 100
                      });

                      console.log(`Found ${deployments.length} deployments`);

                      // Mark all deployments as inactive and delete them
                      for (const deployment of deployments) {
                          try {
                              // Must mark as inactive before deletion
                              await github.rest.repos.createDeploymentStatus({
                                  owner: context.repo.owner,
                                  repo: context.repo.repo,
                                  deployment_id: deployment.id,
                                  state: 'inactive',
                                  description: 'PR closed'
                              });

                              // Delete the deployment
                              await github.rest.repos.deleteDeployment({
                                  owner: context.repo.owner,
                                  repo: context.repo.repo,
                                  deployment_id: deployment.id
                              });

                              console.log(`Deleted deployment ${deployment.id}`);
                          } catch (error) {
                              console.log(`Could not delete deployment ${deployment.id}: ${error.message}`);
                          }
                      }

                      // Delete the environment itself
                      try {
                          await github.rest.repos.deleteAnEnvironment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              environment_name: environment
                          });
                          console.log(`Deleted environment ${environment}`);
                      } catch (error) {
                          console.log(`Could not delete environment ${environment}: ${error.message}`);
                      }

    report-pr-age:
        name: Report age of PR
        runs-on: ubuntu-24.04
        if: github.event.pull_request.head.repo.full_name == github.repository && github.event.pull_request.merged == true
        steps:
            - name: Calculate PR age
              env:
                  PR_CREATED_AT: ${{ github.event.pull_request.created_at }}
                  PR_HREF: ${{ github.event.pull_request._links.commits.href }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
              run: |
                  pr_age=$((($(date '+%s') - $(date -d "$PR_CREATED_AT" '+%s'))))
                  echo pr_age=$pr_age >> $GITHUB_ENV
                  first_commit_message_in_pr=$(curl -s "$PR_HREF" | jq '.[0].commit.message')
                  echo first_commit_message_in_pr=$first_commit_message_in_pr >> $GITHUB_ENV
                  if [[ $first_commit_message_in_pr =~ Revert[[:space:]] ]]; then
                      echo is_revert=true >> $GITHUB_ENV
                  else
                      echo is_revert=false >> $GITHUB_ENV
                  fi
                  # Escape the PR title for JSON
                  pr_title_escaped=$(echo "$PR_TITLE" | jq -R .)
                  echo "pr_title_escaped=${pr_title_escaped}" >> $GITHUB_ENV
            - name: Capture PR age to PostHog
              uses: PostHog/posthog-github-action@v0.1
              with:
                  posthog-token: ${{secrets.POSTHOG_API_TOKEN}}
                  event: 'posthog-ci-pr-stats'
                  properties: '{"prAgeInSeconds": ${{ env.pr_age }}, "isRevert": ${{env.is_revert}}, "prTitle": ${{ env.pr_title_escaped }}, "prNumber": "${{ github.event.pull_request.number}}"  }'
