name: Release hogql-parser

on:
    pull_request:
        paths:
            - common/hogql_parser/**
            - .github/workflows/build-hogql-parser.yml

permissions:
    contents: read
    pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    check-version:
        name: Check version legitimacy
        runs-on: ubuntu-22.04
        outputs:
            parser-release-needed: ${{ steps.version.outputs.parser-release-needed }}
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0 # Fetching all for comparison since last push (not just last commit)
                  filter: blob:none

            - name: Check if common/hogql_parser/ has changed
              id: changed-files
              uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46.0.5
              with:
                  since_last_remote_commit: true
                  files_yaml: |
                      parser:
                      - common/hogql_parser/**

            - name: Check if version was bumped
              shell: bash
              id: version
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  parser_release_needed='false'
                  if [[ ${{ steps.changed-files.outputs.parser_any_changed }} == 'true' ]]; then
                    published=$(curl -fSsl https://pypi.org/pypi/hogql-parser/json | jq -r '.info.version')
                    local=$(python common/hogql_parser/setup.py --version)
                    if [[ "$published" != "$local" ]]; then
                      parser_release_needed='true'
                    else
                      message_body="It looks like the code of \`hogql-parser\` has changed since last push, but its version stayed the same at $local. ðŸ‘€\nMake sure to resolve this in \`hogql_parser/setup.py\` before merging!${{ github.event.pull_request.head.repo.full_name != 'PostHog/posthog' && '\nThis needs to be performed on a branch created on the PostHog/posthog repo itself. A PostHog team member will assist with this.' || ''}}"
                      gh pr comment ${{ github.event.pull_request.number }} --body "$message_body"
                    fi
                  fi
                  echo "parser-release-needed=$parser_release_needed" >> $GITHUB_OUTPUT

    build-wheels:
        name: Build wheels on ${{ matrix.os }}
        needs: check-version
        runs-on: ${{ matrix.os }}
        timeout-minutes: 30
        if: needs.check-version.outputs.parser-release-needed == 'true' &&
            github.event.pull_request.head.repo.full_name == 'PostHog/posthog'
        strategy:
            matrix:
                # As of October 2023, GitHub doesn't have ARM Actions runnersâ€¦ and ARM emulation is insanely slow
                # (20x longer) on the Linux runners (while being reasonable on the macOS runners). Hence, we use
                # BuildJet as a provider of ARM runners - this solution saves a lot of time and consequently some money.
                os: [ubuntu-22.04, buildjet-2vcpu-ubuntu-2204-arm, macos-14, macos-15-intel]
                include:
                    - os: macos-14
                      cibw_archs_macos: arm64
                      MACOSX_DEPLOYMENT_TARGET: 14
                    - os: macos-15-intel
                      cibw_archs_macos: x86_64
                      MACOSX_DEPLOYMENT_TARGET: 15
                    - os: ubuntu-22.04
                      cibw_archs_linux: x86_64
                      MACOSX_DEPLOYMENT_TARGET: ''
                    - os: buildjet-2vcpu-ubuntu-2204-arm
                      cibw_archs_linux: aarch64
                      MACOSX_DEPLOYMENT_TARGET: ''

        steps:
            - uses: actions/checkout@v6

            - uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
              with:
                  python-version: '3.12.10' # There is no 3.12.11/3.12.12 binary for mac/darwin architectures yet

            - name: Build sdist
              if: matrix.os == 'ubuntu-22.04' # Only build the sdist once
              run: |
                  pip install setuptools==80.9.0
                  cd common/hogql_parser && python setup.py sdist

            - name: Install cibuildwheel
              run: pip install cibuildwheel==2.23.*

            - name: Build wheels
              run: cd common/hogql_parser && python -m cibuildwheel --output-dir dist
              env:
                  CIBW_ARCHS_MACOS: ${{ matrix.cibw_archs_macos }}
                  CIBW_ARCHS_LINUX: ${{ matrix.cibw_archs_linux }}
                  MACOSX_DEPLOYMENT_TARGET: ${{ matrix.MACOSX_DEPLOYMENT_TARGET }}

            - name: Upload wheels artifact
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: wheels-${{ matrix.os }}
                  path: |
                      common/hogql_parser/dist/*.whl
                      common/hogql_parser/dist/*.tar.gz
                  if-no-files-found: error

    publish:
        name: Publish on PyPI
        needs: build-wheels
        environment: pypi-hogql-parser
        permissions:
            id-token: write
        runs-on: ubuntu-22.04
        steps:
            - name: Download wheels from ubuntu-22.04
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
              with:
                  name: wheels-ubuntu-22.04
                  path: dist

            - name: Download wheels from buildjet-2vcpu-ubuntu-2204-arm
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
              with:
                  name: wheels-buildjet-2vcpu-ubuntu-2204-arm
                  path: dist

            - name: Download wheels from macos-14
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
              with:
                  name: wheels-macos-14
                  path: dist

            - name: Download wheels from macos-15-intel
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
              with:
                  name: wheels-macos-15-intel
                  path: dist

            - name: Publish package to PyPI
              uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0

            # Use GitHub app token so Actions run after commiting changes
            - name: Get app token
              id: app-token
              uses: getsentry/action-github-app-token@d4b5da6c5e37703f8c3b3e43abb5705b46e159cc # v3.0.0
              with:
                  app_id: ${{ secrets.GH_APP_POSTHOG_TESTS_APP_ID }}
                  private_key: ${{ secrets.GH_APP_POSTHOG_TESTS_PRIVATE_KEY }}

            - uses: actions/checkout@v6
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  token: ${{ steps.app-token.outputs.token }}

            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
              with:
                  python-version: 3.12.12

            - name: Install uv
              id: setup-uv
              uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
              with:
                  enable-cache: true
                  version: 0.9.9

            - name: Update hogql-parser in requirements
              shell: bash
              env:
                  RETRIES: 20
              run: |
                  # In case the version is not available yet, try up to $RETRIES times
                  for i in {1..$RETRIES}; do
                      if uv add hogql-parser==$(python common/hogql_parser/setup.py --version); then
                          break
                      fi
                      if [[ $i -eq $RETRIES ]]; then
                        echo "Failed to update hogql-parser in requirements"
                        exit 1
                      fi
                      sleep 0.5
                  done

            - uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5 # v9.1.4
              with:
                  add: '["pyproject.toml", "uv.lock"]'
                  message: 'Use new hogql-parser version'
                  default_author: github_actions
                  github_token: ${{ steps.app-token.outputs.token }}
