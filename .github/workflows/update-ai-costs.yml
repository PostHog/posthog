name: Update AI Costs

on:
    workflow_dispatch: # Allow manual triggering
    schedule:
        # Run at 10am UTC and 8pm UTC on weekdays (Monday-Friday)
        - cron: '0 10 * * 1-5' # 10am UTC
        - cron: '0 20 * * 1-5' # 8pm UTC

permissions:
    contents: read

jobs:
    update-ai-costs:
        runs-on: ubuntu-latest

        steps:
            - name: Get app token
              id: app-token
              uses: getsentry/action-github-app-token@d4b5da6c5e37703f8c3b3e43abb5705b46e159cc # v3.0.0
              with:
                  app_id: ${{ secrets.GH_APP_POSTHOG_SCHEDULED_ACTIONS_APP_ID }}
                  private_key: ${{ secrets.GH_APP_POSTHOG_SCHEDULED_ACTIONS_PRIVATE_KEY }}

            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  token: ${{ steps.app-token.outputs.token }}

            - name: Install pnpm
              uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

            - name: Set up Node.js
              uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
              with:
                  node-version: 22.22.0
                  cache: 'pnpm'

            - name: Install dependencies
              env:
                  HUSKY: 0
              run: |
                  cd nodejs
                  pnpm install --frozen-lockfile --ignore-scripts

            - name: Update AI costs
              run: |
                  cd nodejs
                  pnpm update-ai-costs

            - name: Format generated files
              run: |
                  cd nodejs
                  pnpm prettier --write src/ingestion/ai/costs/providers/canonical-providers.ts src/ingestion/ai/costs/providers/llm-costs.json

            - name: Check for changes
              id: check-changes
              run: |
                  if git diff --quiet nodejs/src/ingestion/ai/costs/providers/canonical-providers.ts nodejs/src/ingestion/ai/costs/providers/llm-costs.json; then
                    echo "changes=false" >> $GITHUB_OUTPUT
                    echo "No changes detected in AI costs"
                  else
                    echo "changes=true" >> $GITHUB_OUTPUT
                    echo "Changes detected in AI costs"
                    git diff --stat nodejs/src/ingestion/ai/costs/providers/canonical-providers.ts nodejs/src/ingestion/ai/costs/providers/llm-costs.json
                  fi

            - name: Create Pull Request
              if: steps.check-changes.outputs.changes == 'true'
              uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
              with:
                  token: ${{ steps.app-token.outputs.token }}
                  commit-message: 'chore(llma): update LLM costs'
                  title: 'chore(llma): Update LLM costs'
                  body: |
                      This is an automated PR to update LLM pricing models.

                      ## Reviewer checklist

                      Please verify that there aren't any odd changes in the pricing by checking against the official pricing pages:

                      - [Anthropic Pricing](https://claude.com/pricing#api)
                      - [OpenAI Pricing](https://openai.com/api/pricing/)
                      - [Google AI (Gemini) Pricing](https://ai.google.dev/pricing)
                      - [Mistral AI Pricing](https://mistral.ai/pricing#api-pricing)
                  branch: chore/llma-update-ai-costs
                  base: master
                  delete-branch: true
                  labels: |
                      automated
                      llm-analytics
                  team-reviewers: |
                      team-llm-analytics
