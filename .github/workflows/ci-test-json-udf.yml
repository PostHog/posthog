name: Test JSON Drop Keys UDF

on:
    pull_request:
        paths:
            - '.github/workflows/ci-test-json-udf.yml'
            - 'go/json_drop_keys_udf/**'
    workflow_dispatch: {}

permissions:
    contents: write

jobs:
    test:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v6
            - uses: actions/setup-go@v6
              with:
                  go-version-file: ./go/json_drop_keys_udf/go.mod
                  cache: true
            - name: Run integration tests
              run: ./go/json_drop_keys_udf/scripts/integration_test.sh

    build:
        runs-on: ubuntu-latest
        needs: test
        strategy:
            matrix:
                goos: [linux, darwin, windows]
                goarch: [amd64, arm64]
        steps:
            - uses: actions/checkout@v6
            - uses: actions/setup-go@v6
              with:
                  go-version-file: go.mod
                  cache: true
            - name: Build json_drop_keys_udf
              env:
                  GOOS: ${{ matrix.goos }}
                  GOARCH: ${{ matrix.goarch }}
                  CGO_ENABLED: 0
              run: |
                  mkdir -p dist
                  bin_name="json_drop_keys_udf-${GOOS}-${GOARCH}"
                  if [ "${GOOS}" = "windows" ]; then
                    bin_name="${bin_name}.exe"
                  fi
                  (cd go/json_drop_keys_udf/cmd/json_drop_keys_udf && go build -o "../../dist/${bin_name}" .)
