name: Automerge

env:
    MERGE_METHOD: 'squash'
    MERGE_RETRY_SLEEP: 30 # 300000
    MERGE_ERROR_FAIL: true
    MERGE_RETRIES: 1
    LOG: 'TRACE'

on:
    pull_request:
        types:
            - labeled
            - unlabeled
            - synchronize
            - opened
            - edited
            - ready_for_review
            - reopened
            - unlocked
    check_suite:
        types:
            - completed
    status: {}

jobs:
    automerge:
        name: Automerge if requested
        runs-on: ubuntu-24.04
        env:
            IS_POSTHOG_BOT_AVAILABLE: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN != '' }}
        steps:
            # must have an id so subsequent steps can use the output
            - id: automergeStep
              name: Automerge
              if: env.IS_POSTHOG_BOT_AVAILABLE == 'true'
              uses: pascalgn/automerge-action@v0.16.3
              env:
                  GITHUB_TOKEN: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN }}

            - name: Print Workflow Context
              if: ${{ failure() }}
              run: |
                  echo "Available steps Context:"
                  echo "${GITHUB_CONTEXT}" | jq .
              env:
                  GITHUB_CONTEXT: ${{ toJSON(steps) }}

            - name: Dump GitHub Actions context
              if: ${{ failure() }}
              run: |
                  echo "Dumping context for debugging"
                  env

            - name: Print Automerge Outputs as JSON
              if: ${{ failure() }}
              run: |
                  echo "Automerge Outputs:"
                  if [[ "${{ steps.automergeStep.outputs.mergeResult }}" != "" ]]; then
                      echo '{"mergeResult": "${{ steps.automergeStep.outputs.mergeResult }}", "pullRequestNumber": "${{ steps.automergeStep.outputs.pullRequestNumber }}"}' | jq .
                  else
                      echo "No outputs from Automerge action."
                  fi

            - name: Send Automerge Event to PostHog
              if: ${{ failure() }}
              uses: PostHog/posthog-github-action@v0.1
              with:
                  posthog-token: '${{ secrets.POSTHOG_API_TOKEN }}'
                  event: 'posthog-github-automerge-pr-status'
                  properties: >-
                      {
                        "prUrl": "${{ github.event.pull_request.html_url }}",
                        "jobStatus": "${{ job.status }}",
                        "prTitle": "${{ github.event.pull_request.title }}",
                        "prNumber": "${{ github.event.pull_request.number }}",
                        "prState": "${{ github.event.pull_request.mergeable_state }}",
                        "mergeResult": "${{ steps.automergeStep.outputs.mergeResult }}",
                        "pullRequestNumber": "${{ steps.automergeStep.outputs.pullRequestNumber }}"
                        "automergeOutcome": "${{ steps.automergeStep.outcome }}"
                      }
