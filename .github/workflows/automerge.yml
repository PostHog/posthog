name: Automerge

env:
    MERGE_METHOD: 'squash'
    MERGE_RETRY_SLEEP: 300000
    MERGE_ERROR_FAIL: true

on:
    pull_request:
        types:
            - labeled
            - unlabeled
            - synchronize
            - opened
            - edited
            - ready_for_review
            - reopened
            - unlocked
    check_suite:
        types:
            - completed
    status: {}

jobs:
    automerge:
        name: Automerge if requested
        runs-on: ubuntu-24.04
        env:
            IS_POSTHOG_BOT_AVAILABLE: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN != '' }}
        steps:
            - name: Automerge
              if: env.IS_POSTHOG_BOT_AVAILABLE == 'true'
              uses: pascalgn/automerge-action@v0.16.3
              env:
                  GITHUB_TOKEN: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN }}

            - name: Send Slack notification
              uses: rtCamp/action-slack-notify@v2
              env:
                  SLACK_CHANNEL: subscriptions-slack-testing
                  SLACK_COLOR: ${{ job.status }} # or a specific color like 'good' or '#ff00ff'
                  SLACK_ICON: https://github.com/posthog.png?size=48
                  SLACK_USERNAME: Max Hedgehog
                  SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
                  PR_TITLE: ${{ github.event.pull_request.title }}
              with:
                  message: "PR $PR_TITLE #${{ github.event.check_suite.pull_requests[0].number }} $${{ job.status }}. PR is labeled 'automerge'. Automerge result was ${{ steps.automerge.outputs.mergeResult }}"
                  status: ${{ job.status }}
