name: Automerge

env:
    MERGE_METHOD: 'squash'
    MERGE_RETRY_SLEEP: 300000
    MERGE_ERROR_FAIL: true

on:
    pull_request:
        types:
            - labeled
            - unlabeled
            - synchronize
            - opened
            - edited
            - ready_for_review
            - reopened
            - unlocked
    check_suite:
        types:
            - completed
    status: {}

jobs:
    automerge:
        name: Automerge if requested
        runs-on: ubuntu-24.04
        env:
            IS_POSTHOG_BOT_AVAILABLE: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN != '' }}
        steps:
            - name: Automerge
              # must have an id so subsequent steps can use the output
              id: automerge
              if: env.IS_POSTHOG_BOT_AVAILABLE == 'true'
              uses: pascalgn/automerge-action@v0.16.3
              env:
                  GITHUB_TOKEN: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN }}

            - name: Print Automerge Outputs as JSON
                run: |
                echo "Automerge Outputs:"
                echo ${{ steps.automerge.outputs }} | jq .
                env:
                AUTOMERGE_OUTPUT: ${{ toJSON(steps.automerge.outputs) }}

            - name: Send automerge event to PostHog
              if: ${{ steps.automerge.outputs.mergeResult != '' }}
              uses: PostHog/posthog-github-action@v0.1
              with:
                  posthog-token: ${{secrets.POSTHOG_API_TOKEN}}
                  event: 'posthog-github-automerge-pr-status'
                  properties: '{"prUrl": "${{ github.event.pull_request.html_url }}", "jobStatus": "${{ job.status }}", "prTitle": "${{ github.event.pull_request.title}}", "prNumber": "${{ github.event.pull_request.number}}", "mergeResult": "${{ steps.automerge.outputs.mergeResult }}" }'
