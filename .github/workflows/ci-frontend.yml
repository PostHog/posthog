name: Frontend CI
permissions:
    contents: read
on:
    pull_request:
    push:
        branches:
            - master

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    # Job to decide if we should run frontend ci
    # See https://github.com/dorny/paths-filter#conditional-execution for more details
    # we skip each step individually, so   they are still reported as success
    # because many of them are required for CI checks to be green
    changes:
        runs-on: ubuntu-latest
        timeout-minutes: 5
        name: Determine need to run frontend checks
        outputs:
            frontend: ${{ steps.filter.outputs.frontend }}
        steps:
            # For pull requests it's not necessary to check out the code, but we
            # also want this to run on master, so we need to check out
            - uses: actions/checkout@v4

            - uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50 # v2
              id: filter
              with:
                  filters: |
                      frontend:
                        # Avoid running frontend tests for irrelevant changes
                        # NOTE: we are at risk of missing a dependency here.
                        - 'bin/**'
                        - 'frontend/**'
                        - 'ee/frontend/**'
                        - 'common/esbuilder/**'
                        - 'products/**/*.ts'
                        - 'products/**/*.tsx'
                        - 'playwright/**'
                        # Make sure we run if someone is explicitly change the workflow
                        - .github/workflows/ci-frontend.yml
                        # various JS config files
                        - .oxlintrc.json
                        - .prettier*
                        - babel.config.js
                        - package.json
                        - pnpm-lock.yaml
                        - jest.*.ts
                        - tsconfig.json
                        - tsconfig.*.json
                        - webpack.config.js
                        - stylelint*
                        - '**/*.md'
                        - '**/*.mdx'
                        - .config/.markdownlint-cli2.jsonc

    frontend-format:
        name: Frontend formatting
        needs: changes
        if: needs.changes.outputs.frontend == 'true'
        runs-on: depot-ubuntu-24.04
        steps:
            - uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  cache: 'pnpm'

            - name: Get pnpm cache directory path
              id: pnpm-cache-dir
              run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

            - uses: actions/cache@v4
              id: pnpm-cache
              with:
                  path: ${{ steps.pnpm-cache-dir.outputs.PNPM_STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-frontend-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: ${{ runner.os }}-pnpm-frontend-

            - name: Install package.json dependencies with pnpm
              run: |
                  pnpm --filter=@posthog/playwright... install --frozen-lockfile
                  bin/turbo --filter=@posthog/frontend prepare

            - name: Check formatting with prettier
              run: pnpm --filter=@posthog/frontend prettier:check

            - name: Lint with Stylelint
              run: pnpm --filter=@posthog/frontend lint:css

            - name: Lint with Oxlint
              run: pnpm --filter=@posthog/frontend lint:js -f github

            - name: Lint markdown files
              run: pnpm exec markdownlint-cli2 --config .config/.markdownlint-cli2.jsonc "**/*.{md,mdx}"

    frontend-toolbar-checks:
        name: Frontend toolbar checks
        needs: [changes]
        if: needs.changes.outputs.frontend == 'true'
        runs-on: depot-ubuntu-24.04
        steps:
            - uses: actions/checkout@v4
            - name: Install pnpm
              uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  cache: 'pnpm'

            - name: Get pnpm cache directory path
              id: pnpm-cache-dir
              run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

            - uses: actions/cache@v4
              id: pnpm-cache
              with:
                  path: ${{ steps.pnpm-cache-dir.outputs.PNPM_STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-frontend-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: ${{ runner.os }}-pnpm-frontend-

            - name: Install package.json dependencies with pnpm
              run: |
                  pnpm --filter=@posthog/playwright... install --frozen-lockfile
                  bin/turbo --filter=@posthog/frontend prepare

            - name: Build products
              run: pnpm --filter=@posthog/frontend build:products

            - name: Check toolbar bundle size
              uses: preactjs/compressed-size-action@946a292cd35bd1088e0d7eb92b69d1a8d5b5d76a # v2
              with:
                  build-script: '--filter=@posthog/frontend build'
                  install-script: 'pnpm --filter=@posthog/frontend... install'
                  compression: 'none'
                  pattern: 'frontend/dist/toolbar.js'
                  # we only care if the toolbar will increase a lot
                  minimum-change-threshold: 1000

            - name: Check toolbar for CSP eval violations
              run: pnpm --filter=@posthog/frontend check-toolbar-csp-eval

    frontend-typescript-checks:
        name: Frontend typechecking
        needs: [changes]
        if: needs.changes.outputs.frontend == 'true'
        runs-on: depot-ubuntu-24.04-4
        steps:
            - uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  cache: 'pnpm'

            - name: Get pnpm cache directory path
              id: pnpm-cache-dir
              run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

            - uses: actions/cache@v4
              id: pnpm-cache
              with:
                  path: ${{ steps.pnpm-cache-dir.outputs.PNPM_STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-frontend-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: ${{ runner.os }}-pnpm-frontend-

            - name: Install package.json dependencies with pnpm
              run: |
                  pnpm --filter=@posthog/playwright... install --frozen-lockfile
                  bin/turbo --filter=@posthog/frontend prepare

            - name: Cache .typegen
              uses: actions/cache@v4
              with:
                  path: .typegen
                  key: ${{ runner.os }}-typegen-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: ${{ runner.os }}-typegen-

            - name: Build products
              run: pnpm --filter=@posthog/frontend build:products

            - name: Kea typegen
              run: pnpm --filter=@posthog/frontend typegen:write

            - name: Run typescript with strict
              run: pnpm --filter=@posthog/frontend typescript:check
              env:
                  NODE_OPTIONS: --max-old-space-size=16384

            - name: Check if "schema.json" is up to date
              run: pnpm --filter=@posthog/frontend schema:build:json && git diff --exit-code

            - name: Check if mobile replay "schema.json" is up to date
              run: pnpm --filter=@posthog/ee mobile-replay:schema:build:json && git diff --exit-code

    vite-build-test:
        name: Vite build test and bundle comparison
        needs: [changes]
        if: needs.changes.outputs.frontend == 'true'
        runs-on: depot-ubuntu-24.04-4
        steps:
            - uses: actions/checkout@v4

            - name: Install pnpm
              uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  cache: 'pnpm'

            - name: Get pnpm cache directory path
              id: pnpm-cache-dir
              run: echo "PNPM_STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

            - uses: actions/cache@v4
              id: pnpm-cache
              with:
                  path: ${{ steps.pnpm-cache-dir.outputs.PNPM_STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-frontend-${{ hashFiles('pnpm-lock.yaml') }}
                  restore-keys: ${{ runner.os }}-pnpm-frontend-

            - name: Install package.json dependencies with pnpm
              run: |
                  pnpm --filter=@posthog/playwright... install --frozen-lockfile
                  bin/turbo --filter=@posthog/frontend prepare

            - name: Build products
              run: pnpm --filter=@posthog/frontend build:products

            - name: Build with ESBuild (baseline)
              run: |
                  echo "Starting ESBuild at: $(date '+%Y-%m-%d %H:%M:%S')"
                  start_time=$(date +%s)

                  # Run ESBuild with error handling
                  if pnpm --filter=@posthog/frontend build; then
                      end_time=$(date +%s)
                      build_duration=$((end_time - start_time))
                      echo "ESBuild completed successfully in: ${build_duration} seconds"
                      echo "ESBUILD_DURATION=${build_duration}" >> $GITHUB_ENV
                      echo "ESBUILD_SUCCESS=true" >> $GITHUB_ENV
                  else
                      end_time=$(date +%s)
                      build_duration=$((end_time - start_time))
                      echo "ESBuild failed after: ${build_duration} seconds"
                      echo "ESBUILD_DURATION=${build_duration}" >> $GITHUB_ENV
                      echo "ESBUILD_SUCCESS=false" >> $GITHUB_ENV
                      echo "❌ ESBuild baseline build failed - this indicates a serious issue"
                      exit 1
                  fi
              env:
                  NODE_OPTIONS: --max-old-space-size=16384

            - name: Collect ESBuild bundle stats
              run: |
                  echo "=== ESBuild Bundle Analysis ===" > esbuild-stats.txt
                  echo "Build completed at: $(date)" >> esbuild-stats.txt
                  echo "Build duration: ${ESBUILD_DURATION} seconds" >> esbuild-stats.txt
                  echo "" >> esbuild-stats.txt
                  ls -la frontend/dist/ >> esbuild-stats.txt
                  echo "" >> esbuild-stats.txt
                  echo "File sizes:" >> esbuild-stats.txt
                  du -h frontend/dist/*.js frontend/dist/*.css 2>/dev/null >> esbuild-stats.txt || true
                  echo "" >> esbuild-stats.txt
                  echo "Total dist size:" >> esbuild-stats.txt
                  du -sh frontend/dist/ >> esbuild-stats.txt

            - name: Save ESBuild artifacts
              run: |
                  mkdir -p build-comparison/esbuild
                  cp -r frontend/dist/* build-comparison/esbuild/
                  cp esbuild-stats.txt build-comparison/

            - name: Clean dist directory
              run: rm -rf frontend/dist/*

            - name: Build with Vite
              run: |
                  echo "Starting Vite build at: $(date '+%Y-%m-%d %H:%M:%S')"
                  start_time=$(date +%s)

                  # Run Vite build with error handling
                  if NODE_OPTIONS="--max-old-space-size=16384" POSTHOG_USE_VITE_PROD=1 pnpm --filter=@posthog/frontend build; then
                      end_time=$(date +%s)
                      build_duration=$((end_time - start_time))
                      echo "Vite build completed successfully in: ${build_duration} seconds"
                      echo "VITE_DURATION=${build_duration}" >> $GITHUB_ENV
                      echo "VITE_SUCCESS=true" >> $GITHUB_ENV
                  else
                      end_time=$(date +%s)
                      build_duration=$((end_time - start_time))
                      echo "Vite build failed after: ${build_duration} seconds"
                      echo "VITE_DURATION=${build_duration}" >> $GITHUB_ENV
                      echo "VITE_SUCCESS=false" >> $GITHUB_ENV
                      
                      # Create failure report
                      echo "# ❌ Vite Build Failure Report" > build-comparison/vite-failure-report.md
                      echo "" >> build-comparison/vite-failure-report.md
                      echo "**Build failed at:** $(date)" >> build-comparison/vite-failure-report.md
                      echo "**Duration:** ${build_duration} seconds" >> build-comparison/vite-failure-report.md
                      echo "**Commit:** \`${{ github.sha }}\`" >> build-comparison/vite-failure-report.md
                      echo "" >> build-comparison/vite-failure-report.md
                      echo "## Troubleshooting Steps" >> build-comparison/vite-failure-report.md
                      echo "1. Check Vite configuration in \`frontend/vite.config.ts\`" >> build-comparison/vite-failure-report.md
                      echo "2. Verify all Vite plugins are working correctly" >> build-comparison/vite-failure-report.md
                      echo "3. Check for Node.js polyfill issues" >> build-comparison/vite-failure-report.md
                      echo "4. Review build logs above for specific error messages" >> build-comparison/vite-failure-report.md
                      
                      # Still continue to comparison but mark as failed
                      echo "⚠️ Vite build failed - creating partial comparison report"
                  fi

            - name: Collect Vite bundle stats
              run: |
                  echo "=== Vite Bundle Analysis ===" > vite-stats.txt
                  echo "Build completed at: $(date)" >> vite-stats.txt
                  echo "Build duration: ${VITE_DURATION} seconds" >> vite-stats.txt
                  echo "Build status: ${VITE_SUCCESS}" >> vite-stats.txt
                  echo "" >> vite-stats.txt

                  if [ "${VITE_SUCCESS}" = "true" ]; then
                      ls -la frontend/dist/ >> vite-stats.txt
                      echo "" >> vite-stats.txt
                      echo "File sizes:" >> vite-stats.txt
                      du -h frontend/dist/*.js frontend/dist/*.css 2>/dev/null >> vite-stats.txt || true
                      echo "" >> vite-stats.txt
                      echo "Total dist size:" >> vite-stats.txt
                      du -sh frontend/dist/ >> vite-stats.txt
                  else
                      echo "Build failed - no artifacts to analyze" >> vite-stats.txt
                      echo "Check build logs for error details" >> vite-stats.txt
                  fi

            - name: Save Vite artifacts
              run: |
                  mkdir -p build-comparison/vite
                  cp -r frontend/dist/* build-comparison/vite/
                  cp vite-stats.txt build-comparison/

            - name: Generate bundle comparison report
              run: |
                  # Determine overall status
                  if [ "${VITE_SUCCESS}" = "true" ] && [ "${ESBUILD_SUCCESS}" = "true" ]; then
                      status_emoji="✅"
                      overall_status="Success"
                  elif [ "${VITE_SUCCESS}" = "false" ]; then
                      status_emoji="❌"
                      overall_status="Vite Build Failed"
                  elif [ "${ESBUILD_SUCCESS}" = "false" ]; then
                      status_emoji="❌"
                      overall_status="ESBuild Build Failed"
                  else
                      status_emoji="⚠️"
                      overall_status="Unknown"
                  fi

                  echo "# ${status_emoji} Vite vs ESBuild Build Comparison" > build-comparison/comparison-report.md
                  echo "" >> build-comparison/comparison-report.md
                  echo "**Status:** ${overall_status}" >> build-comparison/comparison-report.md
                  echo "**Generated on:** $(date)" >> build-comparison/comparison-report.md
                  echo "**Commit:** \`${{ github.sha }}\`" >> build-comparison/comparison-report.md
                  echo "" >> build-comparison/comparison-report.md

                  # Performance Summary
                  echo "## ⚡ Performance Summary" >> build-comparison/comparison-report.md
                  echo "" >> build-comparison/comparison-report.md

                  if [ "${VITE_SUCCESS}" = "false" ] || [ "${ESBUILD_SUCCESS}" = "false" ]; then
                      echo "⚠️ **Build failure detected - performance comparison not available**" >> build-comparison/comparison-report.md
                      echo "" >> build-comparison/comparison-report.md
                      if [ "${VITE_SUCCESS}" = "false" ]; then
                          echo "- Vite build failed after ${VITE_DURATION}s" >> build-comparison/comparison-report.md
                      fi
                      if [ "${ESBUILD_SUCCESS}" = "false" ]; then
                          echo "- ESBuild build failed after ${ESBUILD_DURATION}s" >> build-comparison/comparison-report.md
                      fi
                      echo "" >> build-comparison/comparison-report.md
                  else
                      echo "| Metric | ESBuild | Vite | Difference | Status |" >> build-comparison/comparison-report.md
                      echo "|--------|---------|------|------------|--------|" >> build-comparison/comparison-report.md
                      
                      # Calculate performance difference with regression detection
                      if [ -n "${ESBUILD_DURATION}" ] && [ -n "${VITE_DURATION}" ]; then
                          diff=$((VITE_DURATION - ESBUILD_DURATION))
                          if [ $diff -gt 60 ]; then
                              diff_text="+${diff}s slower"
                              perf_status="🔴 Regression"
                          elif [ $diff -gt 30 ]; then
                              diff_text="+${diff}s slower"
                              perf_status="🟡 Slower"
                          elif [ $diff -gt 0 ]; then
                              diff_text="+${diff}s slower"
                              perf_status="🟢 Acceptable"
                          elif [ $diff -lt 0 ]; then
                              diff_text="${diff}s faster"
                              perf_status="🟢 Faster"
                          else
                              diff_text="Same"
                              perf_status="🟢 Same"
                          fi
                          echo "| Build Time | ${ESBUILD_DURATION}s | ${VITE_DURATION}s | ${diff_text} | ${perf_status} |" >> build-comparison/comparison-report.md
                      fi
                      
                      # Calculate total bundle sizes
                      if [ -d "build-comparison/esbuild" ] && [ -d "build-comparison/vite" ]; then
                          esbuild_total=$(du -sh build-comparison/esbuild/ | cut -f1)
                          vite_total=$(du -sh build-comparison/vite/ | cut -f1)
                          echo "| Total Bundle Size | ${esbuild_total} | ${vite_total} | - | ℹ️ |" >> build-comparison/comparison-report.md
                      fi
                      echo "" >> build-comparison/comparison-report.md
                  fi

                  # Entry Points Comparison
                  echo "## 📁 Entry Points Comparison" >> build-comparison/comparison-report.md
                  echo "" >> build-comparison/comparison-report.md
                  echo "| Entry Point | ESBuild | Vite | Status |" >> build-comparison/comparison-report.md
                  echo "|-------------|---------|------|--------|" >> build-comparison/comparison-report.md

                  for entry in index exporter render-query toolbar testWorker; do
                      esbuild_file=$(find build-comparison/esbuild -name "${entry}*.js" | head -1)
                      vite_file=$(find build-comparison/vite -name "${entry}*.js" | head -1)
                      
                      if [ -n "$esbuild_file" ] && [ -n "$vite_file" ]; then
                          esbuild_size=$(du -h "$esbuild_file" | cut -f1)
                          vite_size=$(du -h "$vite_file" | cut -f1)
                          echo "| $entry | $esbuild_size | $vite_size | ✅ |" >> build-comparison/comparison-report.md
                      elif [ -n "$vite_file" ]; then
                          vite_size=$(du -h "$vite_file" | cut -f1)
                          echo "| $entry | Missing | $vite_size | ⚠️ |" >> build-comparison/comparison-report.md
                      elif [ -n "$esbuild_file" ]; then
                          esbuild_size=$(du -h "$esbuild_file" | cut -f1)
                          echo "| $entry | $esbuild_size | Missing | ❌ |" >> build-comparison/comparison-report.md
                      else
                          echo "| $entry | Missing | Missing | ❌ |" >> build-comparison/comparison-report.md
                      fi
                  done
                  echo "" >> build-comparison/comparison-report.md

                  echo "## 📊 Detailed Build Analysis" >> build-comparison/comparison-report.md
                  echo "" >> build-comparison/comparison-report.md
                  echo "### ESBuild Results" >> build-comparison/comparison-report.md
                  echo "\`\`\`" >> build-comparison/comparison-report.md
                  cat build-comparison/esbuild-stats.txt >> build-comparison/comparison-report.md
                  echo "\`\`\`" >> build-comparison/comparison-report.md
                  echo "" >> build-comparison/comparison-report.md

                  echo "### Vite Results" >> build-comparison/comparison-report.md
                  echo "\`\`\`" >> build-comparison/comparison-report.md
                  cat build-comparison/vite-stats.txt >> build-comparison/comparison-report.md
                  echo "\`\`\`" >> build-comparison/comparison-report.md
                  echo "" >> build-comparison/comparison-report.md

            - name: Validate build artifacts
              run: |
                  echo "Validating Vite build artifacts..."

                  # Check that all expected entry points exist
                  for entry in index exporter render-query toolbar testWorker; do
                      if ! find build-comparison/vite -name "${entry}*.js" | grep -q .; then
                          echo "❌ Missing entry point: $entry"
                          exit 1
                      else
                          echo "✅ Found entry point: $entry"
                      fi
                  done

                  # Check that manifest.json exists
                  if [ ! -f "build-comparison/vite/.vite/manifest.json" ]; then
                      echo "❌ Missing Vite manifest.json"
                      exit 1
                  else
                      echo "✅ Found Vite manifest.json"
                  fi

                  # Check that assets are copied
                  if [ ! -d "build-comparison/vite/assets" ]; then
                      echo "❌ Missing assets directory"
                      exit 1
                  else
                      echo "✅ Found assets directory"
                  fi

                  echo "✅ All Vite build artifacts validated successfully"

                  # Performance threshold checks
                  echo ""
                  echo "Performance threshold checks:"

                  # Check if Vite build is significantly slower (>2x)
                  if [ -n "${ESBUILD_DURATION}" ] && [ -n "${VITE_DURATION}" ]; then
                      threshold=$((ESBUILD_DURATION * 2))
                      if [ "${VITE_DURATION}" -gt "${threshold}" ]; then
                          echo "⚠️  WARNING: Vite build took ${VITE_DURATION}s, which is >2x slower than ESBuild (${ESBUILD_DURATION}s)"
                          echo "Consider investigating build performance optimizations"
                      else
                          echo "✅ Vite build performance is within acceptable threshold"
                      fi
                  fi

                  # Check for missing entry points
                  missing_entries=0
                  for entry in index exporter render-query toolbar testWorker; do
                      if ! find build-comparison/vite -name "${entry}*.js" | grep -q .; then
                          missing_entries=$((missing_entries + 1))
                      fi
                  done

                  if [ "${missing_entries}" -gt 0 ]; then
                      echo "❌ CRITICAL: ${missing_entries} entry points are missing from Vite build"
                      exit 1
                  else
                      echo "✅ All entry points present in Vite build"
                  fi

                  # Final status check - fail job if critical issues detected
                  echo ""
                  echo "Final validation:"

                  critical_issues=0

                  # Check for build failures
                  if [ "${VITE_SUCCESS}" = "false" ]; then
                      echo "❌ CRITICAL: Vite build failed"
                      critical_issues=$((critical_issues + 1))
                  fi

                  # Check for severe performance regressions (>60s slower)
                  if [ -n "${ESBUILD_DURATION}" ] && [ -n "${VITE_DURATION}" ]; then
                      diff=$((VITE_DURATION - ESBUILD_DURATION))
                      if [ $diff -gt 60 ]; then
                          echo "❌ CRITICAL: Vite build is ${diff}s slower than ESBuild (>60s regression)"
                          critical_issues=$((critical_issues + 1))
                      fi
                  fi

                  if [ "${critical_issues}" -gt 0 ]; then
                      echo ""
                      echo "❌ CI FAILURE: ${critical_issues} critical issue(s) detected"
                      echo "The Vite build system requires attention before it can be considered production-ready"
                      exit 1
                  else
                      echo "✅ CI SUCCESS: Vite build system is working correctly"
                  fi

            - name: Upload build comparison artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: bundle-comparison-${{ github.run_id }}
                  path: build-comparison/
                  retention-days: 7

            - name: Comment bundle comparison on PR
              if: github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');

                      if (fs.existsSync('build-comparison/comparison-report.md')) {
                          const report = fs.readFileSync('build-comparison/comparison-report.md', 'utf8');
                          
                          // Check if there's a failure report
                          let failureReport = '';
                          if (fs.existsSync('build-comparison/vite-failure-report.md')) {
                              failureReport = '\n\n' + fs.readFileSync('build-comparison/vite-failure-report.md', 'utf8');
                          }
                          
                          // Determine if this is a failure or success
                          const isFailure = report.includes('❌') || failureReport !== '';
                          const emoji = isFailure ? '❌' : '✅';
                          const title = isFailure ? 'Vite Build Test - Issues Detected' : 'Vite Build Test Results';
                          
                          github.rest.issues.createComment({
                              issue_number: context.issue.number,
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              body: `## ${emoji} ${title}\n\n${report}${failureReport}\n\n*This comment was generated by the vite-build-test CI job.*`
                          });
                      }

    jest:
        runs-on: depot-ubuntu-24.04
        needs: changes
        if: needs.changes.outputs.frontend == 'true'
        name: Jest test (${{ matrix.segment }} - ${{ matrix.chunk }})

        strategy:
            # If one test fails, still run the others
            fail-fast: false
            matrix:
                segment: ['FOSS', 'EE']
                chunk: [1, 2, 3]

        steps:
            - uses: actions/checkout@v4

            - name: Remove ee
              if: matrix.segment == 'FOSS'
              run: rm -rf ee

            - name: Install pnpm
              uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 22.17.1
                  cache: pnpm

            - name: Install package.json dependencies with pnpm
              run: pnpm --filter=@posthog/frontend... install --frozen-lockfile

            - name: Test with Jest
              run: bin/turbo run test --filter=@posthog/frontend
              env:
                  NODE_OPTIONS: --max-old-space-size=16384
                  SHARD_INDEX: ${{ matrix.chunk }}
                  SHARD_COUNT: 3

    calculate-running-time:
        name: Calculate running time
        needs: [jest, frontend-typescript-checks, frontend-format, frontend-toolbar-checks, vite-build-test, changes]
        runs-on: ubuntu-latest
        if: # Run on pull requests to PostHog/posthog + on PostHog/posthog outside of PRs - but never on forks
            needs.changes.outputs.frontend == 'true' && (
            (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == 'PostHog/posthog') ||
            (github.event_name != 'pull_request' && github.repository == 'PostHog/posthog'))
        steps:
            - name: Calculate running time
              run: |
                  echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
                  run_id=${GITHUB_RUN_ID}
                  repo=${GITHUB_REPOSITORY}
                  run_info=$(gh api repos/${repo}/actions/runs/${run_id})
                  echo run_info: ${run_info}
                  # name is the name of the workflow file
                  # run_started_at is the start time of the workflow
                  # we want to get the number of seconds between the start time and now
                  name=$(echo ${run_info} | jq -r '.name')
                  run_url=$(echo ${run_info} | jq -r '.url')
                  run_started_at=$(echo ${run_info} | jq -r '.run_started_at')
                  run_attempt=$(echo ${run_info} | jq -r '.run_attempt')
                  start_seconds=$(date -d "${run_started_at}" +%s)
                  now_seconds=$(date +%s)
                  duration=$((now_seconds-start_seconds))
                  echo running_time_duration_seconds=${duration} >> $GITHUB_ENV
                  echo running_time_run_url=${run_url} >> $GITHUB_ENV
                  echo running_time_run_attempt=${run_attempt} >> $GITHUB_ENV
                  echo running_time_run_id=${run_id} >> $GITHUB_ENV
                  echo running_time_run_started_at=${run_started_at} >> $GITHUB_ENV

            - name: Capture running time to PostHog
              if: needs.changes.outputs.frontend == 'true'
              uses: PostHog/posthog-github-action@v0.1
              with:
                  posthog-token: ${{secrets.POSTHOG_API_TOKEN}}
                  event: 'posthog-ci-running-time'
                  properties: '{"runner": "depot", "duration_seconds": ${{ env.running_time_duration_seconds }}, "run_url": "${{ env.running_time_run_url }}", "run_attempt": "${{ env.running_time_run_attempt }}", "run_id": "${{ env.running_time_run_id }}", "run_started_at": "${{ env.running_time_run_started_at }}"}'

    frontend_tests:
        needs: [jest, frontend-format, frontend-toolbar-checks, frontend-typescript-checks, vite-build-test]
        name: Frontend Tests Pass
        runs-on: ubuntu-latest
        if: always()
        steps:
            - run: exit 0
            - name: Check outcomes
              run: |
                  if [[ "${{ needs.jest.result }}" != "success" && "${{ needs.jest.result }}" != "skipped" ]]; then
                    echo "Frontend jest tests failed."
                    exit 1
                  fi
                  echo "Frontend jest tests passed."
                  if [[ "${{ needs.frontend-format.result }}" != "success" && "${{ needs.frontend-format.result }}" != "skipped" ]]; then
                    echo "Frontend linting failed."
                    exit 1
                  fi
                  echo "Frontend linting passed."
                  if [[ "${{ needs.frontend-toolbar-checks.result }}" != "success" && "${{ needs.frontend-toolbar-checks.result }}" != "skipped" ]]; then
                    echo "Frontend toolbar checks failed."
                    exit 1
                  fi
                  echo "Frontend toolbar checks passed."
                  if [[ "${{ needs.frontend-typescript-checks.result }}" != "success" && "${{ needs.frontend-typescript-checks.result }}" != "skipped" ]]; then
                    echo "Frontend TypeScript checks failed."
                    exit 1
                  fi
                  echo "Frontend TypeScript checks passed."
                  if [[ "${{ needs.vite-build-test.result }}" != "success" && "${{ needs.vite-build-test.result }}" != "skipped" ]]; then
                    echo "Vite build test failed."
                    exit 1
                  fi
                  echo "Vite build test passed."
