# This workflow runs generic Python tests global to Dagster and PostHog.
name: Python CI
on:
    push:
        branches:
            - master
    pull_request:
    merge_group:

permissions:
    contents: read

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
    # Job to decide if we should run python ci
    # See https://github.com/dorny/paths-filter#conditional-execution for more details
    changes:
        runs-on: ubuntu-latest
        timeout-minutes: 5
        name: Determine need to run python checks
        # Set job outputs to values from filter step
        outputs:
            python: ${{ steps.filter.outputs.python || 'true' }}
        steps:
            # For pull requests it's not necessary to checkout the code, but we
            # also want this to run on master so we need to checkout
            - uses: actions/checkout@v6

            - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
              id: filter
              if: github.event_name != 'push' # Run all tests on master push
              with:
                  filters: |
                      python:
                        - 'pyproject.toml'
                        - 'uv.lock'
                        - 'ee/**/*.py'
                        - 'posthog/**/*'
                        - 'products/**/*.py'
                        # Make sure we run if someone is explicitly change the workflows
                        - .github/workflows/ci-python.yml
                        - .github/workflows/ci-dagster.yml
                        - .github/workflows/ci-backend.yml
                        - .flox/env/manifest.toml
                        - bin/check_uv_python_compatibility.py
                        # Schema changes need to trigger Python CI to validate schema.py is regenerated
                        - 'frontend/src/queries/schema.json'
                        # Products changes need to trigger Python CI to validate the json usage is still valid
                        - 'frontend/src/products.json'
                        # hogli CLI changes need validation
                        - 'common/hogli/**'
                        - 'bin/**'
                        # LLM Gateway service
                        - 'services/llm-gateway/**/*.py'
                        # GitHub scripts
                        - '.github/scripts/**/*.py'

    code-quality:
        needs: changes
        if: needs.changes.outputs.python == 'true'
        timeout-minutes: 30

        name: Python code quality
        runs-on: depot-ubuntu-latest

        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 1

            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
              with:
                  python-version: 3.12.12

            - name: Install uv
              id: setup-uv
              uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
              with:
                  enable-cache: true
                  version: 0.9.9

            - name: Check uv and Python version compatibility
              shell: bash
              run: |
                  python3 bin/check_uv_python_compatibility.py

            - name: Install SAML (python3-saml) dependencies
              if: steps.setup-uv.outputs.cache-hit != 'true'
              shell: bash
              run: |
                  sudo apt-get update
                  sudo apt-get install libxml2-dev libxmlsec1 libxmlsec1-dev libxmlsec1-openssl

            - name: Install Python dependencies
              shell: bash
              run: |
                  UV_PROJECT_ENVIRONMENT=$pythonLocation uv sync --frozen --dev

            - name: Check for syntax errors, import sort, and code style violations
              shell: bash
              run: |
                  ruff check .

            - name: Check formatting
              shell: bash
              run: |
                  ruff format --check --diff .

            - name: Add ty Problem Matcher
              shell: bash
              run: |
                  echo "::add-matcher::.github/ty-problem-matcher.json"

            - name: Check ty type checking (informational)
              shell: bash
              continue-on-error: true
              run: |
                  echo "üëÄ Running ty type checker (informational - does not block CI)"
                  echo "üìä Trial run to evaluate ty vs mypy. Feedback welcome in #team-devex"
                  echo ""
                  ./bin/ty.py check posthog ee common dags || echo "‚ö†Ô∏è ty found type issues (annotations below)"

            - name: Add mypy Problem Matcher
              shell: bash
              run: |
                  echo "::add-matcher::.github/mypy-problem-matcher.json"

            - name: Restore mypy cache
              uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
              with:
                  path: .mypy_cache
                  key: mypy-cache-${{ runner.os }}-3.12-${{ hashFiles('**/pyproject.toml', '**/mypy.ini') }}
                  restore-keys: |
                      mypy-cache-${{ runner.os }}-3.12-

            - name: Check static typing
              shell: bash -e {0}
              run: |
                  mypy --version && mypy --cache-fine-grained . | mypy-baseline filter || (echo "run 'pnpm run mypy-baseline-sync' to update the baseline" && exit 1)

            - name: Check if "schema.py" is up to date
              shell: bash
              run: |
                  npm run schema:build:python && git diff --exit-code

            - name: Check hogli manifest completeness
              shell: bash
              run: |
                  ./bin/hogli meta:check

            - name: Run hogli tests
              shell: bash
              run: |
                  pytest common/hogli/tests/ -v --cov=common/hogli --cov-report=term --junitxml=junit-hogli.xml

            - name: Upload test results
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              if: always()
              with:
                  name: junit-results-hogli
                  path: junit-hogli.xml

            - name: Run dependency detection script tests
              shell: bash
              run: |
                  pytest bin/test/test_find_python_dependencies.py -v --junitxml=junit-dependency-detection.xml

            - name: Upload test results for dependency detection
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              if: always()
              with:
                  name: junit-results-dependency-detection
                  path: junit-dependency-detection.xml

            # - name: Check if "taxonomy.json/taxonomy.tsx" is up to date
            #   if: needs.changes.outputs.python == 'true'
            #   shell: bash
            #   run: |
            #       npm run taxonomy:build:json && git diff --exit-code

    # Collate job - single required status check for branch protection.
    # The code-quality job skips when no Python changes, but this job always
    # runs and reports success, allowing PRs to merge.
    python_tests:
        needs: [changes, code-quality]
        name: Python code quality checks
        runs-on: ubuntu-latest
        if: always()
        steps:
            - name: Check Python CI status
              run: |
                  # Fail if change detection itself failed
                  if [[ "${{ needs.changes.result }}" == "failure" ]]; then
                    echo "Change detection job failed."
                    exit 1
                  fi

                  # Pass if no Python changes detected (jobs were skipped)
                  if [[ "${{ needs.changes.outputs.python }}" != "true" ]]; then
                    echo "Python checks were skipped (no relevant changes)"
                    exit 0
                  fi

                  # Check actual job result
                  if [[ "${{ needs.code-quality.result }}" != "success" && "${{ needs.code-quality.result }}" != "skipped" ]]; then
                    echo "Python code quality checks failed."
                    exit 1
                  fi

                  echo "All Python checks passed."
