# This workflow runs generic Python tests global to Dagster and PostHog.
name: Python CI
on:
    push:
        branches:
            - master
    pull_request:
    merge_group:

permissions:
    contents: read

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
    # Job to decide if we should run python ci
    # See https://github.com/dorny/paths-filter#conditional-execution for more details
    changes:
        runs-on: ubuntu-latest
        timeout-minutes: 5
        name: Determine need to run python checks
        # Set job outputs to values from filter step
        outputs:
            python: ${{ steps.filter.outputs.python || 'true' }}
        steps:
            # For pull requests it's not necessary to checkout the code, but we
            # also want this to run on master so we need to checkout
            - uses: actions/checkout@v4

            - uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50 # v2
              id: filter
              if: github.event_name != 'push' # Run all tests on master push
              with:
                  filters: |
                      python:
                        - 'pyproject.toml'
                        - 'uv.lock'
                        - 'ee/**/*.py'
                        - 'posthog/**/*'
                        - 'products/**/*.py'
                        # Make sure we run if someone is explicitly change the workflows
                        - .github/workflows/ci-python.yml
                        - .github/workflows/ci-dagster.yml
                        - .github/workflows/ci-backend.yml
                        - .flox/env/manifest.toml
                        - bin/check_uv_python_compatibility.py
                        # Schema changes need to trigger Python CI to validate schema.py is regenerated
                        - 'frontend/src/queries/schema.json'
                        # Products changes need to trigger Python CI to validate the json usage is still valid
                        - 'frontend/src/products.json'
                        # hogli CLI changes need validation
                        - 'common/hogli/**'
                        - 'bin/**'
                        # LLM Gateway service
                        - 'services/llm-gateway/**/*.py'

    code-quality:
        needs: changes
        if: needs.changes.outputs.python == 'true'
        timeout-minutes: 30

        name: Python code quality
        runs-on: depot-ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 1

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: 3.12.12

            - name: Install uv
              id: setup-uv
              uses: astral-sh/setup-uv@3259c6206f993105e3a61b142c2d97bf4b9ef83d # v7.1.0
              with:
                  enable-cache: true
                  version: 0.9.9

            - name: Check uv and Python version compatibility
              shell: bash
              run: |
                  python3 bin/check_uv_python_compatibility.py

            - name: Install SAML (python3-saml) dependencies
              if: steps.setup-uv.outputs.cache-hit != 'true'
              shell: bash
              run: |
                  sudo apt-get update
                  sudo apt-get install libxml2-dev libxmlsec1 libxmlsec1-dev libxmlsec1-openssl

            - name: Install Python dependencies
              shell: bash
              run: |
                  UV_PROJECT_ENVIRONMENT=$pythonLocation uv sync --frozen --dev

            - name: Check for syntax errors, import sort, and code style violations
              shell: bash
              run: |
                  ruff check .

            - name: Check formatting
              shell: bash
              run: |
                  ruff format --check --diff .

            - name: Add ty Problem Matcher
              shell: bash
              run: |
                  echo "::add-matcher::.github/ty-problem-matcher.json"

            - name: Check ty type checking (informational)
              shell: bash
              continue-on-error: true
              run: |
                  echo "ðŸ‘€ Running ty type checker (informational - does not block CI)"
                  echo "ðŸ“Š Trial run to evaluate ty vs mypy. Feedback welcome in #team-devex"
                  echo ""
                  ./bin/ty.py check posthog ee common dags || echo "âš ï¸ ty found type issues (annotations below)"

            - name: Add mypy Problem Matcher
              shell: bash
              run: |
                  echo "::add-matcher::.github/mypy-problem-matcher.json"

            - name: Restore mypy cache
              uses: actions/cache@v4
              with:
                  path: .mypy_cache
                  key: mypy-cache-${{ runner.os }}-3.12-${{ hashFiles('**/pyproject.toml', '**/mypy.ini') }}
                  restore-keys: |
                      mypy-cache-${{ runner.os }}-3.12-

            - name: Check static typing
              shell: bash -e {0}
              run: |
                  mypy --version && mypy --cache-fine-grained . | mypy-baseline filter || (echo "run 'pnpm run mypy-baseline-sync' to update the baseline" && exit 1)

            - name: Check if "schema.py" is up to date
              shell: bash
              run: |
                  npm run schema:build:python && git diff --exit-code

            - name: Check hogli manifest completeness
              shell: bash
              run: |
                  ./bin/hogli meta:check

            - name: Run hogli tests
              shell: bash
              run: |
                  pytest common/hogli/tests/ -v --cov=common/hogli --cov-report=term

            # - name: Check if "taxonomy.json/taxonomy.tsx" is up to date
            #   if: needs.changes.outputs.python == 'true'
            #   shell: bash
            #   run: |
            #       npm run taxonomy:build:json && git diff --exit-code

    # TEMPORARY: Test master CI status Slack integration
    test-master-ci-status:
        needs: changes
        if: needs.changes.outputs.python == 'true'
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  ref: master
                  fetch-depth: 1

            - name: Restore incident state from cache
              id: cache
              uses: actions/cache/restore@v4
              with:
                  path: .master-ci-incident
                  key: master-ci-incident-test

            - name: Read incident state
              id: incident
              run: |
                  if [ -f .master-ci-incident ]; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "channel=$(jq -r '.channel' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "ts=$(jq -r '.ts' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "since=$(jq -r '.since' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "failCount=$(jq -r '.failCount // 1' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "commitCount=$(jq -r '.commitCount // 1' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "Incident state:"
                    cat .master-ci-incident
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "No incident found"
                  fi

            # Get commit info from master
            - name: Get commit info
              id: commit
              run: |
                  sha="$(git rev-parse HEAD)"
                  echo "short_sha=${sha:0:7}" >> $GITHUB_OUTPUT
                  echo "message=$(git log -1 --pretty=%s | head -c 50)" >> $GITHUB_OUTPUT
                  echo "author=$(git log -1 --pretty=%an)" >> $GITHUB_OUTPUT
                  echo "url=${{ github.server_url }}/${{ github.repository }}/commit/$sha" >> $GITHUB_OUTPUT
                  echo "sha=$sha" >> $GITHUB_OUTPUT

            # New incident - post initial alert
            - name: Post new incident to Slack (TEST)
              if: steps.incident.outputs.exists == 'false'
              id: slack_new
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  errors: true
                  payload: |
                      channel: "U063CTHPZF0"
                      text: ":red_circle: Master is red (1 commit, 1 workflow failing) [TEST]"
                      blocks:
                        - type: "section"
                          text:
                            type: "mrkdwn"
                            text: ":red_circle: *Master is red* (1 commit, 1 workflow failing) [TEST]"
                        - type: "section"
                          fields:
                            - type: "mrkdwn"
                              text: "*Workflow*\nPython CI"
                            - type: "mrkdwn"
                              text: "*Author*\n${{ steps.commit.outputs.author }}"
                        - type: "section"
                          text:
                            type: "mrkdwn"
                            text: "*Commit*\n<${{ steps.commit.outputs.url }}|${{ steps.commit.outputs.short_sha }}> ${{ steps.commit.outputs.message }}"
                        - type: "actions"
                          elements:
                            - type: "button"
                              text:
                                type: "plain_text"
                                text: "View failing run â†’"
                              url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            - name: Debug Slack response
              if: steps.incident.outputs.exists == 'false'
              run: |
                  echo "Slack OK: ${{ steps.slack_new.outputs.ok }}"
                  echo "Slack ts: ${{ steps.slack_new.outputs.ts }}"
                  echo "Slack channel_id: ${{ steps.slack_new.outputs.channel_id }}"

            - name: Save new incident state (TEST)
              if: steps.incident.outputs.exists == 'false'
              run: |
                  jq -n \
                    --arg channel "${{ steps.slack_new.outputs.channel_id }}" \
                    --arg ts "${{ steps.slack_new.outputs.ts }}" \
                    --arg since "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    --arg firstFailure "Python CI (TEST)" \
                    --arg firstCommit "${{ steps.commit.outputs.sha }}" \
                    --argjson failCount 1 \
                    --argjson commitCount 1 \
                    '{channel: $channel, ts: $ts, since: $since, firstFailure: $firstFailure, failCount: $failCount, commitCount: $commitCount, commits: [$firstCommit]}' > .master-ci-incident
                  echo "Saved incident:"
                  cat .master-ci-incident

            - name: Delete old cache
              if: steps.incident.outputs.exists == 'false'
              continue-on-error: true
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  gh cache delete master-ci-incident-test || true

            - name: Save incident to cache
              if: steps.incident.outputs.exists == 'false'
              uses: actions/cache/save@v4
              with:
                  path: .master-ci-incident
                  key: master-ci-incident-test

            # Existing incident - update count and add thread reply
            - name: Calculate new counts
              if: steps.incident.outputs.exists == 'true'
              id: new_count
              run: |
                  # Always increment workflow fail count
                  fail_count=$(( ${{ steps.incident.outputs.failCount }} + 1 ))
                  echo "failCount=$fail_count" >> $GITHUB_OUTPUT

                  # Check if this commit is new
                  current_sha="${{ steps.commit.outputs.sha }}"
                  if jq -e --arg sha "$current_sha" '.commits | index($sha)' .master-ci-incident > /dev/null 2>&1; then
                    # Commit already tracked
                    echo "commitCount=${{ steps.incident.outputs.commitCount }}" >> $GITHUB_OUTPUT
                  else
                    # New commit
                    commit_count=$(( ${{ steps.incident.outputs.commitCount }} + 1 ))
                    echo "commitCount=$commit_count" >> $GITHUB_OUTPUT
                  fi

            - name: Update Slack message with new count (TEST)
              if: steps.incident.outputs.exists == 'true'
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.update
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  errors: true
                  payload: |
                      channel: "${{ steps.incident.outputs.channel }}"
                      ts: "${{ steps.incident.outputs.ts }}"
                      text: ":red_circle: Master is red (${{ steps.new_count.outputs.commitCount }} commits, ${{ steps.new_count.outputs.failCount }} workflows failing) [TEST]"
                      blocks:
                        - type: "section"
                          text:
                            type: "mrkdwn"
                            text: ":red_circle: *Master is red* (${{ steps.new_count.outputs.commitCount }} commits, ${{ steps.new_count.outputs.failCount }} workflows failing) [TEST]"
                        - type: "section"
                          fields:
                            - type: "mrkdwn"
                              text: "*Latest*\nPython CI"
                            - type: "mrkdwn"
                              text: "*Author*\n${{ steps.commit.outputs.author }}"
                        - type: "section"
                          text:
                            type: "mrkdwn"
                            text: "*Commit*\n<${{ steps.commit.outputs.url }}|${{ steps.commit.outputs.short_sha }}> ${{ steps.commit.outputs.message }}"
                        - type: "actions"
                          elements:
                            - type: "button"
                              text:
                                type: "plain_text"
                                text: "View failing run â†’"
                              url: "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

            - name: Thread reply with failure details (TEST)
              if: steps.incident.outputs.exists == 'true'
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: "${{ steps.incident.outputs.channel }}"
                      thread_ts: "${{ steps.incident.outputs.ts }}"
                      text: "Also failing: *Python CI* (${{ steps.commit.outputs.short_sha }})\n<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View run â†’>"

            - name: Update incident state with new counts (TEST)
              if: steps.incident.outputs.exists == 'true'
              run: |
                  jq \
                    --argjson failCount ${{ steps.new_count.outputs.failCount }} \
                    --argjson commitCount ${{ steps.new_count.outputs.commitCount }} \
                    --arg newCommit "${{ steps.commit.outputs.sha }}" \
                    '.failCount = $failCount | .commitCount = $commitCount | if (.commits | index($newCommit)) then . else .commits += [$newCommit] end' \
                    .master-ci-incident > .master-ci-incident.tmp
                  mv .master-ci-incident.tmp .master-ci-incident
                  cat .master-ci-incident

            - name: Delete old cache (update)
              if: steps.incident.outputs.exists == 'true'
              continue-on-error: true
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  gh cache delete master-ci-incident-test || true

            - name: Save updated incident to cache
              if: steps.incident.outputs.exists == 'true'
              uses: actions/cache/save@v4
              with:
                  path: .master-ci-incident
                  key: master-ci-incident-test

    # Collate job - single required status check for branch protection.
    # The code-quality job skips when no Python changes, but this job always
    # runs and reports success, allowing PRs to merge.
    python_tests:
        needs: [changes, code-quality]
        name: Python code quality checks
        runs-on: ubuntu-latest
        if: always()
        steps:
            - name: Check Python CI status
              run: |
                  # Fail if change detection itself failed
                  if [[ "${{ needs.changes.result }}" == "failure" ]]; then
                    echo "Change detection job failed."
                    exit 1
                  fi

                  # Pass if no Python changes detected (jobs were skipped)
                  if [[ "${{ needs.changes.outputs.python }}" != "true" ]]; then
                    echo "Python checks were skipped (no relevant changes)"
                    exit 0
                  fi

                  # Check actual job result
                  if [[ "${{ needs.code-quality.result }}" != "success" && "${{ needs.code-quality.result }}" != "skipped" ]]; then
                    echo "Python code quality checks failed."
                    exit 1
                  fi

                  echo "All Python checks passed."
