name: Storybook

on:
    pull_request:
        paths: # Only run if the frontend has changed
            - 'frontend/**'
            - '.storybook/**'

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    # Allow snapshot updates to finish, so that we don't need to wait for Storybook to build again
    cancel-in-progress: false

jobs:
    storybook-chromatic:
        name: Publish to Chromatic
        runs-on: ubuntu-latest
        if: github.event.pull_request.head.repo.full_name == github.repository # Don't run on forks
        outputs:
            storybook-url: ${{ steps.publish.outputs.storybookUrl }}
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 0 # ðŸ‘ˆ Required to retrieve git history (https://www.chromatic.com/docs/github-actions)

            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 7.x.x

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 18
                  cache: pnpm

            - name: Install dependencies and Chromatic
              run: pnpm i -D chromatic

            - name: Publish to Chromatic
              uses: chromaui/action@v1
              id: publish
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  # ðŸ‘‡ Chromatic projectToken, refer to the manage page to obtain it.
                  projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}

    visual-regression:
        name: Visual regression tests
        runs-on: ubuntu-20.04
        container:
            image: mcr.microsoft.com/playwright:v1.29.2-focal
        strategy:
            fail-fast: false
            matrix:
                browser: ['chromium', 'webkit', 'firefox']
        env:
            CYPRESS_INSTALL_BINARY: '0'
            NODE_OPTIONS: --max-old-space-size=4096
            JEST_IMAGE_SNAPSHOT_TRACK_OBSOLETE: '1' # Remove obsolete snapshots
        outputs:
            chromium-added: ${{ steps.diff.outputs.chromium-added }}
            chromium-modified: ${{ steps.diff.outputs.chromium-modified }}
            chromium-deleted: ${{ steps.diff.outputs.chromium-deleted }}
            chromium-total: ${{ steps.diff.outputs.chromium-total }}
            chromium-commitHash: ${{ toJson(steps.commit-hash.outputs.chromium-commit-hash) }}
            webkit-added: ${{ steps.diff.outputs.webkit-added }}
            webkit-modified: ${{ steps.diff.outputs.webkit-modified }}
            webkit-deleted: ${{ steps.diff.outputs.webkit-deleted }}
            webkit-total: ${{ steps.diff.outputs.webkit-total }}
            webkit-commitHash: ${{ toJson(steps.commit-hash.outputs.webkit-commit-hash) }}
            firefox-added: ${{ steps.diff.outputs.firefox-added }}
            firefox-modified: ${{ steps.diff.outputs.firefox-modified }}
            firefox-deleted: ${{ steps.diff.outputs.firefox-deleted }}
            firefox-total: ${{ steps.diff.outputs.firefox-total }}
            firefox-commitHash: ${{ toJson(steps.commit-hash.outputs.firefox-commit-hash) }}
        steps:
            - uses: actions/checkout@v3
              with:
                  fetch-depth: 1
                  repository: ${{ github.event.pull_request.head.repo.full_name }}
                  ref: ${{ github.event.pull_request.head.ref }}
                  # Use PostHog Bot token when not on forks to enable proper snapshot updating
                  token: ${{ github.event.pull_request.head.repo.full_name == github.repository && secrets.POSTHOG_BOT_GITHUB_TOKEN || github.token }}

            - name: Install pnpm
              uses: pnpm/action-setup@v2
              with:
                  version: 7.x.x

            - name: Set up Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: 18
                  cache: pnpm

            - name: Install package.json dependencies with pnpm
              run: pnpm install --frozen-lockfile

            - name: Install CI utilities with pnpm
              run: pnpm install http-server wait-on

            - name: Build Storybook
              run: pnpm build-storybook --quiet # Silence since progress logging results in a massive wall of spam

            - name: Serve Storybook in the background
              run: |
                  pnpm exec http-server storybook-static --port 6006 --silent &
                  pnpm wait-on http://127.0.0.1:6006 --timeout 60 # Wait for the server to be ready

            - name: Run @storybook/test-runner
              env:
                  # Solving this bug by overriding $HOME: https://github.com/microsoft/playwright/issues/6500
                  HOME: /root
                  # Update snapshots for PRs on the main repo, verify on forks, which don't have access to PostHog Bot
                  VARIANT: ${{ github.event.pull_request.head.repo.full_name == github.repository && 'update' || 'verify' }}
              run: |
                  pnpm test:visual-regression:stories:ci:$VARIANT ${{ matrix.browser }}

            - name: Run @playwright/test (legacy, Chromium-only)
              if: matrix.browser == 'chromium'
              env:
                  # Update snapshots for PRs on the main repo, verify on forks, which don't have access to PostHog Bot
                  VARIANT: ${{ github.event.pull_request.head.repo.full_name == github.repository && 'update' || 'verify' }}
              run: |
                  pnpm test:visual-regression:legacy:ci:$VARIANT

            - name: Count snapshot changes from git diff
              id: diff
              # Skip on forks
              if: github.event.pull_request.head.repo.full_name == github.repository
              run: |
                  git config --global --add safe.directory '*' # Calm git down about file ownership
                  ADDED=$(git diff --name-status | grep '^A' | wc -l)
                  MODIFIED=$(git diff --name-status | grep '^M' | wc -l)
                  DELETED=$(git diff --name-status | grep '^D' | wc -l)
                  TOTAL=$(git diff --name-status | wc -l)
                  echo "${{ matrix.browser }}-added=$ADDED" >> $GITHUB_OUTPUT
                  echo "${{ matrix.browser }}-modified=$MODIFIED" >> $GITHUB_OUTPUT
                  echo "${{ matrix.browser }}-deleted=$DELETED" >> $GITHUB_OUTPUT
                  echo "${{ matrix.browser }}-total=$TOTAL" >> $GITHUB_OUTPUT

            - name: Commit updated snapshots
              uses: EndBug/add-and-commit@v9
              # Skip on forks
              if: github.event.pull_request.head.repo.full_name == github.repository
              id: commit
              with:
                  add: '["frontend/__snapshots__/", "playwright/"]'
                  message: 'Update `${{ matrix.browser }}` UI snapshots'
                  pull: --rebase --autostash # Make sure we're up to date with other browsers' updates
                  default_author: github_actions
                  github_token: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN }}

            - name: Add commit hash to outputs, including browser name
              id: commit-hash
              if: steps.commit.outputs.pushed == 'true'
              run: echo "${{ matrix.browser }}-commit-hash=${{ steps.commit.outputs.commit_long_sha }}" >> $GITHUB_OUTPUT

    visual-regression-summary:
        name: Summarize visual regression tests
        runs-on: ubuntu-20.04
        needs: visual-regression
        if: always() # Run even if visual-regression fails for one (or more) of the browsers
        steps:
            - name: Post comment about updated snapshots
              if: github.event.pull_request.head.repo.full_name == github.repository
              uses: actions/github-script@v6
              with:
                  github-token: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN }}
                  script: |
                      const BROWSERS = ['chromium', 'webkit', 'firefox']

                      const diffJobOutputs = ${{ toJson(needs.visual-regression.outputs) }}
                      const summaryDiff = { total: 0, added: 0, modified: 0, deleted: 0 }
                      const diffByBrowser = {}
                      for (const [key, rawValue] of Object.entries(diffJobOutputs)) {
                        const value = JSON.parse(rawValue)
                        // Split e.g. 'chromium-commitHash' into ['chromium', 'commitHash']
                        const [browser, diffKey] = key.split('-')
                        if (!diffByBrowser[browser]) diffByBrowser[browser] = {}
                        diffByBrowser[browser][diffKey] = value
                        // Sum up the counts - but not the commit hash
                        if (typeof value === 'number') {
                          summaryDiff[diffKey] += value
                        }
                      }

                      for (const browser of BROWSERS) {
                        if (diffByBrowser[browser]?.total === undefined) {
                          diffByBrowser[browser] = null // Null means failure
                        }
                      }

                      if (summaryDiff.total === 0) {
                        console.log('No changes were made, skipping comment')
                        return
                      }

                      const diffByBrowserDisplay = Object.entries(diffByBrowser).map(([browser, diff]) => {
                        if (!diff) {
                          return `- \`${browser}\`: failed`
                        }
                        const { added: a, modified: m, deleted: d, commitHash } = diff
                        const extraInfo = commitHash ? ` ([view diff](https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}/commits/${commitHash}))` : ''
                        const b = a + m + d > 0 ? '**' : '' // Bold list item if there were changes
                        return `- ${b}\`${browser}\`${b}: **${a}** added, **${m}** modified, **${d}** deleted${extraInfo}`
                      }).join('\n')

                      github.rest.issues.createComment({
                        issue_number: context.issue.number,
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        body: `## ðŸ“¸ UI snapshots have been updated

                      **${summaryDiff.total}** snapshot changes in total. **${summaryDiff.added}** added, **${summaryDiff.modified}** modified, **${summaryDiff.deleted}** deleted:

                      ${diffByBrowserDisplay}

                      Triggered by [this commit](https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}/commits/${{ env.GITHUB_SHA }}).

                      ðŸ‘‰ **[Review this PR's diff of snapshots.](https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}/files#:~:text=frontend/__snapshots__/)**`
                      })
