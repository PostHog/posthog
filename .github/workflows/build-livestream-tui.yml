# Livestream TUI Build Workflow
#
# This workflow builds the posthog-live TUI binaries and publishes them as GitHub releases.
#
# Download the latest version:
#   curl -L https://github.com/PostHog/posthog/releases/download/posthog-live-latest/posthog-live-linux-amd64 -o posthog-live && chmod +x posthog-live
#
# Or browse all versions at: https://github.com/PostHog/posthog/releases?q=posthog-live&expanded=true

name: Build Livestream TUI

on:
    push:
        branches:
            - master
        paths:
            - 'livestream/tui/**'
            - '.github/workflows/build-livestream-tui.yml'

permissions:
    contents: write

jobs:
    build:
        runs-on: ubuntu-24.04

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version: '1.24'

            - name: Build production binaries
              run: cd livestream && make -f Makefile.tui build-all

            - name: Create versioned and latest releases
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  VERSION="posthog-live-$(date +%Y%m%d-%H%M%S)"

                  # Versioned release for history
                  gh release create "$VERSION" \
                      livestream/posthog-live-linux-amd64 \
                      livestream/posthog-live-linux-arm64 \
                      livestream/posthog-live-darwin-amd64 \
                      livestream/posthog-live-darwin-arm64 \
                      --title "PostHog Live TUI $VERSION" \
                      --notes "Build from commit ${{ github.sha }}" \
                      --latest=false

                  # Update floating latest release
                  gh release delete posthog-live-latest --yes || true
                  git push origin :refs/tags/posthog-live-latest || true
                  gh release create posthog-live-latest \
                      livestream/posthog-live-linux-amd64 \
                      livestream/posthog-live-linux-arm64 \
                      livestream/posthog-live-darwin-amd64 \
                      livestream/posthog-live-darwin-arm64 \
                      --title "PostHog Live TUI (Latest)" \
                      --notes "Latest posthog-live build - same as $VERSION

                  Download (Linux amd64): \`curl -L https://github.com/PostHog/posthog/releases/download/posthog-live-latest/posthog-live-linux-amd64 -o posthog-live && chmod +x posthog-live\`
                  Download (Linux arm64): \`curl -L https://github.com/PostHog/posthog/releases/download/posthog-live-latest/posthog-live-linux-arm64 -o posthog-live && chmod +x posthog-live\`
                  Download (macOS amd64): \`curl -L https://github.com/PostHog/posthog/releases/download/posthog-live-latest/posthog-live-darwin-amd64 -o posthog-live && chmod +x posthog-live\`
                  Download (macOS arm64): \`curl -L https://github.com/PostHog/posthog/releases/download/posthog-live-latest/posthog-live-darwin-arm64 -o posthog-live && chmod +x posthog-live\`" \
                      --latest=false
