name: Cleanup Hobby Preview Droplets

on:
    schedule:
        # Run daily at 3am UTC
        - cron: '0 3 * * *'
    workflow_call:
        inputs:
            pr_number:
                description: 'Specific PR number to cleanup (optional)'
                type: string
                required: false
    workflow_dispatch:
        inputs:
            pr_number:
                description: 'Specific PR number to cleanup (leave empty for all stale)'
                type: string
                required: false
            dry_run:
                description: 'Dry run (no actual cleanup)'
                type: boolean
                default: true
            max_inactive_days:
                description: 'Max days of PR inactivity before cleanup'
                type: number
                default: 7

permissions:
    deployments: write

jobs:
    cleanup:
        name: Cleanup preview droplets
        runs-on: ubuntu-24.04
        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: '3.11'

            - name: Install dependencies
              run: pip install python-digitalocean requests

            - name: Cleanup specific PR droplet
              if: inputs.pr_number != ''
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
                  PR_NUMBER: ${{ inputs.pr_number }}
              run: python3 bin/hobby-ci.py destroy-pr

            - name: Cleanup stale droplets
              if: inputs.pr_number == ''
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  MAX_INACTIVE_DAYS: ${{ inputs.max_inactive_days || '7' }}
                  DRY_RUN: ${{ inputs.dry_run || 'false' }}
              run: python3 bin/hobby-ci.py cleanup-stale

            - name: Cleanup GitHub deployment and environment
              if: inputs.pr_number != ''
              uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
              with:
                  script: |
                      const prNumber = '${{ inputs.pr_number }}';
                      const environment = `preview-pr-${prNumber}`;

                      console.log(`Cleaning up deployments for ${environment}`);

                      const { data: deployments } = await github.rest.repos.listDeployments({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          environment: environment,
                          per_page: 100
                      });

                      console.log(`Found ${deployments.length} deployments`);

                      for (const deployment of deployments) {
                          try {
                              await github.rest.repos.createDeploymentStatus({
                                  owner: context.repo.owner,
                                  repo: context.repo.repo,
                                  deployment_id: deployment.id,
                                  state: 'inactive',
                                  description: 'PR closed'
                              });

                              await github.rest.repos.deleteDeployment({
                                  owner: context.repo.owner,
                                  repo: context.repo.repo,
                                  deployment_id: deployment.id
                              });

                              console.log(`Deleted deployment ${deployment.id}`);
                          } catch (error) {
                              console.log(`Could not delete deployment ${deployment.id}: ${error.message}`);
                          }
                      }

                      try {
                          await github.rest.repos.deleteAnEnvironment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              environment_name: environment
                          });
                          console.log(`Deleted environment ${environment}`);
                      } catch (error) {
                          console.log(`Could not delete environment ${environment}: ${error.message}`);
                      }
