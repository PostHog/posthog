# This workflow runs e2e smoke test for hobby deployment
# To check on the status of the instance if this fails go to DO open the instance
# Instance name should look like `do-ci-hobby-deploy-xxxx`
# SSH onto the instance and `tail -f /var/log/cloud-init-output.log`
name: e2e - hobby smoke test
on:
    push:
        branches:
            - 'release-*.*'
    pull_request:
        types: [opened, synchronize, labeled]
        paths:
            - docker-compose.base.yml
            - docker-compose.hobby.yml
            - bin/*
            - docker/*
            - .github/workflows/ci-hobby.yml

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    wait-for-docker-image:
        name: Wait for Docker image build
        runs-on: ubuntu-24.04
        timeout-minutes: 60
        if: github.event_name == 'pull_request'
        outputs:
            preview-mode: ${{ steps.check-preview.outputs.preview }}
            comment-id: ${{ steps.post-comment.outputs.comment-id }}
        steps:
            - name: Check for preview mode
              id: check-preview
              run: |
                  LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels -q '.labels[].name' 2>/dev/null || echo "")
                  if echo "$LABELS" | grep -q "hobby-preview"; then
                    echo "preview=true" >> $GITHUB_OUTPUT
                    echo "üîÑ Preview mode enabled - will reuse droplet if exists"
                  else
                    echo "preview=false" >> $GITHUB_OUTPUT
                    echo "üß™ Smoke test mode - ephemeral droplet"
                  fi
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            - name: Post initial PR comment
              id: post-comment
              uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b
              with:
                  script: |
                      const commentMarker = '<!-- hobby-ci-comment -->';
                      const previewMode = '${{ steps.check-preview.outputs.preview }}' === 'true';

                      // Find existing comment to update (in case of workflow retry)
                      const { data: comments } = await github.rest.issues.listComments({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                      });

                      const existingComment = comments.find(c => c.body.includes(commentMarker));

                      const initialBody = `${commentMarker}
                      ## ü¶î Hobby deployment instance

                      ${previewMode ? 'üîÑ **Preview mode** - Reusing or creating persistent droplet' : 'üß™ **Smoke test mode** - Creating ephemeral droplet'}

                      ‚è≥ Setting up instance... (this takes ~30 minutes)

                      **Commit:** \`${context.sha.substring(0, 7)}\`
                      **Workflow run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})
                      `;

                      let commentId;
                      if (existingComment) {
                          // Update existing comment
                          await github.rest.issues.updateComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              comment_id: existingComment.id,
                              body: initialBody,
                          });
                          commentId = existingComment.id;
                          console.log(`Updated existing comment ${commentId}`);
                      } else {
                          // Create new comment
                          const { data: newComment } = await github.rest.issues.createComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: context.issue.number,
                              body: initialBody,
                          });
                          commentId = newComment.id;
                          console.log(`Created new comment ${commentId}`);
                      }

                      // Save comment ID for later update
                      const fs = require('fs');
                      const path = require('path');
                      const outputFile = path.join(process.env.RUNNER_TEMP, 'hobby-comment-id.txt');
                      fs.writeFileSync(outputFile, commentId.toString());

                      // Also set as step output for the changes job to pick up
                      const output = `comment-id=${commentId}`;
                      fs.appendFileSync(process.env.GITHUB_OUTPUT, `${output}\n`);
            - name: Wait for container image build to complete
              uses: fountainhead/action-wait-for-check@4699210ccc66e2a13260803fadbb77085421b891 # v1.2.0
              id: wait-for-image
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  checkName: Build Docker image
                  ref: ${{ github.event.pull_request.head.sha }}
                  timeoutSeconds: 3600
                  intervalSeconds: 30
            - name: Fail if Docker build failed
              if: steps.wait-for-image.outputs.conclusion != 'success'
              run: |
                  echo "Docker image build failed with conclusion: ${{ steps.wait-for-image.outputs.conclusion }}"
                  exit 1

    changes:
        runs-on: ubuntu-24.04
        timeout-minutes: 40
        name: Setup DO Hobby Instance and test
        needs: [wait-for-docker-image]
        if: always() && (needs.wait-for-docker-image.result == 'success' || github.event_name == 'push')
        steps:
            - uses: actions/checkout@v4
              with:
                  clean: false
            - name: Clean up data directories with container permissions
              run: |
                  # Use docker to clean up files created by containers
                  [ -d "data" ] && docker run --rm -v "$(pwd)/data:/data" alpine sh -c "rm -rf /data/seaweedfs /data/minio" || true
              continue-on-error: true
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.8'
            - name: Get python deps
              run: pip install python-digitalocean==1.17.0 requests==2.28.1 paramiko
            - name: Set environment variables from previous job
              run: |
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    PREVIEW_MODE="${{ needs.wait-for-docker-image.outputs.preview-mode }}"
                    COMMENT_ID="${{ needs.wait-for-docker-image.outputs.comment-id }}"
                    echo "PREVIEW_MODE=$PREVIEW_MODE" >> $GITHUB_ENV
                    echo "HOBBY_COMMENT_ID=$COMMENT_ID" >> $GITHUB_ENV
                    if [ "$PREVIEW_MODE" = "true" ]; then
                      echo "üîÑ Preview mode enabled - will reuse droplet if exists"
                    else
                      echo "üß™ Smoke test mode - ephemeral droplet"
                    fi
                  else
                    echo "PREVIEW_MODE=false" >> $GITHUB_ENV
                  fi
            - name: Setup DO Hobby Instance
              run: python3 bin/hobby-ci.py create "$GITHUB_HEAD_REF" "${{ github.run_id }}-${{ github.run_attempt }}" "${{ github.sha }}" "${{ github.event.pull_request.number || 'unknown' }}" 2>&1 | tee /tmp/hobby-ci-output.txt
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
                  DIGITALOCEAN_SSH_PRIVATE_KEY: ${{ secrets.DO_DEPLOY_SSH_PRIVATE_KEY }}
            - name: Update PR comment with instance info
              if: github.event_name == 'pull_request' && env.HOBBY_COMMENT_ID
              uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
              with:
                  script: |
                      const fs = require('fs');
                      const commentMarker = '<!-- hobby-ci-comment -->';
                      const commentId = process.env.HOBBY_COMMENT_ID;
                      const previewMode = process.env.PREVIEW_MODE === 'true';

                      let output = '';
                      try {
                          output = fs.readFileSync('/tmp/hobby-ci-output.txt', 'utf8');
                      } catch (error) {
                          output = 'Could not read hobby-ci output';
                      }

                      const dropletInfo = fs.existsSync('/tmp/droplet_info.txt')
                          ? fs.readFileSync('/tmp/droplet_info.txt', 'utf8')
                          : '';

                      // Parse droplet info for nice display
                      let instanceUrl = '';
                      let sshCommand = '';
                      let dropletIp = '';
                      if (dropletInfo) {
                          const urlMatch = dropletInfo.match(/URL: (.*)/);
                          const sshMatch = dropletInfo.match(/SSH: (.*)/);
                          const ipMatch = dropletInfo.match(/Droplet IP: (.*)/);
                          if (urlMatch) instanceUrl = urlMatch[1];
                          if (sshMatch) sshCommand = sshMatch[1];
                          if (ipMatch) dropletIp = ipMatch[1];
                      }

                      const commentBody = `${commentMarker}
                      ## ü¶î Hobby deployment instance

                      ${previewMode ? '‚úÖ **Preview deployment ready**' : '‚úÖ **Smoke test instance ready**'}

                      ${instanceUrl ? `### üåê Access the instance\n**URL:** ${instanceUrl}\n` : ''}
                      ${sshCommand ? `**SSH:** \`${sshCommand}\`\n` : ''}
                      ${dropletIp ? `**IP:** \`${dropletIp}\`\n` : ''}

                      **Commit:** \`${context.sha.substring(0, 7)}\`
                      **Workflow run:** [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})

                      ${dropletInfo ? '\n<details>\n<summary>Full instance details</summary>\n\n```\n' + dropletInfo + '```\n</details>\n' : ''}

                      <details>
                      <summary>Deployment output</summary>

                      \`\`\`
                      ${output}
                      \`\`\`
                      </details>
                      `;

                      await github.rest.issues.updateComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          comment_id: parseInt(commentId),
                          body: commentBody,
                      });
            - name: Run smoke tests on DO
              id: test
              timeout-minutes: 30
              run: |
                  set +e
                  python3 bin/hobby-ci.py test
                  echo "TEST_EXIT_CODE=$?" >> $GITHUB_ENV
                  exit 0
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
            - name: Generate demo data
              if: env.TEST_EXIT_CODE == '0' && env.PREVIEW_MODE == 'true' && env.HOBBY_DROPLET_NEW == 'true'
              timeout-minutes: 15
              run: python3 bin/hobby-ci.py generate-demo-data
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
                  DIGITALOCEAN_SSH_PRIVATE_KEY: ${{ secrets.DO_DEPLOY_SSH_PRIVATE_KEY }}
            - name: Fetch logs after test
              if: always()
              run: python3 bin/hobby-ci.py fetch-logs || echo "Could not fetch logs"
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
                  DIGITALOCEAN_SSH_PRIVATE_KEY: ${{ secrets.DO_DEPLOY_SSH_PRIVATE_KEY }}
            - name: Show droplet info
              if: always()
              run: cat /tmp/droplet_info.txt 2>/dev/null || echo "No droplet info available"
            - name: Upload logs as artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: hobby-ci-logs
                  path: |
                      /tmp/cloud-init-output.log
                      /tmp/droplet_info.txt
                      /tmp/docker-compose-logs.txt
                  if-no-files-found: warn
            - name: Post-cleanup step
              if: always() && env.PREVIEW_MODE == 'false'
              run: python3 bin/hobby-ci.py destroy
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
            - name: Check test result
              if: always()
              run: |
                  if [ "$TEST_EXIT_CODE" != "0" ]; then
                    echo "‚ùå Test failed with exit code $TEST_EXIT_CODE"
                    exit 1
                  fi
                  echo "‚úÖ Test passed"
