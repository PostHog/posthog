# This workflow runs e2e smoke test for hobby deployment
# To check on the status of the instance if this fails go to DO open the instance
# Instance name should look like `do-ci-hobby-deploy-xxxx`
# SSH onto the instance and `tail -f /var/log/cloud-init-output.log`
name: e2e - hobby smoke test
on:
    push:
        branches:
            - 'release-*.*'
    pull_request:
        paths:
            - docker-compose.base.yml
            - docker-compose.hobby.yml
            - bin/*
            - docker/*
            - .github/workflows/ci-hobby.yml

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    wait-for-docker-image:
        name: Wait for Docker image build
        runs-on: ubuntu-24.04
        timeout-minutes: 60
        if: github.event_name == 'pull_request'
        steps:
            - name: Wait for container image build to complete
              uses: fountainhead/action-wait-for-check@4699210ccc66e2a13260803fadbb77085421b891 # v1.2.0
              id: wait-for-image
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  checkName: Build Docker image
                  ref: ${{ github.event.pull_request.head.sha }}
                  timeoutSeconds: 3600
                  intervalSeconds: 30
            - name: Fail if Docker build failed
              if: steps.wait-for-image.outputs.conclusion != 'success'
              run: |
                  echo "Docker image build failed with conclusion: ${{ steps.wait-for-image.outputs.conclusion }}"
                  exit 1

    changes:
        runs-on: ubuntu-24.04
        timeout-minutes: 40
        name: Setup DO Hobby Instance and test
        needs: [wait-for-docker-image]
        if: always() && (needs.wait-for-docker-image.result == 'success' || github.event_name == 'push')
        steps:
            - uses: actions/checkout@v4
              with:
                  clean: false
            - name: Clean up data directories with container permissions
              run: |
                  # Use docker to clean up files created by containers
                  [ -d "data" ] && docker run --rm -v "$(pwd)/data:/data" alpine sh -c "rm -rf /data/seaweedfs /data/minio" || true
              continue-on-error: true
            - uses: actions/setup-python@v5
              with:
                  python-version: '3.8'
            - name: Get python deps
              run: pip install python-digitalocean==1.17.0 requests==2.28.1 paramiko
            - name: Check for preview mode
              id: check-preview
              run: |
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    LABELS=$(gh pr view ${{ github.event.pull_request.number }} --json labels -q '.labels[].name' 2>/dev/null || echo "")
                    if echo "$LABELS" | grep -q "hobby-preview"; then
                      echo "PREVIEW_MODE=true" >> $GITHUB_ENV
                      echo "preview=true" >> $GITHUB_OUTPUT
                      echo "üîÑ Preview mode enabled - will reuse droplet if exists"
                    else
                      echo "PREVIEW_MODE=false" >> $GITHUB_ENV
                      echo "preview=false" >> $GITHUB_OUTPUT
                      echo "üß™ Smoke test mode - ephemeral droplet"
                    fi
                  else
                    echo "PREVIEW_MODE=false" >> $GITHUB_ENV
                    echo "preview=false" >> $GITHUB_OUTPUT
                  fi
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            - name: Setup DO Hobby Instance
              run: python3 bin/hobby-ci.py create "$GITHUB_HEAD_REF" "${{ github.run_id }}-${{ github.run_attempt }}" "${{ github.sha }}" "${{ github.event.pull_request.number || 'unknown' }}"
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
                  DIGITALOCEAN_SSH_PRIVATE_KEY: ${{ secrets.DO_DEPLOY_SSH_PRIVATE_KEY }}
            - name: Run smoke tests on DO
              id: test
              timeout-minutes: 30
              run: |
                  set +e
                  python3 bin/hobby-ci.py test
                  echo "TEST_EXIT_CODE=$?" >> $GITHUB_ENV
                  exit 0
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
            - name: Fetch logs after test
              if: always()
              run: python3 bin/hobby-ci.py fetch-logs || echo "Could not fetch logs"
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
            - name: Show droplet info
              if: always()
              run: cat /tmp/droplet_info.txt 2>/dev/null || echo "No droplet info available"
            - name: Upload logs as artifact
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: hobby-ci-logs
                  path: |
                      /tmp/cloud-init-output.log
                      /tmp/droplet_info.txt
                      /tmp/docker-compose-logs.txt
                  if-no-files-found: warn
            - name: Post-cleanup step
              if: always() && env.PREVIEW_MODE == 'false'
              run: python3 bin/hobby-ci.py destroy
              env:
                  DIGITALOCEAN_TOKEN: ${{ secrets.DIGITAL_OCEAN_HOBBY_TOKEN }}
            - name: Check test result
              if: always()
              run: |
                  if [ "$TEST_EXIT_CODE" != "0" ]; then
                    echo "‚ùå Test failed with exit code $TEST_EXIT_CODE"
                    exit 1
                  fi
                  echo "‚úÖ Test passed"
