name: Turbo CI
on:
    pull_request:

jobs:
    turbo-affected-4:
        timeout-minutes: 30
        name: Turbo Affected
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                # os: [depot-ubuntu-22.04, depot-ubuntu-22.04-4]
                os: [depot-ubuntu-22.04-4]
        permissions:
            contents: read

        steps:
            - name: Check out code
              uses: actions/checkout@v6
              with:
                  # Just fetch the current commit/PR head
                  fetch-depth: 1

            - name: Detect architecture
              if: ${{ runner.os == 'Linux' || runner.os == 'macOS' }}
              run: |
                  ARCH=$(uname -m)
                  echo "ARCH=$ARCH" >> $GITHUB_ENV

            # Conditionally fetch the base branch so Turborepo can compare against it
            - name: Fetch base branch
              run: |
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    git fetch origin refs/heads/${GITHUB_BASE_REF}:refs/heads/${GITHUB_BASE_REF} --depth=1
                    echo "TURBO_SCM_BASE=${GITHUB_BASE_REF}" >> $GITHUB_ENV
                  else
                    git fetch origin refs/heads/master:refs/heads/master --depth=1
                    echo "TURBO_SCM_BASE=master" >> $GITHUB_ENV
                  fi

            - name: Set up Python
              uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405  # v6.2.0
              with:
                  python-version-file: 'pyproject.toml'

            - name: Install uv
              id: setup-uv
              uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
              with:
                  version: '0.10.2' # pinned: unpinned setup-uv calls GH API on every job, exhausts rate limit
                  enable-cache: true

            - name: Install pnpm
              uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

            - name: Fix node-gyp permissions
              run: chmod +x ~/setup-pnpm/node_modules/.pnpm/pnpm@*/node_modules/pnpm/dist/node_modules/node-gyp/gyp/gyp_main.py

            - name: Set up Node.js
              uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
              with:
                  node-version: 18
                  cache: 'pnpm'

            - name: Restore node-gyp cache
              uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5
              with:
                  path: ~/.cache/node-gyp
                  key: ${{ runner.os }}-${{ env.ARCH }}-node-gyp-node-18-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-${{ env.ARCH }}-node-gyp-node-18-

            - name: Run Python and Node setup in parallel
              run: |
                  set -e
                  set -m

                  (
                    if [ "${{ steps.setup-uv.outputs.cache-hit }}" != "true" ]; then
                      echo ">>> [Python] Installing SAML (python3-saml) dependencies..."
                      sudo apt-get update
                      sudo apt-get install -y libxml2-dev libxmlsec1 libxmlsec1-dev libxmlsec1-openssl
                    fi

                    echo ">>> [Python] Installing dependencies..."
                    UV_PROJECT_ENVIRONMENT=$pythonLocation uv sync --frozen --dev
                  ) &
                  PY_PID=$!

                  (
                    echo ">>> [Node] Installing dependencies..."
                    pnpm install --frozen-lockfile
                  ) &
                  NODE_PID=$!

                  wait -n || (echo ">>> One of the parallel tasks failed, killing the other..." && kill $PY_PID $NODE_PID 2>/dev/null && exit 1)
                  wait -n || (echo ">>> The second parallel task failed" && exit 1)

                  echo ">>> Both parallel tasks completed successfully!"

            - name: Turbo Affected
              run: |
                  bin/turbo build --affected --dry-run
              env:
                  NODE_OPTIONS: --max-old-space-size=8192
                  TURBO_SCM_BASE: ${{ env.TURBO_SCM_BASE }}

            - name: Save node-gyp cache
              uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5
              with:
                  path: ~/.cache/node-gyp
                  key: ${{ runner.os }}-${{ env.ARCH }}-node-gyp-node-18-${{ hashFiles('**/pnpm-lock.yaml') }}
