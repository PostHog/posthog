name: Turbo CI
on:
    pull_request:

jobs:
    turbo-affected-4:
        timeout-minutes: 30
        name: Turbo Affected
        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                # os: [depot-ubuntu-22.04, depot-ubuntu-22.04-4]
                os: [depot-ubuntu-22.04-4]
        permissions:
            contents: read

        steps:
            - name: Check out code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
              with:
                  # Just fetch the current commit/PR head
                  fetch-depth: 1

            - name: Detect architecture
              if: ${{ runner.os == 'Linux' || runner.os == 'macOS' }}
              run: |
                  ARCH=$(uname -m)
                  echo "ARCH=$ARCH" >> $GITHUB_ENV

            # Conditionally fetch the base branch so Turborepo can compare against it
            - name: Fetch base branch
              run: |
                  if [ "${{ github.event_name }}" = "pull_request" ]; then
                    git fetch origin refs/heads/${GITHUB_BASE_REF}:refs/heads/${GITHUB_BASE_REF} --depth=1
                    echo "TURBO_SCM_BASE=${GITHUB_BASE_REF}" >> $GITHUB_ENV
                  else
                    git fetch origin refs/heads/master:refs/heads/master --depth=1
                    echo "TURBO_SCM_BASE=master" >> $GITHUB_ENV
                  fi

            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
              with:
                  python-version-file: 'pyproject.toml'

            - name: Install uv
              id: setup-uv
              uses: astral-sh/setup-uv@681c641aba71e4a1c380be3ab5e12ad51f415867 # v7.1.6
              with:
                  enable-cache: true
                  version: 0.9.9

            - name: Install pnpm
              uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

            - name: Set up Node.js
              uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
              with:
                  node-version: 18
                  cache: 'pnpm'

            - name: Cache node-gyp artifacts
              uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb # v5.0.1
              with:
                  path: ~/.cache/node-gyp
                  key: ${{ runner.os }}-${{ env.ARCH }}-node-gyp-node-${{ matrix.node-version }}-${{ hashFiles('**/pnpm-lock.yaml') }}
                  restore-keys: |
                      ${{ runner.os }}-${{ env.ARCH }}-node-gyp-node-${{ matrix.node-version }}-

            - name: Run Python and Node setup in parallel
              run: |
                  set -e
                  set -m

                  (
                    if [ "${{ steps.setup-uv.outputs.cache-hit }}" != "true" ]; then
                      echo ">>> [Python] Installing SAML (python3-saml) dependencies..."
                      sudo apt-get update
                      sudo apt-get install -y libxml2-dev libxmlsec1 libxmlsec1-dev libxmlsec1-openssl
                    fi

                    echo ">>> [Python] Installing dependencies..."
                    UV_PROJECT_ENVIRONMENT=$pythonLocation uv sync --frozen --dev
                  ) &
                  PY_PID=$!

                  (
                    echo ">>> [Node] Installing dependencies..."
                    pnpm install --frozen-lockfile
                  ) &
                  NODE_PID=$!

                  wait -n || (echo ">>> One of the parallel tasks failed, killing the other..." && kill $PY_PID $NODE_PID 2>/dev/null && exit 1)
                  wait -n || (echo ">>> The second parallel task failed" && exit 1)

                  echo ">>> Both parallel tasks completed successfully!"

            - name: Turbo Affected
              run: |
                  bin/turbo build --affected --dry-run
              env:
                  NODE_OPTIONS: --max-old-space-size=8192
                  TURBO_SCM_BASE: ${{ env.TURBO_SCM_BASE }}
