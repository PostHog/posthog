name: Build and Deploy to GKE

on:
    - pull_request

env:
    PROJECT_ID: ${{ secrets.GKE_PROJECT_EE_TEST }}
    GKE_CLUSTER: ee-test # Add your cluster name here.
    GKE_ZONE: us-central1-c # Add your cluster zone here.
    DEPLOYMENT_NAME: posthog # Add your deployment name here.
    IMAGE: posthog # the image name that's pushed to google
    REGISTRY_HOSTNAME: gcr.io
    AWS_REGION: us-east-2 # for helm repo and update

jobs:
    setup-build-publish-deploy:
        name: Setup, Build, Publish, and Deploy
        runs-on: ubuntu-latest
        steps:
            # pulls the repo this is running on because later I'm going to docker build, basically git clone posthog
            - name: Checkout
              uses: actions/checkout@v2

            # Setup gcloud CLI
            - uses: google-github-actions/setup-gcloud@master
              with:
                  service_account_key: ${{ secrets.GKE_SA_KEY_TEST_EE }}
                  project_id: ${{ secrets.GKE_PROJECT_EE_TEST }}
                  export_default_credentials: true

            # Configure docker to use the gcloud command-line tool as a credential helper
            - run: |-
                  gcloud --quiet auth configure-docker

            # Get the GKE credentials so we can deploy to the cluster
            - uses: google-github-actions/get-gke-credentials@main
              with:
                  cluster_name: ${{ env.GKE_CLUSTER }}
                  location: ${{ env.GKE_ZONE }}
                  credentials: ${{ secrets.GKE_SA_KEY_TEST_EE }}

            # Build the Docker image
            - name: Build
              run: |-
                  docker build \
                    --tag "$REGISTRY_HOSTNAME/$PROJECT_ID/$IMAGE:$GITHUB_SHA" \
                    --build-arg GITHUB_SHA="$GITHUB_SHA" \
                    --build-arg GITHUB_REF="$GITHUB_REF" \
                    .

            # Push the Docker image to Google Container Registry
            - name: Publish
              run: |-
                  docker push "$REGISTRY_HOSTNAME/$PROJECT_ID/$IMAGE:$GITHUB_SHA"

            # Checkout vpc repo for values.yaml
            - name: Checkout Posthog/vpc
              uses: actions/checkout@v2
              with:
                  repository: Posthog/vpc
                  token: ${{ secrets.POSTHOG_BOT_GITHUB_TOKEN }}
                  path: vpc

            # Helm update
            - name: Helm upgrade
              run: |-
                  helm plugin install https://github.com/hypnoglow/helm-s3.git
                  helm upgrade posthog vpc/charts/posthog -f vpc/client_values/posthog/values.yaml --set image.repository="$REGISTRY_HOSTNAME/$PROJECT_ID/posthog" --set image.sha="$GITHUB_SHA"
