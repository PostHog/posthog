name: Master CI Status

on:
    workflow_run:
        branches: [master]
        types: [completed]

env:
    # #flakey-tests channel until we're confident, then move to a more visible channel
    SLACK_CHANNEL: 'C09ADEV3AJD'

permissions:
    contents: read
    actions: read

jobs:
    check-master-status:
        runs-on: ubuntu-latest
        # Only run for actual master push events, not PR merges
        if: github.event.workflow_run.event == 'push'
        steps:
            - uses: actions/checkout@v4

            # Restore incident state from cache
            - name: Restore incident state
              id: cache
              uses: actions/cache/restore@v4
              with:
                  path: .master-ci-incident
                  key: master-ci-incident

            - name: Read incident state
              id: incident
              run: |
                  if [ -f .master-ci-incident ]; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "channel=$(jq -r '.channel' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "ts=$(jq -r '.ts' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "since=$(jq -r '.since' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "failCount=$(jq -r '.failCount // 1' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "commitCount=$(jq -r '.commitCount // 1' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "commits=$(jq -r '.commits // []' .master-ci-incident)" >> $GITHUB_OUTPUT
                    echo "Current incident:"
                    cat .master-ci-incident
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "No active incident"
                  fi

            # Get commit info for better messages
            - name: Get commit info
              id: commit
              uses: actions/github-script@v7
              with:
                  script: |
                      const sha = '${{ github.event.workflow_run.head_sha }}';
                      const { data: commit } = await github.rest.repos.getCommit({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: sha
                      });
                      const shortSha = sha.substring(0, 7);
                      const message = commit.commit.message.split('\n')[0].substring(0, 50);
                      const author = commit.author?.login || commit.commit.author.name;
                      core.setOutput('short_sha', shortSha);
                      core.setOutput('message', message);
                      core.setOutput('author', author);
                      core.setOutput('url', commit.html_url);

            # ============ ON FAILURE ============

            # New incident - post initial alert
            - name: Post new incident to Slack
              if: github.event.workflow_run.conclusion == 'failure' && steps.incident.outputs.exists == 'false'
              id: slack_new
              uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  errors: true
                  payload: |
                      channel: "${{ env.SLACK_CHANNEL }}"
                      text: ":red_circle: Master is red (1 commit, 1 workflow failing)"
                      blocks:
                        - type: "section"
                          text:
                            type: "mrkdwn"
                            text: ":red_circle: *Master is red* (1 commit, 1 workflow failing)"
                        - type: "section"
                          fields:
                            - type: "mrkdwn"
                              text: "*Workflow*\n${{ github.event.workflow_run.name }}"
                            - type: "mrkdwn"
                              text: "*Author*\n${{ steps.commit.outputs.author }}"
                        - type: "section"
                          text:
                            type: "mrkdwn"
                            text: "*Commit*\n<${{ steps.commit.outputs.url }}|${{ steps.commit.outputs.short_sha }}> ${{ steps.commit.outputs.message }}"
                        - type: "actions"
                          elements:
                            - type: "button"
                              text:
                                type: "plain_text"
                                text: "View failing run →"
                              url: "${{ github.event.workflow_run.html_url }}"

            - name: Save new incident state
              if: github.event.workflow_run.conclusion == 'failure' && steps.incident.outputs.exists == 'false'
              run: |
                  jq -n \
                    --arg channel "${{ steps.slack_new.outputs.channel_id }}" \
                    --arg ts "${{ steps.slack_new.outputs.ts }}" \
                    --arg since "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                    --arg firstFailure "${{ github.event.workflow_run.name }}" \
                    --arg firstCommit "${{ github.event.workflow_run.head_sha }}" \
                    --argjson failCount 1 \
                    --argjson commitCount 1 \
                    '{channel: $channel, ts: $ts, since: $since, firstFailure: $firstFailure, failCount: $failCount, commitCount: $commitCount, commits: [$firstCommit]}' > .master-ci-incident
                  cat .master-ci-incident

            # Existing incident - update message count and add thread reply
            - name: Update incident counts
              if: github.event.workflow_run.conclusion == 'failure' && steps.incident.outputs.exists == 'true'
              id: new_count
              run: |
                  # Always increment workflow fail count
                  fail_count=$(( ${{ steps.incident.outputs.failCount }} + 1 ))
                  echo "failCount=$fail_count" >> $GITHUB_OUTPUT

                  # Check if this commit is new
                  current_sha="${{ github.event.workflow_run.head_sha }}"
                  if jq -e --arg sha "$current_sha" '.commits | index($sha)' .master-ci-incident > /dev/null 2>&1; then
                    # Commit already tracked
                    echo "commitCount=${{ steps.incident.outputs.commitCount }}" >> $GITHUB_OUTPUT
                    echo "is_new_commit=false" >> $GITHUB_OUTPUT
                  else
                    # New commit
                    commit_count=$(( ${{ steps.incident.outputs.commitCount }} + 1 ))
                    echo "commitCount=$commit_count" >> $GITHUB_OUTPUT
                    echo "is_new_commit=true" >> $GITHUB_OUTPUT
                  fi

            - name: Update Slack message with new count
              if: github.event.workflow_run.conclusion == 'failure' && steps.incident.outputs.exists == 'true'
              uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
              with:
                  method: chat.update
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  errors: true
                  payload: |
                      channel: "${{ steps.incident.outputs.channel }}"
                      ts: "${{ steps.incident.outputs.ts }}"
                      text: ":red_circle: Master is red (${{ steps.new_count.outputs.commitCount }} commits, ${{ steps.new_count.outputs.failCount }} workflows failing)"
                      blocks:
                        - type: "section"
                          text:
                            type: "mrkdwn"
                            text: ":red_circle: *Master is red* (${{ steps.new_count.outputs.commitCount }} commits, ${{ steps.new_count.outputs.failCount }} workflows failing)"
                        - type: "section"
                          fields:
                            - type: "mrkdwn"
                              text: "*Latest*\n${{ github.event.workflow_run.name }}"
                            - type: "mrkdwn"
                              text: "*Author*\n${{ steps.commit.outputs.author }}"
                        - type: "section"
                          text:
                            type: "mrkdwn"
                            text: "*Commit*\n<${{ steps.commit.outputs.url }}|${{ steps.commit.outputs.short_sha }}> ${{ steps.commit.outputs.message }}"
                        - type: "actions"
                          elements:
                            - type: "button"
                              text:
                                type: "plain_text"
                                text: "View failing run →"
                              url: "${{ github.event.workflow_run.html_url }}"

            - name: Thread reply with failure details
              if: github.event.workflow_run.conclusion == 'failure' && steps.incident.outputs.exists == 'true'
              uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: "${{ steps.incident.outputs.channel }}"
                      thread_ts: "${{ steps.incident.outputs.ts }}"
                      text: "Also failing: *${{ github.event.workflow_run.name }}* (${{ steps.commit.outputs.short_sha }})\n<${{ github.event.workflow_run.html_url }}|View run →>"

            - name: Update incident state with new counts
              if: github.event.workflow_run.conclusion == 'failure' && steps.incident.outputs.exists == 'true'
              run: |
                  current_sha="${{ github.event.workflow_run.head_sha }}"
                  jq \
                    --argjson failCount ${{ steps.new_count.outputs.failCount }} \
                    --argjson commitCount ${{ steps.new_count.outputs.commitCount }} \
                    --arg newCommit "$current_sha" \
                    '.failCount = $failCount | .commitCount = $commitCount | if (.commits | index($newCommit)) then . else .commits += [$newCommit] end' \
                    .master-ci-incident > .master-ci-incident.tmp
                  mv .master-ci-incident.tmp .master-ci-incident
                  cat .master-ci-incident

            # ============ ON SUCCESS ============

            - name: Check if all workflows are green
              if: github.event.workflow_run.conclusion == 'success' && steps.incident.outputs.exists == 'true'
              id: check_green
              uses: actions/github-script@v7
              with:
                  script: |
                      const { data } = await github.rest.checks.listForRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: '${{ github.event.workflow_run.head_sha }}'
                      });

                      const failing = data.check_runs.filter(c =>
                        c.status === 'completed' &&
                        c.conclusion !== 'success' &&
                        c.conclusion !== 'skipped' &&
                        c.name !== 'check-master-status'
                      );

                      core.setOutput('all_green', failing.length === 0 ? 'true' : 'false');
                      core.setOutput('still_failing', failing.map(c => c.name).join(', '));
                      console.log('Failing checks:', failing.map(c => c.name));

            - name: Calculate incident duration
              if: github.event.workflow_run.conclusion == 'success' && steps.incident.outputs.exists == 'true' && steps.check_green.outputs.all_green == 'true'
              id: duration
              run: |
                  since="${{ steps.incident.outputs.since }}"
                  now=$(date +%s)
                  then=$(date -d "$since" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%SZ" "$since" +%s 2>/dev/null || echo "$now")
                  mins=$(( (now - then) / 60 ))
                  echo "mins=$mins" >> $GITHUB_OUTPUT

            - name: Update Slack message to resolved
              if: github.event.workflow_run.conclusion == 'success' && steps.incident.outputs.exists == 'true' && steps.check_green.outputs.all_green == 'true'
              uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
              with:
                  method: chat.update
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  errors: true
                  payload: |
                      channel: "${{ steps.incident.outputs.channel }}"
                      ts: "${{ steps.incident.outputs.ts }}"
                      text: ":large_green_circle: Master is green (was red for ~${{ steps.duration.outputs.mins }} min, ${{ steps.incident.outputs.commitCount }} commits affected)"
                      blocks:
                        - type: "section"
                          text:
                            type: "mrkdwn"
                            text: ":large_green_circle: *Master is green* (was red for ~${{ steps.duration.outputs.mins }} min, ${{ steps.incident.outputs.commitCount }} commits affected)"
                        - type: "section"
                          fields:
                            - type: "mrkdwn"
                              text: "*Fixed after*\n${{ github.event.workflow_run.name }} passed"
                            - type: "mrkdwn"
                              text: "*Author*\n${{ steps.commit.outputs.author }}"
                        - type: "section"
                          text:
                            type: "mrkdwn"
                            text: "*Commit*\n<${{ steps.commit.outputs.url }}|${{ steps.commit.outputs.short_sha }}> ${{ steps.commit.outputs.message }}"

            - name: Thread reply with resolution
              if: github.event.workflow_run.conclusion == 'success' && steps.incident.outputs.exists == 'true' && steps.check_green.outputs.all_green == 'true'
              uses: slackapi/slack-github-action@91efab103c0de0a537f72a35f6b8cda0ee76bf0a # v2.1.1
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: "${{ steps.incident.outputs.channel }}"
                      thread_ts: "${{ steps.incident.outputs.ts }}"
                      text: ":white_check_mark: Resolved: *${{ github.event.workflow_run.name }}* passed (${{ steps.commit.outputs.short_sha }})"

            - name: Clear incident state
              if: github.event.workflow_run.conclusion == 'success' && steps.incident.outputs.exists == 'true' && steps.check_green.outputs.all_green == 'true'
              run: rm -f .master-ci-incident

            # ============ SAVE CACHE ============

            - name: Delete old cache
              if: github.event.workflow_run.conclusion == 'failure'
              continue-on-error: true
              env:
                  GH_TOKEN: ${{ github.token }}
              run: gh cache delete master-ci-incident || true

            - name: Save incident to cache
              if: github.event.workflow_run.conclusion == 'failure'
              uses: actions/cache/save@v4
              with:
                  path: .master-ci-incident
                  key: master-ci-incident

            - name: Delete cache on resolution
              if: github.event.workflow_run.conclusion == 'success' && steps.incident.outputs.exists == 'true' && steps.check_green.outputs.all_green == 'true'
              continue-on-error: true
              env:
                  GH_TOKEN: ${{ github.token }}
              run: gh cache delete master-ci-incident || true
