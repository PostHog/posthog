name: Master CI Status

on:
    workflow_run:
        branches: [master]
        types: [completed]

jobs:
    check-master-status:
        runs-on: ubuntu-latest
        # Only run for actual master push events, not PR merges
        if: github.event.workflow_run.event == 'push'
        steps:
            - name: Get incident state
              id: incident
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.POSTHOG_BOT_PAT }}
                  script: |
                      try {
                        const { data } = await github.rest.actions.getRepoVariable({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          name: 'MASTER_CI_INCIDENT'
                        });
                        const incident = data.value ? JSON.parse(data.value) : null;
                        core.setOutput('exists', incident ? 'true' : 'false');
                        core.setOutput('channel', incident?.channel || '');
                        core.setOutput('ts', incident?.ts || '');
                        core.setOutput('since', incident?.since || '');
                      } catch (e) {
                        if (e.status === 404) {
                          core.setOutput('exists', 'false');
                        } else throw e;
                      }

            # On FAILURE: Create or update incident
            - name: Post new incident to Slack
              if: github.event.workflow_run.conclusion == 'failure' && steps.incident.outputs.exists == 'false'
              id: slack_new
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: "CXXXXXXXX"
                      text: ":red_circle: *Master is red*\n${{ github.event.workflow_run.name }} failed\n<${{ github.event.workflow_run.html_url }}|View run>"

            - name: Save new incident state
              if: github.event.workflow_run.conclusion == 'failure' && steps.incident.outputs.exists == 'false'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.POSTHOG_BOT_PAT }}
                  script: |
                      const value = JSON.stringify({
                        channel: '${{ steps.slack_new.outputs.channel_id }}',
                        ts: '${{ steps.slack_new.outputs.ts }}',
                        since: new Date().toISOString(),
                        firstFailure: '${{ github.event.workflow_run.name }}'
                      });
                      try {
                        await github.rest.actions.updateRepoVariable({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          name: 'MASTER_CI_INCIDENT',
                          value
                        });
                      } catch (e) {
                        if (e.status === 404) {
                          await github.rest.actions.createRepoVariable({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            name: 'MASTER_CI_INCIDENT',
                            value
                          });
                        } else throw e;
                      }

            - name: Thread reply to existing incident
              if: github.event.workflow_run.conclusion == 'failure' && steps.incident.outputs.exists == 'true'
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.postMessage
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: "${{ steps.incident.outputs.channel }}"
                      thread_ts: "${{ steps.incident.outputs.ts }}"
                      text: "Still failing: ${{ github.event.workflow_run.name }}\n<${{ github.event.workflow_run.html_url }}|View run>"

            # On SUCCESS: Check if all green, then resolve
            - name: Check all workflows status
              if: github.event.workflow_run.conclusion == 'success' && steps.incident.outputs.exists == 'true'
              id: check_green
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.POSTHOG_BOT_PAT }}
                  script: |
                      const { data } = await github.rest.checks.listForRef({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        ref: '${{ github.event.workflow_run.head_sha }}'
                      });

                      const failing = data.check_runs.filter(c =>
                        c.status === 'completed' &&
                        c.conclusion !== 'success' &&
                        c.conclusion !== 'skipped' &&
                        c.name !== 'check-master-status'
                      );

                      core.setOutput('all_green', failing.length === 0 ? 'true' : 'false');
                      core.setOutput('still_failing', failing.map(c => c.name).join(', '));

            - name: Calculate incident duration
              if: github.event.workflow_run.conclusion == 'success' && steps.incident.outputs.exists == 'true' && steps.check_green.outputs.all_green == 'true'
              id: duration
              run: |
                  since="${{ steps.incident.outputs.since }}"
                  now=$(date +%s)
                  then=$(date -d "$since" +%s 2>/dev/null || date -j -f "%Y-%m-%dT%H:%M:%S" "${since%%.*}" +%s)
                  mins=$(( (now - then) / 60 ))
                  echo "mins=$mins" >> $GITHUB_OUTPUT

            - name: Update Slack message to resolved
              if: github.event.workflow_run.conclusion == 'success' && steps.incident.outputs.exists == 'true' && steps.check_green.outputs.all_green == 'true'
              uses: slackapi/slack-github-action@v2.1.0
              with:
                  method: chat.update
                  token: ${{ secrets.SLACK_BOT_TOKEN }}
                  payload: |
                      channel: "${{ steps.incident.outputs.channel }}"
                      ts: "${{ steps.incident.outputs.ts }}"
                      text: ":large_green_circle: *Master is green* (was red for ~${{ steps.duration.outputs.mins }} min)\nResolved after ${{ github.event.workflow_run.name }} passed"

            - name: Clear incident state
              if: github.event.workflow_run.conclusion == 'success' && steps.incident.outputs.exists == 'true' && steps.check_green.outputs.all_green == 'true'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.POSTHOG_BOT_PAT }}
                  script: |
                      await github.rest.actions.updateRepoVariable({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        name: 'MASTER_CI_INCIDENT',
                        value: ''
                      });
