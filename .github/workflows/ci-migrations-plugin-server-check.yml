name: Migration & Nodejs Services Separation Check

on:
    pull_request:
    merge_group:

permissions:
    contents: read

jobs:
    check-migration-nodejs-separation:
        name: Check migrations and nodejs changes are not in same PR
        runs-on: ubuntu-latest
        timeout-minutes: 5
        steps:
            - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

            - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
              id: filter
              with:
                  filters: |
                      migrations:
                          - 'posthog/migrations/*.py'
                          - 'posthog/clickhouse/migrations/*.py'
                          - 'products/*/backend/migrations/*.py'
                          - 'ee/migrations/*.py'
                          - 'rust/persons_migrations/*.sql'
                      nodejs:
                          - 'nodejs/**'

            - name: Check for conflicting changes
              id: check
              run: |
                  if [ "${{ steps.filter.outputs.migrations }}" == "true" ] && [ "${{ steps.filter.outputs.nodejs }}" == "true" ]; then
                      echo "error=true" >> $GITHUB_OUTPUT
                      echo "❌ Found both migration and nodejs changes"
                  else
                      echo "error=false" >> $GITHUB_OUTPUT
                      echo "✅ No conflicting changes detected"
                  fi

            - name: Fail if conflicting changes detected
              if: steps.check.outputs.error == 'true'
              run: |
                  echo "::error::This PR contains both migration files and nodejs changes. These must be separated into different PRs."
                  exit 1
