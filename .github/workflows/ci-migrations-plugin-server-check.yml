name: Migration & Plugin Server Separation Check

on:
    pull_request:
    merge_group:

permissions:
    pull-requests: write
    contents: read

jobs:
    check-migration-plugin-server-separation:
        name: Check migrations and plugin-server changes are not in same PR
        runs-on: ubuntu-latest
        timeout-minutes: 5
        steps:
            - uses: actions/checkout@v4

            - uses: dorny/paths-filter@4512585405083f25c027a35db413c2b3b9006d50 # v2
              id: filter
              with:
                  filters: |
                      migrations:
                          - 'posthog/migrations/*.py'
                          - 'posthog/clickhouse/migrations/*.py'
                          - 'products/*/backend/migrations/*.py'
                          - 'products/*/migrations/*.py'
                          - 'ee/migrations/*.py'
                          - 'ee/clickhouse/migrations/*.py'
                          - 'rust/persons_migrations/*.sql'
                      plugin_server:
                          - 'plugin-server/**'

            - name: Check for conflicting changes
              id: check
              run: |
                  if [ "${{ steps.filter.outputs.migrations }}" == "true" ] && [ "${{ steps.filter.outputs.plugin_server }}" == "true" ]; then
                      echo "error=true" >> $GITHUB_OUTPUT
                      echo "❌ Found both migration and plugin-server changes"
                  else
                      echo "error=false" >> $GITHUB_OUTPUT
                      echo "✅ No conflicting changes detected"
                  fi

            - name: Comment on PR
              if: steps.check.outputs.error == 'true' && github.event_name == 'pull_request'
              uses: actions/github-script@v7
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      await github.rest.issues.createComment({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                          body: '⚠️ **This PR contains both migration and plugin-server changes.**\n\nPlease split into separate PRs:\n1. One PR for migrations\n2. Another PR for plugin-server changes\n3. Deploy migrations first, then plugin-server\n\nThis ensures safe deployment and easier rollbacks.'
                      });

            - name: Fail if conflicting changes detected
              if: steps.check.outputs.error == 'true'
              run: |
                  echo "::error::This PR contains both migration files and plugin-server changes. These must be separated into different PRs."
                  exit 1
