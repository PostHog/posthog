name: Release hogql-parser npm

on:
    pull_request:
        paths:
            - common/hogql_parser/**
            - .github/workflows/build-hogql-parser-npm.yml

permissions:
    contents: read
    pull-requests: write

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    check-package-version:
        name: Check npm package version
        runs-on: ubuntu-24.04
        outputs:
            committed-version: ${{ steps.check-package-version.outputs.committed-version }}
            published-version: ${{ steps.check-package-version.outputs.published-version }}
            is-new-version: ${{ steps.check-package-version.outputs.is-new-version }}
        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0
                  filter: blob:none

            - name: Check if common/hogql_parser/ has changed
              id: changed-files
              uses: step-security/changed-files@95b56dadb92a30ca9036f16423fd3c088a71ee94 # v46.0.5
              with:
                  since_last_remote_commit: true
                  files_yaml: |
                      parser:
                      - common/hogql_parser/**

            - name: Check package version and detect an update
              id: check-package-version
              uses: PostHog/check-package-version@138438a8fed9213fa112f841b1c89f9bd68f5cca # v2.1.0
              with:
                  path: common/hogql_parser

            - name: Comment on PR if version not bumped
              if: steps.changed-files.outputs.parser_any_changed == 'true' && steps.check-package-version.outputs.is-new-version == 'false'
              env:
                  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  message_body="It looks like the code of \`@posthog/hogql-parser\` (npm) has changed since last push, but its version stayed the same at ${{ steps.check-package-version.outputs.committed-version }}. ðŸ‘€\nMake sure to resolve this in \`common/hogql_parser/package.json\` before merging!${{ github.event.pull_request.head.repo.full_name != 'PostHog/posthog' && '\nThis needs to be performed on a branch created on the PostHog/posthog repo itself. A PostHog team member will assist with this.' || ''}}"
                  gh pr comment ${{ github.event.pull_request.number }} --body "$message_body"

    build-wasm:
        name: Build WASM
        needs: check-package-version
        runs-on: ubuntu-24.04
        timeout-minutes: 30
        if: needs.check-package-version.outputs.is-new-version == 'true' &&
            github.event.pull_request.head.repo.full_name == 'PostHog/posthog'
        steps:
            - uses: actions/checkout@v6

            - name: Setup Emscripten for WASM build
              uses: ./.github/actions/setup-emsdk

            - name: Install Ninja
              run: sudo apt-get install -y ninja-build

            - name: Build WASM package
              run: cd common/hogql_parser && npm run build

            - name: Upload dist artifact
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
              with:
                  name: hogql-parser-dist
                  path: common/hogql_parser/dist/
                  if-no-files-found: error

    publish-npm:
        name: Publish on npm
        needs: build-wasm
        runs-on: ubuntu-24.04
        permissions:
            contents: read
            id-token: write
        steps:
            - uses: actions/checkout@v6

            - name: Download dist artifact
              uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
              with:
                  name: hogql-parser-dist
                  path: common/hogql_parser/dist

            - name: Set up Node 24
              uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
              with:
                  node-version: 24
                  registry-url: https://registry.npmjs.org

            - name: Publish package to npm
              run: cd common/hogql_parser && npm publish --access public
              env:
                  NODE_AUTH_TOKEN: ''
                  NPM_CONFIG_PROVENANCE: true

            # Use GitHub app token so Actions run after committing changes
            - name: Get app token
              id: app-token
              uses: getsentry/action-github-app-token@d4b5da6c5e37703f8c3b3e43abb5705b46e159cc # v3.0.0
              with:
                  app_id: ${{ secrets.GH_APP_POSTHOG_TESTS_APP_ID }}
                  private_key: ${{ secrets.GH_APP_POSTHOG_TESTS_PRIVATE_KEY }}

            - uses: actions/checkout@v6
              with:
                  ref: ${{ github.event.pull_request.head.ref }}
                  token: ${{ steps.app-token.outputs.token }}

            - name: Install pnpm
              uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

            - name: Set up Node 24
              uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
              with:
                  node-version: 24
                  cache: 'pnpm'

            - name: Update @posthog/hogql-parser in frontend
              shell: bash
              env:
                  RETRIES: 20
              run: |
                  VERSION=$(node -p "require('./common/hogql_parser/package.json').version")
                  for i in $(seq 1 $RETRIES); do
                      if pnpm --filter=@posthog/frontend add "@posthog/hogql-parser@$VERSION"; then
                          break
                      fi
                      if [[ $i -eq $RETRIES ]]; then
                        echo "Failed to update @posthog/hogql-parser in frontend"
                        exit 1
                      fi
                      sleep 0.5
                  done

            - uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5 # v9.1.4
              with:
                  add: '["frontend/package.json", "pnpm-lock.yaml"]'
                  message: 'Use new @posthog/hogql-parser npm version'
                  default_author: github_actions
                  github_token: ${{ steps.app-token.outputs.token }}
