#
# Build and push PostHog and PostHog Cloud container images
#
# - posthog_build: build and push the PostHog container image to DockerHub
#
# - posthog_cloud_build: build the PostHog Cloud container image using
#   as base image the container image from the previous step. The image is
#   then pushed to AWS ECR.
#
name: Test Dagster

on:
    pull_request:

jobs:
    reload:
        runs-on: ubuntu-24.04
        steps:
            # - name: Check for changes that affect dagster code locations
            #   id: check_changes_dagster_code_location
            #   run: |
            #       echo "changed=$((git diff --name-only HEAD^ HEAD | grep -qE '^dags/' && echo true) || echo false)" >> $GITHUB_OUTPUT

            - name: Trigger Dagster Code Location Reload
              if: steps.check_changes_dagster_code_location.outputs.changed == 'true'
              uses: peter-evans/repository-dispatch@v3
              with:
                  token: ${{ steps.deployer.outputs.token }}
                  repository: PostHog/charts
                  event-type: restart_dagster_code_location
                  client-payload: |
                      {
                        "values": {
                          "image": {
                            "sha": "${{ steps.build.outputs.digest }}"
                          }
                        },
                        "release": "ingestion",
                        "commit": ${{ toJson(github.event.head_commit) }},
                        "repository": ${{ toJson(github.repository) }},
                        "labels": ${{ toJson(steps.labels.outputs.labels) }},
                        "timestamp": "${{ github.event.head_commit.timestamp }}"
                      }
