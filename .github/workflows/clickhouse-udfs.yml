name: ClickHouse UDFs

on:
    push:
        branches:
            - master
        paths:
            - 'posthog/user_scripts/**'

jobs:
    trigger_udfs_workflow:
        runs-on: ubuntu-24.04
        steps:
            - name: Get app token
              id: app-token
              # NOTE: This token is very limited in what it can do.
              # It can't (and should not) read repo contents or create PRs.
              # Do not use for cross-repo dependencies, see thread below for an alternative approach:
              # https://posthog.slack.com/archives/C02E3BKC78F/p1769016151167609
              uses: getsentry/action-github-app-token@d4b5da6c5e37703f8c3b3e43abb5705b46e159cc # v3.0.0
              with:
                  app_id: ${{ secrets.GH_APP_POSTHOG_CLOUD_INFRA_WORKFLOW_TRIGGER_APP_ID }}
                  private_key: ${{ secrets.GH_APP_POSTHOG_CLOUD_INFRA_WORKFLOW_TRIGGER_PRIVATE_KEY }}

            - name: Trigger UDFs Workflow
              shell: bash
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  gh workflow run clickhouse-udfs.yml \
                    -R posthog/posthog-cloud-infra \
                    --ref main
