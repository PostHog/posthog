name: Sync ClickHouse Versions

on:
    schedule:
        - cron: '0 6 * * *'
    workflow_dispatch: # Manual trigger for testing

permissions:
    contents: write
    pull-requests: write

jobs:
    sync:
        runs-on: ubuntu-latest
        steps:
            - name: Get app token for infra repo
              id: infra-token
              uses: getsentry/action-github-app-token@d4b5da6c5e37703f8c3b3e43abb5705b46e159cc # v3.0.0
              with:
                  app_id: ${{ secrets.GH_APP_POSTHOG_CLOUD_INFRA_WORKFLOW_TRIGGER_APP_ID }}
                  private_key: ${{ secrets.GH_APP_POSTHOG_CLOUD_INFRA_WORKFLOW_TRIGGER_PRIVATE_KEY }}

            - name: Get app token for PR creation
              id: app-token
              uses: getsentry/action-github-app-token@d4b5da6c5e37703f8c3b3e43abb5705b46e159cc # v3.0.0
              with:
                  app_id: ${{ secrets.GH_APP_POSTHOG_SCHEDULED_ACTIONS_APP_ID }}
                  private_key: ${{ secrets.GH_APP_POSTHOG_SCHEDULED_ACTIONS_PRIVATE_KEY }}

            - uses: actions/checkout@v6
              with:
                  token: ${{ steps.app-token.outputs.token }}

            - name: Fetch ClickHouse versions from infra repo
              id: fetch-versions
              env:
                  GH_TOKEN: ${{ steps.infra-token.outputs.token }}
              run: |
                  errors=""

                  # Fetch and validate a ClickHouse version from a file in posthog-cloud-infra
                  # Usage: fetch_infra_version <name> <file_path> <grep_pattern> <sed_pattern>
                  fetch_infra_version() {
                    local name="$1"
                    local file_path="$2"
                    local grep_pattern="$3"
                    local sed_pattern="$4"

                    local version=$(gh api "repos/PostHog/posthog-cloud-infra/contents/$file_path" \
                      --jq '.content' 2>/dev/null | base64 --decode 2>/dev/null | \
                      grep -m 1 -E "$grep_pattern" | sed -E "$sed_pattern" || echo "")

                    if [ -z "$version" ]; then
                      errors="${errors}- **$name**: Failed to fetch from \`$file_path\`\n"
                    elif ! [[ "$version" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
                      errors="${errors}- **$name**: Invalid version format: \`$version\` (expected X.Y.Z.W)\n"
                    fi

                    echo "$version"
                  }

                  # Terraform/Terragrunt files use: clickhouse_version = "X.Y.Z.W"
                  tf_grep='clickhouse_version'
                  tf_sed='s/.*"([^"]+)".*/\1/'

                  # Ansible files use: clickhouse_version: X.Y.Z.W
                  ansible_grep='clickhouse_version:'
                  ansible_sed='s/.*: *([0-9.]+).*/\1/'

                  # Production EU uses Ansible role defaults (the TF file is stale)
                  # This is also the source for hobby deployments
                  ansible_version=$(fetch_infra_version "Ansible (EU/Hobby)" "ansible/roles/clickhouse/defaults/main.yml" "$ansible_grep" "$ansible_sed")
                  production_eu="$ansible_version"
                  hobby="$ansible_version"

                  # Production US uses Terragrunt (new cluster)
                  production_us=$(fetch_infra_version "Production US" "terraform/environments/aws-accnt-clickhouse-prod-us/us-east-1/clickhouse/terragrunt.hcl" "$tf_grep" "$tf_sed")

                  # Dev environment
                  dev=$(fetch_infra_version "Dev" "terraform/environments/aws-accnt-dev/us-east-1/clickhouse/clickhouse.tf" "$tf_grep" "$tf_sed")

                  # Local version from docker-compose (extract from this repo)
                  local_version=$(grep -oE 'clickhouse/clickhouse-server:[0-9.]+' docker-compose.base.yml | head -1 | cut -d: -f2)
                  if [ -z "$local_version" ]; then
                    local_version="$production_eu"
                    echo "::warning::Could not extract local version from docker-compose.base.yml, using production_eu"
                  fi

                  if [ -n "$errors" ]; then
                    echo "::error::Failed to fetch ClickHouse versions. File paths in posthog-cloud-infra may have changed."
                    echo ""
                    echo "Errors:"
                    echo -e "$errors"
                    echo ""
                    echo "Please update the file paths in .github/workflows/sync-clickhouse-versions.yml"
                    exit 1
                  fi

                  # Compute the oldest supported version across production environments for compat testing
                  # If tests pass on the oldest version, they should work everywhere
                  oldest_supported=$(printf '%s\n' "$production_eu" "$production_us" "$dev" | sort -V | head -1)

                  echo "production_eu=$production_eu" >> $GITHUB_OUTPUT
                  echo "production_us=$production_us" >> $GITHUB_OUTPUT
                  echo "dev=$dev" >> $GITHUB_OUTPUT
                  echo "hobby=$hobby" >> $GITHUB_OUTPUT
                  echo "local=$local_version" >> $GITHUB_OUTPUT
                  echo "oldest_supported=$oldest_supported" >> $GITHUB_OUTPUT
                  echo "::notice::Production EU: $production_eu, Production US: $production_us, Dev: $dev, Hobby: $hobby, Local: $local_version, Oldest supported: $oldest_supported"

            - name: Update .github/clickhouse-versions.json
              run: |
                  production_eu="${{ steps.fetch-versions.outputs.production_eu }}"
                  production_us="${{ steps.fetch-versions.outputs.production_us }}"
                  dev="${{ steps.fetch-versions.outputs.dev }}"
                  hobby="${{ steps.fetch-versions.outputs.hobby }}"
                  local_version="${{ steps.fetch-versions.outputs.local }}"
                  oldest_supported="${{ steps.fetch-versions.outputs.oldest_supported }}"

                  # Build JSON with all versions (CI handles deduplication)
                  # "oldest_supported" is the minimum version across production environments - used as primary compat target
                  jq -n \
                    --arg production_eu "clickhouse/clickhouse-server:$production_eu" \
                    --arg production_us "clickhouse/clickhouse-server:$production_us" \
                    --arg dev "clickhouse/clickhouse-server:$dev" \
                    --arg hobby "clickhouse/clickhouse-server:$hobby" \
                    --arg local "clickhouse/clickhouse-server:$local_version" \
                    --arg oldest_supported "clickhouse/clickhouse-server:$oldest_supported" \
                    '{
                      production_eu: $production_eu,
                      production_us: $production_us,
                      dev: $dev,
                      hobby: $hobby,
                      local: $local,
                      oldest_supported: $oldest_supported
                    }' > .github/clickhouse-versions.json

                  echo "Updated .github/clickhouse-versions.json:"
                  cat .github/clickhouse-versions.json

            - name: Check for changes
              id: check-changes
              run: |
                  if git diff --quiet; then
                    echo "changed=false" >> $GITHUB_OUTPUT
                    echo "No changes detected"
                  else
                    echo "changed=true" >> $GITHUB_OUTPUT
                    echo "Changes detected:"
                    git diff --stat
                  fi

            - name: Create Pull Request
              if: steps.check-changes.outputs.changed == 'true'
              uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
              with:
                  token: ${{ steps.app-token.outputs.token }}
                  commit-message: 'chore(ci): sync ClickHouse versions from infra'
                  title: 'chore(ci): sync ClickHouse versions from infra'
                  body: |
                      Automated sync of ClickHouse versions from posthog-cloud-infra.

                      **Current versions:**
                      | Environment | Version | Source |
                      |-------------|---------|--------|
                      | Production EU | `${{ steps.fetch-versions.outputs.production_eu }}` | Ansible defaults |
                      | Production US | `${{ steps.fetch-versions.outputs.production_us }}` | Terragrunt |
                      | Dev | `${{ steps.fetch-versions.outputs.dev }}` | Terraform |
                      | Hobby | `${{ steps.fetch-versions.outputs.hobby }}` | Ansible defaults |
                      | Local | `${{ steps.fetch-versions.outputs.local }}` | docker-compose.base.yml |
                      | **Oldest Supported** | `${{ steps.fetch-versions.outputs.oldest_supported }}` | min(EU, US, Dev) |

                      **Files updated:**
                      - `.github/clickhouse-versions.json` - version definitions (source of truth)

                      The "oldest_supported" version is the minimum across production environments and is used as the primary compatibility target in CI. If tests pass on the oldest supported version, they should work everywhere.

                      This PR was automatically created by the daily sync workflow.
                  branch: chore/sync-clickhouse-versions
                  base: master
                  delete-branch: true
                  labels: |
                      automated
                      infrastructure
