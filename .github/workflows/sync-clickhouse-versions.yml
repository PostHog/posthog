name: Sync ClickHouse Versions and Settings

# Syncs ClickHouse versions AND critical configuration settings from posthog-cloud-infra.
# This reduces the chance of issues where queries work in CI but fail in production due to config mismatches
# (e.g., enable_analyzer setting affecting JOIN ON conditions).

on:
    schedule:
        - cron: '0 6 * * *'
    workflow_dispatch: # Manual trigger for testing

permissions:
    contents: write
    pull-requests: write

jobs:
    sync:
        runs-on: ubuntu-latest
        steps:
            - name: Get app token for infra repo
              id: infra-token
              uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
              with:
                  app-id: ${{ secrets.GH_APP_POSTHOG_CLOUD_INFRA_WORKFLOW_TRIGGER_APP_ID }}
                  private-key: ${{ secrets.GH_APP_POSTHOG_CLOUD_INFRA_WORKFLOW_TRIGGER_PRIVATE_KEY }}
                  owner: PostHog
                  repositories: posthog-cloud-infra
                  permission-contents: read

            - name: Get app token for PR creation
              id: app-token
              uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
              with:
                  app-id: ${{ secrets.GH_APP_POSTHOG_SCHEDULED_ACTIONS_APP_ID }}
                  private-key: ${{ secrets.GH_APP_POSTHOG_SCHEDULED_ACTIONS_PRIVATE_KEY }}
                  permission-contents: write
                  permission-pull-requests: write

            - uses: actions/checkout@v6
              with:
                  token: ${{ steps.app-token.outputs.token }}

            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
              with:
                  python-version: '3.12'

            - name: Install uv
              uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
              with:
                  enable-cache: true
                  version: 0.9.9

            - name: Install python dependencies
              shell: bash
              run: UV_PROJECT_ENVIRONMENT=$pythonLocation uv sync --frozen --dev

            - name: Sync ClickHouse versions
              id: sync-versions
              env:
                  GH_TOKEN: ${{ steps.infra-token.outputs.token }}
              run: |
                  # Fetch raw content from infra repo files
                  fetch_content() {
                    local path="$1"
                    local response
                    local status_line
                    local body
                    local content

                    response=$(gh api -i "repos/PostHog/posthog-cloud-infra/contents/$path" 2>&1 || true)
                    status_line=$(printf '%s' "$response" | head -n 1 | tr -d '\r')
                    body=$(printf '%s' "$response" | tr -d '\r' | sed '1,/^$/d')
                    content=$(printf '%s' "$body" | jq -r '.content // empty' 2>/dev/null || true)

                    if [ -z "$content" ]; then
                      if [ -z "$status_line" ]; then
                        status_line="HTTP status unknown"
                      fi
                      echo "::warning::Could not fetch $path (${status_line})"
                      echo ""
                      return
                    fi
                    echo "$content" | base64 --decode 2>/dev/null || echo ""
                  }

                  prod_eu_content=$(fetch_content "ansible/roles/clickhouse/defaults/main.yml")
                  prod_us_content=$(fetch_content "terraform/environments/aws-accnt-clickhouse-prod-us/us-east-1/clickhouse/terragrunt.hcl")

                  if [ -z "$prod_eu_content" ]; then
                    echo "::warning::Could not fetch production_eu_content"
                    exit 1
                  fi
                  if [ -z "$prod_us_content" ]; then
                    echo "::warning::Could not fetch production_us_content"
                    exit 1
                  fi

                  python .github/scripts/sync_clickhouse.py sync-versions \
                    --prod-eu-content "$prod_eu_content" \
                    --prod-us-content "$prod_us_content" \
                    --local-file docker-compose.base.yml \
                    --output-file .github/clickhouse-versions.json

            - name: Sync ClickHouse settings
              id: sync-settings
              env:
                  GH_TOKEN: ${{ steps.infra-token.outputs.token }}
              run: |
                  # Fetch users.xml from production EU workers
                  fetch_content() {
                    local path="$1"
                    local response
                    local status_line
                    local body
                    local content

                    response=$(gh api -i "repos/PostHog/posthog-cloud-infra/contents/$path" 2>&1 || true)
                    status_line=$(printf '%s' "$response" | head -n 1 | tr -d '\r')
                    body=$(printf '%s' "$response" | tr -d '\r' | sed '1,/^$/d')
                    content=$(printf '%s' "$body" | jq -r '.content // empty' 2>/dev/null || true)

                    if [ -z "$content" ]; then
                      if [ -z "$status_line" ]; then
                        status_line="HTTP status unknown"
                      fi
                      echo "::warning::Could not fetch $path (${status_line})"
                      echo ""
                      return
                    fi
                    echo "$content" | base64 --decode 2>/dev/null || echo ""
                  }

                  prod_users_xml=$(fetch_content "ansible/eu/clickhouse/config/workers/users.xml")

                  if [ -z "$prod_users_xml" ]; then
                    echo "::warning::Could not fetch production users.xml"
                    exit 1
                  fi

                  python .github/scripts/sync_clickhouse.py sync-settings \
                    --prod-xml "$prod_users_xml" \
                    --local-files "docker/clickhouse/users-dev.xml,docker/clickhouse/users.xml"

            - name: Check for changes
              id: check-changes
              run: |
                  if git diff --quiet; then
                    echo "changed=false" >> $GITHUB_OUTPUT
                    echo "No changes detected"
                  else
                    echo "changed=true" >> $GITHUB_OUTPUT
                    echo "Changes detected:"
                    git diff --stat
                  fi

            - name: Build PR body
              id: pr-body
              if: steps.check-changes.outputs.changed == 'true'
              run: |
                  python .github/scripts/sync_clickhouse.py build-pr-body \
                    --versions-file .github/clickhouse-versions.json \
                    --settings-json '${{ steps.sync-settings.outputs.settings_json }}' \
                    --mismatches '${{ steps.sync-settings.outputs.mismatches }}' \
                    --missing-settings '${{ steps.sync-settings.outputs.missing_settings }}' \
                    --additional-settings '${{ steps.sync-settings.outputs.additional_settings }}'

            - name: Create Pull Request
              if: steps.check-changes.outputs.changed == 'true'
              uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
              with:
                  token: ${{ steps.app-token.outputs.token }}
                  commit-message: 'chore(ci): sync ClickHouse versions from infra'
                  title: 'chore(ci): sync ClickHouse versions from infra'
                  body: ${{ steps.pr-body.outputs.body }}
                  branch: chore/sync-clickhouse-versions
                  base: master
                  delete-branch: true
                  labels: |
                      automated
                      infrastructure
                  reviewers: |
                      PostHog/team-analytics-platform
                      Posthog/clickhouse
