name: Browserslist

on:
    schedule:
        - cron: '0 12 * * MON'
    workflow_dispatch:

permissions:
    contents: read

jobs:
    update-browserslist-database:
        runs-on: ubuntu-latest
        steps:
            - name: Get app token
              id: app-token
              uses: getsentry/action-github-app-token@d4b5da6c5e37703f8c3b3e43abb5705b46e159cc # v3.0.0
              with:
                  app_id: ${{ secrets.GH_APP_POSTHOG_SCHEDULED_ACTIONS_APP_ID }}
                  private_key: ${{ secrets.GH_APP_POSTHOG_SCHEDULED_ACTIONS_PRIVATE_KEY }}

            - name: Checkout repository
              uses: actions/checkout@v6
              with:
                  token: ${{ steps.app-token.outputs.token }}

            - name: Configure git
              run: |
                  git config --global user.email "action@github.com"
                  git config --global user.name "Browserslist Update Action"

            - name: Install pnpm
              uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0

            - name: Set up Node.js
              uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6.1.0
              with:
                  node-version: 22.22.0
                  cache: 'pnpm'

            - name: Reset stale browserslist branch
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
              run: |
                  if git ls-remote --heads origin browserslist-update | grep browserslist-update; then
                    echo "Resetting stale browserslist-update branch to master to avoid rebase conflicts"
                    git fetch origin browserslist-update
                    git checkout -b browserslist-update origin/browserslist-update
                    git reset --hard origin/master
                    git push origin browserslist-update --force
                    git checkout master
                  fi

            - name: Update Browserslist database and create PR if applies
              id: update-browserlist
              uses: c2corg/browserslist-update-action@a76abb476199caea5399f9e28ff3f16e491ec566 # v2.5.0
              with:
                  github_token: ${{ steps.app-token.outputs.token }}
                  commit_message: 'build: update Browserslist db'
                  title: 'build: update Browserslist db'
                  labels: 'dependencies'

            - name: Enable automerge
              env:
                  GH_TOKEN: ${{ steps.app-token.outputs.token }}
                  PR_NUMBER: ${{ steps.update-browserlist.outputs.pr_number }}
              run: |
                  gh pr merge "$PR_NUMBER" --auto --squash
