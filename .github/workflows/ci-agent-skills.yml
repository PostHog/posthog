name: Agent Skills

on:
    pull_request:
    push:
        branches:
            - master
        paths:
            - 'products/*/skills/**'
            - 'products/posthog_ai/scripts/**'
            - '.github/workflows/ci-agent-skills.yml'

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    changes:
        permissions:
            contents: read
            pull-requests: read
        runs-on: ubuntu-24.04
        timeout-minutes: 5
        name: Determine need to run skill checks
        outputs:
            skills: ${{ steps.filter.outputs.skills || 'true' }}
        steps:
            - uses: actions/checkout@v6

            - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
              id: filter
              if: github.event_name != 'push'
              with:
                  filters: |
                      skills:
                        - 'products/*/skills/**'
                        - 'products/*/backend/max_tools.py'
                        - 'products/posthog_ai/**'
                        - '.github/workflows/ci-agent-skills.yml'

    check-skills:
        name: Check agent skills
        runs-on: ubuntu-latest
        needs: changes
        if: needs.changes.outputs.skills == 'true'
        permissions:
            contents: read

        steps:
            - uses: actions/checkout@v6

            - name: Start PostgreSQL with Docker Compose
              run: |
                  docker compose -f docker-compose.dev.yml up db -d --wait

            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
              with:
                  python-version-file: 'pyproject.toml'

            - name: Install uv
              uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
              with:
                  enable-cache: true
                  save-cache: ${{ github.ref == 'refs/heads/master' }}
                  version: 0.9.9

            - name: Install python dependencies
              run: UV_PROJECT_ENVIRONMENT=$pythonLocation uv sync --frozen --dev

            - name: Lint skills
              run: ./bin/hogli lint:skills

            - name: Wait for PostgreSQL
              run: bin/check_postgres_up

            - name: Run migrations and create test data
              env:
                  SECRET_KEY: '6b01eee4f945ca25045b5aab440b953461faf08693a9abbf1166dc7c6b9772da'
                  DATABASE_URL: 'postgres://posthog:posthog@localhost:5432/posthog'
                  REDIS_URL: 'redis://localhost'
                  OBJECT_STORAGE_ENABLED: 'True'
                  OBJECT_STORAGE_ENDPOINT: 'http://localhost:19000'
                  OBJECT_STORAGE_ACCESS_KEY_ID: 'object_storage_root_user'
                  OBJECT_STORAGE_SECRET_ACCESS_KEY: 'object_storage_root_password'
                  TEST: 1
                  DEBUG: 1
              run: |
                  python manage.py migrate --noinput
                  python manage.py setup_dev --no-data

            - name: Build skills
              env:
                  SECRET_KEY: '6b01eee4f945ca25045b5aab440b953461faf08693a9abbf1166dc7c6b9772da'
                  DATABASE_URL: 'postgres://posthog:posthog@localhost:5432/posthog'
                  REDIS_URL: 'redis://localhost'
                  OBJECT_STORAGE_ENABLED: 'True'
                  OBJECT_STORAGE_ENDPOINT: 'http://localhost:19000'
                  OBJECT_STORAGE_ACCESS_KEY_ID: 'object_storage_root_user'
                  OBJECT_STORAGE_SECRET_ACCESS_KEY: 'object_storage_root_password'
                  TEST: 1
                  DEBUG: 1
              run: ./bin/hogli build:skills

    release-skills:
        name: Release agent skills
        runs-on: ubuntu-latest
        needs: check-skills
        if: github.ref == 'refs/heads/master'
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Start PostgreSQL with Docker Compose
              run: |
                  docker compose -f docker-compose.dev.yml up db -d --wait

            - name: Set up Python
              uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548 # v6.1.0
              with:
                  python-version-file: 'pyproject.toml'

            - name: Install uv
              uses: astral-sh/setup-uv@61cb8a9741eeb8a550a1b8544337180c0fc8476b # v7.2.0
              with:
                  enable-cache: true
                  save-cache: false
                  version: 0.9.9

            - name: Install python dependencies
              run: UV_PROJECT_ENVIRONMENT=$pythonLocation uv sync --frozen --dev

            - name: Wait for PostgreSQL
              run: bin/check_postgres_up

            - name: Run migrations and create test data
              env:
                  SECRET_KEY: '6b01eee4f945ca25045b5aab440b953461faf08693a9abbf1166dc7c6b9772da'
                  DATABASE_URL: 'postgres://posthog:posthog@localhost:5432/posthog'
                  REDIS_URL: 'redis://localhost'
                  OBJECT_STORAGE_ENABLED: 'True'
                  OBJECT_STORAGE_ENDPOINT: 'http://localhost:19000'
                  OBJECT_STORAGE_ACCESS_KEY_ID: 'object_storage_root_user'
                  OBJECT_STORAGE_SECRET_ACCESS_KEY: 'object_storage_root_password'
                  TEST: 1
                  DEBUG: 1
              run: |
                  python manage.py migrate --noinput
                  python manage.py setup_dev --no-data

            - name: Build skills ZIP
              env:
                  SECRET_KEY: '6b01eee4f945ca25045b5aab440b953461faf08693a9abbf1166dc7c6b9772da'
                  DATABASE_URL: 'postgres://posthog:posthog@localhost:5432/posthog'
                  REDIS_URL: 'redis://localhost'
                  OBJECT_STORAGE_ENABLED: 'True'
                  OBJECT_STORAGE_ENDPOINT: 'http://localhost:19000'
                  OBJECT_STORAGE_ACCESS_KEY_ID: 'object_storage_root_user'
                  OBJECT_STORAGE_SECRET_ACCESS_KEY: 'object_storage_root_password'
                  TEST: 1
                  DEBUG: 1
              run: ./bin/hogli build:skills

            - name: Determine next version
              id: version
              run: |
                  LATEST_TAG=$(git tag -l 'agent-skills-v*' | grep -E '^agent-skills-v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n 1)
                  if [ -z "$LATEST_TAG" ]; then LATEST_TAG="agent-skills-v0.0.0"; fi
                  MINOR=$(echo "${LATEST_TAG#agent-skills-v}" | cut -d. -f2)
                  echo "tag=agent-skills-v0.$((MINOR + 1)).0" >> "$GITHUB_OUTPUT"

            - name: Create versioned and latest releases
              env:
                  GH_TOKEN: ${{ github.token }}
              run: |
                  gh release create "${{ steps.version.outputs.tag }}" \
                      products/posthog_ai/dist/skills.zip \
                      --title "Agent skills ${{ steps.version.outputs.tag }}" \
                      --notes "Build from ${{ github.sha }}" \
                      --latest=false

                  gh release delete agent-skills-latest --yes || true
                  git push origin :refs/tags/agent-skills-latest || true
                  gh release create agent-skills-latest \
                      products/posthog_ai/dist/skills.zip \
                      --title "Agent skills (Latest)" \
                      --notes "Latest build â€” same as ${{ steps.version.outputs.tag }}" \
                      --latest=false
