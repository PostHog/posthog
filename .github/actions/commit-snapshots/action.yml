name: Commit Aggregated Snapshots
description: Applies snapshot patches, counts changes, commits, and posts PR comment

inputs:
    workflow-type:
        description: 'Workflow type (storybook, playwright, or backend)'
        required: true
    patch-path:
        description: 'Path where patch artifacts are already downloaded (e.g., /tmp/snapshot-patches/)'
        required: true
    snapshot-path:
        description: 'Path to snapshot directory (e.g., frontend/__snapshots__/ or playwright/)'
        required: true
    commit-message:
        description: 'Commit message for snapshot changes'
        required: true
    pr-number:
        description: 'Pull request number'
        required: true
    repository:
        description: 'Repository name (owner/repo)'
        required: true
    commit-sha:
        description: 'Commit SHA that was tested'
        required: true
    branch-name:
        description: 'Branch name'
        required: true
    github-token:
        description: 'GitHub token for authentication'
        required: true

outputs:
    committed:
        description: 'Whether snapshots were committed (true/false)'
        value: ${{ steps.commit.outputs.committed }}
    changes:
        description: 'JSON object with change counts'
        value: ${{ steps.commit.outputs.changes }}

runs:
    using: composite
    steps:
        - name: Apply snapshot patches
          shell: bash
          env:
              PATCH_PATH: ${{ inputs.patch-path }}
          run: |
              # Apply all patch files from the provided patch directory
              # Patches handle A/M/D automatically including binary files
              if [ -d "$PATCH_PATH" ]; then
                PATCHES=$(find "$PATCH_PATH" -name "*.patch" | sort)
                if [ -n "$PATCHES" ]; then
                  echo "::group::Applying snapshot patches"
                  echo "Applying patches from $PATCH_PATH..."
                  for patch in $PATCHES; do
                    echo "Applying $patch"
                    git apply --index "$patch"
                  done
                  echo "Applied all patches successfully"
                  echo "::endgroup::"
                else
                  echo "No patch files found in $PATCH_PATH"
                fi
              else
                echo "Patch directory $PATCH_PATH does not exist"
              fi

        - name: Configure git
          shell: bash
          run: |
              git config --global --add safe.directory '*'
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"

        - name: Verify branch hasn't advanced
          id: verify
          shell: bash
          env:
              BRANCH_NAME: ${{ inputs.branch-name }}
              TESTED_SHA: ${{ inputs.commit-sha }}
          run: |
              echo "::group::Verifying branch hasn't advanced"
              # Check if the remote branch HEAD still matches the commit we tested
              CURRENT_SHA=$(git ls-remote origin "refs/heads/$BRANCH_NAME" | cut -f1)

              if [ "$TESTED_SHA" != "$CURRENT_SHA" ]; then
                echo "branch-advanced=true" >> $GITHUB_OUTPUT
                echo "current-sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
                echo "::warning::â­ï¸ Branch advanced during workflow - snapshot commit skipped"
                echo "   Tested:  $TESTED_SHA"
                echo "   Current: $CURRENT_SHA"
              else
                echo "branch-advanced=false" >> $GITHUB_OUTPUT
                echo "::notice::âœ… Branch HEAD matches tested commit - proceeding with snapshot commit"
              fi
              echo "::endgroup::"

        - name: Post skip comment
          if: steps.verify.outputs.branch-advanced == 'true'
          shell: bash
          env:
              GH_TOKEN: ${{ inputs.github-token }}
              TESTED_SHA: ${{ inputs.commit-sha }}
              CURRENT_SHA: ${{ steps.verify.outputs.current-sha }}
              PR_NUMBER: ${{ inputs.pr-number }}
          run: |
              gh pr comment $PR_NUMBER --body "â­ï¸ Skipped snapshot commit because branch advanced to \`${CURRENT_SHA:0:7}\` while workflow was testing \`${TESTED_SHA:0:7}\`.

              The new commit will trigger its own snapshot update workflow.

              **If you expected this workflow to succeed:** This can happen due to concurrent commits. To get a fresh workflow run, either:
              - Merge master into your branch, or
              - Push an empty commit: \`git commit --allow-empty -m 'trigger CI' && git push\`"

        - name: Count and commit changes
          id: commit
          if: steps.verify.outputs.branch-advanced == 'false'
          shell: bash
          env:
              GH_TOKEN: ${{ inputs.github-token }}
              SNAPSHOT_PATH: ${{ inputs.snapshot-path }}
              PR_NUMBER: ${{ inputs.pr-number }}
              COMMIT_MESSAGE: ${{ inputs.commit-message }}
              BRANCH_NAME: ${{ inputs.branch-name }}
          run: |
              CHANGES_JSON=$(.github/scripts/count-snapshot-changes.sh $SNAPSHOT_PATH)
              echo "changes=$CHANGES_JSON" >> $GITHUB_OUTPUT
              echo "Snapshot changes: $CHANGES_JSON"

              TOTAL=$(echo "$CHANGES_JSON" | jq -r '.total')
              if [ "$TOTAL" -gt 0 ]; then
                # Disable auto-merge BEFORE committing
                # This ensures auto-merge is disabled even if workflow gets cancelled after push
                gh pr merge --disable-auto $PR_NUMBER || echo "Auto-merge was not enabled"
                echo "::notice::ðŸ”’ Auto-merge disabled - snapshot changes require manual review"

                # Now commit and push
                git add $SNAPSHOT_PATH -A
                git commit -m "$COMMIT_MESSAGE"
                # Push directly - SHA verification already ensured we're up to date
                git push origin HEAD:"$BRANCH_NAME" --quiet
                SNAPSHOT_SHA=$(git rev-parse HEAD)
                echo "::notice::ðŸ“¸ Committed snapshot changes"
                echo "committed=true" >> $GITHUB_OUTPUT
                echo "snapshot-sha=$SNAPSHOT_SHA" >> $GITHUB_OUTPUT
              else
                echo "No snapshot changes to commit"
                echo "committed=false" >> $GITHUB_OUTPUT
              fi

        - name: Post snapshot comment
          if: steps.commit.outputs.committed == 'true'
          shell: bash
          env:
              GH_TOKEN: ${{ inputs.github-token }}
              SNAPSHOT_SHA: ${{ steps.commit.outputs.snapshot-sha }}
              PR_NUMBER: ${{ inputs.pr-number }}
              COMMIT_SHA: ${{ inputs.commit-sha }}
              WORKFLOW_TYPE: ${{ inputs.workflow-type }}
              CHANGES: ${{ steps.commit.outputs.changes }}
              REPOSITORY: ${{ inputs.repository }}
          run: |
              .github/scripts/post-snapshot-comment.js \
                "$WORKFLOW_TYPE" \
                "update" \
                "$CHANGES" \
                "$PR_NUMBER" \
                "$REPOSITORY" \
                "$COMMIT_SHA" \
                "$SNAPSHOT_SHA"

        - name: Fail workflow to signal snapshot changes
          if: steps.commit.outputs.committed == 'true'
          shell: bash
          run: |
              echo "::notice::Snapshots were updated and committed. Workflow fails to prevent auto-merge and signal review needed."
              exit 1
