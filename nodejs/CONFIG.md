# Plugin Server Configuration by Service

Environment variables required by each service, extracted from narrowed Hub types.

> **Last updated:** 2025-12-22
> **Commit:** `2decb536d37938c3a82abb301c3508432de2f6f7`

---

## Shared Infrastructure Configuration

Services declare which infrastructure they need. These are the config variables for each infrastructure component.

### Kafka Producer (rdkafka)

All services use the Kafka producer via `KafkaProducerWrapper.create()`.

```text
KAFKA_CLIENT_RACK
KAFKA_PRODUCER_*  (dynamic: any KAFKA_PRODUCER_<rdkafka.config> env var is passed through)
```

### Kafka Consumer (KafkaJS) - Legacy

Used by `KafkaJSIngestionConsumer` and some other consumers.

```text
KAFKA_HOSTS
KAFKAJS_LOG_LEVEL
KAFKA_SECURITY_PROTOCOL
KAFKA_CLIENT_CERT_B64
KAFKA_CLIENT_CERT_KEY_B64
KAFKA_TRUSTED_CERT_B64
KAFKA_SASL_MECHANISM
KAFKA_SASL_USER
KAFKA_SASL_PASSWORD
```

### Kafka Consumer (rdkafka)

```text
KAFKA_CLIENT_RACK
KAFKA_CONSUMER_*  (dynamic: any KAFKA_CONSUMER_<rdkafka.config> env var is passed through)
```

### PostgresRouter

```text
DATABASE_URL
DATABASE_READONLY_URL
POSTGRES_CONNECTION_POOL_SIZE
PLUGIN_STORAGE_DATABASE_URL
PERSONS_DATABASE_URL
PERSONS_READONLY_DATABASE_URL
BEHAVIORAL_COHORTS_DATABASE_URL
PLUGIN_SERVER_MODE
```

For Persons migration (additional):

```text
PERSONS_MIGRATION_DATABASE_URL
PERSONS_MIGRATION_READONLY_DATABASE_URL
```

### Redis (by kind)

**Ingestion** (used by PubSub, main Hub redisPool):

```text
REDIS_URL
REDIS_POOL_MIN_SIZE
REDIS_POOL_MAX_SIZE
POSTHOG_REDIS_HOST
POSTHOG_REDIS_PORT
POSTHOG_REDIS_PASSWORD
INGESTION_REDIS_HOST
INGESTION_REDIS_PORT
```

**Cookieless** (used by CookielessManager):

```text
REDIS_URL
REDIS_POOL_MIN_SIZE
REDIS_POOL_MAX_SIZE
COOKIELESS_REDIS_HOST
COOKIELESS_REDIS_PORT
```

**Session Recording**:

```text
REDIS_URL
REDIS_POOL_MIN_SIZE
REDIS_POOL_MAX_SIZE
POSTHOG_SESSION_RECORDING_REDIS_HOST
POSTHOG_SESSION_RECORDING_REDIS_PORT
```

**CDP**:

```text
REDIS_URL
REDIS_POOL_MIN_SIZE
REDIS_POOL_MAX_SIZE
CDP_REDIS_HOST
CDP_REDIS_PORT
CDP_REDIS_PASSWORD
```

**Logs**:

```text
REDIS_URL
REDIS_POOL_MIN_SIZE
REDIS_POOL_MAX_SIZE
LOGS_REDIS_HOST
LOGS_REDIS_PORT
LOGS_REDIS_PASSWORD
LOGS_REDIS_TLS
```

**PostHog** (used by Celery):

```text
REDIS_URL
REDIS_POOL_MIN_SIZE
REDIS_POOL_MAX_SIZE
POSTHOG_REDIS_HOST
POSTHOG_REDIS_PORT
POSTHOG_REDIS_PASSWORD
```

---

## Ingestion Services

### IngestionConsumer

Uses: Kafka Producer, Kafka Consumer (rdkafka), PostgresRouter, Redis (ingestion), Redis (cookieless)

Service-specific config:

```text
KAFKA_CLIENT_RACK
USE_DYNAMIC_EVENT_INGESTION_RESTRICTION_CONFIG  # Passed directly to EventIngestionRestrictionManager constructor
INGESTION_OVERFLOW_PRESERVE_PARTITION_LOCALITY
PERSONS_PREFETCH_ENABLED
PERSON_BATCH_WRITING_DB_WRITE_MODE
PERSON_BATCH_WRITING_MAX_CONCURRENT_UPDATES
PERSON_BATCH_WRITING_MAX_OPTIMISTIC_UPDATE_RETRIES
PERSON_BATCH_WRITING_OPTIMISTIC_UPDATE_RETRY_INTERVAL_MS
PERSON_PROPERTIES_UPDATE_ALL
GROUP_BATCH_WRITING_MAX_CONCURRENT_UPDATES
GROUP_BATCH_WRITING_MAX_OPTIMISTIC_UPDATE_RETRIES
GROUP_BATCH_WRITING_OPTIMISTIC_UPDATE_RETRY_INTERVAL_MS
CLICKHOUSE_JSON_EVENTS_KAFKA_TOPIC
CLICKHOUSE_HEATMAPS_KAFKA_TOPIC
SITE_URL
```

Cookieless config:

```text
COOKIELESS_DISABLED
COOKIELESS_FORCE_STATELESS_MODE
COOKIELESS_DELETE_EXPIRED_LOCAL_SALTS_INTERVAL_MS
COOKIELESS_SESSION_TTL_SECONDS
COOKIELESS_SALT_TTL_SECONDS
COOKIELESS_SESSION_INACTIVITY_MS
COOKIELESS_IDENTIFIES_TTL_SECONDS
TIMESTAMP_COMPARISON_LOGGING_SAMPLE_RATE
```

### SessionRecordingIngester

Uses: Kafka Producer, Kafka Consumer (rdkafka), Redis (session-recording)

Service-specific config:

```text
SESSION_RECORDING_DEBUG_PARTITION
SESSION_RECORDING_V2_S3_ENDPOINT
SESSION_RECORDING_V2_S3_REGION
SESSION_RECORDING_V2_S3_BUCKET
SESSION_RECORDING_V2_S3_PREFIX
SESSION_RECORDING_V2_S3_ACCESS_KEY_ID
SESSION_RECORDING_V2_S3_SECRET_ACCESS_KEY
SESSION_RECORDING_V2_REPLAY_EVENTS_KAFKA_TOPIC
SESSION_RECORDING_V2_CONSOLE_LOG_ENTRIES_KAFKA_TOPIC
SESSION_RECORDING_V2_CONSOLE_LOG_STORE_SYNC_BATCH_LIMIT
SESSION_RECORDING_V2_S3_TIMEOUT_MS
SESSION_RECORDING_MAX_BATCH_SIZE_KB
SESSION_RECORDING_MAX_BATCH_AGE_MS
SESSION_RECORDING_V2_MAX_EVENTS_PER_SESSION_PER_BATCH
USE_DYNAMIC_EVENT_INGESTION_RESTRICTION_CONFIG  # Passed directly to EventIngestionRestrictionManager constructor
KAFKA_CLIENT_RACK
```

---

## CDP Services

### CdpConsumerBase (all CDP consumers inherit these)

Uses: Kafka Producer, Redis (cdp)

```text
# Kafka
KAFKA_CLIENT_RACK

# Redis (CDP)
REDIS_URL
REDIS_POOL_MIN_SIZE
REDIS_POOL_MAX_SIZE
CDP_REDIS_HOST
CDP_REDIS_PORT
CDP_REDIS_PASSWORD

# Native destinations
NATIVE_DESTINATION_EXECUTOR_CYCLOTRON_URL
NATIVE_DESTINATION_EXECUTOR_CYCLOTRON_AUTH_TOKEN
NATIVE_DESTINATION_EXECUTOR_ENABLED

# Segment destinations
SEGMENT_DESTINATION_EXECUTOR_ENDPOINT
SEGMENT_DESTINATION_EXECUTOR_ENABLED

# Hog executor
HOG_EXECUTOR_SYNC_FETCH_TIMEOUT_MS
HOG_EXECUTOR_SYNC_FETCH_ENABLED
HOG_EXECUTOR_MAPPING_ENABLED
HOG_EXECUTOR_JS_EVALUATION_ENABLED

# Hog watcher
HOG_WATCHER_DISABLED

# CDP general
CDP_OVERFLOW_QUEUE_ENABLED
SITE_URL
ENCRYPTION_SALT_KEYS

# CDP watcher (from CdpConfig)
CDP_WATCHER_COST_ERROR
CDP_WATCHER_HOG_COST_TIMING
CDP_WATCHER_HOG_COST_TIMING_LOWER_MS
CDP_WATCHER_HOG_COST_TIMING_UPPER_MS
CDP_WATCHER_ASYNC_COST_TIMING
CDP_WATCHER_ASYNC_COST_TIMING_LOWER_MS
CDP_WATCHER_ASYNC_COST_TIMING_UPPER_MS
CDP_WATCHER_THRESHOLD_DEGRADED
CDP_WATCHER_BUCKET_SIZE
CDP_WATCHER_TTL
CDP_WATCHER_STATE_LOCK_TTL
CDP_WATCHER_REFILL_RATE
CDP_WATCHER_DISABLED_TEMPORARY_TTL
CDP_WATCHER_DISABLED_TEMPORARY_MAX_COUNT
CDP_WATCHER_AUTOMATICALLY_DISABLE_FUNCTIONS
CDP_WATCHER_SEND_EVENTS
CDP_WATCHER_OBSERVE_RESULTS_BUFFER_TIME_MS
CDP_WATCHER_OBSERVE_RESULTS_BUFFER_MAX_RESULTS

# CDP rate limiter
CDP_RATE_LIMITER_BUCKET_SIZE
CDP_RATE_LIMITER_REFILL_RATE
CDP_RATE_LIMITER_TTL

# CDP monitoring
HOG_FUNCTION_MONITORING_APP_METRICS_TOPIC
HOG_FUNCTION_MONITORING_LOG_ENTRIES_TOPIC

# CDP fetch (CdpFetchConfig - shared across NativeDestinationExecutor, SegmentDestinationExecutor, HogExecutor)
CDP_FETCH_RETRIES
CDP_FETCH_BACKOFF_BASE_MS
CDP_FETCH_BACKOFF_MAX_MS
```

### CdpEventsConsumer (adds to CdpConsumerBase)

```text
CDP_EVENT_PROCESSOR_EXECUTE_FIRST_STEP
```

### CdpCyclotronWorker (adds to CdpConsumerBase)

```text
CDP_CYCLOTRON_JOB_QUEUE_CONSUMER_KIND
CYCLOTRON_DATABASE_URL
CDP_CYCLOTRON_BATCH_SIZE
CDP_CYCLOTRON_BATCH_DELAY_MS
```

### CdpCyclotronDelayConsumer (adds to CdpConsumerBase)

```text
CDP_CYCLOTRON_JOB_QUEUE_CONSUMER_KIND
```

### CdpLegacyEventsConsumer (adds to CdpEventsConsumer)

```text
CDP_LEGACY_EVENT_CONSUMER_GROUP_ID
CDP_LEGACY_EVENT_CONSUMER_TOPIC
CDP_LEGACY_EVENT_REDIRECT_TOPIC
```

---

## Logs Services

### LogsIngestionConsumer

Uses: Kafka Producer, Kafka Consumer (rdkafka), Redis (logs)

```text
# Consumer config
LOGS_INGESTION_CONSUMER_GROUP_ID
LOGS_INGESTION_CONSUMER_CONSUME_TOPIC
LOGS_INGESTION_CONSUMER_CLICKHOUSE_TOPIC
LOGS_INGESTION_CONSUMER_OVERFLOW_TOPIC
LOGS_INGESTION_CONSUMER_DLQ_TOPIC

# Rate limiter
LOGS_LIMITER_ENABLED_TEAMS
LOGS_LIMITER_DISABLED_FOR_TEAMS
LOGS_LIMITER_BUCKET_SIZE_KB
LOGS_LIMITER_REFILL_RATE_KB_PER_SECOND
LOGS_LIMITER_TTL_SECONDS
LOGS_LIMITER_TEAM_BUCKET_SIZE_KB
LOGS_LIMITER_TEAM_REFILL_RATE_KB_PER_SECOND

# Redis (Logs) - see Shared Infrastructure
REDIS_URL
REDIS_POOL_MIN_SIZE
REDIS_POOL_MAX_SIZE
LOGS_REDIS_HOST
LOGS_REDIS_PORT
LOGS_REDIS_PASSWORD
LOGS_REDIS_TLS

# Kafka
KAFKA_CLIENT_RACK
```

---

## LLM Analytics Services

### EvaluationScheduler (TemporalService + EvaluationManagerService)

Uses: PostgresRouter, PubSub (Redis ingestion)

```text
TEMPORAL_HOST
TEMPORAL_PORT
TEMPORAL_NAMESPACE
TEMPORAL_CLIENT_ROOT_CA
TEMPORAL_CLIENT_CERT
TEMPORAL_CLIENT_KEY
```

---

## Legacy Plugin System

### LegacyPluginHub

Uses: PostgresRouter, Redis (ingestion), Redis (posthog via Celery), Kafka Producer

```text
TASK_TIMEOUT
RELOAD_PLUGIN_JITTER_MAX_MS
PLUGIN_LOAD_SEQUENTIALLY
BASE_DIR
CDP_PLUGIN_CAPTURE_EVENTS_TOPIC
PLUGINS_DEFAULT_LOG_LEVEL
PERSON_INFO_CACHE_TTL
```

RustyHook config (for webhook delivery):

```text
RUSTY_HOOK_URL
HOG_HOOK_URL
RUSTY_HOOK_FOR_TEAMS
RUSTY_HOOK_ROLLOUT_PERCENTAGE
EXTERNAL_REQUEST_TIMEOUT_MS
```

GeoIP config:

```text
MMDB_FILE_LOCATION
```

---

## Async Webhooks

### AsyncWebhooksHandler

Uses: Kafka Consumer (KafkaJS), Kafka Producer

```text
KAFKA_CONSUMPTION_SESSION_TIMEOUT_MS
KAFKA_CONSUMPTION_REBALANCE_TIMEOUT_MS
EXTERNAL_REQUEST_TIMEOUT_MS
TASKS_PER_WORKER
```

---

## KafkaJS Queue (Legacy)

### KafkaJSIngestionConsumer

Uses: Kafka Consumer (KafkaJS)

```text
KAFKA_CONSUMPTION_SESSION_TIMEOUT_MS
KAFKA_CONSUMPTION_REBALANCE_TIMEOUT_MS
KAFKA_HOSTS
KAFKA_PARTITIONS_CONSUMED_CONCURRENTLY
```

---

## Notes

- Each service declares a narrowed Hub type that specifies exactly which fields it needs
- Hub types are composed via TypeScript intersection (`&`) and `Pick<>` types
- Base classes use TypeScript generics (`class Foo<THub extends FooHub>`) to allow child classes to extend hub types without `declare` overrides
- Shared configuration subsets (like `CdpFetchConfig`) are defined once and reused across hub types via composition
- The "Uses" section indicates which shared infrastructure is required
- Dynamic env vars (like `KAFKA_PRODUCER_*`) use prefix matching to configure rdkafka
- Some services (like `EventIngestionRestrictionManager`) accept config directly in constructors rather than using hub types, when they only need 1-2 properties
- See `SERVICES.md` for the full service list, hub type names, and the generic inheritance pattern
