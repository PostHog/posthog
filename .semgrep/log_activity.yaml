rules:
    # ===================
    # log_activity rules
    # ===================
    - id: log-activity-requires-was-impersonated
      patterns:
          - pattern: log_activity(...)
          - pattern-not: log_activity(..., was_impersonated=..., ...)
          - pattern-not-inside: |
                $DICT = {..., "was_impersonated": $V, ...}
                ...
                log_activity(..., **$DICT, ...)
          # Exclude the internal call within bulk_log_activity
          - pattern-not-inside: |
                def bulk_log_activity(...):
                    ...
      message: "log_activity() must include 'was_impersonated' parameter"
      languages: [python]
      severity: ERROR

    # ===================
    # bulk_log_activity rules
    # ===================

    # Case 1: Direct append before bulk_log_activity
    - id: bulk-log-activity-append-requires-was-impersonated
      patterns:
          - pattern: |
                $LIST.append($DICT)
                ...
                bulk_log_activity($LIST, ...)
          - metavariable-pattern:
                metavariable: $DICT
                patterns:
                    - pattern: '{...}'
                    - pattern-not: '{..., "was_impersonated": $V, ...}'
      message: "Dict appended for bulk_log_activity() must include 'was_impersonated'"
      languages: [python]
      severity: ERROR

    # Case 2: Append inside a for loop before bulk_log_activity
    - id: bulk-log-activity-loop-append-requires-was-impersonated
      patterns:
          - pattern: |
                for $X in $Y:
                    ...
                    $LIST.append($DICT)
                ...
                bulk_log_activity($LIST, ...)
          - metavariable-pattern:
                metavariable: $DICT
                patterns:
                    - pattern: '{...}'
                    - pattern-not: '{..., "was_impersonated": $V, ...}'
      message: "Dict appended for bulk_log_activity() must include 'was_impersonated'"
      languages: [python]
      severity: ERROR
