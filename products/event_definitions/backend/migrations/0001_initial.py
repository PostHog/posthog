# Generated by Django 4.2.28 on 2026-02-20 06:11

import django.utils.timezone
import django.db.models.deletion
import django.contrib.postgres.indexes
import django.db.models.functions.comparison
from django.conf import settings
from django.db import migrations, models

import posthog.models.utils


class Migration(migrations.Migration):
    initial = True

    dependencies = [
        ("posthog", "1015_normalize_feature_flag_payloads_to_strings"),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    database_operations = []

    state_operations = [
        migrations.CreateModel(
            name="EventDefinition",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.UUIDT,
                        editable=False,
                        primary_key=True,
                        serialize=False,
                    ),
                ),
                ("name", models.CharField(max_length=400)),
                (
                    "created_at",
                    models.DateTimeField(default=django.utils.timezone.now, null=True),
                ),
                ("last_seen_at", models.DateTimeField(default=None, null=True)),
                ("query_usage_30_day", models.IntegerField(default=None, null=True)),
                ("volume_30_day", models.IntegerField(default=None, null=True)),
                (
                    "enforcement_mode",
                    models.CharField(
                        choices=[("allow", "Allow"), ("reject", "Reject")],
                        default="allow",
                        max_length=10,
                    ),
                ),
                (
                    "project",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        to="posthog.project",
                    ),
                ),
                (
                    "team",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="event_definitions",
                        related_query_name="team",
                        to="posthog.team",
                    ),
                ),
            ],
            options={
                "db_table": "posthog_eventdefinition",
            },
        ),
        migrations.CreateModel(
            name="SchemaPropertyGroup",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.UUIDT,
                        editable=False,
                        primary_key=True,
                        serialize=False,
                    ),
                ),
                ("name", models.CharField(max_length=400)),
                ("description", models.TextField(blank=True)),
                ("created_at", models.DateTimeField(default=django.utils.timezone.now)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "created_by",
                    models.ForeignKey(
                        blank=True,
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="created_schema_property_groups",
                        to=settings.AUTH_USER_MODEL,
                    ),
                ),
                (
                    "project",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        to="posthog.project",
                    ),
                ),
                (
                    "team",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="schema_property_groups",
                        related_query_name="schema_property_group",
                        to="posthog.team",
                    ),
                ),
            ],
            options={
                "db_table": "posthog_schemapropertygroup",
            },
        ),
        migrations.CreateModel(
            name="PropertyDefinition",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.UUIDT,
                        editable=False,
                        primary_key=True,
                        serialize=False,
                    ),
                ),
                ("name", models.CharField(max_length=400)),
                ("is_numerical", models.BooleanField(default=False)),
                (
                    "property_type",
                    models.CharField(
                        blank=True,
                        choices=[
                            ("DateTime", "DateTime"),
                            ("String", "String"),
                            ("Numeric", "Numeric"),
                            ("Boolean", "Boolean"),
                            ("Duration", "Duration"),
                        ],
                        max_length=50,
                        null=True,
                    ),
                ),
                (
                    "type",
                    models.PositiveSmallIntegerField(
                        choices=[
                            (1, "event"),
                            (2, "person"),
                            (3, "group"),
                            (4, "session"),
                        ],
                        default=1,
                    ),
                ),
                ("group_type_index", models.PositiveSmallIntegerField(null=True)),
                (
                    "property_type_format",
                    models.CharField(
                        blank=True,
                        choices=[
                            ("unix_timestamp", "Unix Timestamp in seconds"),
                            (
                                "unix_timestamp_milliseconds",
                                "Unix Timestamp in milliseconds",
                            ),
                            ("YYYY-MM-DDThh:mm:ssZ", "YYYY-MM-DDThh:mm:ssZ"),
                            ("YYYY-MM-DD hh:mm:ss", "YYYY-MM-DD hh:mm:ss"),
                            ("DD-MM-YYYY hh:mm:ss", "DD-MM-YYYY hh:mm:ss"),
                            ("YYYY-MM-DD", "YYYY-MM-DD"),
                            ("rfc_822", "day, DD MMM YYYY hh:mm:ss TZ"),
                            ("YYYY/MM/DD hh:mm:ss", "YYYY/MM/DD hh:mm:ss"),
                            ("DD/MM/YYYY hh:mm:ss", "DD/MM/YYYY hh:mm:ss"),
                        ],
                        max_length=50,
                        null=True,
                    ),
                ),
                ("volume_30_day", models.IntegerField(default=None, null=True)),
                ("query_usage_30_day", models.IntegerField(default=None, null=True)),
                (
                    "project",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        to="posthog.project",
                    ),
                ),
                (
                    "team",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="property_definitions",
                        related_query_name="team",
                        to="posthog.team",
                    ),
                ),
            ],
            options={
                "db_table": "posthog_propertydefinition",
            },
        ),
        migrations.CreateModel(
            name="EventSchema",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.UUIDT,
                        editable=False,
                        primary_key=True,
                        serialize=False,
                    ),
                ),
                ("created_at", models.DateTimeField(default=django.utils.timezone.now)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "event_definition",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="schemas",
                        related_query_name="schema",
                        to="event_definitions.eventdefinition",
                    ),
                ),
                (
                    "property_group",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="event_schemas",
                        related_query_name="event_schema",
                        to="event_definitions.schemapropertygroup",
                    ),
                ),
            ],
            options={
                "db_table": "posthog_eventschema",
            },
        ),
        migrations.CreateModel(
            name="EventProperty",
            fields=[
                ("id", models.BigAutoField(primary_key=True, serialize=False)),
                ("event", models.CharField(max_length=400)),
                ("property", models.CharField(max_length=400)),
                (
                    "project",
                    models.ForeignKey(
                        null=True,
                        on_delete=django.db.models.deletion.CASCADE,
                        to="posthog.project",
                    ),
                ),
                (
                    "team",
                    models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, to="posthog.team"),
                ),
            ],
            options={
                "db_table": "posthog_eventproperty",
            },
        ),
        migrations.CreateModel(
            name="SchemaPropertyGroupProperty",
            fields=[
                (
                    "id",
                    models.UUIDField(
                        default=posthog.models.utils.UUIDT,
                        editable=False,
                        primary_key=True,
                        serialize=False,
                    ),
                ),
                ("name", models.CharField(max_length=400)),
                (
                    "property_type",
                    models.CharField(
                        choices=[
                            ("DateTime", "DateTime"),
                            ("String", "String"),
                            ("Numeric", "Numeric"),
                            ("Boolean", "Boolean"),
                            ("Object", "Object"),
                        ],
                        max_length=50,
                    ),
                ),
                ("is_required", models.BooleanField(default=False)),
                ("description", models.TextField(blank=True)),
                ("created_at", models.DateTimeField(default=django.utils.timezone.now)),
                ("updated_at", models.DateTimeField(auto_now=True)),
                (
                    "property_group",
                    models.ForeignKey(
                        on_delete=django.db.models.deletion.CASCADE,
                        related_name="properties",
                        related_query_name="property",
                        to="event_definitions.schemapropertygroup",
                    ),
                ),
            ],
            options={
                "db_table": "posthog_schemapropertygroupproperty",
                "ordering": ["name"],
                "indexes": [
                    models.Index(
                        fields=["property_group", "name"],
                        name="schema_pgp_group_name_idx",
                    )
                ],
            },
        ),
        migrations.AddConstraint(
            model_name="schemapropertygroupproperty",
            constraint=models.UniqueConstraint(
                fields=("property_group", "name"),
                name="unique_property_group_property_name",
            ),
        ),
        migrations.AddIndex(
            model_name="schemapropertygroup",
            index=models.Index(fields=["team", "name"], name="schema_pg_team_name_idx"),
        ),
        migrations.AddConstraint(
            model_name="schemapropertygroup",
            constraint=models.UniqueConstraint(fields=("team", "name"), name="unique_schema_property_group_team_name"),
        ),
        migrations.AddIndex(
            model_name="propertydefinition",
            index=models.Index(fields=["project"], name="posthog_prop_proj_id_d3eb982d"),
        ),
        migrations.AddIndex(
            model_name="propertydefinition",
            index=models.Index(
                models.F("team_id"),
                models.F("type"),
                django.db.models.functions.comparison.Coalesce(models.F("group_type_index"), -1),
                models.OrderBy(models.F("query_usage_30_day"), descending=True, nulls_last=True),
                models.OrderBy(models.F("name")),
                name="index_property_def_query",
            ),
        ),
        migrations.AddIndex(
            model_name="propertydefinition",
            index=models.Index(
                django.db.models.functions.comparison.Coalesce(models.F("project_id"), models.F("team_id")),
                models.F("type"),
                django.db.models.functions.comparison.Coalesce(models.F("group_type_index"), -1),
                models.OrderBy(models.F("query_usage_30_day"), descending=True, nulls_last=True),
                models.OrderBy(models.F("name")),
                name="index_property_def_query_proj",
            ),
        ),
        migrations.AddIndex(
            model_name="propertydefinition",
            index=models.Index(
                fields=["team_id", "type", "is_numerical"],
                name="posthog_pro_team_id_eac36d_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="propertydefinition",
            index=models.Index(
                django.db.models.functions.comparison.Coalesce(models.F("project_id"), models.F("team_id")),
                models.F("type"),
                models.F("is_numerical"),
                name="posthog_pro_project_3583d2_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="propertydefinition",
            index=django.contrib.postgres.indexes.GinIndex(
                fields=["name"],
                name="index_property_definition_name",
                opclasses=["gin_trgm_ops"],
            ),
        ),
        migrations.AddConstraint(
            model_name="propertydefinition",
            constraint=models.CheckConstraint(
                check=models.Q(
                    (
                        "property_type__in",
                        ["DateTime", "String", "Numeric", "Boolean", "Duration"],
                    )
                ),
                name="property_type_is_valid",
            ),
        ),
        migrations.AddConstraint(
            model_name="propertydefinition",
            constraint=models.CheckConstraint(
                check=models.Q(
                    models.Q(("type", 3), _negated=True),
                    ("group_type_index__isnull", False),
                    _connector="OR",
                ),
                name="group_type_index_set",
            ),
        ),
        migrations.AddConstraint(
            model_name="propertydefinition",
            constraint=posthog.models.utils.UniqueConstraintByExpression(
                concurrently=True,
                expression="(coalesce(project_id, team_id), name, type, coalesce(group_type_index, -1))",
                name="posthog_propdef_proj_uniq",
            ),
        ),
        migrations.AddConstraint(
            model_name="eventschema",
            constraint=models.UniqueConstraint(
                fields=("event_definition", "property_group"),
                name="unique_event_schema",
            ),
        ),
        migrations.AddIndex(
            model_name="eventproperty",
            index=models.Index(fields=["project"], name="posthog_eve_proj_id_dd2337d2"),
        ),
        migrations.AddIndex(
            model_name="eventproperty",
            index=models.Index(fields=["team", "event"], name="posthog_eve_team_id_22de03_idx"),
        ),
        migrations.AddIndex(
            model_name="eventproperty",
            index=models.Index(
                django.db.models.functions.comparison.Coalesce(models.F("project_id"), models.F("team_id")),
                models.F("event"),
                name="posthog_eve_proj_id_22de03_idx",
            ),
        ),
        migrations.AddIndex(
            model_name="eventproperty",
            index=models.Index(fields=["team", "property"], name="posthog_eve_team_id_26dbfb_idx"),
        ),
        migrations.AddIndex(
            model_name="eventproperty",
            index=models.Index(
                django.db.models.functions.comparison.Coalesce(models.F("project_id"), models.F("team_id")),
                models.F("property"),
                name="posthog_eve_proj_id_26dbfb_idx",
            ),
        ),
        migrations.AddConstraint(
            model_name="eventproperty",
            constraint=posthog.models.utils.UniqueConstraintByExpression(
                concurrently=True,
                expression="(coalesce(project_id, team_id), event, property)",
                name="posthog_event_property_unique_proj_event_property",
            ),
        ),
        migrations.AddIndex(
            model_name="eventdefinition",
            index=models.Index(fields=["project"], name="posthog_eve_proj_id_f93fcbb0"),
        ),
        migrations.AddIndex(
            model_name="eventdefinition",
            index=django.contrib.postgres.indexes.GinIndex(
                fields=["name"],
                name="index_event_definition_name",
                opclasses=["gin_trgm_ops"],
            ),
        ),
        migrations.AddIndex(
            model_name="eventdefinition",
            index=models.Index(
                condition=models.Q(("enforcement_mode", "reject")),
                fields=["team_id"],
                name="posthog_eventdef_enforce_idx",
            ),
        ),
        migrations.AddConstraint(
            model_name="eventdefinition",
            constraint=posthog.models.utils.UniqueConstraintByExpression(
                concurrently=True,
                expression="(coalesce(project_id, team_id), name)",
                name="event_definition_proj_uniq",
            ),
        ),
    ]

    operations = [
        migrations.SeparateDatabaseAndState(
            database_operations=database_operations,
            state_operations=state_operations,
        )
    ]
