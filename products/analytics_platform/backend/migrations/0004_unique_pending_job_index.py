# Generated by Django 4.2.26

from django.db import migrations


class Migration(migrations.Migration):
    # Required for CREATE INDEX CONCURRENTLY
    atomic = False

    dependencies = [
        ("analytics_platform", "0003_preaggregation_job_expires_at_index"),
    ]

    operations = [
        # Add partial unique index to prevent duplicate pending jobs for the same range
        # This ensures only one PENDING job can exist per (team, query_hash, range) at a time
        # Using CONCURRENTLY to avoid locking the table in production
        migrations.RunSQL(
            sql="""
                CREATE UNIQUE INDEX CONCURRENTLY IF NOT EXISTS unique_pending_job_per_range
                ON analytics_platform_preaggregationjob (team_id, query_hash, time_range_start, time_range_end)
                WHERE status = 'pending';
            """,
            reverse_sql="DROP INDEX CONCURRENTLY IF EXISTS unique_pending_job_per_range;",
        ),
    ]
