# serializer version: 1
# name: TestMarketingAnalyticsAdapters.test_azure_adapter_query_generation
  '''
  
  SELECT toString(campaign_name) AS match_key, toString(campaign_name) AS campaign, toString(campaign_name) AS id, toString(`'Azure'`) AS source, toFloat(coalesce(impressions, 0)) AS impressions, toFloat(coalesce(clicks, 0)) AS clicks, toFloat(convertCurrency('\'USD\'', 'USD', toFloat(coalesce(spend, 0)))) AS cost, toFloat(coalesce(conversions, 0)) AS reported_conversion, toFloat(coalesce(0, 0)) AS reported_conversion_value 
  FROM azure_table 
  WHERE and(greaterOrEquals(toDateTime(report_date), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(report_date), toDateTime('2024-12-31 23:59:59')))
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_bing_ads_native_query_generation
  '''
  
  SELECT toString(bing_campaigns.name) AS match_key, toString(bing_campaigns.name) AS campaign, toString(bing_campaigns.id) AS id, toString('bing') AS source, toFloat(SUM(ifNull(toFloat(bing_campaign_performance_report.impressions), 0))) AS impressions, toFloat(SUM(ifNull(toFloat(bing_campaign_performance_report.clicks), 0))) AS clicks, SUM(ifNull(toFloat(bing_campaign_performance_report.spend), 0)) AS cost, toFloat(SUM(ifNull(toFloat(bing_campaign_performance_report.conversions), 0))) AS reported_conversion, toFloat(SUM(ifNull(toFloat(bing_campaign_performance_report.revenue), 0))) AS reported_conversion_value 
  FROM bing_campaigns LEFT JOIN bing_campaign_performance_report ON equals(toString(bing_campaigns.id), toString(bing_campaign_performance_report.campaign_id)) 
  WHERE and(greaterOrEquals(toDateTime(bing_campaign_performance_report.time_period), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(bing_campaign_performance_report.time_period), toDateTime('2024-12-31 23:59:59'))) 
  GROUP BY toString(bing_campaigns.name), toString(bing_campaigns.id)
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_cloudflare_r2_adapter_query_generation
  '''
  
  SELECT toString(campaign_name) AS match_key, toString(campaign_name) AS campaign, toString(campaign_name) AS id, toString(`'Cloudflare'`) AS source, toFloat(coalesce(impressions, 0)) AS impressions, toFloat(coalesce(clicks, 0)) AS clicks, toFloat(convertCurrency('\'USD\'', 'USD', toFloat(coalesce(spend, 0)))) AS cost, toFloat(coalesce(conversions, 0)) AS reported_conversion, toFloat(coalesce(0, 0)) AS reported_conversion_value 
  FROM cloudflare_table 
  WHERE and(greaterOrEquals(toDateTime(report_date), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(report_date), toDateTime('2024-12-31 23:59:59')))
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_currency_conversion_handling
  '''
  
  SELECT toString(campaign_name) AS match_key, toString(campaign_name) AS campaign, toString(campaign_name) AS id, toString(`'Facebook'`) AS source, toFloat(coalesce(impressions, 0)) AS impressions, toFloat(coalesce(clicks, 0)) AS clicks, toFloat(convertCurrency('spend_currency', 'USD', toFloat(coalesce(spend_amount, 0)))) AS cost, toFloat(coalesce(conversions, 0)) AS reported_conversion, toFloat(coalesce(0, 0)) AS reported_conversion_value 
  FROM currency_test_table 
  WHERE and(greaterOrEquals(toDateTime(date), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(date), toDateTime('2024-12-31 23:59:59')))
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_facebook_ads_query_generation
  '''
  
  SELECT toString(campaign_name) AS match_key, toString(campaign_name) AS campaign, toString(campaign_name) AS id, toString(`'Facebook'`) AS source, toFloat(coalesce(impressions, 0)) AS impressions, toFloat(coalesce(clicks, 0)) AS clicks, toFloat(convertCurrency('\'USD\'', 'USD', toFloat(coalesce(spend_usd, 0)))) AS cost, toFloat(coalesce(conversions, 0)) AS reported_conversion, toFloat(coalesce(0, 0)) AS reported_conversion_value 
  FROM facebook_table 
  WHERE and(greaterOrEquals(toDateTime(report_date), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(report_date), toDateTime('2024-12-31 23:59:59')))
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_google_ads_query_generation
  '''
  
  SELECT toString(google_campaign.campaign_name) AS match_key, toString(google_campaign.campaign_name) AS campaign, toString(google_campaign.campaign_id) AS id, toString('google') AS source, toFloat(SUM(ifNull(toFloat(google_stats.metrics_impressions), 0))) AS impressions, toFloat(SUM(ifNull(toFloat(google_stats.metrics_clicks), 0))) AS clicks, toFloat(convertCurrency('USD', 'USD', SUM(toFloat(divide(google_stats.metrics_cost_micros, 1000000))))) AS cost, toFloat(SUM(ifNull(toFloat(google_stats.metrics_conversions), 0))) AS reported_conversion, toFloat(SUM(ifNull(toFloat(google_stats.metrics_conversions_value), 0))) AS reported_conversion_value 
  FROM google_campaign LEFT JOIN google_stats ON equals(google_campaign.campaign_id, google_stats.campaign_id) 
  WHERE and(greaterOrEquals(toDateTime(google_stats.segments_date), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(google_stats.segments_date), toDateTime('2024-12-31 23:59:59'))) 
  GROUP BY toString(google_campaign.campaign_name), toString(google_campaign.campaign_id)
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_linkedin_ads_query_generation
  '''
  
  SELECT toString(linkedin_campaigns.name) AS match_key, toString(linkedin_campaigns.name) AS campaign, toString(linkedin_campaigns.id) AS id, toString('linkedin') AS source, toFloat(SUM(ifNull(toFloat(linkedin_stats.impressions), 0))) AS impressions, toFloat(SUM(ifNull(toFloat(linkedin_stats.clicks), 0))) AS clicks, toFloat(SUM(ifNull(toFloat(linkedin_stats.cost_in_usd), 0))) AS cost, toFloat(SUM(ifNull(toFloat(linkedin_stats.external_website_conversions), 0))) AS reported_conversion, 0 AS reported_conversion_value 
  FROM linkedin_campaigns LEFT JOIN linkedin_stats ON equals(linkedin_campaigns.id, linkedin_stats.campaign_id) 
  WHERE and(greaterOrEquals(toDateTime(linkedin_stats.date_start), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(linkedin_stats.date_start), toDateTime('2024-12-31 23:59:59'))) 
  GROUP BY toString(linkedin_campaigns.name), toString(linkedin_campaigns.id)
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_match_key_uses_campaign_id_when_configured
  '''
  
  SELECT toString(metaads_campaigns.id) AS match_key, toString(metaads_campaigns.name) AS campaign, toString(metaads_campaigns.id) AS id, toString('meta') AS source, toFloat(SUM(ifNull(toFloat(metaads_campaign_stats.impressions), 0))) AS impressions, toFloat(SUM(ifNull(toFloat(metaads_campaign_stats.clicks), 0))) AS clicks, SUM(ifNull(toFloat(metaads_campaign_stats.spend), 0)) AS cost, 0 AS reported_conversion, 0 AS reported_conversion_value 
  FROM metaads_campaigns LEFT JOIN metaads_campaign_stats ON equals(metaads_campaigns.id, metaads_campaign_stats.campaign_id) 
  WHERE and(greaterOrEquals(toDateTime(metaads_campaign_stats.date_stop), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(metaads_campaign_stats.date_stop), toDateTime('2024-12-31 23:59:59'))) 
  GROUP BY toString(metaads_campaigns.name), toString(metaads_campaigns.id)
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_match_key_uses_campaign_name_by_default
  '''
  
  SELECT toString(metaads_campaigns.name) AS match_key, toString(metaads_campaigns.name) AS campaign, toString(metaads_campaigns.id) AS id, toString('meta') AS source, toFloat(SUM(ifNull(toFloat(metaads_campaign_stats.impressions), 0))) AS impressions, toFloat(SUM(ifNull(toFloat(metaads_campaign_stats.clicks), 0))) AS clicks, SUM(ifNull(toFloat(metaads_campaign_stats.spend), 0)) AS cost, 0 AS reported_conversion, 0 AS reported_conversion_value 
  FROM metaads_campaigns LEFT JOIN metaads_campaign_stats ON equals(metaads_campaigns.id, metaads_campaign_stats.campaign_id) 
  WHERE and(greaterOrEquals(toDateTime(metaads_campaign_stats.date_stop), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(metaads_campaign_stats.date_stop), toDateTime('2024-12-31 23:59:59'))) 
  GROUP BY toString(metaads_campaigns.name), toString(metaads_campaigns.id)
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_meta_ads_query_generation
  '''
  
  SELECT toString(meta_campaigns.name) AS match_key, toString(meta_campaigns.name) AS campaign, toString(meta_campaigns.id) AS id, toString('meta') AS source, toFloat(SUM(ifNull(toFloat(meta_campaign_stats.impressions), 0))) AS impressions, toFloat(SUM(ifNull(toFloat(meta_campaign_stats.clicks), 0))) AS clicks, SUM(ifNull(toFloat(meta_campaign_stats.spend), 0)) AS cost, toFloat(SUM(if(greater(arraySum(x -> JSONExtractFloat(x, 'value'), arrayFilter(x -> or(equals(JSONExtractString(x, 'action_type'), 'omni_purchase'), equals(JSONExtractString(x, 'action_type'), 'omni_lead'), equals(JSONExtractString(x, 'action_type'), 'omni_complete_registration'), equals(JSONExtractString(x, 'action_type'), 'omni_app_install'), equals(JSONExtractString(x, 'action_type'), 'omni_subscribe')), JSONExtractArrayRaw(coalesce(meta_campaign_stats.actions, '[]')))), 0), arraySum(x -> JSONExtractFloat(x, 'value'), arrayFilter(x -> or(equals(JSONExtractString(x, 'action_type'), 'omni_purchase'), equals(JSONExtractString(x, 'action_type'), 'omni_lead'), equals(JSONExtractString(x, 'action_type'), 'omni_complete_registration'), equals(JSONExtractString(x, 'action_type'), 'omni_app_install'), equals(JSONExtractString(x, 'action_type'), 'omni_subscribe')), JSONExtractArrayRaw(coalesce(meta_campaign_stats.actions, '[]')))), arraySum(x -> JSONExtractFloat(x, 'value'), arrayFilter(x -> or(equals(JSONExtractString(x, 'action_type'), 'purchase'), equals(JSONExtractString(x, 'action_type'), 'offsite_conversion.fb_pixel_purchase'), equals(JSONExtractString(x, 'action_type'), 'app_custom_event.fb_mobile_purchase'), equals(JSONExtractString(x, 'action_type'), 'lead'), equals(JSONExtractString(x, 'action_type'), 'offsite_conversion.fb_pixel_lead'), equals(JSONExtractString(x, 'action_type'), 'onsite_conversion.lead_grouped'), equals(JSONExtractString(x, 'action_type'), 'complete_registration'), equals(JSONExtractString(x, 'action_type'), 'offsite_conversion.fb_pixel_complete_registration'), equals(JSONExtractString(x, 'action_type'), 'app_custom_event.fb_mobile_complete_registration'), equals(JSONExtractString(x, 'action_type'), 'offsite_complete_registration_add_meta_leads'), equals(JSONExtractString(x, 'action_type'), 'app_install'), equals(JSONExtractString(x, 'action_type'), 'mobile_app_install'), equals(JSONExtractString(x, 'action_type'), 'subscribe'), equals(JSONExtractString(x, 'action_type'), 'offsite_conversion.fb_pixel_subscribe')), JSONExtractArrayRaw(coalesce(meta_campaign_stats.actions, '[]'))))))) AS reported_conversion, toFloat(SUM(if(greater(arraySum(x -> JSONExtractFloat(x, 'value'), arrayFilter(x -> or(equals(JSONExtractString(x, 'action_type'), 'omni_purchase'), equals(JSONExtractString(x, 'action_type'), 'omni_lead'), equals(JSONExtractString(x, 'action_type'), 'omni_complete_registration'), equals(JSONExtractString(x, 'action_type'), 'omni_app_install'), equals(JSONExtractString(x, 'action_type'), 'omni_subscribe')), JSONExtractArrayRaw(coalesce(meta_campaign_stats.action_values, '[]')))), 0), arraySum(x -> JSONExtractFloat(x, 'value'), arrayFilter(x -> or(equals(JSONExtractString(x, 'action_type'), 'omni_purchase'), equals(JSONExtractString(x, 'action_type'), 'omni_lead'), equals(JSONExtractString(x, 'action_type'), 'omni_complete_registration'), equals(JSONExtractString(x, 'action_type'), 'omni_app_install'), equals(JSONExtractString(x, 'action_type'), 'omni_subscribe')), JSONExtractArrayRaw(coalesce(meta_campaign_stats.action_values, '[]')))), arraySum(x -> JSONExtractFloat(x, 'value'), arrayFilter(x -> or(equals(JSONExtractString(x, 'action_type'), 'purchase'), equals(JSONExtractString(x, 'action_type'), 'offsite_conversion.fb_pixel_purchase'), equals(JSONExtractString(x, 'action_type'), 'app_custom_event.fb_mobile_purchase'), equals(JSONExtractString(x, 'action_type'), 'lead'), equals(JSONExtractString(x, 'action_type'), 'offsite_conversion.fb_pixel_lead'), equals(JSONExtractString(x, 'action_type'), 'onsite_conversion.lead_grouped'), equals(JSONExtractString(x, 'action_type'), 'complete_registration'), equals(JSONExtractString(x, 'action_type'), 'offsite_conversion.fb_pixel_complete_registration'), equals(JSONExtractString(x, 'action_type'), 'app_custom_event.fb_mobile_complete_registration'), equals(JSONExtractString(x, 'action_type'), 'offsite_complete_registration_add_meta_leads'), equals(JSONExtractString(x, 'action_type'), 'app_install'), equals(JSONExtractString(x, 'action_type'), 'mobile_app_install'), equals(JSONExtractString(x, 'action_type'), 'subscribe'), equals(JSONExtractString(x, 'action_type'), 'offsite_conversion.fb_pixel_subscribe')), JSONExtractArrayRaw(coalesce(meta_campaign_stats.action_values, '[]'))))))) AS reported_conversion_value 
  FROM meta_campaigns LEFT JOIN meta_campaign_stats ON equals(meta_campaigns.id, meta_campaign_stats.campaign_id) 
  WHERE and(greaterOrEquals(toDateTime(meta_campaign_stats.date_stop), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(meta_campaign_stats.date_stop), toDateTime('2024-12-31 23:59:59'))) 
  GROUP BY toString(meta_campaigns.name), toString(meta_campaigns.id)
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_reddit_ads_query_generation
  '''
  
  SELECT toString(reddit_campaign.name) AS match_key, toString(reddit_campaign.name) AS campaign, toString(reddit_campaign.id) AS id, toString('reddit') AS source, toFloat(SUM(ifNull(toFloat(reddit_stats.impressions), 0))) AS impressions, toFloat(SUM(ifNull(toFloat(reddit_stats.clicks), 0))) AS clicks, SUM(toFloat(divide(reddit_stats.spend, 1000000))) AS cost, toFloat(SUM(ifNull(toFloat(reddit_stats.key_conversion_total_count), 0))) AS reported_conversion, toFloat(plus(SUM(ifNull(toFloat(reddit_stats.conversion_purchase_total_value), 0)), SUM(ifNull(toFloat(reddit_stats.conversion_signup_total_value), 0)))) AS reported_conversion_value 
  FROM reddit_campaign LEFT JOIN reddit_stats ON equals(reddit_campaign.id, reddit_stats.campaign_id) 
  WHERE and(greaterOrEquals(toDateTime(reddit_stats.date), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(reddit_stats.date), toDateTime('2024-12-31 23:59:59'))) 
  GROUP BY toString(reddit_campaign.name), toString(reddit_campaign.id)
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_tiktok_ads_native_query_generation
  '''
  
  SELECT toString(tiktok_campaigns.campaign_name) AS match_key, toString(tiktok_campaigns.campaign_name) AS campaign, toString(tiktok_campaigns.campaign_id) AS id, toString('tiktok') AS source, toFloat(SUM(ifNull(toFloat(tiktok_campaign_report.impressions), 0))) AS impressions, toFloat(SUM(ifNull(toFloat(tiktok_campaign_report.clicks), 0))) AS clicks, SUM(ifNull(toFloat(tiktok_campaign_report.spend), 0)) AS cost, toFloat(SUM(ifNull(toFloat(tiktok_campaign_report.conversion), 0))) AS reported_conversion, 0 AS reported_conversion_value 
  FROM tiktok_campaigns LEFT JOIN tiktok_campaign_report ON equals(tiktok_campaigns.campaign_id, tiktok_campaign_report.campaign_id) 
  WHERE and(greaterOrEquals(toDateTime(tiktok_campaign_report.stat_time_day), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(tiktok_campaign_report.stat_time_day), toDateTime('2024-12-31 23:59:59'))) 
  GROUP BY toString(tiktok_campaigns.campaign_name), toString(tiktok_campaigns.campaign_id)
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_tiktok_ads_query_generation
  '''
  
  SELECT toString(campaign_name) AS match_key, toString(campaign_name) AS campaign, toString(campaign_name) AS id, toString(`'TikTok'`) AS source, toFloat(coalesce(impressions, 0)) AS impressions, toFloat(coalesce(clicks, 0)) AS clicks, toFloat(convertCurrency('\'USD\'', 'USD', toFloat(coalesce(spend, 0)))) AS cost, toFloat(coalesce(conversions, 0)) AS reported_conversion, toFloat(coalesce(0, 0)) AS reported_conversion_value 
  FROM tiktok_table 
  WHERE and(greaterOrEquals(toDateTime(report_date), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(report_date), toDateTime('2024-12-31 23:59:59')))
  '''
# ---
# name: TestMarketingAnalyticsAdapters.test_union_query_compatibility
  '''
  
  SELECT campaign AS campaign, source AS source, impressions AS impressions, clicks AS clicks, cost AS cost 
  FROM (
  SELECT toString(campaign_id) AS match_key, toString(campaign_id) AS campaign, toString(campaign_id) AS id, toString(`'Facebook'`) AS source, toFloat(coalesce(impressions, 0)) AS impressions, toFloat(coalesce(clicks, 0)) AS clicks, toFloat(convertCurrency('currency', 'USD', toFloat(coalesce(spend, 0)))) AS cost, toFloat(coalesce(conversions, 0)) AS reported_conversion, toFloat(coalesce(0, 0)) AS reported_conversion_value 
  FROM facebook_table 
  WHERE and(greaterOrEquals(toDateTime(date), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(date), toDateTime('2024-12-31 23:59:59'))) UNION ALL 
  SELECT toString(campaign_name) AS match_key, toString(campaign_name) AS campaign, toString(campaign_name) AS id, toString(`'TikTok'`) AS source, toFloat(coalesce(impressions, 0)) AS impressions, toFloat(coalesce(clicks, 0)) AS clicks, toFloat(convertCurrency('currency', 'USD', toFloat(coalesce(spend, 0)))) AS cost, toFloat(coalesce(conversions, 0)) AS reported_conversion, toFloat(coalesce(0, 0)) AS reported_conversion_value 
  FROM tiktok_table 
  WHERE and(greaterOrEquals(toDateTime(date), toDateTime('2024-01-01 00:00:00')), lessOrEquals(toDateTime(date), toDateTime('2024-12-31 23:59:59')))) AS all_marketing_data
  '''
# ---
