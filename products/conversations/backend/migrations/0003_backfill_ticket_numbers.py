# Generated by Django 4.2.26 on 2025-01-16 00:01

from django.db import migrations


def backfill_ticket_numbers(apps, schema_editor):
    """
    Backfill ticket_number for existing tickets.
    Each team gets its own sequence starting from 1, ordered by created_at.
    """
    Ticket = apps.get_model("conversations", "Ticket")

    # Get all teams that have tickets
    teams = Ticket.objects.values_list("team_id", flat=True).distinct()

    for team_id in teams:
        # Get all tickets for this team, ordered by created_at
        tickets = Ticket.objects.filter(team_id=team_id).order_by("created_at")

        # Assign sequential ticket numbers
        for index, ticket in enumerate(tickets, start=1):
            ticket.ticket_number = index
            ticket.save(update_fields=["ticket_number"])


def reverse_backfill(apps, schema_editor):
    """
    Reverse migration: set all ticket_numbers back to NULL.
    """
    Ticket = apps.get_model("conversations", "Ticket")
    Ticket.objects.all().update(ticket_number=None)


class Migration(migrations.Migration):
    dependencies = [
        ("conversations", "0002_ticket_ticket_number"),
    ]

    operations = [
        migrations.RunPython(backfill_ticket_numbers, reverse_backfill),
    ]
