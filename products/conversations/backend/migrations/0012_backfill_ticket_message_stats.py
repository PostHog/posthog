# Generated by Django 4.2.27 on 2026-01-22

from django.db import migrations


def backfill_message_stats(apps, schema_editor):
    """
    Backfill message_count, last_message_at, last_message_text for existing tickets.
    """
    Ticket = apps.get_model("conversations", "Ticket")
    Comment = apps.get_model("posthog", "Comment")

    batch_size = 500
    offset = 0

    while True:
        tickets = list(Ticket.objects.all()[offset : offset + batch_size])
        if not tickets:
            break

        for ticket in tickets:
            comments = Comment.objects.filter(
                team_id=ticket.team_id,
                scope="conversations_ticket",
                item_id=str(ticket.id),
                deleted=False,
            )

            ticket.message_count = comments.count()
            last_comment = comments.order_by("-created_at").first()

            if last_comment:
                ticket.last_message_at = last_comment.created_at
                ticket.last_message_text = (last_comment.content or "")[:500]

        Ticket.objects.bulk_update(
            tickets,
            ["message_count", "last_message_at", "last_message_text"],
            batch_size=batch_size,
        )

        offset += batch_size


def reverse_backfill(apps, schema_editor):
    """Reset all stats to defaults (for rollback)."""
    Ticket = apps.get_model("conversations", "Ticket")
    Ticket.objects.all().update(
        message_count=0,
        last_message_at=None,
        last_message_text=None,
    )


class Migration(migrations.Migration):
    dependencies = [
        ("conversations", "0011_ticket_message_stats_fields"),
        ("posthog", "0982_comment_conversations_index"),  # Ensure Comment model is available
    ]

    operations = [
        migrations.RunPython(backfill_message_stats, reverse_backfill),
    ]
