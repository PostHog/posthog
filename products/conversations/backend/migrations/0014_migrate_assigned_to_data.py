# Generated by Django 4.2.27 on 2026-01-23

from django.db import migrations


def migrate_assigned_to_forward(apps, schema_editor):
    """Migrate existing assigned_to data to TicketAssignment table."""
    Ticket = apps.get_model("conversations", "Ticket")
    TicketAssignment = apps.get_model("conversations", "TicketAssignment")

    # Use bulk_create for better performance
    assignments = []
    for ticket in Ticket.objects.filter(assigned_to__isnull=False).iterator(chunk_size=1000):
        assignments.append(
            TicketAssignment(
                ticket_id=ticket.id,
                user_id=ticket.assigned_to_id,
                role_id=None,
            )
        )
        if len(assignments) >= 1000:
            TicketAssignment.objects.bulk_create(assignments, ignore_conflicts=True)
            assignments = []

    if assignments:
        TicketAssignment.objects.bulk_create(assignments, ignore_conflicts=True)


def migrate_assigned_to_reverse(apps, schema_editor):
    """Reverse migration: copy TicketAssignment user back to assigned_to."""
    Ticket = apps.get_model("conversations", "Ticket")
    TicketAssignment = apps.get_model("conversations", "TicketAssignment")

    for assignment in TicketAssignment.objects.filter(user__isnull=False).iterator(chunk_size=1000):
        Ticket.objects.filter(id=assignment.ticket_id).update(assigned_to_id=assignment.user_id)


class Migration(migrations.Migration):
    dependencies = [
        ("conversations", "0013_ticket_assignment"),
    ]

    operations = [
        migrations.RunPython(migrate_assigned_to_forward, migrate_assigned_to_reverse),
    ]
