# Generated by Django 4.2.26 on 2025-01-16 00:02

from django.db import migrations


def backfill_ticket_numbers(apps, schema_editor):
    """
    Backfill ticket_number for existing tickets, per team, ordered by created_at.
    Uses batching to avoid memory issues and long locks.
    """
    Ticket = apps.get_model("conversations", "Ticket")

    # Get all distinct team IDs with tickets that need backfilling
    team_ids = list(Ticket.objects.filter(ticket_number__isnull=True).values_list("team_id", flat=True).distinct())

    for team_id in team_ids:
        # Get all tickets for this team ordered by created_at
        tickets = list(
            Ticket.objects.filter(team_id=team_id, ticket_number__isnull=True)
            .order_by("created_at")
            .only("id", "ticket_number")
        )

        # Assign sequential numbers
        for i, ticket in enumerate(tickets, start=1):
            ticket.ticket_number = i

        # Batch update
        batch_size = 1000
        for i in range(0, len(tickets), batch_size):
            Ticket.objects.bulk_update(tickets[i : i + batch_size], ["ticket_number"])


class Migration(migrations.Migration):
    atomic = False

    dependencies = [
        ("conversations", "0003_ticket_number_index"),
    ]

    operations = [
        migrations.RunPython(backfill_ticket_numbers, migrations.RunPython.noop, elidable=True),
    ]
