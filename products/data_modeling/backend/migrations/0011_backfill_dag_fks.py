# Generated by Django 4.2.28 on 2026-02-14 04:50

from django.db import migrations
from django.db.models import OuterRef, Subquery


def backfill_dag_fks(apps, _):
    DAG = apps.get_model("data_modeling", "DAG")
    Node = apps.get_model("data_modeling", "Node")
    Edge = apps.get_model("data_modeling", "Edge")

    dag_subquery = Subquery(
        DAG.objects.filter(
            team_id=OuterRef("team_id"),
            name=OuterRef("dag_id"),
        ).values("id")[:1]
    )
    Node.objects.filter(dag_fk__isnull=True).update(dag_fk=dag_subquery)
    Edge.objects.filter(dag_fk__isnull=True).update(dag_fk=dag_subquery)


class Migration(migrations.Migration):
    dependencies = [
        ("data_modeling", "0010_edge_dag_node_dag"),
    ]

    operations = [
        migrations.RunPython(backfill_dag_fks, migrations.RunPython.noop),
    ]
