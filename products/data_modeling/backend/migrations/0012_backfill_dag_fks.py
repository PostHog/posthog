# Generated by Django 4.2.28 on 2026-02-14 04:50

from django.db import migrations


def backfill_dag_fks(apps, _):
    DAG = apps.get_model("data_modeling", "DAG")
    Node = apps.get_model("data_modeling", "Node")
    Edge = apps.get_model("data_modeling", "Edge")

    batch_size = 1000
    dag_lookup = {}
    for dag in DAG.objects.values_list("team_id", "name", "id"):
        dag_lookup[(dag[0], dag[1])] = dag[2]

    default_dag = "posthog"
    nodes = Node.objects.filter(dag_id_text=default_dag)
    node_updates = []
    for node in nodes.iterator(chunk_size=batch_size):
        dag_id = dag_lookup.get((node.team_id, node.dag_id_text))
        if dag_id is None:
            continue
        node.dag_id = dag_id
        node_updates.append(node)
    if node_updates:
        Node.objects.bulk_update(node_updates, ["dag_id"], batch_size=batch_size)

    # edges must use save() since bulk_update is disabled
    edges = Edge.objects.filter(dag_id_text=default_dag)
    for edge in edges.iterator(chunk_size=batch_size):
        dag_id = dag_lookup.get((edge.team_id, edge.dag_id_text))
        if dag_id is None:
            continue
        edge.dag_id = dag_id
        edge.save(skip_validation=True, update_fields=["dag_id"])


class Migration(migrations.Migration):
    dependencies = [
        ("data_modeling", "0011_edge_dag_node_dag"),
    ]

    operations = [
        migrations.RunPython(backfill_dag_fks, migrations.RunPython.noop),
    ]
