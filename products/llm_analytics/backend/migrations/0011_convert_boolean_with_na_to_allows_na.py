# Generated by Django 4.2.26 on 2025-01-07

from django.db import migrations, models


def convert_boolean_with_na_to_allows_na(apps, schema_editor):
    """Convert boolean_with_na output_type to boolean with allows_na=True in output_config."""
    Evaluation = apps.get_model("llm_analytics", "Evaluation")

    for evaluation in Evaluation.objects.filter(output_type="boolean_with_na"):
        output_config = evaluation.output_config or {}
        output_config["allows_na"] = True
        evaluation.output_config = output_config
        evaluation.output_type = "boolean"
        evaluation.save(update_fields=["output_type", "output_config"])


def reverse_convert(apps, schema_editor):
    """Reverse: convert boolean with allows_na=True back to boolean_with_na."""
    Evaluation = apps.get_model("llm_analytics", "Evaluation")

    for evaluation in Evaluation.objects.filter(output_type="boolean"):
        output_config = evaluation.output_config or {}
        if output_config.get("allows_na"):
            evaluation.output_type = "boolean_with_na"
            output_config.pop("allows_na", None)
            evaluation.output_config = output_config
            evaluation.save(update_fields=["output_type", "output_config"])


class Migration(migrations.Migration):
    dependencies = [
        ("llm_analytics", "0010_alter_evaluation_output_type"),
    ]

    operations = [
        # First convert the data
        migrations.RunPython(convert_boolean_with_na_to_allows_na, reverse_convert),
        # Then update the field choices to only have boolean
        migrations.AlterField(
            model_name="evaluation",
            name="output_type",
            field=models.CharField(
                choices=[("boolean", "Boolean (True/False)")],
                max_length=50,
            ),
        ),
    ]
