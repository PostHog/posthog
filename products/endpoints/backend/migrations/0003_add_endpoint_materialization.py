# Generated by Django 4.2.22 on 2025-10-24 00:00

import django.db.models.deletion
from django.contrib.postgres.operations import AddIndexConcurrently
from django.db import migrations, models


class Migration(migrations.Migration):
    atomic = False  # Required for AddIndexConcurrently

    dependencies = [
        ("endpoints", "0002_endpoint_cache_age_seconds"),
    ]

    operations = [
        migrations.RunSQL(
            """
            ALTER TABLE "endpoints_endpoint" ADD COLUMN "saved_query_id" integer NULL CONSTRAINT "endpoints_endpoint_saved_query_id_fk" REFERENCES "posthog_datawarehousesavedquery"("id") DEFERRABLE INITIALLY DEFERRED;
            SET CONSTRAINTS "endpoints_endpoint_saved_query_id_fk" IMMEDIATE;
            """,
            reverse_sql="""
                ALTER TABLE "endpoints_endpoint" DROP COLUMN IF EXISTS "saved_query_id";
            """,
            state_operations=[
                migrations.AddField(
                    model_name="endpoint",
                    name="saved_query",
                    field=models.ForeignKey(
                        blank=True,
                        help_text="The underlying materialized view that backs this endpoint",
                        null=True,
                        on_delete=django.db.models.deletion.SET_NULL,
                        related_name="endpoints",
                        to="posthog.datawarehousesavedquery",
                    ),
                )
            ],
        ),
        AddIndexConcurrently(
            model_name="endpoint",
            index=models.Index(fields=["saved_query"], name="endpoints_endpoint_saved_query_idx"),
        ),
    ]
