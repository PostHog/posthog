# Generated by Django 4.2.22 on 2025-11-05 13:20

from django.db import migrations


def create_initial_versions(apps, schema_editor):
    """For each existing endpoint, create version 1 with current query."""
    Endpoint = apps.get_model("endpoints", "Endpoint")
    EndpointVersion = apps.get_model("endpoints", "EndpointVersion")

    endpoints = Endpoint.objects.all()
    versions_to_create = []

    for endpoint in endpoints:
        versions_to_create.append(
            EndpointVersion(
                endpoint=endpoint,
                version=1,
                query=endpoint.query,
                created_at=endpoint.created_at,
                created_by=endpoint.created_by,
            )
        )

    EndpointVersion.objects.bulk_create(versions_to_create, batch_size=500)


def reverse_migration(apps, schema_editor):
    """Delete all version 1 records."""
    EndpointVersion = apps.get_model("endpoints", "EndpointVersion")
    EndpointVersion.objects.filter(version=1).delete()


class Migration(migrations.Migration):
    dependencies = [
        ("endpoints", "0004_endpoint_current_version_endpointversion_and_more"),
    ]

    operations = [
        migrations.RunPython(create_initial_versions, reverse_migration),
    ]
