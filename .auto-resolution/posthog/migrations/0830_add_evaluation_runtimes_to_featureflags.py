# Generated by Django 4.2.22 on 2025-08-21 21:12

from django.db import migrations


def backfill_evaluation_runtime(apps, schema_editor):
    """Backfill evaluation_runtime field in batches to avoid locking"""
    FeatureFlag = apps.get_model("posthog", "FeatureFlag")

    batch_size = 1000
    total_updated = 0

    while True:
        # Get batch of records where evaluation_runtime is NULL
        batch_ids = list(
            FeatureFlag.objects.filter(evaluation_runtime__isnull=True).values_list("id", flat=True)[:batch_size]
        )

        if not batch_ids:
            break

        # Update this batch
        updated_count = FeatureFlag.objects.filter(id__in=batch_ids).update(evaluation_runtime="all")
        total_updated += updated_count

        # If we updated fewer than batch_size, we're done
        if updated_count < batch_size:
            break


class Migration(migrations.Migration):
    dependencies = [
        ("posthog", "0829_organization_default_role"),
    ]

    operations = [
        # Only backfill existing column; do not add or alter schema here
        migrations.RunPython(
            backfill_evaluation_runtime,
            migrations.RunPython.noop,
        ),
    ]
