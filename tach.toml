# ============================================================================
# NOTE: Tach is currently NOT enforced in CI
# ============================================================================
# This config documents existing coupling and provides infrastructure for future isolation.
#
# Current state:
# - All existing products in 'non_isolated' layer (can import from each other)
# - Core (posthog/ee) explicitly coupled to products (legacy mess, we accept this)
# - Zero violations = current code is blessed as-is
#
# For new isolated products:
# - Add with layer="products" to prevent coupling
# - See commented example at bottom of file
#
# Local development usage:
#   tach check        # Verify you haven't violated boundaries
#   tach test         # Run only tests affected by your changes
#   tach sync         # Update dependencies from actual imports
#
# To enforce in CI: Add to GitHub Actions workflow after team alignment
# ============================================================================

interfaces = []

# Two-tier layer system for products only:
# Layers listed from highest to lowest
# - products: NEW products (isolated from each other, can import from non_isolated and core)
# - non_isolated: Existing products (can import from each other)
# Note: core (posthog/ee/<root>) is NOT in a layer - uses explicit depends_on
# This allows core to be bidirectionally coupled with products (legacy mess)
layers = [
    "products",
    "non_isolated",
]
exclude = [
    ".*__pycache__",
    ".*egg-info",
    "docs",
    "tests",
]
source_roots = [
    ".",
]

[[modules]]
path = "<root>"
depends_on = [
    "ee",
    "posthog",
    "products.data_warehouse",
    "products.error_tracking",
    "products.experiments",
    "products.llm_analytics",
]
# layer intentionally omitted - core is coupled to everything

[[modules]]
path = "common.hogql_parser"
depends_on = []
# layer intentionally omitted - utility module
utility = true

[[modules]]
path = "common.hogvm.python"
depends_on = [
    "posthog",
]
# layer intentionally omitted - utility module
utility = true

[[modules]]
path = "ee"
depends_on = [
    "<root>",
    "posthog",
    "products.dashboards",
    "products.data_warehouse",
    "products.error_tracking",
    "products.experiments",
    "products.feature_flags",
    "products.llm_analytics",
    "products.notebooks",
    "products.replay",
    "products.revenue_analytics",
    "products.surveys",
]
# layer intentionally omitted - core is coupled to everything

[[modules]]
path = "posthog"
depends_on = [
    "<root>",
    "ee",
    "products.batch_exports",
    "products.customer_analytics",
    "products.data_warehouse",
    "products.desktop_recordings",
    "products.early_access_features",
    "products.endpoints",
    "products.error_tracking",
    "products.experiments",
    "products.links",
    "products.live_debugger",
    "products.llm_analytics",
    "products.logs",
    "products.marketing_analytics",
    "products.notebooks",
    "products.revenue_analytics",
    "products.tasks",
    "products.user_interviews",
    "products.workflows",
]
# layer intentionally omitted - core is coupled to everything

[[modules]]
path = "products.batch_exports"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.cdp"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.customer_analytics"
depends_on = [
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.dashboards"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.data_warehouse"
depends_on = [
    "ee",
    "posthog",
    "products.revenue_analytics",
]
layer = "non_isolated"

[[modules]]
path = "products.desktop_recordings"
depends_on = [
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.early_access_features"
depends_on = [
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.endpoints"
depends_on = [
    "common.hogvm.python",
    "posthog",
    "products.data_warehouse",
]
layer = "non_isolated"

[[modules]]
path = "products.error_tracking"
depends_on = [
    "common.hogvm.python",
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.experiments"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.feature_flags"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.links"
depends_on = [
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.live_debugger"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.llm_analytics"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.logs"
depends_on = [
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.managed_migrations"
depends_on = [
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.marketing_analytics"
depends_on = [
    "posthog",
    "products.data_warehouse",
]
layer = "non_isolated"

[[modules]]
path = "products.notebooks"
depends_on = [
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.product_analytics"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.replay"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.revenue_analytics"
depends_on = [
    "ee",
    "posthog",
    "products.data_warehouse",
]
layer = "non_isolated"

[[modules]]
path = "products.surveys"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.tasks"
depends_on = [
    "posthog",
    "products.llm_analytics",
]
layer = "non_isolated"

[[modules]]
path = "products.user_interviews"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.web_analytics"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

[[modules]]
path = "products.workflows"
depends_on = [
    "ee",
    "posthog",
]
layer = "non_isolated"

# ============================================================================
# Template for New Isolated Products
# ============================================================================
# When creating a new product that should be isolated from existing products,
# add it with the "products" layer. This prevents it from importing from
# other products in the same layer, while allowing imports from non_isolated
# products and core infrastructure.
#
# Example:
# [[modules]]
# path = "products.new_feature"
# depends_on = ["posthog"]  # Can only depend on core infrastructure
# layer = "products"        # Isolated from other new products
#
# This enables:
# - ✅ Import from posthog/ee (core infrastructure)
# - ✅ Import from non_isolated products (existing legacy products)
# - ❌ Import from other "products" layer modules (enforced isolation)
# - ✅ Isolated testing with 'tach test' (only runs affected tests)
# ============================================================================

[[modules]]
path = "products.visual_review"
depends_on = ["posthog"]  # Only core - no ee, no other products
layer = "products"
