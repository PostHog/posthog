if command -v flox >/dev/null 2>&1; then # Only activate flox if installed
    # Check if Flox environment is already active for this project or its subdirectories
    if [ -z "${FLOX_ENV_PROJECT}" ] || [[ "${PWD}" != "${FLOX_ENV_PROJECT}"* ]]; then
        # Check if we would be nesting environments
        if [ -n "${FLOX_ENV_PROJECT}" ]; then
            echo "⚠️  About to activate Flox environment in worktree while already in environment for:"
            echo "   ${FLOX_ENV_PROJECT}"
            echo ""
            read -p "Continue with nested activation? (y/N): " -n 1 -r
            echo ""
            if [[ ! $REPLY =~ ^[Yy]$ ]]; then
                echo "Skipping Flox activation. Run 'exit' first if you want to switch environments."
                return 0
            fi
        fi
        # Clean up conflicting environment variables before activation
        unset VIRTUAL_ENV PYTHONPATH CONDA_DEFAULT_ENV 2>/dev/null || true
        flox activate
    fi
fi
