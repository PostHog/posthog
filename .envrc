if command -v flox >/dev/null 2>&1; then # Only activate flox if installed
    # Check if Flox environment is already active for this project or its subdirectories
    if [ -z "${FLOX_ENV_PROJECT}" ]; then
        # No environment active, safe to activate
        unset VIRTUAL_ENV PYTHONPATH CONDA_DEFAULT_ENV 2>/dev/null || true
        flox activate
    elif [[ "${PWD}" != "${FLOX_ENV_PROJECT}"* ]]; then
        # Different project environment active, check for nesting
        echo "⚠️  About to activate Flox environment in worktree while already in environment for:"
        echo "   ${FLOX_ENV_PROJECT}"
        echo ""
        read -p "Continue with nested activation? (y/N): " -n 1 -r
        echo ""
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            echo "Skipping Flox activation. To switch to this environment, run:"
            echo "  exit"
            echo "  cd ${PWD}"
            return 0
        fi
        # Clean up conflicting environment variables before activation
        unset VIRTUAL_ENV PYTHONPATH CONDA_DEFAULT_ENV 2>/dev/null || true
        flox activate
    fi
fi
